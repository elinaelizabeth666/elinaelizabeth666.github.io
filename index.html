<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>å’¸é±¼çš„å°èŒ¶é¦†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- å­—ä½“å¯¼å…¥ -->
  <style>
    /* å¯’è‰å›¢åœ†ä½“ */
    @import url("https://fontsapi.zeoseven.com/66/main/result.css");
    
    /* å‘†èŒæ‰‹å†™ä½“ */
    @import url("https://fontsapi.zeoseven.com/638/main/result.css");
    
    /* ç¼åˆåƒç´ å­—ä½“ */
    @import url("https://fontsapi.zeoseven.com/570/main/result.css");
    
    /* Permanent Markerå­—ä½“ */
    @font-face {
        font-family: "ZSFT-dr";
        src: url("https://fontsapi.zeoseven.com/dr/main.woff2") format('woff2'),
            url("https://fontsapi-storage.zeoseven.com/dr/main.woff2") format('woff2');
        font-display: swap;
    }
    
    /* å¹³æ–¹æ˜Ÿè¾°ä½“ */
    @import url("https://fontsapi.zeoseven.com/512/main/result.css");
    
    /* é»„å‡¯æ¡¦å¾‹å¸ˆæ‰‹å†™ä½“ */
    @import url("https://fontsapi.zeoseven.com/223/main/result.css");
  </style>
  <style>
    body { background: #ededed; font-family: "å¾®è½¯é›…é»‘", Arial, sans-serif; margin: 0; -webkit-user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
    
    /* ä¸»å®¹å™¨ */
    .app-container { max-width: 420px; margin: 10px auto; background: #f5f5f5; border-radius: 10px; box-shadow: 0 2px 8px #ccc; display: flex; flex-direction: column; height: calc(100vh - 20px); min-height: 600px; }
    @media (max-width: 480px) {
      .app-container { margin: 5px; max-width: none; height: calc(100vh - 10px); border-radius: 0; }
    }
    
    /* èŠå¤©åˆ—è¡¨ç•Œé¢ */
    .chat-list-view { display: none; flex-direction: column; height: 100%; }
    .chat-list-view.active { display: flex; }
    .chat-list-header { background: #6DA3BD; color: #fff; padding: 16px; border-radius: 10px 10px 0 0; font-size: 20px; display: flex; justify-content: space-between; align-items: center; }
    .header-buttons { display: flex; gap: 10px; }
    .header-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 16px; -webkit-tap-highlight-color: transparent; }
    .header-btn:hover { background: rgba(255,255,255,0.3); }
    .header-btn:active { background: rgba(255,255,255,0.4); }
    
    /* AIå›å¤è®¾ç½®é¢æ¿æ ·å¼ */
    .ai-settings-panel { background: #fff; padding: 20px; border-bottom: 1px solid #ddd; display: none; max-height: calc(100vh - 200px); overflow-y: auto; }
    .ai-settings-panel.show { display: block; }
    .context-setting { margin-bottom: 20px; }
    .context-input { width: 80px; }
    .setting-textarea { width: 100%; min-height: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; font-family: inherit; font-size: 14px; line-height: 1.5; outline: none; box-sizing: border-box; }
    .setting-textarea:focus { border-color: #6DA3BD; box-shadow: 0 0 0 2px rgba(109, 163, 189, 0.2); }
    
    /* èŠå¤©æ°”æ³¡æ“ä½œèœå•æ ·å¼ */
          .msg-menu { position: absolute; background: #000; border-radius: 8px; padding: 8px 0; z-index: 1000; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 120px; --arrow-position: 50%; }
.msg-menu::before { content: ''; position: absolute; bottom: -6px; left: var(--arrow-position, 50%); transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid #000; }
    .msg-menu-item { padding: 12px 16px; color: #fff; cursor: pointer; white-space: nowrap; font-size: 14px; text-align: center; }
    .msg-menu-item:hover { background: rgba(255,255,255,0.1); }
    .msg-menu-item.danger { color: #ff4d4f; }
.msg-menu-item.regenerate { color: #52c41a; }
    
    /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
    @media (max-width: 768px) {
      .msg-menu { min-width: 140px; font-size: 16px; }
      .msg-menu-item { padding: 14px 20px; }
    }
    
    /* æ°”æ³¡é€‰ä¸­çŠ¶æ€ */
    .msg.selected .bubble { background: rgba(26, 136, 230, 0.1) !important; }
    
    /* æ¶ˆæ¯å¤šé€‰æ¨¡å¼æ ·å¼ */
    .multi-select-mode .msg { cursor: pointer; }
    .multi-select-mode .msg:hover { background: rgba(26, 136, 230, 0.05); }
    .multi-select-mode .msg.selected .bubble { 
      background: rgba(26, 136, 230, 0.1) !important; 
      border: 2px solid #1890ff !important;
    }
    .multi-select-mode .msg-menu { display: none !important; } /* å¤šé€‰æ¨¡å¼ä¸‹éšè—å•ä¸ªèœå• */
    
    /* å¤šé€‰å·¥å…·æ æ ·å¼ */
    .multi-select-toolbar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px 12px 0 0;
      padding: 16px;
      box-shadow: 0 -2px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      display: none;
      min-width: 300px;
      text-align: center;
    }
    
    .multi-select-toolbar.show {
      display: block;
    }
    
    .multi-select-info {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
    }
    
    .multi-select-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    
    .multi-select-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .multi-select-btn.forward {
      background: #1890ff;
      color: white;
    }
    
    .multi-select-btn.forward:hover {
      background: #0e7abe;
    }
    
    .multi-select-btn.cancel {
      background: #f5f5f5;
      color: #666;
    }
    
    .multi-select-btn.cancel:hover {
      background: #e8e8e8;
    }
    
    .multi-select-btn.delete {
      background: #ff4d4f;
      color: white;
    }
    
    .multi-select-btn.delete:hover {
      background: #d32f2f;
    }
    
    @media (max-width: 480px) {
      .multi-select-toolbar {
        left: 8px;
        right: 8px;
        transform: none;
        min-width: unset;
        width: calc(100% - 16px);
      }
    }
    
    /* å›å¤æ¶ˆæ¯æ ·å¼ */
    .reply-reference { background: rgba(0,0,0,0.05); border-left: 3px solid #1890ff; padding: 8px 12px; margin-bottom: 8px; border-radius: 4px; font-size: 12px; color: #666; max-height: 60px; overflow: hidden; }
    .reply-reference .reply-from { color: #1890ff; font-weight: bold; margin-bottom: 2px; }
    .reply-reference .reply-content { line-height: 1.4; }
    
    /* è½¬å‘æ¶ˆæ¯æ ·å¼ */
    .forward-message { border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; margin: 4px 0; background: #fafafa; }
    .forward-header { display: flex; align-items: center; margin-bottom: 8px; color: #666; font-size: 12px; }
    .forward-header .icon { margin-right: 4px; }
    .forward-content { color: #333; font-size: 14px; line-height: 1.4; }
    .forward-from { color: #1890ff; font-weight: bold; margin-bottom: 4px; font-size: 12px; }
    
    /* èŠå¤©è®°å½•æ ·å¼ */
    .chat-record { 
      border: 1px solid #e0e0e0; 
      border-radius: 8px; 
      padding: 0; 
      margin: 4px 0; 
      background: #fafafa; 
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .chat-record:hover { background: #f0f0f0; }
    
    .chat-record-header {
      padding: 12px;
      border-bottom: 1px solid #e8e8e8;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .chat-record-title {
      display: flex;
      align-items: center;
      color: #666;
      font-size: 13px;
    }
    
    .chat-record-title .icon {
      margin-right: 6px;
      font-size: 14px;
    }
    
    .chat-record-count {
      color: #999;
      font-size: 12px;
    }
    
    .chat-record-preview {
      padding: 8px 12px;
      max-height: 60px;
      overflow: hidden;
    }
    
    .chat-record-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 4px;
      font-size: 12px;
      line-height: 1.4;
    }
    
    .chat-record-item:last-child {
      margin-bottom: 0;
    }
    
    .chat-record-sender {
      color: #1890ff;
      font-weight: bold;
      margin-right: 6px;
      min-width: 0;
      white-space: nowrap;
    }
    
    .chat-record-text {
      color: #666;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* èŠå¤©è®°å½•å±•å¼€æ¨¡æ€æ¡† */
    .chat-record-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 3000;
      display: none;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .chat-record-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .chat-record-modal-content {
      background: #fff;
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .chat-record-modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f7f7f7;
    }
    
    .chat-record-modal-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    
    .chat-record-modal-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #666;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .chat-record-modal-close:hover {
      background: #e8e8e8;
    }
    
    .chat-record-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
    }
    
    .chat-record-detail-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .chat-record-detail-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    
    .chat-record-detail-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 10px;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .chat-record-detail-content {
      flex: 1;
      min-width: 0;
    }
    
    .chat-record-detail-sender {
      color: #1890ff;
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .chat-record-detail-text {
      color: #333;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
    }
    
    .chat-record-detail-time {
      color: #999;
      font-size: 11px;
      margin-top: 4px;
    }
    
    @media (max-width: 480px) {
      .chat-record-modal {
        padding: 10px;
      }
      
      .chat-record-modal-content {
        max-height: 90vh;
      }
      
      .chat-record-modal-header {
        padding: 12px 16px;
      }
      
      .chat-record-modal-body {
        padding: 12px 16px;
      }
    }
    
    /* è½¬å‘é€‰æ‹©ç•Œé¢æ ·å¼ */
    .forward-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; }
    .forward-modal.show { display: flex; align-items: center; justify-content: center; }
    .forward-content-wrapper { background: #fff; border-radius: 12px; width: 90%; max-width: 400px; max-height: 80%; overflow: hidden; }
    .forward-header-bar { background: #f7f7f7; padding: 16px; border-bottom: 1px solid #e0e0e0; text-align: center; position: relative; }
    .forward-title { font-size: 16px; font-weight: bold; color: #333; }
    .forward-close { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 18px; color: #666; cursor: pointer; }
    .forward-search { padding: 12px 16px; border-bottom: 1px solid #e0e0e0; }
    .forward-search input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; font-size: 14px; background: #f5f5f5; }
    .forward-chat-list { max-height: 300px; overflow-y: auto; }
    .forward-chat-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
    .forward-chat-item:hover { background: #f5f5f5; }
    .forward-chat-item.selected { background: #e6f3ff; }
    .forward-chat-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; object-fit: cover; }
    .forward-chat-info { flex: 1; }
    .forward-chat-name { font-size: 14px; color: #333; margin-bottom: 2px; }
    .forward-chat-desc { font-size: 12px; color: #999; }
    .forward-checkbox { width: 18px; height: 18px; border: 2px solid #ddd; border-radius: 50%; position: relative; }
    .forward-checkbox.checked { background: #1890ff; border-color: #1890ff; }
    .forward-checkbox.checked::after { content: 'âœ“'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; font-weight: bold; }
    .forward-actions { padding: 16px; border-top: 1px solid #e0e0e0; display: flex; gap: 12px; }
    .forward-btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; }
    .forward-cancel { background: #f5f5f5; color: #666; }
    .forward-confirm { background: #1890ff; color: white; }
    .forward-confirm:disabled { background: #d9d9d9; cursor: not-allowed; }
    
    /* æ¶ˆæ¯é¢„è§ˆæ ·å¼ */
    .forward-preview { padding: 16px; border-bottom: 1px solid #e0e0e0; }
    .forward-preview-title { font-size: 14px; color: #666; margin-bottom: 8px; }
    .forward-preview-content { background: #f9f9f9; padding: 12px; border-radius: 8px; font-size: 13px; color: #333; max-height: 100px; overflow: hidden; }
    
    /* ç­‰å¾…æŒ‡ç¤ºå™¨åŠ¨ç”» */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }
    
    .waiting-indicator {
      animation: pulse 1.5s infinite;
    }
    
    /* å›å¤çŠ¶æ€å’Œç­‰å¾…æŒ‡ç¤ºå™¨æ ·å¼ä¼˜åŒ– */
    .reply-status, .waiting-indicator {
      margin: 0 12px 8px 12px !important; /* ä¸chat-footerä¿æŒä¸€è‡´çš„å·¦å³è¾¹è· */
      border-radius: 8px !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }
    
    @media (max-width: 480px) {
      .reply-status, .waiting-indicator {
        margin: 0 8px 8px 8px !important; /* ç§»åŠ¨ç«¯å‡å°‘è¾¹è· */
        padding: 10px 12px !important;
        font-size: 11px !important;
      }
    }
    
    .chat-list-body { flex: 1; overflow-y: auto; background: #fff; }
    .chat-item { display: flex; align-items: center; padding: 16px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
    .chat-item:hover { background: #f5f5f5; }
    .chat-item:active { background: #eee; }
    .chat-item:last-child { border-bottom: none; }
    
    .chat-item-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 12px; flex-shrink: 0; }
    .chat-item-content { flex: 1; min-width: 0; }
    .chat-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .chat-item-name { font-weight: bold; font-size: 16px; color: #333; }
    .chat-item-time { font-size: 12px; color: #999; }
    .chat-item-preview { font-size: 14px; color: #666; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
    .chat-item-actions { display: flex; flex-direction: column; gap: 5px; margin-left: 8px; }
    .chat-item-btn { background: #6DA3BD; color: #fff; border: none; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer; min-width: 40px; }
    .chat-item-btn.delete { background: #e74c3c; }
    .chat-item-btn:hover { opacity: 0.8; }
    
    .empty-chat-list { text-align: center; padding: 60px 20px; color: #999; }
    .empty-chat-list .icon { font-size: 60px; margin-bottom: 20px; }
    .empty-chat-list .text { font-size: 16px; margin-bottom: 20px; }
    
    .new-chat-btn { background: #6DA3BD; color: #fff; border: none; border-radius: 25px; padding: 12px 24px; font-size: 16px; cursor: pointer; margin: 0 auto; }
    .new-chat-btn:hover { background: #5a8ba0; }
    
    /* èŠå¤©ç•Œé¢ */
    .chat-view { display: none; flex-direction: column; height: 100%; }
    .chat-view.active { display: flex; }
    
    .chat-container { display: flex; flex-direction: column; height: 100%; }
    .chat-header { background: #6DA3BD; color: #fff; padding: 16px; border-radius: 10px 10px 0 0; font-size: 20px; text-align: center; position: relative; }
    
    /* èŠå¤©æ ‡é¢˜ç¼–è¾‘æ ·å¼ */
    .chat-title { 
      cursor: pointer; 
      padding: 4px 8px; 
      border-radius: 4px; 
      transition: background-color 0.2s; 
      display: inline-block;
      min-width: 100px;
      max-width: 200px;
      word-break: break-all;
    }
    .chat-title:hover { 
      background-color: rgba(255,255,255,0.1); 
    }
    .chat-title:hover::after {
      content: " âœï¸";
      font-size: 14px;
      opacity: 0.7;
    }
    /* è‡ªå®šä¹‰æ ‡é¢˜æ ‡è¯† */
    .chat-title.custom-title::before {
      content: "ğŸ“ ";
      font-size: 12px;
      opacity: 0.6;
    }
    .chat-title-input { 
      background: rgba(255,255,255,0.9); 
      color: #333; 
      border: none; 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-size: 20px; 
      text-align: center; 
      min-width: 100px;
      max-width: 200px;
      outline: none;
    }
    
    /* æ ‡é¢˜ç¼–è¾‘å®¹å™¨æ ·å¼ */
    .chat-title-edit-container {
      background: rgba(255, 255, 255, 0.98);
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      animation: titleEditSlideIn 0.3s ease-out;
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 8px;
      z-index: 1000;
    }
    
    @keyframes titleEditSlideIn {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scale(1);
      }
    }
    
    .chat-title-edit-container input:focus {
      outline: none;
      border-color: #07c160 !important;
      box-shadow: 0 0 0 3px rgba(7, 193, 96, 0.2);
    }
    
    .chat-title-edit-container button:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .chat-title-edit-container button:active {
      transform: scale(0.98);
    }
    
    /* ä¸ºäº†ç¡®ä¿ç¼–è¾‘å®¹å™¨ä¸è¢«é®æŒ¡ï¼Œç»™èŠå¤©æ ‡é¢˜ä¸€ä¸ªç›¸å¯¹å®šä½ */
    .chat-title {
      position: relative;
    }
    .back-btn { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: #fff; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 16px; -webkit-tap-highlight-color: transparent; display: flex; align-items: center; justify-content: center; }
    .back-btn:hover { background: rgba(255,255,255,0.3); }
    .back-btn:active { background: rgba(255,255,255,0.4); }
    .back-btn svg { flex-shrink: 0; }
    
    .settings-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; color: #fff; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 16px; -webkit-tap-highlight-color: transparent; }
    .settings-btn:hover { background: rgba(255,255,255,0.3); }
    .settings-btn:active { background: rgba(255,255,255,0.4); }
    #themeBtn { right: 104px; }
    #userBtn { right: 60px; }
    #roleBtn { right: 16px; }
    @media (max-width: 480px) {
      .settings-btn { width: 36px; height: 36px; font-size: 18px; }
      .back-btn { width: 36px; height: 36px; }
      #themeBtn { right: 96px; }
      #userBtn { right: 56px; }
      #roleBtn { right: 12px; }
    }
    .settings-panel { 
      background: #fff; 
      padding: 20px; 
      border-bottom: 1px solid #ddd; 
      display: none; 
      max-height: calc(100vh - 200px); 
      overflow-y: auto;
      padding-right: 15px;
      margin-right: 5px;
    }
    .settings-panel.show { display: block; }
    
    /* ç”¨æˆ·è®¾å®šå’Œè§’è‰²è®¾å®šé¢æ¿æ»šåŠ¨æ ·å¼ */
    #userPanel, #rolePanel {
      max-height: calc(100vh - 200px);
      overflow-y: auto;
      padding-right: 15px;
      margin-right: 5px;
    }
    
    /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
    @media (max-width: 480px) {
      #userPanel, #rolePanel, #settingsPanel, #emojiPanel {
        max-height: calc(100vh - 150px);
        padding-right: 10px;
        margin-right: 0px;
      }
    }
    
    /* æ»šåŠ¨æ¡æ ·å¼ä¼˜åŒ– */
    #userPanel::-webkit-scrollbar, #rolePanel::-webkit-scrollbar, #settingsPanel::-webkit-scrollbar, #emojiPanel::-webkit-scrollbar, #userEmojiPanel::-webkit-scrollbar {
      width: 6px;
    }
    
    #userPanel::-webkit-scrollbar-track, #rolePanel::-webkit-scrollbar-track, #settingsPanel::-webkit-scrollbar-track, #emojiPanel::-webkit-scrollbar-track, #userEmojiPanel::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    #userPanel::-webkit-scrollbar-thumb, #rolePanel::-webkit-scrollbar-thumb, #settingsPanel::-webkit-scrollbar-thumb, #emojiPanel::-webkit-scrollbar-thumb, #userEmojiPanel::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
      transition: background 0.3s ease;
    }
    
    #userPanel::-webkit-scrollbar-thumb:hover, #rolePanel::-webkit-scrollbar-thumb:hover, #settingsPanel::-webkit-scrollbar-thumb:hover, #emojiPanel::-webkit-scrollbar-thumb:hover, #userEmojiPanel::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* ä¸ºFirefoxæµè§ˆå™¨æ·»åŠ æ»šåŠ¨æ¡æ ·å¼ */
    #userPanel, #rolePanel, #settingsPanel, #emojiPanel, #userEmojiPanel {
      scrollbar-width: thin;
      scrollbar-color: #c1c1c1 #f1f1f1;
      scroll-behavior: smooth;
    }
    .setting-group { margin-bottom: 15px; }
    .setting-label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
    .setting-input { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box; resize: vertical; font-family: inherit; }
    .setting-select { width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box; background: #fff; }
    .setting-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
    .setting-btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; min-height: 44px; -webkit-tap-highlight-color: transparent; }
    .save-btn { background: #6DA3BD; color: #fff; }
    .save-btn:hover { background: #5a8ba0; }
    .cancel-btn { background: #95a5a6; color: #fff; }
    .cancel-btn:hover { background: #7f8c8d; }
    .test-btn { background: #3498db; color: #fff; }
    .test-btn:hover { background: #2980b9; }
    .test-btn:disabled { background: #bdc3c7; cursor: not-allowed; }
    .refresh-models-btn { background: #9b59b6; color: #fff; }
    .refresh-models-btn:hover { background: #8e44ad; }
    .refresh-models-btn:disabled { background: #bdc3c7; cursor: not-allowed; }
    
    /* APIé…ç½®ç®¡ç†æ ·å¼ */
    .api-config-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      margin-bottom: 8px;
    }
    
    .api-config-item.active {
      background: #e7f3ff;
      border-color: #6DA3BD;
    }
    
    .api-config-info {
      flex: 1;
      min-width: 0;
    }
    
    .api-config-name {
      font-weight: bold;
      color: #333;
      margin-bottom: 2px;
    }
    
    .api-config-details {
      font-size: 11px;
      color: #666;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .api-config-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }
    
    .api-config-actions button {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      min-width: 50px;
    }
    .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-left: 10px; }
    .status-ready { background: #6DA3BD; }
    .status-error { background: #e74c3c; }
    .status-testing { background: #f39c12; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    /* ä¸»é¢˜è®¾ç½®æ ·å¼ */
    .theme-preset-btn {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      color: #495057;
      padding: 12px 8px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      text-align: center;
    }
    .theme-preset-btn:hover {
      background: #e9ecef;
      border-color: #6DA3BD;
    }
    .theme-preset-btn.active {
      background: #6DA3BD;
      border-color: #6DA3BD;
      color: white;
    }
    
    .color-setting-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .color-label {
      min-width: 100px;
      font-weight: bold;
      color: #333;
    }
    .color-input {
      width: 50px;
      height: 35px;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      padding: 0;
    }
    .color-text {
      width: 100px;
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      font-family: monospace;
    }
    
    .font-setting-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .font-label {
      min-width: 100px;
      font-weight: bold;
      color: #333;
    }
    
    .style-setting-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .style-label {
      min-width: 120px;
      font-weight: bold;
      color: #333;
    }
    .style-slider {
      flex: 1;
      min-width: 150px;
    }
    .style-value {
      min-width: 60px;
      font-weight: bold;
      color: #6DA3BD;
    }
    
    .theme-preview {
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      background: #f5f5f5;
    }
    .preview-header {
      background: #6DA3BD;
      color: white;
      padding: 12px;
      text-align: center;
      font-weight: bold;
    }
    .preview-chat {
      padding: 15px;
      background: #f5f5f5;
      min-height: 120px;
    }
    .preview-msg {
      display: flex;
      margin-bottom: 10px;
    }
    .preview-msg.user {
      justify-content: flex-end;
    }
    .preview-msg.ai {
      justify-content: flex-start;
    }
    .preview-bubble {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 14px;
    }
    .preview-bubble.user {
      background: #95EC69;
      color: #333;
    }
    .preview-bubble.ai {
      background: white;
      color: #333;
      border: 1px solid #eee;
    }
    .test-result { margin-top: 10px; padding: 8px 12px; border-radius: 6px; font-size: 12px; }
    .test-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .test-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .test-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .model-info { font-size: 12px; color: #666; margin-top: 5px; }
    .chat-body { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; background-image: url('https://i.postimg.cc/LsfcNN6t/IMG-20250617-214650.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; }
    .msg { display: flex; margin-bottom: 8px; align-items: flex-end; }
    .msg.user { justify-content: flex-end; margin-bottom: 12px; }
    .msg.ai { justify-content: flex-start; }
    .msg.ai + .msg.ai { margin-bottom: 6px; }
    .msg.ai:last-child { margin-bottom: 12px; }
    
    .avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .msg.user .avatar { margin-left: 8px; order: 2; }
    .msg.ai .avatar { margin-right: 8px; order: 1; }
    
    .bubble { max-width: 75%; padding: 10px 16px; border-radius: 18px; font-size: 16px; line-height: 1.5; position: relative; }
    .msg.user .bubble { background: rgba(149, 236, 105, 0.95); color: #222; border-bottom-right-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); order: 1; }
    .msg.ai .bubble { background: rgba(255, 255, 255, 0.95); color: #222; border-bottom-left-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); order: 2; }
    
    /* å¾®ä¿¡é£æ ¼ç‹¬ç«‹æ—¶é—´æ˜¾ç¤º */
    .msg-time { 
      font-size: 12px; 
      color: rgba(0,0,0,0.6); 
      text-align: center;
      margin: 10px 0 8px 0;
      width: 100%;
      display: flex;
      justify-content: center;
      position: relative;
    }
    
    .msg-time span {
      background: rgba(0,0,0,0.05);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      color: rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
    }
    
    /* æ°”æ³¡å®¹å™¨æ ·å¼è°ƒæ•´ */
    .bubble-container {
      display: flex;
      flex-direction: column;
      max-width: 75%;
    }
    .msg.user .bubble-container {
      align-items: flex-end;
      order: 1;
    }
    .msg.ai .bubble-container {
      align-items: flex-start;
      order: 2;
    }
    
    /* è¡¨æƒ…åŒ…æ°”æ³¡å®¹å™¨ç‰¹æ®Šå¤„ç† */
    .bubble-container.emoji-container-wrapper {
      max-width: 150px !important; /* ä¸ºè¡¨æƒ…åŒ…è®¾ç½®æ›´å°çš„æœ€å¤§å®½åº¦ */
    }
    
    /* è¡¨æƒ…åŒ…å®¹å™¨æ ·å¼ */
    .emoji-container {
      width: 120px !important;
      height: 120px !important;
      overflow: hidden;
      border-radius: 8px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f0f0;
    }
    
    .emoji-container img {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
      display: block !important;
    }
    .bubble[data-streaming="true"] { position: relative; }
    .bubble[data-streaming="true"]:after { 
      content: 'â–‹'; 
      color: #6DA3BD; 
      animation: blink 1s infinite; 
      margin-left: 2px; 
    }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
    
    /* è¡¨æƒ…åŒ…è®¾ç½®ç›¸å…³æ ·å¼ */
    .emotion-tabs { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .emotion-tab { padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: #fff; cursor: pointer; font-size: 14px; transition: all 0.3s; }
    .emotion-tab:hover { background: #f0f0f0; }
    .emotion-tab.active { background: #6DA3BD; color: #fff; border-color: #6DA3BD; }
    
    .emoji-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-bottom: 20px; max-height: 300px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; }
    .emoji-item { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; cursor: pointer; transition: transform 0.2s; }
    .emoji-item:hover { transform: scale(1.05); }
    .emoji-item img { width: 100%; height: 100%; object-fit: cover; }
    .emoji-item .delete-btn { position: absolute; top: 2px; right: 2px; background: rgba(231, 76, 60, 0.8); color: #fff; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: none; }
    .emoji-item:hover .delete-btn { display: block; }
    
    @media (max-width: 480px) {
      .emotion-tabs { gap: 5px; }
      .emotion-tab { padding: 6px 12px; font-size: 12px; }
      .emoji-gallery { grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; }
    }
    .chat-footer { 
      display: flex; 
      flex-direction: column; 
      gap: 8px; 
      padding: 12px; 
      background: #fafafa; 
      border-radius: 0 0 10px 10px; 
    }
    
    .chat-input-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .chat-buttons-row {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: flex-start;
      padding: 0 4px;
      border-top: 1px solid #f0f0f0;
      padding-top: 8px;
      margin-top: 4px;
    }
    
    .chat-button-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    
    .chat-button-label {
      font-size: 11px;
      color: #666;
      line-height: 1;
    }
    .chat-input { flex: 1; padding: 12px 16px; border: 1px solid #ddd; border-radius: 18px; font-size: 16px; outline: none; -webkit-appearance: none; -webkit-tap-highlight-color: transparent; }
    .send-btn { background: #6DA3BD; color: #fff; border: none; border-radius: 18px; padding: 12px 24px; font-size: 16px; cursor: pointer; min-height: 44px; -webkit-tap-highlight-color: transparent; }
    .send-btn:active { background: #5a8ba0; }
    .send-btn:disabled { background: #bdc3c7; cursor: not-allowed; }
    .emoji-btn { background: #fff; border: 1px solid #ddd; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; }
    .emoji-btn:hover { background: #f0f0f0; border-color: #6DA3BD; }
    .emoji-btn:active { background: #e0e0e0; }
    
    /* ä½ç½®æŒ‰é’®æ ·å¼ */
    .location-btn { background: #fff; border: 1px solid #ddd; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; }
    .location-btn:hover { background: #f0f0f0; border-color: #6DA3BD; }
    .location-btn:active { background: #e0e0e0; }
    
    /* è½¬è´¦æŒ‰é’®æ ·å¼ */
    .transfer-btn { background: #fff; border: 1px solid #ddd; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; }
    .transfer-btn:hover { background: #f0f0f0; border-color: #6DA3BD; }
    .transfer-btn:active { background: #e0e0e0; }
    
    /* å›¾ç‰‡æŒ‰é’®æ ·å¼ */
    .image-btn { background: #fff; border: 1px solid #ddd; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; }
    .image-btn:hover { background: #f0f0f0; border-color: #6DA3BD; }
    .image-btn:active { background: #e0e0e0; }
    
    /* ç”¨æˆ·è¡¨æƒ…åŒ…é¢æ¿æ ·å¼ */
    .user-emoji-panel { position: absolute; bottom: 120px; left: 12px; right: 12px; background: #fff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000; display: none; max-height: 300px; }
    .user-emoji-panel.show { display: block; }
    .user-emoji-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #eee; }
    .user-emoji-title { font-size: 14px; font-weight: bold; color: #333; }
    .user-emoji-close { background: none; border: none; font-size: 18px; color: #999; cursor: pointer; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
    .user-emoji-close:hover { background: #f0f0f0; color: #333; }
    .user-emoji-grid { padding: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto; }
    .user-emoji-item { aspect-ratio: 1; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; border: 2px solid transparent; }
    .user-emoji-item:hover { transform: scale(1.05); border-color: #6DA3BD; }
    .user-emoji-item:active { transform: scale(0.95); }
    .user-emoji-item img { width: 100%; height: 100%; object-fit: cover; }
    .user-emoji-empty { grid-column: 1/-1; text-align: center; color: #999; padding: 20px; font-size: 14px; }
    .user-emoji-empty .icon { font-size: 32px; margin-bottom: 8px; display: block; }
    
    /* è¡¨æƒ…åŒ…æ°”æ³¡æ ·å¼ */
    .emoji-bubble { 
      background: transparent !important; 
      padding: 4px !important; 
      box-shadow: none !important; 
      border: none !important;
      max-width: 140px !important; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé¿å…é®æŒ¡å¤´åƒ */
      width: auto !important;
    }
    .emoji-container { 
      border-radius: 8px; 
      overflow: hidden; 
      width: 120px !important;
      height: 120px !important;
    }
    
    /* ä½ç½®æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
    .location-bubble {
      background: #fff !important;
      border: 1px solid #e0e0e0 !important;
      border-radius: 12px !important;
      padding: 0 !important;
      max-width: 260px !important;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }
    .location-container {
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
    }
    .location-container:hover {
      background: #f5f5f5;
    }
    .location-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }
    .location-info {
      padding: 12px 16px;
      border-top: 1px solid #f0f0f0;
    }
    .location-name {
      font-size: 16px;
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
      line-height: 1.3;
    }
    .location-address {
      font-size: 13px;
      color: #666;
      line-height: 1.4;
    }
    .location-icon {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    /* è½¬è´¦æ¶ˆæ¯æ°”æ³¡æ ·å¼ */
    .transfer-bubble {
      background: #fff !important;
      border: 1px solid #e0e0e0 !important;
      border-radius: 12px !important;
      padding: 0 !important;
      max-width: 280px !important;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }
    .transfer-container {
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: white;
    }
    .transfer-container:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .transfer-header {
      padding: 16px 20px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .transfer-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .transfer-icon {
      font-size: 20px;
    }
    .transfer-subtitle {
      font-size: 13px;
      opacity: 0.9;
    }
    .transfer-body {
      padding: 12px 20px 16px;
    }
    .transfer-amount {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .transfer-note {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    .transfer-status {
      font-size: 12px;
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 4px;
    }
          .transfer-status-icon {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(255,255,255,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 8px;
      }
      
      /* å›¾ç‰‡æ¶ˆæ¯æ ·å¼ */
      .image-bubble {
        background: transparent !important;
        border: none !important;
        padding: 0 !important;
        border-radius: 12px;
        overflow: hidden;
        max-width: 300px;
      }
      
      .image-message {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        background: #f5f5f5;
        min-height: 100px;
        display: flex;
        flex-direction: column;
      }
      
      .image-message img {
        width: 100%;
        height: auto;
        max-height: 400px;
        object-fit: cover;
        display: block;
        cursor: pointer;
        transition: transform 0.2s ease;
      }
      
      .image-message img:hover {
        transform: scale(1.02);
      }
      
      .image-message-text {
        padding: 12px;
        background: rgba(255, 255, 255, 0.95);
        font-size: 14px;
        line-height: 1.4;
        color: #333;
        border-top: 1px solid #eee;
      }
      
      .image-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100px;
        background: #f5f5f5;
        color: #666;
        font-size: 14px;
      }
      
      .image-error {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100px;
        background: #ffeaea;
        color: #d63031;
        font-size: 14px;
        border: 1px solid #fab1a0;
      }
    @media (max-width: 480px) {
      .chat-footer { padding: 8px; gap: 6px; }
      .chat-input-row { gap: 6px; }
      .chat-buttons-row { gap: 8px; padding: 0 2px; }
      .chat-button-item { gap: 2px; }
      .chat-button-label { font-size: 10px; }
      .chat-input { font-size: 16px; padding: 10px 14px; }
      .send-btn { padding: 10px 20px; min-width: 60px; }
      .emoji-btn { width: 40px; height: 40px; font-size: 16px; }
      .image-btn { width: 40px; height: 40px; font-size: 16px; }
      .location-btn { width: 40px; height: 40px; font-size: 16px; }
      .transfer-btn { width: 40px; height: 40px; font-size: 16px; }
      .video-call-btn { width: 40px; height: 40px; font-size: 16px; }
      .avatar { width: 50px; height: 50px; }
      .msg.user .avatar { margin-left: 8px; }
      .msg.ai .avatar { margin-right: 8px; }
      
      /* ç§»åŠ¨ç«¯èŠå¤©æ°”æ³¡å®½åº¦ä¼˜åŒ– */
      .bubble { max-width: 85% !important; }
      .bubble-container { max-width: 85% !important; }
      
      /* ç§»åŠ¨ç«¯æ¶ˆæ¯é—´è·è°ƒæ•´ */
      .msg { margin-bottom: 16px !important; }
      .msg.user + .msg.user { margin-bottom: 8px !important; }
      .msg.ai + .msg.ai { margin-bottom: 8px !important; }
      
      .user-emoji-panel { bottom: 100px; left: 8px; right: 8px; max-height: 250px; }
      .user-emoji-grid { grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 6px; }
      
      /* ç§»åŠ¨ç«¯è¡¨æƒ…åŒ…å°ºå¯¸è°ƒæ•´ */
      .emoji-container { 
        width: 110px !important; 
        height: 110px !important; 
      }
      .emoji-bubble { 
        max-width: 120px !important; 
      }
      
      /* ç§»åŠ¨ç«¯ä½ç½®æ¶ˆæ¯å°ºå¯¸è°ƒæ•´ */
      .location-bubble {
        max-width: 280px !important;
      }
      .location-image {
        height: 100px !important;
      }
      
      /* ç§»åŠ¨ç«¯ä½ç½®å¼¹çª—ä¼˜åŒ– */
      .location-modal-content {
        width: 95%;
        max-height: 95vh;
        margin: 10px;
      }
      
      .location-modal-header {
        padding: 12px 16px;
      }
      
      .location-modal-title {
        font-size: 16px;
      }
      
      .location-modal-body {
        padding: 16px;
      }
      
      .location-modal-footer {
        padding: 12px 16px;
      }
      
      .location-preview-image {
        height: 150px !important;
      }
      
      .location-form-input {
        font-size: 16px;
      }
      
      /* ç§»åŠ¨ç«¯è½¬è´¦æ¶ˆæ¯å°ºå¯¸è°ƒæ•´ */
      .transfer-bubble {
        max-width: 280px !important;
      }
      .transfer-amount {
        font-size: 24px !important;
      }
      
      /* ç§»åŠ¨ç«¯è½¬è´¦å¼¹çª—ä¼˜åŒ– */
      .transfer-modal-content {
        width: 95%;
        max-height: 95vh;
        margin: 10px;
        box-sizing: border-box;
      }
      
      .transfer-modal-header {
        padding: 12px 16px;
      }
      
      .transfer-modal-title {
        font-size: 16px;
      }
      
      .transfer-modal-body {
        padding: 16px;
        box-sizing: border-box;
      }
      
      .transfer-modal-footer {
        padding: 12px 16px;
      }
      
      .transfer-form-input {
        font-size: 16px;
      }
      
      .transfer-amount-input {
        font-size: 20px !important;
      }
      
      .transfer-preview-amount {
        font-size: 28px !important;
      }
    }
    
    /* ç¾¤èŠç›¸å…³æ ·å¼ */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; }
    .modal-content { background: #fff; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal-header { padding: 20px 20px 0; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { margin: 0; color: #333; }
    .modal-close { background: none; border: none; font-size: 24px; color: #999; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { color: #333; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 0 20px 20px; display: flex; gap: 10px; justify-content: flex-end; }
    
    .role-item { display: flex; align-items: center; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; background: #f9f9f9; }
    .role-item-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px; }
    .role-item-info { flex: 1; }
    .role-item-name { font-weight: bold; color: #333; margin-bottom: 4px; }
    .role-item-desc { font-size: 12px; color: #666; line-height: 1.4; }
    .role-item-frequency { font-size: 11px; color: #999; margin-top: 2px; }
    .role-item-actions { display: flex; flex-direction: column; gap: 5px; }
    .role-item-btn { padding: 4px 8px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; min-width: 50px; }
    .role-item-btn.edit { background: #3498db; color: #fff; }
    .role-item-btn.delete { background: #e74c3c; color: #fff; }
    .role-item-btn:hover { opacity: 0.8; }
    
    .group-chat-indicator { display: inline-block; background: #9b59b6; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 8px; }
    
    /* é¢„è®¾ç®¡ç†ç›¸å…³æ ·å¼ */
    .preset-item { display: flex; align-items: center; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; background: #f9f9f9; }
    .preset-item-info { flex: 1; }
    .preset-item-name { font-weight: bold; color: #333; margin-bottom: 4px; }
    .preset-item-desc { font-size: 12px; color: #666; line-height: 1.4; }
    .preset-item-type { font-size: 11px; color: #999; margin-top: 2px; }
    .preset-item-actions { display: flex; gap: 5px; }
    .preset-item-btn { padding: 4px 8px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; min-width: 50px; }
    .preset-item-btn.use { background: #3498db; color: #fff; }
    .preset-item-btn.delete { background: #e74c3c; color: #fff; }
    .preset-item-btn:hover { opacity: 0.8; }
    .preset-item.builtin { background: #e8f5e8; border-color: #c3e6c3; }
    .preset-item.custom { background: #f0f8ff; border-color: #b3d9ff; }
    
    /* ç¾¤èŠæ¶ˆæ¯æ˜¾ç¤º */
    .msg.group { 
      margin-bottom: 12px; 
      position: relative; 
    }
    
    /* ç¾¤èŠä¸­AIæ¶ˆæ¯éƒ½éœ€è¦ä¸Šè¾¹è·ä¸ºè§’è‰²åç§°ç•™ç©ºé—´ */
    .msg.group.ai {
      margin-top: 20px;
    }
    
    /* è§’è‰²åç§°æ ·å¼ */
    .msg.group .role-name { 
      font-size: 12px; 
      color: #666; 
      margin-bottom: 4px; 
      position: absolute;
      top: -18px;
      left: 53px;
      z-index: 1;
      white-space: nowrap;
    }
    .msg.group.user .role-name { 
      left: auto;
      right: 53px; 
      text-align: right; 
    }
    
    /* æ–‡ä»¶ä¸Šä¼ ç›¸å…³æ ·å¼ */
    .upload-area {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin: 10px 0;
      transition: all 0.3s ease;
      background: #fafafa;
    }
    
    .upload-area:hover {
      border-color: #007AFF;
      background: #f0f8ff;
    }
    
    .upload-area.dragover {
      border-color: #007AFF;
      background: #e6f3ff;
      transform: scale(1.02);
    }
    
    .upload-btn {
      background: #17a2b8 !important;
      color: white !important;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    
    .upload-btn:hover {
      background: #138496 !important;
    }
    
    .upload-btn:disabled {
      background: #6c757d !important;
      cursor: not-allowed;
    }
    
    .file-info {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    .preview-image {
      max-width: 100px;
      max-height: 100px;
      border-radius: 4px;
      margin-top: 10px;
      border: 1px solid #ddd;
    }
    
    /* æ‹–æ‹½ä¸Šä¼ æç¤º */
    .drag-hint {
      color: #999;
      font-size: 12px;
      margin-top: 5px;
    }
    
    /* ç¾¤èŠä¸­ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ä¸Šè¾¹è· */
    .msg.group:first-child { 
      margin-top: 20px; 
    }
    
    /* ç”¨æˆ·æ¶ˆæ¯åçš„AIæ¶ˆæ¯éœ€è¦é¢å¤–é—´è· */
    .msg.group.user + .msg.group.ai { 
      margin-top: 24px; 
    }
    
    /* è¿ç»­AIæ¶ˆæ¯çš„é—´è·è°ƒæ•´ */
    .msg.group.ai + .msg.group.ai {
      margin-top: 16px; /* ç¨å¾®ç´§å¯†ä¸€äº›ï¼Œä½†ä»ä¸ºåç§°ç•™ç©ºé—´ */
    }
    
    @media (max-width: 480px) {
      .modal-content { width: 95%; max-height: 90vh; }
      .modal-header, .modal-body, .modal-footer { padding: 15px; }
      .role-item { padding: 10px; }
      .role-item-avatar { width: 35px; height: 35px; }
      
      /* ç§»åŠ¨ç«¯ç¾¤èŠè§’è‰²åç§°è°ƒæ•´ */
      .msg.group .role-name { 
        left: 58px; 
        font-size: 11px;
        top: -16px;
      }
      .msg.group.user .role-name { 
        right: 58px; 
      }
    }
    
    /* æœ‹å‹åœˆç•Œé¢æ ·å¼ */
    .moments-view { display: none; flex-direction: column; height: 100%; background: #f7f7f7; }
    .moments-view.active { display: flex; }
    
    .moments-header { 
      background: linear-gradient(135deg, #6DA3BD 0%, #8BC34A 100%); 
      color: #fff; 
      padding: 16px; 
      border-radius: 10px 10px 0 0; 
      position: relative;
      height: 200px;
      background-image: url('https://i.postimg.cc/7Lr42Xqf/IMG-20250618-215711.jpg');
      background-size: cover;
      background-position: center;
      background-blend-mode: overlay;
    }
    
    .moments-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: none;
      border-radius: 10px 10px 0 0;
    }
    
    .moments-header-content {
      position: relative;
      z-index: 2;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      height: 100%;
    }
    
    .moments-back-btn { 
      background: rgba(0,0,0,0.4); 
      border: none; 
      color: #fff; 
      border-radius: 50%; 
      width: 36px; 
      height: 36px; 
      cursor: pointer; 
      font-size: 18px; 
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(10px);
    }
    .moments-back-btn:hover { background: rgba(0,0,0,0.6); }
    
    .moments-user-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      margin-top: auto;
      margin-bottom: 20px;
    }
    
    .moments-user-name {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .moments-user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      border: 3px solid rgba(255,255,255,0.8);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .moments-content { 
      flex: 1; 
      overflow-y: auto; 
      background: #f7f7f7; 
      padding: 0;
    }
    
    .moments-publish-area {
      background: #fff;
      padding: 15px;
      border-bottom: 8px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .publish-avatar {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      object-fit: cover;
    }
    
    .publish-text {
      flex: 1;
      background: #f5f5f5;
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-size: 16px;
      color: #999;
      cursor: pointer;
      outline: none;
    }
    
    .moments-list {
      background: #f7f7f7;
    }
    
    .moment-item {
      background: #fff;
      margin-bottom: 8px;
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .moment-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .moment-avatar {
      width: 45px;
      height: 45px;
      border-radius: 6px;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .moment-author-info {
      flex: 1;
    }
    
    .moment-author {
      font-weight: bold;
      color: #576b95;
      font-size: 16px;
      margin-bottom: 4px;
    }
    
    .moment-content-text {
      font-size: 16px;
      line-height: 1.5;
      color: #333;
      margin-bottom: 12px;
      word-break: break-word;
    }
    
    .moment-images {
      display: grid;
      gap: 4px;
      margin-bottom: 12px;
    }
    
    .moment-images.single { grid-template-columns: 1fr; max-width: 200px; }
    .moment-images.two { grid-template-columns: 1fr 1fr; max-width: 300px; }
    .moment-images.three { grid-template-columns: 1fr 1fr 1fr; }
    .moment-images.four { grid-template-columns: 1fr 1fr; }
    .moment-images.five { grid-template-columns: 1fr 1fr 1fr; }
    .moment-images.six { grid-template-columns: 1fr 1fr 1fr; }
    .moment-images.seven { grid-template-columns: 1fr 1fr 1fr; }
    .moment-images.eight { grid-template-columns: 1fr 1fr 1fr; }
    .moment-images.nine { grid-template-columns: 1fr 1fr 1fr; }
    
    .moment-image {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .moment-image:hover {
      transform: scale(1.02);
    }
    
    .moment-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #999;
    }
    
    .moment-time {
      font-size: 13px;
      color: #999;
    }
    
    .moment-actions {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .moment-like-btn, .moment-comment-btn {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    .moment-like-btn:hover, .moment-comment-btn:hover {
      background: #f0f0f0;
    }
    
    .moment-like-btn.liked {
      color: #e74c3c;
    }
    
    .moment-comments {
      background: #f7f7f7;
      margin-top: 12px;
      padding: 0;
      border-radius: 4px;
      font-size: 14px;
      display: none;
    }
    
    .moment-comments.show {
      display: block;
    }
    
    .comments-header {
      padding: 8px 12px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f0f0f0;
      border-radius: 4px 4px 0 0;
    }
    
    .comments-title {
      font-weight: bold;
      color: #666;
      font-size: 13px;
    }
    
    .comments-toggle {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 3px;
    }
    
    .comments-toggle:hover {
      background: #ddd;
    }
    
    .comments-list {
      max-height: 300px;
      overflow-y: auto;
      padding: 8px 12px;
    }
    
    .comments-list.collapsed {
      max-height: 60px;
      overflow: hidden;
    }
    
    .moment-comment {
      margin-bottom: 8px;
      line-height: 1.4;
      position: relative;
      padding: 4px 0;
    }
    
    .moment-comment:last-child {
      margin-bottom: 0;
    }
    
    .comment-author {
      color: #576b95;
      font-weight: bold;
      cursor: pointer;
    }
    
    .comment-author:hover {
      text-decoration: underline;
    }
    
    .comment-text {
      color: #333;
    }
    
    .comment-reply {
      color: #576b95;
      font-weight: bold;
    }
    
    .comment-mention {
      color: #576b95;
      font-weight: bold;
      background: #e8f4f8;
      padding: 0 2px;
      border-radius: 2px;
    }
    
    .comment-time {
      color: #999;
      font-size: 12px;
      margin-left: 8px;
    }
    
    .comment-actions {
      display: none;
      position: absolute;
      right: 0;
      top: 2px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 2px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      z-index: 10;
    }
    
    .moment-comment:hover .comment-actions {
      display: block;
    }
    
    .reply-btn {
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 2px;
    }
    
    .reply-btn:hover {
      background: #f0f0f0;
    }
    
    .comment-input-area {
      padding: 8px 12px;
      border-top: 1px solid #e0e0e0;
      background: #fff;
    }
    
    .comment-input-container {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      position: relative;
    }
    
    .comment-input {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px 10px;
      font-size: 14px;
      outline: none;
      resize: none;
      min-height: 20px;
      max-height: 80px;
      line-height: 1.4;
      font-family: inherit;
    }
    
    .comment-input:focus {
      border-color: #6DA3BD;
    }
    
    .comment-send-btn {
      background: #6DA3BD;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .comment-send-btn:hover {
      background: #5a8ba0;
    }
    
    .comment-send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .reply-indicator {
      background: #e8f4f8;
      padding: 4px 8px;
      margin: 4px 0;
      border-radius: 4px;
      font-size: 12px;
      color: #666;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .cancel-reply {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 12px;
      padding: 0;
    }
    
    .cancel-reply:hover {
      color: #666;
    }
    
    .mention-suggestions {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
      max-height: 150px;
      overflow-y: auto;
      z-index: 20;
      display: none;
    }
    
    .mention-suggestions.show {
      display: block;
    }
    
    .mention-item {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .mention-item:last-child {
      border-bottom: none;
    }
    
    .mention-item:hover {
      background: #f5f5f5;
    }
    
    .mention-item.selected {
      background: #e8f4f8;
    }
    
    .mention-avatar {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      object-fit: cover;
    }
    
    .mention-name {
      font-weight: bold;
      color: #333;
    }
    
    /* å‘å¸ƒæœ‹å‹åœˆå¼¹çª— */
    .publish-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .publish-modal.show {
      display: flex;
    }
    
    .publish-modal-content {
      background: #fff;
      width: 90%;
      max-width: 400px;
      border-radius: 10px;
      overflow: hidden;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    
    .publish-modal-header {
      background: #6DA3BD;
      color: #fff;
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .publish-modal-title {
      font-size: 18px;
      font-weight: bold;
    }
    
    .publish-modal-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .publish-modal-close:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .publish-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .publish-textarea {
      width: 100%;
      border: none;
      outline: none;
      font-size: 16px;
      line-height: 1.5;
      resize: none;
      min-height: 120px;
      font-family: inherit;
      color: #333;
    }
    
    .publish-images-container {
      margin-top: 15px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    
    .publish-image-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 6px;
      overflow: hidden;
      background: #f5f5f5;
      border: 1px dashed #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .publish-image-item.has-image {
      border: none;
    }
    
    .publish-image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .publish-image-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .publish-add-image {
      font-size: 24px;
      color: #999;
    }
    
    .publish-visibility {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #f0f0f0;
    }
    
    .visibility-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .visibility-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .visibility-option {
      background: #f5f5f5;
      border: 1px solid #ddd;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }
    
    .visibility-option.selected {
      background: #6DA3BD;
      color: #fff;
      border-color: #6DA3BD;
    }
    
    .visibility-option.disabled {
      background: #f0f0f0;
      color: #999;
      border-color: #e0e0e0;
      cursor: not-allowed;
    }
    
    .publish-modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #f0f0f0;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .publish-btn {
      background: #6DA3BD;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .publish-btn:hover {
      background: #5a8ba0;
    }
    
    .publish-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .cancel-btn {
      background: #95a5a6;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .cancel-btn:hover {
      background: #7f8c8d;
    }
    
    /* å›¾ç‰‡é¢„è§ˆå¼¹çª— */
    .image-preview-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .image-preview-modal.show {
      display: flex;
    }
    
    .image-preview-content {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }
    
    .image-preview-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: #fff;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .image-preview-close:hover {
      background: rgba(255,255,255,0.3);
    }

    /* ä½ç½®é€‰æ‹©å¼¹çª— */
    .location-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .location-modal.show {
      display: flex;
    }
    
    .location-modal-content {
      background: #fff;
      border-radius: 12px;
      width: 90%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
    }
    
    .location-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
      background: #fafafa;
      flex-shrink: 0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    .location-modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .location-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .location-modal-close:hover {
      background: #f0f0f0;
      color: #333;
    }
    
    .location-modal-body {
      padding: 20px;
      flex: 1;
      overflow: visible;
    }
    
    .location-preview {
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
      background: #fff;
    }
    
    .location-preview-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
      display: block;
      background: #f5f5f5;
    }
    
    .location-preview-info {
      padding: 16px;
    }
    
    .location-form-group {
      margin-bottom: 16px;
    }
    
    .location-form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 6px;
    }
    
    .location-form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .location-form-input:focus {
      border-color: #6DA3BD;
      box-shadow: 0 0 0 2px rgba(109, 163, 189, 0.2);
    }
    
    .location-form-textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }
    
    .location-image-upload {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafafa;
    }
    
    .location-image-upload:hover {
      border-color: #6DA3BD;
      background: #f0f8ff;
    }
    
    .location-image-upload.has-image {
      border-style: solid;
      padding: 0;
      background: none;
    }
    
    .location-upload-text {
      color: #666;
      font-size: 14px;
      margin-top: 8px;
    }
    
    .location-upload-icon {
      font-size: 32px;
      color: #ccc;
      margin-bottom: 8px;
    }
    
    .location-modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #f0f0f0;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      background: #fafafa;
      flex-shrink: 0;
      position: sticky;
      bottom: 0;
      z-index: 1;
    }
    
    .location-btn-cancel {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .location-btn-cancel:hover {
      background: #e0e0e0;
      border-color: #ccc;
    }
    
    .location-btn-send {
      background: #6DA3BD;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .location-btn-send:hover {
      background: #5a8ba0;
    }
    
    .location-btn-send:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* ä½ç½®å¼¹çª—æ»šåŠ¨æ¡æ ·å¼ */
    .location-modal-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .location-modal-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    .location-modal-content::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
      transition: background 0.2s;
    }
    
    .location-modal-content::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
    
    /* Firefoxæ»šåŠ¨æ¡æ ·å¼ */
    .location-modal-content {
      scrollbar-width: thin;
      scrollbar-color: #c1c1c1 #f1f1f1;
    }

    /* è½¬è´¦å¼¹çª—æ ·å¼ */
    .transfer-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .transfer-modal.show {
      display: flex;
    }
    
    .transfer-modal-content {
      background: #fff;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      display: flex;
      flex-direction: column;
    }
    
    .transfer-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: white;
      flex-shrink: 0;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    .transfer-modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .transfer-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: white;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .transfer-modal-close:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .transfer-modal-body {
      padding: 20px;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    
    .transfer-form-group {
      margin-bottom: 20px;
    }
    
    .transfer-form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
    }
    
    .transfer-form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s;
    }
    
    .transfer-form-input:focus {
      border-color: #ff6b35;
      box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2);
    }
    
    .transfer-amount-input {
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      color: #ff6b35;
    }
    
    .transfer-amount-input::placeholder {
      color: #ccc;
    }
    
    .transfer-form-textarea {
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }
    
    .transfer-preview {
      border: 1px solid #f0f0f0;
      border-radius: 12px;
      overflow: hidden;
      margin: 0 auto 20px auto;
      background: #fff;
      box-sizing: border-box;
      width: 100%;
    }
    
    .transfer-preview-container {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-sizing: border-box;
      width: 100%;
    }
    
    .transfer-preview-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .transfer-preview-amount {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      word-break: break-all;
    }
    
    .transfer-preview-note {
      font-size: 14px;
      opacity: 0.9;
      line-height: 1.3;
      word-wrap: break-word;
    }
    
    .transfer-modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #f0f0f0;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      background: #fafafa;
      flex-shrink: 0;
      position: sticky;
      bottom: 0;
      z-index: 1;
    }
    
    .transfer-btn-cancel {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #ddd;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .transfer-btn-cancel:hover {
      background: #e0e0e0;
      border-color: #ccc;
    }
    
    .transfer-btn-send {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
    }
    
    .transfer-btn-send:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
    }
    
    .transfer-btn-send:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* è½¬è´¦å¼¹çª—æ»šåŠ¨æ¡æ ·å¼ */
    .transfer-modal-body::-webkit-scrollbar {
      width: 6px;
    }
    
    .transfer-modal-body::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    
    .transfer-modal-body::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
      transition: background 0.2s;
    }
    
    .transfer-modal-body::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
    
    /* Firefoxæ»šåŠ¨æ¡æ ·å¼ */
    .transfer-modal-body {
      scrollbar-width: thin;
      scrollbar-color: #c1c1c1 #f1f1f1;
    }

    /* ç¡®ä¿è½¬è´¦é¢„è§ˆåœ¨æœ‰æ»šåŠ¨æ¡æ—¶ä¿æŒæ­£ç¡®å¯¹é½ */
    .transfer-modal-body {
      box-sizing: border-box;
    }

    /* æ»šåŠ¨æ¡èƒŒæ™¯é€æ˜åŒ– */
    .transfer-modal-body::-webkit-scrollbar-track {
      background: transparent;
    }

    /* è½¬è´¦é¢„è§ˆå›¾ç‰‡å¯¹é½ä¿®å¤ */
    .transfer-preview-container * {
      box-sizing: border-box;
    }

    /* è½¬è´¦é¢„è§ˆå®Œç¾å±…ä¸­ */
    .transfer-preview {
      display: block;
      margin-left: auto;
      margin-right: auto;
      position: relative;
      left: 0;
      right: 0;
    }

    /* ç¡®ä¿è½¬è´¦é¢„è§ˆå®¹å™¨å®Œå…¨å±…ä¸­ */
    .transfer-modal-body .transfer-preview {
      margin-left: 0;
      margin-right: 0;
      width: 100%;
      max-width: 100%;
    }

    /* è§†é¢‘é€šè¯æŒ‰é’®æ ·å¼ */
    .video-call-btn {
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .video-call-btn:hover {
      background: #218838;
      transform: scale(1.05);
    }

    .video-call-btn:active {
      transform: scale(0.95);
    }

    /* è§†é¢‘é€šè¯ç”³è¯·å¼¹çª—æ ·å¼ */
    .video-call-request-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    .video-call-request-modal.show {
      display: flex;
    }

    .video-call-request-content {
      background: #fff;
      border-radius: 20px;
      padding: 40px 30px;
      text-align: center;
      max-width: 300px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      animation: slideInUp 0.3s ease;
    }

    .video-call-request-avatar {
      margin-bottom: 20px;
    }

    .video-call-request-avatar img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #28a745;
    }

    .video-call-request-name {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }

    .video-call-request-text {
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
    }

    .video-call-request-actions {
      display: flex;
      gap: 20px;
      justify-content: center;
    }

    .video-call-decline-btn {
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .video-call-decline-btn:hover {
      background: #c82333;
      transform: scale(1.05);
    }

    .video-call-accept-btn {
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .video-call-accept-btn:hover {
      background: #218838;
      transform: scale(1.05);
    }

    .video-call-decline-btn::before {
      content: 'âœ•';
    }

    .video-call-accept-btn::before {
      content: 'âœ“';
    }

    /* æ‹ä¸€æ‹æé†’å¼¹çª—æ ·å¼ */
    .pat-reminder-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2500;
      backdrop-filter: blur(2px);
    }

    .pat-reminder-modal.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .pat-reminder-content {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      max-width: 280px;
      width: 80%;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      animation: slideInScale 0.4s ease;
      position: relative;
    }

    .pat-reminder-avatar {
      margin-bottom: 16px;
      position: relative;
    }

    .pat-reminder-avatar img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #6DA3BD;
      animation: patBounce 0.6s ease-in-out;
    }

    .pat-reminder-text {
      font-size: 16px;
      color: #333;
      margin-bottom: 20px;
      line-height: 1.4;
    }

    .pat-reminder-close {
      background: #6DA3BD;
      color: #fff;
      border: none;
      border-radius: 20px;
      padding: 8px 20px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .pat-reminder-close:hover {
      background: #5a8ca0;
      transform: translateY(-1px);
    }

    /* æ‹ä¸€æ‹åŠ¨ç”»æ•ˆæœ */
    @keyframes patBounce {
      0% { transform: scale(1); }
      20% { transform: scale(1.1) rotate(-5deg); }
      40% { transform: scale(0.95) rotate(3deg); }
      60% { transform: scale(1.05) rotate(-2deg); }
      80% { transform: scale(0.98) rotate(1deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    @keyframes slideInScale {
      0% { 
        transform: scale(0.8) translateY(20px); 
        opacity: 0; 
      }
      100% { 
        transform: scale(1) translateY(0); 
        opacity: 1; 
      }
    }

    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      .pat-reminder-content {
        max-width: 260px;
        width: 85%;
        padding: 20px;
      }
      
      .pat-reminder-avatar img {
        width: 70px;
        height: 70px;
      }
      
      .pat-reminder-text {
        font-size: 15px;
      }
    }

    /* æ‹ä¸€æ‹æ¶ˆæ¯æ ·å¼ */
    .pat-message {
      text-align: center;
      margin: 8px 0;
      padding: 0;
    }

    .pat-message-content {
      display: inline-block;
      background: rgba(0, 0, 0, 0.05);
      color: #999;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 12px;
      max-width: 80%;
      word-wrap: break-word;
      animation: patMessageFadeIn 0.3s ease;
    }

    .pat-message-content.shake {
      animation: patShake 0.6s ease-in-out;
    }

    /* æ‹ä¸€æ‹æ¶ˆæ¯åŠ¨ç”» */
    @keyframes patMessageFadeIn {
      0% { 
        opacity: 0; 
        transform: scale(0.8) translateY(10px); 
      }
      100% { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
      }
    }

    @keyframes patShake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
      20%, 40%, 60%, 80% { transform: translateX(2px); }
    }

    /* å¤´åƒè¢«æ‹åŠ¨ç”» */
    @keyframes patBounce {
      0% { transform: scale(1); }
      20% { transform: scale(1.1) rotate(-5deg); }
      40% { transform: scale(1.05) rotate(3deg); }
      60% { transform: scale(1.08) rotate(-2deg); }
      80% { transform: scale(1.02) rotate(1deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    /* è§†é¢‘é€šè¯ç•Œé¢æ ·å¼ */
    .video-call-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: none;
      z-index: 3000;
    }

    .video-call-modal.show {
      display: block;
    }

    .video-call-content {
      height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .video-call-screen {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .video-call-main-video {
      width: 100%;
      height: 100%;
      position: relative;
      background: #1a1a1a;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .video-call-main-video img,
    .video-call-main-video video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-call-user-info {
      position: absolute;
      top: 20px;
      left: 20px;
      color: #fff;
      z-index: 10;
    }

    .video-call-user-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .video-call-duration {
      font-size: 14px;
      opacity: 0.8;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }

    .video-call-user-video {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 120px;
      height: 160px;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10;
    }

    .video-call-user-video img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-call-messages {
      position: absolute;
      bottom: 170px;
      left: 20px;
      right: 20px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 10;
      padding-bottom: 15px;
    }

    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
    .video-call-messages::-webkit-scrollbar {
      width: 4px;
    }

    .video-call-messages::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
    }

    .video-call-messages::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
    }

    .video-call-messages::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.5);
    }

    .video-call-message {
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 12px 16px;
      border-radius: 20px;
      margin-bottom: 10px;
      max-width: 80%;
      word-wrap: break-word;
      backdrop-filter: blur(15px);
      animation: fadeInUp 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .video-call-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.8);
      padding: 20px;
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    .video-call-input-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }

    .video-call-input {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 25px;
      background: rgba(255,255,255,0.9);
      font-size: 16px;
      outline: none;
    }

    .video-call-input::placeholder {
      color: #999;
    }

    .video-call-send-btn {
      background: #007AFF;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .video-call-send-btn:hover {
      background: #0056CC;
      transform: scale(1.05);
    }

    .video-call-action-row {
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .video-call-mute-btn,
    .video-call-camera-btn {
      background: rgba(255,255,255,0.2);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .video-call-mute-btn:hover,
    .video-call-camera-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.05);
    }

    .video-call-hangup-btn {
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 64px;
      height: 64px;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      transform: rotate(135deg);
    }

    .video-call-hangup-btn:hover {
      background: #c82333;
      transform: scale(1.05) rotate(135deg);
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      .video-call-user-video {
        width: 100px;
        height: 130px;
        top: 15px;
        right: 15px;
      }

      .video-call-user-info {
        top: 15px;
        left: 15px;
      }

      .video-call-user-name {
        font-size: 16px;
      }

      .video-call-duration {
        font-size: 12px;
      }

      .video-call-messages {
        bottom: 140px;
        left: 15px;
        right: 15px;
        max-height: 180px;
        padding-bottom: 15px;
      }

      .video-call-controls {
        padding: 15px;
      }

      .video-call-input-row {
        margin-bottom: 12px;
      }

      .video-call-input {
        padding: 10px 14px;
        font-size: 14px;
      }

      .video-call-send-btn {
        width: 44px;
        height: 44px;
        font-size: 14px;
      }

      .video-call-mute-btn,
      .video-call-camera-btn {
        width: 48px;
        height: 48px;
        font-size: 18px;
      }

      .video-call-hangup-btn {
        width: 56px;
        height: 56px;
        font-size: 20px;
      }

      .video-call-action-row {
        gap: 15px;
      }
    }

    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- èŠå¤©åˆ—è¡¨ç•Œé¢ -->
    <div class="chat-list-view active" id="chatListView">
      <div class="chat-list-header">
        <span>èŠå¤©</span>
        <div class="header-buttons">
          <button class="header-btn" id="momentsBtn" title="æœ‹å‹åœˆ">ğŸ“¸</button>
          <button class="header-btn" id="settingsBtn" title="APIè®¾ç½®">âš™</button>
          <button class="header-btn" id="emojiBtn" title="è¡¨æƒ…åŒ…è®¾ç½®">ğŸ˜Š</button>
          <button class="header-btn" id="aiSettingsBtn" title="AIå›å¤è®¾ç½®">ğŸ¤–</button>
          <button class="header-btn" id="newGroupChatBtn" title="æ–°å»ºç¾¤èŠ">ğŸ‘¥</button>
          <button class="header-btn" id="newChatBtn" title="æ–°å»ºèŠå¤©">+</button>
        </div>
      </div>
      
      <!-- APIè®¾ç½®é¢æ¿ -->
    <div class="settings-panel" id="settingsPanel">
      <!-- APIé…ç½®ç®¡ç† -->
      <div class="setting-group">
        <label class="setting-label">å·²ä¿å­˜çš„APIé…ç½®:</label>
        <select class="setting-select" id="savedApiSelect">
          <option value="">é€‰æ‹©å·²ä¿å­˜çš„APIé…ç½®...</option>
        </select>
        <div class="setting-buttons" style="margin-top: 8px;">
          <button class="setting-btn test-btn" id="loadApiBtn">åŠ è½½é…ç½®</button>
          <button class="setting-btn test-btn" id="deleteApiBtn" style="background: #e74c3c;">åˆ é™¤é…ç½®</button>
          <button class="setting-btn test-btn" id="newApiConfigBtn" style="background: #27ae60;">æ–°å»ºé…ç½®</button>
        </div>
      </div>
      
      <div class="setting-group">
        <label class="setting-label">é…ç½®åç§°:</label>
        <input type="text" class="setting-input" id="apiConfigNameInput" placeholder="ä¸ºæ­¤APIé…ç½®èµ·ä¸ªåå­—ï¼Œå¦‚ï¼šDeepSeekä¸»è¦" />
      </div>
      
      <div class="setting-group">
        <label class="setting-label">APIåœ°å€:</label>
        <input type="text" class="setting-input" id="apiUrlInput" placeholder="è¯·è¾“å…¥APIåŸºç¡€åœ°å€" />
        <div class="model-info" style="margin-top: 8px; font-size: 12px; color: #666;">
          <div><strong>æ”¯æŒçš„APIæ ¼å¼ï¼š</strong></div>
          <div>â€¢ <strong>DeepSeek:</strong> https://api.deepseek.com</div>
          <div>â€¢ <strong>OpenAI:</strong> https://api.openai.com/v1</div>
          <div>â€¢ <strong>ç¡…åŸºæµåŠ¨:</strong> https://api.siliconflow.cn/v1</div>
          <div style="margin-top: 5px; color: #e74c3c;"><strong>æ³¨æ„ï¼š</strong>Google APIå¯†é’¥æ ¼å¼ä¸º AIza... å¼€å¤´</div>
          <div style="margin-top: 5px; color: #f39c12;"><strong>ç¬¬ä¸‰æ–¹APIï¼š</strong>å¦‚é‡è¿æ¥é—®é¢˜ï¼Œè¯·ä½¿ç”¨"ğŸ” è°ƒè¯•æ¨¡å‹"æŒ‰é’®</div>
          <div style="margin-top: 5px; color: #8e44ad;">å¦‚æœè¿æ¥å¤±è´¥ï¼Œè¯·ä½¿ç”¨"ğŸ’¬ ç›´æ¥æµ‹è¯•èŠå¤©"æŒ‰é’®</div>
          <div style="margin-top: 10px;">
            <button class="setting-btn test-btn" id="siliconflowApiHelperBtn" style="background: #2ecc71; color: white;">
              ğŸš€ ç¡…åŸºæµåŠ¨ API è¿æ¥åŠ©æ‰‹
            </button>
          </div>
        </div>
      </div>
      <div class="setting-group">
        <label class="setting-label">APIç§˜é’¥:</label>
        <input type="password" class="setting-input" id="apiKeyInput" placeholder="è¯·è¾“å…¥APIç§˜é’¥" />
      </div>
      
      <!-- è¯†å›¾APIé…ç½® -->
      <div class="setting-group">
        <h3 style="margin: 0 0 10px 0; color: #333; font-size: 14px;">ğŸ–¼ï¸ è¯†å›¾APIé…ç½® (å¯é€‰)</h3>
        <p style="font-size: 12px; color: #666; margin: 0 0 10px 0;">é…ç½®è¯†å›¾APIåï¼ŒAIå¯ä»¥è¯†åˆ«ç”¨æˆ·å‘é€çš„å›¾ç‰‡å†…å®¹</p>
      </div>
      
      <div class="setting-group">
        <label class="setting-label">è¯†å›¾APIåœ°å€:</label>
        <input type="text" class="setting-input" id="visionApiUrlInput" placeholder="è¯·è¾“å…¥è¯†å›¾APIåœ°å€ï¼ˆå¯é€‰ï¼‰" />
        <div class="model-info" style="margin-top: 5px; font-size: 12px; color: #666;">
          <div><strong>æ”¯æŒçš„è¯†å›¾APIï¼š</strong></div>
          <div>â€¢ <strong>OpenAI:</strong> https://api.openai.com/v1</div>
          <div>â€¢ <strong>ç¡…åŸºæµåŠ¨:</strong> https://api.siliconflow.cn/v1</div>
          <div>â€¢ <strong>å…¶ä»–å…¼å®¹OpenAIæ ¼å¼çš„API</strong></div>
        </div>
      </div>
      
      <div class="setting-group">
        <label class="setting-label">è¯†å›¾APIå¯†é’¥:</label>
        <input type="password" class="setting-input" id="visionApiKeyInput" placeholder="è¯·è¾“å…¥è¯†å›¾APIå¯†é’¥ï¼ˆå¯é€‰ï¼‰" />
      </div>
      
      <div class="setting-group">
        <label class="setting-label">è¯†å›¾æ¨¡å‹:</label>
        <select class="setting-select" id="visionModelSelect">
          <option value="">è¯·å…ˆæµ‹è¯•è¯†å›¾è¿æ¥ä»¥è·å–å¯ç”¨æ¨¡å‹</option>
        </select>
        <div class="model-info" id="visionModelInfo">é€‰æ‹©ä¸€ä¸ªæ”¯æŒè§†è§‰è¯†åˆ«çš„AIæ¨¡å‹</div>
      </div>
      
      <div class="setting-buttons" style="margin-top: 10px;">
        <button class="setting-btn test-btn" id="testVisionBtn" style="background: #9b59b6;">æµ‹è¯•è¯†å›¾è¿æ¥</button>
        <button class="setting-btn refresh-models-btn" id="refreshVisionModelsBtn" style="background: #9b59b6;">åˆ·æ–°è¯†å›¾æ¨¡å‹</button>
        <button class="setting-btn test-btn" id="debugVisionModelsBtn" style="background: #e67e22;">ğŸ” è°ƒè¯•è¯†å›¾æ¨¡å‹</button>
      </div>
      
      <div class="setting-group">
        <label class="setting-label">AIæ¨¡å‹:</label>
        <select class="setting-select" id="modelSelect">
          <option value="">è¯·å…ˆæµ‹è¯•è¿æ¥ä»¥è·å–å¯ç”¨æ¨¡å‹</option>
        </select>
        <div class="model-info" id="modelInfo">é€‰æ‹©ä¸€ä¸ªAIæ¨¡å‹è¿›è¡Œå¯¹è¯</div>
      </div>
      <div id="testResult"></div>
      <div class="setting-buttons">
        <button class="setting-btn test-btn" id="testBtn">æµ‹è¯•è¿æ¥</button>
        <button class="setting-btn refresh-models-btn" id="refreshModelsBtn">åˆ·æ–°æ¨¡å‹</button>
        <button class="setting-btn test-btn" id="debugModelsBtn" style="background: #e67e22;">ğŸ” è°ƒè¯•æ¨¡å‹</button>
        <button class="setting-btn test-btn" id="directChatTestBtn" style="background: #27ae60;">ğŸ’¬ ç›´æ¥æµ‹è¯•èŠå¤©</button>
      </div>
      <div class="setting-buttons" style="margin-top: 10px;">
        <button class="setting-btn save-btn" id="saveAsNewBtn">ğŸ’¾ ä¿å­˜ä¸ºæ–°é…ç½®</button>
        <button class="setting-btn save-btn" id="updateCurrentBtn" style="background: #f39c12;">ğŸ“ æ›´æ–°å½“å‰é…ç½®</button>
        <button class="setting-btn cancel-btn" id="cancelBtn">å–æ¶ˆ</button>
      </div>
    </div>
      
      <!-- è¡¨æƒ…åŒ…è®¾ç½®é¢æ¿ -->
      <div class="settings-panel" id="emojiPanel">
        <div class="setting-group">
          <label class="setting-label">AIè¡¨æƒ…åŒ…è®¾ç½®</label>
          <p style="font-size: 12px; color: #666; margin: 5px 0;">AIæ¯æ¬¡å›å¤åéƒ½ä¼šå‘é€è¡¨æƒ…åŒ…ï¼Œä¼šæ ¹æ®ç”¨æˆ·å’ŒAIçš„æƒ…ç»ªé€‰æ‹©å¯¹åº”çš„è¡¨æƒ…åŒ…</p>
        </div>
        
        <div class="emotion-tabs">
          <button class="emotion-tab active" data-emotion="happy">ğŸ˜Š å¼€å¿ƒ</button>
          <button class="emotion-tab" data-emotion="sad">ğŸ˜¢ ä¼¤å¿ƒ</button>
          <button class="emotion-tab" data-emotion="angry">ğŸ˜  ç”Ÿæ°”</button>
          <button class="emotion-tab" data-emotion="confused">ğŸ˜• ç–‘æƒ‘</button>
          <button class="emotion-tab" data-emotion="love">ğŸ˜ å–œæ¬¢</button>
        </div>
        
        <div class="emoji-gallery" id="emojiGallery">
          <!-- è¡¨æƒ…åŒ…ä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
        </div>
        
        <div class="setting-group">
          <label class="setting-label">æ·»åŠ è¡¨æƒ…åŒ…:</label>
          <input type="url" class="setting-input" id="newEmojiInput" placeholder="è¯·è¾“å…¥è¡¨æƒ…åŒ…å›¾ç‰‡é“¾æ¥" />
          <div class="setting-buttons" style="margin-top: 10px;">
            <button class="setting-btn save-btn" id="addEmojiBtn">æ·»åŠ é“¾æ¥</button>
            <button class="setting-btn test-btn upload-btn" id="uploadEmojiBtn">ğŸ“ ä¸Šä¼ æ–‡ä»¶</button>
          </div>
          <div class="upload-area" id="emojiDropArea">
            <div>ğŸ“¤ æ‹–æ‹½å›¾ç‰‡æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ </div>
            <div class="drag-hint">æˆ–ç‚¹å‡»ä¸Šæ–¹"ä¸Šä¼ æ–‡ä»¶"æŒ‰é’®é€‰æ‹©å›¾ç‰‡</div>
            <div class="file-info">æ”¯æŒ JPGã€PNGã€GIFã€WebP æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
          </div>
          <input type="file" id="emojiFileInput" accept="image/*" style="display: none;" />
        </div>
        
        <div class="setting-buttons">
          <button class="setting-btn cancel-btn" id="closeEmojiBtn">å…³é—­</button>
        </div>
      </div>
      
      <!-- AIå›å¤è®¾ç½®é¢æ¿ -->
      <div class="ai-settings-panel" id="aiSettingsPanel">
        <div class="setting-group">
          <label class="setting-label">ğŸ¤– AIå›å¤è®¾ç½®</label>
          <p style="font-size: 12px; color: #666; margin: 5px 0;">æ§åˆ¶AIå¯ä»¥çœ‹åˆ°çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œé¿å…è®°å¿†æ··ä¹±</p>
        </div>
        
        <div class="setting-group context-setting">
          <label class="setting-label">ä¸Šä¸‹æ–‡è½®æ•°:</label>
          <input type="number" class="setting-input context-input" id="contextLengthInput" 
                 value="10" min="1" max="50" placeholder="10" />
          <span style="font-size: 12px; color: #666; margin-left: 10px;">AIå¯ä»¥çœ‹åˆ°æœ€è¿‘Nä¸ªå¯¹è¯è½®æ•°</span>
        </div>
        
        <div class="setting-group context-setting">
          <label class="setting-label">å“åº”é—´éš” (ç§’):</label>
          <input type="number" class="setting-input context-input" id="responseDelayInput" 
                 value="0" min="0" max="60" placeholder="0" />
          <span style="font-size: 12px; color: #666; margin-left: 10px;">0è¡¨ç¤ºç«‹å³å›å¤ï¼Œ>0è¡¨ç¤ºå»¶è¿Ÿå›å¤</span>
        </div>
        
        <div class="setting-group">
          <label class="setting-label">è®¾ç½®è¯´æ˜:</label>
          <div style="font-size: 12px; color: #666; line-height: 1.5; padding: 10px; background: #f9f9f9; border-radius: 6px;">
            <div>â€¢ <strong>ä¸Šä¸‹æ–‡è½®æ•°:</strong> æ§åˆ¶AIèƒ½çœ‹åˆ°çš„å†å²å¯¹è¯æ•°é‡</div>
            <div>â€¢ <strong>æ•°å€¼è¶Šå¤§:</strong> AIè®°å¿†æ›´å®Œæ•´ï¼Œä½†å¯èƒ½æ··ä¹±</div>
            <div>â€¢ <strong>æ•°å€¼è¶Šå°:</strong> AIè®°å¿†æ›´æ¸…æ™°ï¼Œä½†å¯èƒ½æ–­å±‚</div>
            <div>â€¢ <strong>æ¨èå€¼:</strong> å•èŠ 10-20ï¼Œç¾¤èŠ 5-15</div>
            <div>â€¢ <strong>å“åº”é—´éš”:</strong> è®¾ç½®AIå»¶è¿Ÿå›å¤æ—¶é—´ï¼Œå¯æ”¶é›†å¤šæ¡æ¶ˆæ¯</div>
            <div>â€¢ <strong>é—´éš”ç”¨é€”:</strong> 0ç§’ç«‹å³å›å¤ï¼Œ3-10ç§’é€‚åˆè¿ç»­å¯¹è¯</div>
            <div>â€¢ <strong>é‡ç½®èŠå¤©:</strong> æ¸…ç©ºèŠå¤©åAIå°†å®Œå…¨å¿˜è®°ä¹‹å‰çš„å¯¹è¯</div>
          </div>
        </div>
        
        <div class="setting-group">
          <label class="setting-label">é¢„è®¾æç¤ºè¯:</label>
          <textarea class="setting-textarea" id="aiPromptInput" 
                    placeholder="åœ¨è¿™é‡Œè¾“å…¥é¢„è®¾æç¤ºè¯ï¼ŒAIå°†æ ¹æ®è¿™äº›æç¤ºè¯æ¥è§„èŒƒå›å¤å†…å®¹...&#10;&#10;ä¾‹å¦‚ï¼š&#10;- è¯·ç”¨ç®€æ´æ˜äº†çš„è¯­è¨€å›å¤&#10;- ä¿æŒå‹å–„å’Œè€å¿ƒçš„è¯­æ°”&#10;- å¦‚æœä¸ç¡®å®šç­”æ¡ˆï¼Œè¯·è¯šå®è¯´æ˜&#10;- å›å¤æ—¶è¯·è€ƒè™‘ä¸Šä¸‹æ–‡æƒ…å†µ" 
                    maxlength="2000"></textarea>
          <div style="font-size: 12px; color: #666; margin-top: 5px;">
            <span>ğŸ’¡ æç¤ºè¯å°†ä½œä¸ºç³»ç»ŸæŒ‡ä»¤å‘é€ç»™AIï¼Œå¸®åŠ©è§„èŒƒAIçš„å›å¤é£æ ¼å’Œå†…å®¹</span>
            <span style="float: right;" id="promptCharCount">0/2000</span>
          </div>
        </div>
        
        <div class="setting-group">
          <label class="setting-label">é¢„è®¾æ¨¡æ¿:</label>
          <div class="setting-buttons">
            <button class="setting-btn test-btn" onclick="setPromptTemplate('professional')">ä¸“ä¸šåŠ©æ‰‹</button>
            <button class="setting-btn test-btn" onclick="setPromptTemplate('friendly')">å‹å–„èŠå¤©</button>
            <button class="setting-btn test-btn" onclick="setPromptTemplate('creative')">åˆ›æ„å†™ä½œ</button>
          </div>
          <div class="setting-buttons" style="margin-top: 8px;">
            <button class="setting-btn test-btn" onclick="setPromptTemplate('teacher')">æ•™å­¦æŒ‡å¯¼</button>
            <button class="setting-btn test-btn" onclick="setPromptTemplate('clear')">æ¸…ç©ºæç¤ºè¯</button>
          </div>
        </div>

        <div class="setting-group">
          <label class="setting-label">å¿«é€Ÿè®¾ç½®:</label>
          <div class="setting-buttons">
            <button class="setting-btn test-btn" onclick="setAIConfig(5, 0)">ç®€çŸ­è®°å¿†+å³æ—¶å›å¤</button>
            <button class="setting-btn test-btn" onclick="setAIConfig(10, 3)">æ ‡å‡†è®°å¿†+3ç§’å»¶è¿Ÿ</button>
            <button class="setting-btn test-btn" onclick="setAIConfig(20, 0)">é•¿æœŸè®°å¿†+å³æ—¶å›å¤</button>
          </div>
          <div class="setting-buttons" style="margin-top: 8px;">
            <button class="setting-btn test-btn" onclick="setAIConfig(15, 5)">å¯¹è¯æ¨¡å¼(5ç§’å»¶è¿Ÿ)</button>
            <button class="setting-btn test-btn" onclick="setAIConfig(10, 10)">æ·±åº¦æ€è€ƒ(10ç§’å»¶è¿Ÿ)</button>
          </div>
        </div>
        
        <div class="setting-buttons">
          <button class="setting-btn save-btn" id="saveAISettingsBtn">ä¿å­˜è®¾ç½®</button>
          <button class="setting-btn cancel-btn" id="closeAISettingsBtn">å…³é—­</button>
        </div>
      </div>
      
      <div class="chat-list-body" id="chatListBody">
        <div class="empty-chat-list" id="emptyChatList">
          <div class="icon">ğŸ’¬</div>
          <div class="text">è¿˜æ²¡æœ‰èŠå¤©è®°å½•</div>
          <button class="new-chat-btn" onclick="createNewChat()">å¼€å§‹æ–°èŠå¤©</button>
          <button class="new-chat-btn" onclick="createNewGroupChat()" style="margin-top: 10px; background: #9b59b6;">åˆ›å»ºç¾¤èŠ</button>
        </div>
      </div>
    </div>

    <!-- æœ‹å‹åœˆç•Œé¢ -->
    <div class="moments-view" id="momentsView">
      <div class="moments-header">
        <div class="moments-header-content">
          <button class="moments-back-btn" id="momentsBackBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m15 18-6-6 6-6"/>
            </svg>
          </button>
          <button class="moments-back-btn" id="momentsSettingsBtn" style="position: absolute; top: 16px; right: 16px;" title="æœ‹å‹åœˆè®¾ç½®">
            âš™ï¸
          </button>
          <div class="moments-user-info">
            <div class="moments-user-name" id="momentsUserName">æˆ‘çš„æœ‹å‹åœˆ</div>
            <img class="moments-user-avatar" id="momentsUserAvatar" src="https://i.postimg.cc/9fv1G8vS/default-user.png" alt="ç”¨æˆ·å¤´åƒ">
          </div>
        </div>
      </div>
      
      <div class="moments-content">
        <div class="moments-publish-area" id="momentsPublishArea">
          <img class="publish-avatar" id="publishAvatar" src="https://i.postimg.cc/9fv1G8vS/default-user.png" alt="å¤´åƒ">
          <div class="publish-text" id="publishText">åˆ†äº«æ–°é²œäº‹...</div>
        </div>
        
        <div class="moments-list" id="momentsList">
          <!-- æœ‹å‹åœˆåŠ¨æ€åˆ—è¡¨ -->
        </div>
      </div>
    </div>

    <!-- å‘å¸ƒæœ‹å‹åœˆå¼¹çª— -->
    <div class="publish-modal" id="publishModal">
      <div class="publish-modal-content">
        <div class="publish-modal-header">
          <div class="publish-modal-title">å‘è¡¨æœ‹å‹åœˆ</div>
          <button class="publish-modal-close" id="publishModalClose">Ã—</button>
        </div>
        <div class="publish-modal-body">
          <textarea class="publish-textarea" id="publishTextarea" placeholder="è¿™ä¸€åˆ»çš„æƒ³æ³•..."></textarea>
          <div class="publish-images-container" id="publishImagesContainer">
            <div class="publish-image-item" id="addImageBtn">
              <div class="publish-add-image">+</div>
            </div>
          </div>
          <div class="publish-visibility">
            <div class="visibility-label">
              <span>ğŸ‘ï¸</span>
              <span>è°å¯ä»¥çœ‹</span>
            </div>
                    <div class="visibility-options" id="visibilityOptions">
          <!-- è§’è‰²é€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
        </div>
          </div>
        </div>
        <div class="publish-modal-footer">
          <button class="cancel-btn" id="publishCancel">å–æ¶ˆ</button>
          <button class="cancel-btn" id="testAIReply" style="background: #e67e22;">ğŸ¤– æµ‹è¯•AIå›å¤</button>
          <button class="publish-btn" id="publishConfirm">å‘è¡¨</button>
        </div>
      </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
    <div class="image-preview-modal" id="imagePreviewModal">
      <button class="image-preview-close" id="imagePreviewClose">Ã—</button>
      <img class="image-preview-content" id="imagePreviewContent">
    </div>

    <!-- è½¬å‘é€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="forward-modal" id="forwardModal">
      <div class="forward-content-wrapper">
        <div class="forward-header-bar">
          <div class="forward-title">é€‰æ‹©èŠå¤©</div>
          <button class="forward-close" id="forwardClose">Ã—</button>
        </div>
        
        <div class="forward-preview" id="forwardPreview">
          <div class="forward-preview-title">è½¬å‘å†…å®¹ï¼š</div>
          <div class="forward-preview-content" id="forwardPreviewContent"></div>
        </div>
        
        <div class="forward-search">
          <input type="text" id="forwardSearchInput" placeholder="æœç´¢èŠå¤©">
        </div>
        
        <div class="forward-chat-list" id="forwardChatList">
          <!-- èŠå¤©åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="forward-actions">
          <button class="forward-btn forward-cancel" id="forwardCancel">å–æ¶ˆ</button>
          <button class="forward-btn forward-confirm" id="forwardConfirm" disabled>å‘é€</button>
        </div>
      </div>
    </div>

    <!-- æœ‹å‹åœˆè®¾ç½®å¼¹çª— -->
    <div class="publish-modal" id="momentsSettingsModal">
      <div class="publish-modal-content">
        <div class="publish-modal-header">
          <div class="publish-modal-title">æœ‹å‹åœˆè®¾ç½®</div>
          <button class="publish-modal-close" id="momentsSettingsClose">Ã—</button>
        </div>
        <div class="publish-modal-body">
          <div class="setting-group">
            <label class="setting-label">æœ‹å‹åœˆæ ‡é¢˜:</label>
            <input type="text" class="setting-input" id="momentsTitle" placeholder="æˆ‘çš„æœ‹å‹åœˆ" maxlength="20">
          </div>
          
          <div class="setting-group">
            <label class="setting-label">å°é¢å›¾ç‰‡:</label>
            <input type="url" class="setting-input" id="momentsCoverUrl" placeholder="è¯·è¾“å…¥å°é¢å›¾ç‰‡é“¾æ¥ï¼ˆå¯é€‰ï¼‰">
            <div class="setting-buttons" style="margin-top: 10px;">
              <button class="setting-btn test-btn upload-btn" id="uploadMomentsCoverBtn">ğŸ“· ä¸Šä¼ å°é¢</button>
              <button class="setting-btn cancel-btn" id="resetMomentsCoverBtn">é‡ç½®é»˜è®¤</button>
              <button class="setting-btn save-btn" id="setAsDefaultBtn">â­ è®¾ä¸ºé»˜è®¤</button>
            </div>
            <input type="file" id="momentsCoverFileInput" accept="image/*" style="display: none;">
          </div>
          
          <div class="setting-group">
            <label class="setting-label">å°é¢é¢„è§ˆ:</label>
            <div id="momentsCoverPreview" style="width: 100%; height: 150px; background-size: cover; background-position: center; border-radius: 8px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; color: #999; font-size: 14px;">
              å½“å‰å°é¢é¢„è§ˆ
            </div>
          </div>
          
          <div class="setting-group">
            <label class="setting-label">AIè§’è‰²è¯„è®ºè®¾ç½®:</label>
            <select class="setting-select" id="momentsCommentMode">
              <option value="smart">æ™ºèƒ½è¯„è®ºï¼ˆæ¨èï¼‰</option>
              <option value="all">æ‰€æœ‰å¯è§è§’è‰²éƒ½è¯„è®º</option>
              <option value="random">éšæœºé€‰æ‹©è§’è‰²è¯„è®º</option>
              <option value="none">å…³é—­AIè¯„è®º</option>
            </select>
            <div style="font-size: 12px; color: #666; margin-top: 5px; line-height: 1.4;">
              <div><strong>æ™ºèƒ½è¯„è®ºï¼š</strong>â‰¤3ä¸ªè§’è‰²å…¨éƒ¨è¯„è®ºï¼Œ>3ä¸ªè§’è‰²æ™ºèƒ½é€‰æ‹©2-4ä¸ª</div>
              <div><strong>æ‰€æœ‰è¯„è®ºï¼š</strong>æ‰€æœ‰å¯è§è§’è‰²éƒ½ä¼šè¯„è®ºï¼ˆå¯èƒ½è¾ƒå¤šï¼‰</div>
              <div><strong>éšæœºè¯„è®ºï¼š</strong>éšæœºé€‰æ‹©1-3ä¸ªè§’è‰²è¯„è®º</div>
              <div><strong>å…³é—­è¯„è®ºï¼š</strong>AIè§’è‰²ä¸ä¼šè‡ªåŠ¨è¯„è®ºæœ‹å‹åœˆ</div>
            </div>
          </div>
        </div>
        <div class="publish-modal-footer">
          <button class="cancel-btn" id="cancelMomentsSettings">å–æ¶ˆ</button>
          <button class="publish-btn" id="saveMomentsSettings">ä¿å­˜è®¾ç½®</button>
        </div>
      </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="momentImageInput" accept="image/*" multiple style="display: none;">

    <!-- èŠå¤©ç•Œé¢ -->
    <div class="chat-view" id="chatView">
  <div class="chat-container">
    <div class="chat-header">
          <button class="back-btn" id="backBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m15 18-6-6 6-6"/>
            </svg>
          </button>
      <span id="chatTitle" class="chat-title">AIå¾®ä¿¡èŠå¤©</span>
      <span class="status-indicator" id="statusIndicator"></span>
      <button class="settings-btn" id="themeBtn" title="ä¸»é¢˜è®¾ç½®">ğŸ¨</button>
      <button class="settings-btn" id="userBtn" title="ç”¨æˆ·è®¾å®š">ğŸ‘¤</button>
      <button class="settings-btn" id="roleBtn" title="è§’è‰²è®¾å®š">ğŸ­</button>
    </div>
    

    
    <div class="settings-panel" id="rolePanel">
          <div class="setting-group">
            <label class="setting-label">èŠå¤©ç±»å‹: <span id="chatTypeDisplay">å•èŠ</span></label>
            <div id="groupChatControls" style="display: none;">
              <div class="setting-group">
                <label class="setting-label">æ¯æ¬¡æœ€å¤šå›å¤è§’è‰²æ•°:</label>
                <select class="setting-select" id="maxRolesPerReplySelect">
                  <option value="1">1ä¸ªè§’è‰²</option>
                  <option value="2">2ä¸ªè§’è‰²</option>
                  <option value="3" selected>3ä¸ªè§’è‰²</option>
                  <option value="4">4ä¸ªè§’è‰²</option>
                  <option value="5">5ä¸ªè§’è‰²</option>
                  <option value="999">æ‰€æœ‰è§’è‰²éƒ½å›å¤</option>
                </select>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">æ§åˆ¶æ¯æ¬¡ç”¨æˆ·å‘è¨€æ—¶æœ€å¤šæœ‰å‡ ä¸ªè§’è‰²å›å¤ã€‚é€‰æ‹©"æ‰€æœ‰è§’è‰²éƒ½å›å¤"å°†å¿½ç•¥è§’è‰²é¢‘ç‡è®¾ç½®ã€‚</div>
              </div>
              <button class="setting-btn save-btn" id="addRoleBtn">æ·»åŠ è§’è‰²</button>
              <div class="setting-label" style="margin-top: 15px;">ç¾¤èŠè§’è‰²åˆ—è¡¨:</div>
              <div id="rolesList"></div>
            </div>
          </div>
          
          <div id="singleRoleSettings">
      <div class="setting-group">
        <label class="setting-label">è§’è‰²é¢„è®¾:</label>
        <select class="setting-select" id="rolePresetSelect">
          <option value="">é€‰æ‹©é¢„è®¾è§’è‰²ï¼ˆå¯é€‰ï¼‰</option>
          <option value="louwuche">æ¥¼æ— æ¾ˆ</option>
          <option value="template">æ¨¡æ¿</option>
        </select>
        <div class="setting-buttons" style="margin-top: 10px;">
          <button class="setting-btn test-btn" id="saveRolePresetBtn">ä¿å­˜ä¸ºé¢„è®¾</button>
          <button class="setting-btn refresh-models-btn" id="manageRolePresetsBtn">ç®¡ç†é¢„è®¾</button>
        </div>
      </div>
      <div class="setting-group">
        <label class="setting-label">è§’è‰²å§“å:</label>
        <input type="text" class="setting-input" id="roleNameInput" placeholder="è¯·è¾“å…¥è§’è‰²å§“åï¼Œå¦‚ï¼šå°åŠ©æ‰‹ã€è€å¸ˆç­‰" />
      </div>
      <div class="setting-group">
        <label class="setting-label">è§’è‰²æè¿°:</label>
        <textarea class="setting-input" id="roleDescInput" rows="6" placeholder="è¯·è¯¦ç»†æè¿°è§’è‰²ç‰¹ç‚¹ã€æ€§æ ¼ã€è¯´è¯é£æ ¼ç­‰ï¼ŒAIå°†æ ¹æ®æ­¤æè¿°æ¥æ‰®æ¼”è§’è‰²..."></textarea>
            </div>
            <div class="setting-group">
              <label class="setting-label">AIå¤´åƒ:</label>
              <input type="url" class="setting-input" id="aiAvatarInput" placeholder="è¯·è¾“å…¥AIå¤´åƒå›¾ç‰‡é“¾æ¥ï¼ˆå¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤å¤´åƒï¼‰" />
              <div class="setting-buttons" style="margin-top: 10px;">
                <button class="setting-btn test-btn upload-btn" id="uploadAiAvatarBtn">ğŸ“· ä¸Šä¼ AIå¤´åƒ</button>
              </div>
              <input type="file" id="aiAvatarFileInput" accept="image/*" style="display: none;" />
            </div>
            <div class="setting-group">
              <label class="setting-label">è§†é¢‘é€šè¯ç”»é¢:</label>
              <input type="url" class="setting-input" id="aiVideoInput" placeholder="è¯·è¾“å…¥è§†é¢‘é€šè¯ç”»é¢é“¾æ¥ï¼ˆå¯é€‰ï¼‰" />
              <div class="setting-buttons" style="margin-top: 10px;">
                <button class="setting-btn test-btn upload-btn" id="uploadAiVideoBtn">ğŸ“¹ ä¸Šä¼ è§†é¢‘/å›¾ç‰‡</button>
                <button class="setting-btn test-btn" id="previewAiVideoBtn">ğŸ‘ï¸ é¢„è§ˆ</button>
              </div>
              <input type="file" id="aiVideoFileInput" accept="image/*,image/jpeg,image/png,image/gif,image/webp,video/*,video/mp4,video/webm,video/ogg,video/mov,video/avi" capture="environment" style="display: none;" />
              <div style="font-size: 12px; color: #666; margin-top: 5px;">æ”¯æŒå›¾ç‰‡å’Œè§†é¢‘æ–‡ä»¶ï¼Œç•™ç©ºåˆ™ä½¿ç”¨AIå¤´åƒ</div>
            </div>
      </div>
      


      
      <div class="setting-buttons">
        <button class="setting-btn save-btn" id="saveRoleBtn">ä¿å­˜è®¾å®š</button>
        <button class="setting-btn cancel-btn" id="cancelRoleBtn">å–æ¶ˆ</button>
        <button class="setting-btn cancel-btn" id="clearChatBtn">æ¸…ç©ºèŠå¤©</button>
        <button class="setting-btn test-btn" id="exportChatBtn">å¯¼å‡ºèŠå¤©è®°å½•</button>
        <button class="setting-btn refresh-models-btn" id="importChatBtn">å¯¼å…¥èŠå¤©è®°å½•</button>
      </div>
      <input type="file" id="importFileInput" accept=".json" style="display: none;" />
    </div>
    
    <!-- ç”¨æˆ·è®¾å®šé¢æ¿ -->
    <div class="settings-panel" id="userPanel">
      <div class="setting-group">
        <label class="setting-label">ç”¨æˆ·é¢„è®¾:</label>
        <select class="setting-select" id="userPresetSelect">
          <option value="">é€‰æ‹©ç”¨æˆ·é¢„è®¾ï¼ˆå¯é€‰ï¼‰</option>
        </select>
        <div class="setting-buttons" style="margin-top: 10px;">
          <button class="setting-btn test-btn" id="saveUserPresetBtn">ä¿å­˜ä¸ºé¢„è®¾</button>
          <button class="setting-btn refresh-models-btn" id="manageUserPresetsBtn">ç®¡ç†é¢„è®¾</button>
        </div>
      </div>
      <div class="setting-group">
        <label class="setting-label">ç”¨æˆ·å§“å:</label>
        <input type="text" class="setting-input" id="userNameInput" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“åæˆ–æ˜µç§°..." />
      </div>
      <div class="setting-group">
        <label class="setting-label">ç”¨æˆ·æè¿°:</label>
        <textarea class="setting-input" id="userDescInput" rows="4" placeholder="è¯·æè¿°æ‚¨çš„æ€§æ ¼ã€å–œå¥½ã€èƒŒæ™¯ç­‰ï¼ŒAIå°†æ ¹æ®æ­¤ä¿¡æ¯ä¸æ‚¨äº’åŠ¨..."></textarea>
      </div>
      <div class="setting-group">
        <label class="setting-label">ç”¨æˆ·å¤´åƒ:</label>
        <input type="url" class="setting-input" id="userAvatarInput" placeholder="è¯·è¾“å…¥å¤´åƒå›¾ç‰‡é“¾æ¥ï¼ˆå¯é€‰ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤å¤´åƒï¼‰" />
        <div class="setting-buttons" style="margin-top: 10px;">
          <button class="setting-btn test-btn upload-btn" id="uploadUserAvatarBtn">ğŸ“· ä¸Šä¼ ç”¨æˆ·å¤´åƒ</button>
        </div>
        <input type="file" id="userAvatarFileInput" accept="image/*" style="display: none;" />
      </div>
      
      <div class="setting-buttons">
        <button class="setting-btn save-btn" id="saveUserBtn">ä¿å­˜è®¾å®š</button>
        <button class="setting-btn cancel-btn" id="cancelUserBtn">å–æ¶ˆ</button>
      </div>
    </div>
        
        <!-- ç¾¤èŠè§’è‰²ç¼–è¾‘å¼¹çª— -->
        <div class="modal-overlay" id="roleEditModal" style="display: none;">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="roleEditTitle">æ·»åŠ è§’è‰²</h3>
              <button class="modal-close" id="closeRoleEditModal">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="setting-group">
                <label class="setting-label">è§’è‰²é¢„è®¾:</label>
                <select class="setting-select" id="modalRolePresetSelect">
                  <option value="">é€‰æ‹©é¢„è®¾è§’è‰²ï¼ˆå¯é€‰ï¼‰</option>
                  <option value="louwuche">æ¥¼æ— æ¾ˆ</option>
                  <option value="template">æ¨¡æ¿</option>
                </select>
                <div class="setting-buttons" style="margin-top: 10px;">
                  <button class="setting-btn test-btn" id="saveModalRolePresetBtn">ä¿å­˜ä¸ºé¢„è®¾</button>
                  <button class="setting-btn refresh-models-btn" id="manageModalRolePresetsBtn">ç®¡ç†é¢„è®¾</button>
                </div>
              </div>
              <div class="setting-group">
                <label class="setting-label">è§’è‰²å§“å:</label>
                <input type="text" class="setting-input" id="modalRoleNameInput" placeholder="è¯·è¾“å…¥è§’è‰²å§“å" />
              </div>
              <div class="setting-group">
                <label class="setting-label">è§’è‰²æè¿°:</label>
                <textarea class="setting-input" id="modalRoleDescInput" rows="6" placeholder="è¯·è¯¦ç»†æè¿°è§’è‰²ç‰¹ç‚¹ã€æ€§æ ¼ã€è¯´è¯é£æ ¼ç­‰..."></textarea>
              </div>
              <div class="setting-group">
                <label class="setting-label">è§’è‰²å¤´åƒ:</label>
                <input type="url" class="setting-input" id="modalRoleAvatarInput" placeholder="è¯·è¾“å…¥å¤´åƒå›¾ç‰‡é“¾æ¥ï¼ˆå¯é€‰ï¼‰" />
                <div class="setting-buttons" style="margin-top: 10px;">
                  <button class="setting-btn test-btn upload-btn" id="uploadModalRoleAvatarBtn">ğŸ“· ä¸Šä¼ è§’è‰²å¤´åƒ</button>
                </div>
                <input type="file" id="modalRoleAvatarFileInput" accept="image/*" style="display: none;" />
              </div>
              <div class="setting-group">
                <label class="setting-label">è§†é¢‘é€šè¯ç”»é¢:</label>
                <input type="url" class="setting-input" id="modalRoleVideoInput" placeholder="è¯·è¾“å…¥è§†é¢‘é€šè¯ç”»é¢é“¾æ¥ï¼ˆå¯é€‰ï¼‰" />
                <div class="setting-buttons" style="margin-top: 10px;">
                  <button class="setting-btn test-btn upload-btn" id="uploadModalRoleVideoBtn">ğŸ“¹ ä¸Šä¼ è§†é¢‘/å›¾ç‰‡</button>
                  <button class="setting-btn test-btn" id="previewModalRoleVideoBtn">ğŸ‘ï¸ é¢„è§ˆ</button>
                </div>
                <input type="file" id="modalRoleVideoFileInput" accept="image/*,image/jpeg,image/png,image/gif,image/webp,video/*,video/mp4,video/webm,video/ogg,video/mov,video/avi" capture="environment" style="display: none;" />
                <div style="font-size: 12px; color: #666; margin-top: 5px;">æ”¯æŒå›¾ç‰‡å’Œè§†é¢‘æ–‡ä»¶ï¼Œç•™ç©ºåˆ™ä½¿ç”¨è§’è‰²å¤´åƒ</div>
              </div>
              <div class="setting-group">
                <label class="setting-label">å›å¤é¢‘ç‡:</label>
                <select class="setting-select" id="modalRoleFrequencySelect">
                  <option value="always">æ¯æ¬¡éƒ½å›å¤</option>
                  <option value="often">ç»å¸¸å›å¤</option>
                  <option value="sometimes">å¶å°”å›å¤</option>
                  <option value="rarely">å¾ˆå°‘å›å¤</option>
                </select>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">æ§åˆ¶è¯¥è§’è‰²åœ¨ç¾¤èŠä¸­çš„æ´»è·ƒåº¦</div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="setting-btn save-btn" id="saveRoleEditBtn">ä¿å­˜è§’è‰²</button>
              <button class="setting-btn cancel-btn" id="cancelRoleEditBtn">å–æ¶ˆ</button>
            </div>
          </div>
    </div>
    
    <!-- é¢„è®¾ç®¡ç†å¼¹çª— -->
    <div class="modal-overlay" id="presetManageModal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="presetManageTitle">ç®¡ç†é¢„è®¾</h3>
          <button class="modal-close" id="closePresetManageModal">Ã—</button>
        </div>
        <div class="modal-body">
      <div class="setting-group">
            <label class="setting-label">ç°æœ‰é¢„è®¾:</label>
            <div id="presetList" style="max-height: 300px; overflow-y: auto;">
              <!-- é¢„è®¾åˆ—è¡¨ä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
      </div>
      </div>
        </div>
        <div class="modal-footer">
          <button class="setting-btn cancel-btn" id="closePresetManageBtn">å…³é—­</button>
        </div>
      </div>
      </div>
      
    <!-- ä¿å­˜é¢„è®¾å¼¹çª— -->
    <div class="modal-overlay" id="savePresetModal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="savePresetTitle">ä¿å­˜é¢„è®¾</h3>
          <button class="modal-close" id="closeSavePresetModal">Ã—</button>
        </div>
        <div class="modal-body">
      <div class="setting-group">
            <label class="setting-label">é¢„è®¾åç§°:</label>
            <input type="text" class="setting-input" id="presetNameInput" placeholder="è¯·è¾“å…¥é¢„è®¾åç§°" />
      </div>
          <div class="setting-group">
            <label class="setting-label">é¢„è®¾æè¿°:</label>
            <input type="text" class="setting-input" id="presetDescInput" placeholder="è¯·è¾“å…¥é¢„è®¾æè¿°ï¼ˆå¯é€‰ï¼‰" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="setting-btn save-btn" id="confirmSavePresetBtn">ä¿å­˜</button>
          <button class="setting-btn cancel-btn" id="cancelSavePresetBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    
    <!-- ä¸»é¢˜è®¾ç½®å¼¹çª— -->
    <div class="modal-overlay" id="themeSettingsModal" style="display: none;">
      <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-header">
          <h3>ğŸ¨ ä¸»é¢˜è®¾ç½®</h3>
          <button class="modal-close" id="closeThemeSettingsModal">Ã—</button>
        </div>
        <div class="modal-body">
          <!-- é¢„è®¾ä¸»é¢˜ -->
          <div class="setting-group">
            <label class="setting-label">ğŸŒˆ é¢„è®¾ä¸»é¢˜:</label>
            <div class="theme-presets" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;">
                          <button class="theme-preset-btn" data-theme="default">é»˜è®¤ä¸»é¢˜</button>
            <button class="theme-preset-btn" data-theme="dark">æš—é»‘ä¸»é¢˜</button>
            <button class="theme-preset-btn" data-theme="blue">è“è‰²ä¸»é¢˜</button>
            <button class="theme-preset-btn" data-theme="green">ç»¿è‰²ä¸»é¢˜</button>
            <button class="theme-preset-btn" data-theme="purple">ç´«è‰²ä¸»é¢˜</button>
            <button class="theme-preset-btn" data-theme="pink">ç²‰è‰²ä¸»é¢˜</button>
            </div>
          </div>
          
          <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">
          
          <!-- é¢œè‰²è®¾ç½® -->
          <div class="setting-group">
            <label class="setting-label">ğŸ¨ é¢œè‰²è®¾ç½®:</label>
            
            <div class="color-setting-item">
              <label class="color-label">å¯¼èˆªæ é¢œè‰²:</label>
              <input type="color" class="color-input" id="headerColorInput" value="#6DA3BD">
              <input type="text" class="color-text" id="headerColorText" value="#6DA3BD">
            </div>
            
            <div class="color-setting-item">
              <label class="color-label">èŠå¤©èƒŒæ™¯:</label>
              <input type="color" class="color-input" id="chatBgColorInput" value="#f5f5f5">
              <input type="text" class="color-text" id="chatBgColorText" value="#f5f5f5">
            </div>
            
            <div class="color-setting-item">
              <label class="color-label">ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡:</label>
              <input type="color" class="color-input" id="userBubbleColorInput" value="#95EC69">
              <input type="text" class="color-text" id="userBubbleColorText" value="#95EC69">
            </div>
            
            <div class="color-setting-item">
              <label class="color-label">AIæ¶ˆæ¯æ°”æ³¡:</label>
              <input type="color" class="color-input" id="aiBubbleColorInput" value="#FFFFFF">
              <input type="text" class="color-text" id="aiBubbleColorText" value="#FFFFFF">
            </div>
          </div>
          
          <!-- èŠå¤©èƒŒæ™¯å›¾ç‰‡ -->
          <div class="setting-group">
            <label class="setting-label">ğŸ–¼ï¸ èŠå¤©èƒŒæ™¯å›¾ç‰‡:</label>
            <input type="url" class="setting-input" id="chatBgImageInput" placeholder="è¯·è¾“å…¥èƒŒæ™¯å›¾ç‰‡é“¾æ¥ï¼ˆå¯é€‰ï¼‰">
            <div class="setting-buttons" style="margin-top: 10px;">
              <button class="setting-btn test-btn" id="uploadChatBgBtn">ğŸ“· ä¸Šä¼ èƒŒæ™¯</button>
              <button class="setting-btn cancel-btn" id="removeChatBgBtn">ç§»é™¤èƒŒæ™¯</button>
            </div>
            <input type="file" id="chatBgFileInput" accept="image/*" style="display: none;">
          </div>
          
          <!-- å­—ä½“è®¾ç½® -->
          <div class="setting-group">
            <label class="setting-label">ğŸ“ å­—ä½“è®¾ç½®:</label>
            
            <div class="font-setting-item">
              <label class="font-label">å­—ä½“æ—:</label>
              <select class="setting-select" id="fontFamilySelect">
                <option value="å¾®è½¯é›…é»‘, Arial, sans-serif">å¾®è½¯é›…é»‘</option>
                <option value="&quot;å¯’è‰å›¢åœ†ä½“ Round&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif">å¯’è‰å›¢åœ†ä½“</option>
                <option value="&quot;DymonShouXieTi&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif">å‘†èŒæ‰‹å†™ä½“</option>
                <option value="&quot;Fusion Pixel 12px Monospaced zh_hans&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif">ç¼åˆåƒç´ å­—ä½“</option>
                <option value="&quot;ZSFT-dr&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif">Permanent Marker</option>
                <option value="&quot;å¹³æ–¹æ˜Ÿè¾°ä½“&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif">å¹³æ–¹æ˜Ÿè¾°ä½“</option>
                <option value="&quot;huangkaihuaLawyerfont&quot;, å¾®è½¯é›…é»‘, Arial, sans-serif">é»„å‡¯æ¡¦å¾‹å¸ˆæ‰‹å†™ä½“</option>
                <option value="å®‹ä½“, serif">å®‹ä½“</option>
                <option value="é»‘ä½“, sans-serif">é»‘ä½“</option>
                <option value="æ¥·ä½“, cursive">æ¥·ä½“</option>
                <option value="Arial, sans-serif">Arial</option>
                <option value="Times New Roman, serif">Times New Roman</option>
                <option value="Courier New, monospace">Courier New</option>
                <option value="Georgia, serif">Georgia</option>
              </select>
            </div>
            
            <div class="font-setting-item">
              <label class="font-label">å¯¼å…¥å­—ä½“:</label>
              <input type="file" class="setting-input" id="fontFileInput" accept=".ttf,.otf,.woff,.woff2" style="display: none;">
              <button class="setting-btn test-btn" id="importFontBtn">ğŸ“ å¯¼å…¥å­—ä½“æ–‡ä»¶</button>
              <button class="setting-btn cancel-btn" id="clearCustomFontsBtn">æ¸…é™¤è‡ªå®šä¹‰å­—ä½“</button>
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 5px; margin-left: 120px;">
              æ”¯æŒæ ¼å¼: .ttf, .otf, .woff, .woff2 | æœ€å¤§æ–‡ä»¶å¤§å°: 50MB
            </div>
            
            <div class="color-setting-item">
              <label class="color-label">å­—ä½“é¢œè‰²:</label>
              <input type="color" class="color-input" id="fontColorInput" value="#333333">
              <input type="text" class="color-text" id="fontColorText" value="#333333">
            </div>
          </div>
          
          <!-- å¯¼èˆªæ æ ·å¼è®¾ç½® -->
          <div class="setting-group">
            <label class="setting-label">ğŸ§­ å¯¼èˆªæ æ ·å¼:</label>
            
            <div class="style-setting-item">
              <label class="style-label">å¯¼èˆªæ åœ†è§’:</label>
              <input type="range" class="style-slider" id="headerBorderRadiusSlider" min="0" max="20" value="10">
              <span class="style-value" id="headerBorderRadiusValue">10px</span>
            </div>
            
            <div class="style-setting-item">
              <label class="style-label">å¯¼èˆªæ é€æ˜åº¦:</label>
              <input type="range" class="style-slider" id="headerOpacitySlider" min="0.5" max="1" step="0.1" value="1">
              <span class="style-value" id="headerOpacityValue">100%</span>
            </div>
            
            <div class="style-setting-item">
              <label class="style-label">å¯¼èˆªæ é˜´å½±:</label>
              <select class="setting-select" id="headerShadowSelect">
                <option value="none">æ— é˜´å½±</option>
                <option value="light">è½»å¾®é˜´å½±</option>
                <option value="normal" selected>æ™®é€šé˜´å½±</option>
                <option value="heavy">é‡é˜´å½±</option>
              </select>
            </div>
          </div>
          
          <!-- æ°”æ³¡æ ·å¼è®¾ç½® -->
          <div class="setting-group">
            <label class="setting-label">ğŸ’¬ æ°”æ³¡æ ·å¼:</label>
            
            <div class="style-setting-item">
              <label class="style-label">æ°”æ³¡åœ†è§’:</label>
              <input type="range" class="style-slider" id="bubbleBorderRadiusSlider" min="8" max="25" value="18">
              <span class="style-value" id="bubbleBorderRadiusValue">18px</span>
            </div>
            
            <div class="style-setting-item">
              <label class="style-label">æ°”æ³¡é€æ˜åº¦:</label>
              <input type="range" class="style-slider" id="bubbleOpacitySlider" min="0.7" max="1" step="0.1" value="0.95">
              <span class="style-value" id="bubbleOpacityValue">95%</span>
            </div>
            
            <div class="style-setting-item">
              <label class="style-label">æ°”æ³¡é˜´å½±:</label>
              <select class="setting-select" id="bubbleShadowSelect">
                <option value="none">æ— é˜´å½±</option>
                <option value="light" selected>è½»å¾®é˜´å½±</option>
                <option value="normal">æ™®é€šé˜´å½±</option>
                <option value="heavy">é‡é˜´å½±</option>
              </select>
            </div>
            
            <div class="style-setting-item">
              <label class="style-label">æ°”æ³¡è¾¹æ¡†:</label>
              <select class="setting-select" id="bubbleBorderSelect">
                <option value="none" selected>æ— è¾¹æ¡†</option>
                <option value="thin">ç»†è¾¹æ¡†</option>
                <option value="normal">æ™®é€šè¾¹æ¡†</option>
                <option value="thick">ç²—è¾¹æ¡†</option>
              </select>
            </div>
          </div>
          
          <!-- é¢„è§ˆåŒºåŸŸ -->
          <div class="setting-group">
            <label class="setting-label">ğŸ‘€ æ•ˆæœé¢„è§ˆ:</label>
            <div class="theme-preview" id="themePreview">
              <div class="preview-header">
                <span>èŠå¤©é¢„è§ˆ</span>
              </div>
              <div class="preview-chat">
                <div class="preview-msg user">
                  <div class="preview-bubble user">è¿™æ˜¯ç”¨æˆ·æ¶ˆæ¯é¢„è§ˆ</div>
                </div>
                <div class="preview-msg ai">
                  <div class="preview-bubble ai">è¿™æ˜¯AIæ¶ˆæ¯é¢„è§ˆ</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="setting-btn save-btn" id="applyThemeBtn">åº”ç”¨ä¸»é¢˜</button>
          <button class="setting-btn test-btn" id="previewThemeBtn">å®æ—¶é¢„è§ˆ</button>
          <button class="setting-btn refresh-models-btn" id="resetThemeBtn">é‡ç½®é»˜è®¤</button>
          <button class="setting-btn cancel-btn" id="cancelThemeBtn">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
    

    
    <div class="chat-body" id="chatBody"></div>
    <!-- ç”¨æˆ·è¡¨æƒ…åŒ…é¢æ¿ -->
    <div class="user-emoji-panel" id="userEmojiPanel">
      <div class="user-emoji-header">
        <span class="user-emoji-title">é€‰æ‹©è¡¨æƒ…åŒ…</span>
        <button class="user-emoji-close" id="userEmojiClose">Ã—</button>
      </div>
      <div class="user-emoji-grid" id="userEmojiGrid">
        <!-- è¡¨æƒ…åŒ…å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
      </div>
    </div>
    
    <div class="chat-footer">
      <div class="chat-input-row">
        <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off" />
        <button class="send-btn" id="sendBtn">å‘é€</button>
      </div>
      <div class="chat-buttons-row">
        <div class="chat-button-item">
          <button class="emoji-btn" id="userEmojiBtn" title="å‘é€è¡¨æƒ…åŒ…">ğŸ˜Š</button>
          <span class="chat-button-label">è¡¨æƒ…</span>
        </div>
        <div class="chat-button-item">
          <button class="image-btn" id="imageBtn" title="å‘é€å›¾ç‰‡">ğŸ–¼ï¸</button>
          <span class="chat-button-label">å›¾ç‰‡</span>
        </div>
        <div class="chat-button-item">
          <button class="location-btn" id="locationBtn" title="å‘é€ä½ç½®">ğŸ“</button>
          <span class="chat-button-label">ä½ç½®</span>
        </div>
        <div class="chat-button-item">
          <button class="transfer-btn" id="transferBtn" title="è½¬è´¦">ğŸ’°</button>
          <span class="chat-button-label">è½¬è´¦</span>
        </div>
        <div class="chat-button-item">
          <button class="video-call-btn" id="videoCallBtn" title="è§†é¢‘é€šè¯">ğŸ“¹</button>
          <span class="chat-button-label">è§†é¢‘</span>
        </div>
      </div>
      
      <!-- éšè—çš„å›¾ç‰‡ä¸Šä¼ è¾“å…¥æ¡† -->
      <input type="file" id="imageFileInput" accept="image/*" style="display: none;" />
    </div>
  </div>
    </div>
  </div>

  <!-- å¤šé€‰å·¥å…·æ  -->
  <div class="multi-select-toolbar" id="multiSelectToolbar">
    <div class="multi-select-info" id="multiSelectInfo">å·²é€‰æ‹© 0 æ¡æ¶ˆæ¯</div>
    <div class="multi-select-actions">
      <button class="multi-select-btn forward" id="multiForwardBtn">è½¬å‘</button>
      <button class="multi-select-btn delete" id="multiDeleteBtn">åˆ é™¤</button>
      <button class="multi-select-btn cancel" id="multiCancelBtn">å–æ¶ˆ</button>
    </div>
  </div>

  <!-- èŠå¤©è®°å½•æŸ¥çœ‹æ¨¡æ€æ¡† -->
  <div class="chat-record-modal" id="chatRecordModal">
    <div class="chat-record-modal-content">
      <div class="chat-record-modal-header">
        <div class="chat-record-modal-title">èŠå¤©è®°å½•</div>
        <button class="chat-record-modal-close" id="chatRecordClose">Ã—</button>
      </div>
      <div class="chat-record-modal-body" id="chatRecordModalBody">
        <!-- èŠå¤©è®°å½•è¯¦æƒ…å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <!-- ä½ç½®é€‰æ‹©å¼¹çª— -->
  <div class="location-modal" id="locationModal">
    <div class="location-modal-content">
      <div class="location-modal-header">
        <div class="location-modal-title">å‘é€ä½ç½®</div>
        <button class="location-modal-close" id="locationModalClose">Ã—</button>
      </div>
      <div class="location-modal-body">
        <!-- ä½ç½®é¢„è§ˆ -->
        <div class="location-preview">
          <img class="location-preview-image" id="locationPreviewImage" src="https://i.postimg.cc/8ckw0FYH/Camera-1040g0k03186v4spmjk005pmubdtiubpdu8mmhbg.jpg" alt="ä½ç½®å›¾ç‰‡">
          <div class="location-preview-info">
            <div class="location-name" id="locationPreviewName">æˆ‘çš„ä½ç½®</div>
            <div class="location-address" id="locationPreviewAddress">è¯·ç¼–è¾‘ä½ç½®ä¿¡æ¯</div>
          </div>
        </div>
        
        <!-- ä½ç½®ç¼–è¾‘è¡¨å• -->
        <div class="location-form-group">
          <label class="location-form-label">ä½ç½®åç§°</label>
          <input type="text" class="location-form-input" id="locationNameInput" placeholder="ä¾‹å¦‚ï¼šå’–å•¡å…ã€å…¬å¸ã€å®¶" value="æˆ‘çš„ä½ç½®">
        </div>
        
        <div class="location-form-group">
          <label class="location-form-label">è¯¦ç»†åœ°å€</label>
          <textarea class="location-form-input location-form-textarea" id="locationAddressInput" placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€ä¿¡æ¯">è¯·ç¼–è¾‘ä½ç½®ä¿¡æ¯</textarea>
        </div>
        
        <div class="location-form-group">
          <label class="location-form-label">ä½ç½®å›¾ç‰‡</label>
          <div class="location-image-upload" id="locationImageUpload">
            <div class="location-upload-icon">ğŸ“·</div>
            <div class="location-upload-text">ç‚¹å‡»æ›´æ¢ä½ç½®å›¾ç‰‡</div>
          </div>
          <input type="file" id="locationImageInput" accept="image/*" style="display: none;">
        </div>
      </div>
      <div class="location-modal-footer">
        <button class="location-btn-cancel" id="locationCancelBtn">å–æ¶ˆ</button>
        <button class="location-btn-send" id="locationSendBtn">å‘é€</button>
      </div>
    </div>
  </div>

  <!-- è½¬è´¦å¼¹çª— -->
  <div class="transfer-modal" id="transferModal">
    <div class="transfer-modal-content">
      <div class="transfer-modal-header">
        <div class="transfer-modal-title">è½¬è´¦</div>
        <button class="transfer-modal-close" id="transferModalClose">Ã—</button>
      </div>
      <div class="transfer-modal-body">
        <!-- è½¬è´¦é¢„è§ˆ -->
        <div class="transfer-preview">
          <div class="transfer-preview-container">
            <div class="transfer-preview-title">
              <span class="transfer-icon">ğŸ’°</span>
              <span>è½¬è´¦</span>
            </div>
            <div class="transfer-preview-amount" id="transferPreviewAmount">Â¥0.00</div>
            <div class="transfer-preview-note" id="transferPreviewNote">è¯·è¾“å…¥è½¬è´¦ä¿¡æ¯</div>
          </div>
        </div>
        
        <!-- è½¬è´¦è¡¨å• -->
        <div class="transfer-form-group">
          <label class="transfer-form-label">è½¬è´¦é‡‘é¢</label>
          <input type="number" class="transfer-form-input transfer-amount-input" id="transferAmountInput" placeholder="0.00" min="0.01" max="99999" step="0.01">
        </div>
        
        <div class="transfer-form-group">
          <label class="transfer-form-label">è½¬è´¦è¯´æ˜</label>
          <textarea class="transfer-form-input transfer-form-textarea" id="transferNoteInput" placeholder="è¯·è¾“å…¥è½¬è´¦è¯´æ˜ï¼ˆå¯é€‰ï¼‰"></textarea>
        </div>
        
        <div class="transfer-form-group">
          <label class="transfer-form-label">æ”¶æ¬¾äºº</label>
          <input type="text" class="transfer-form-input" id="transferReceiverInput" placeholder="è¯·è¾“å…¥æ”¶æ¬¾äººå§“å" readonly>
        </div>
      </div>
      <div class="transfer-modal-footer">
        <button class="transfer-btn-cancel" id="transferCancelBtn">å–æ¶ˆ</button>
        <button class="transfer-btn-send" id="transferSendBtn">ç¡®è®¤è½¬è´¦</button>
      </div>
    </div>
  </div>

  <!-- è§†é¢‘é€šè¯ç”³è¯·å¼¹çª— -->
  <div class="video-call-request-modal" id="videoCallRequestModal">
    <div class="video-call-request-content">
      <div class="video-call-request-avatar">
        <img id="videoCallRequestAvatar" src="" alt="å¤´åƒ">
      </div>
      <div class="video-call-request-info">
        <div class="video-call-request-name" id="videoCallRequestName">è§’è‰²å</div>
        <div class="video-call-request-text">å‘ä½ å‘é€é€šè¯ç”³è¯·</div>
      </div>
      <div class="video-call-request-actions">
        <button class="video-call-decline-btn" id="videoCallDeclineBtn">æ‹’ç»</button>
        <button class="video-call-accept-btn" id="videoCallAcceptBtn">æ¥å¬</button>
      </div>
    </div>
  </div>

  <!-- æ‹ä¸€æ‹æé†’å¼¹çª— -->
  <div class="pat-reminder-modal" id="patReminderModal">
    <div class="pat-reminder-content">
      <div class="pat-reminder-avatar">
        <img id="patReminderAvatar" src="" alt="è§’è‰²å¤´åƒ">
      </div>
      <div class="pat-reminder-text" id="patReminderText">
        è§’è‰²æ‹äº†æ‹ä½ 
      </div>
      <button class="pat-reminder-close" id="patReminderClose">çŸ¥é“äº†</button>
    </div>
  </div>

  <!-- è§†é¢‘é€šè¯ç•Œé¢ -->
  <div class="video-call-modal" id="videoCallModal">
    <div class="video-call-content">
      <!-- è§†é¢‘ç”»é¢åŒºåŸŸ -->
      <div class="video-call-screen">
        <div class="video-call-main-video">
          <img id="videoCallMainImage" src="" alt="è§†é¢‘ç”»é¢" style="display: none;">
          <video id="videoCallMainVideo" style="display: none;" autoplay loop muted playsinline webkit-playsinline>
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
          </video>
          <div class="video-call-user-info">
            <div class="video-call-user-name" id="videoCallUserName">è§’è‰²å</div>
            <div class="video-call-duration" id="videoCallDuration">00:00</div>
          </div>
        </div>
        
        <!-- ç”¨æˆ·å°çª—å£ -->
        <div class="video-call-user-video">
          <img src="" alt="ç”¨æˆ·å¤´åƒ" id="videoCallUserAvatar">
        </div>
      </div>
      
      <!-- AIæ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
      <div class="video-call-messages" id="videoCallMessages">
        <!-- AIæ¶ˆæ¯ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º -->
      </div>
      
      <!-- è¾“å…¥å’Œæ§åˆ¶åŒºåŸŸ -->
      <div class="video-call-controls">
        <div class="video-call-input-row">
          <input type="text" class="video-call-input" id="videoCallInput" placeholder="è¾“å…¥æ¶ˆæ¯..." autocomplete="off">
          <button class="video-call-send-btn" id="videoCallSendBtn">å‘é€</button>
        </div>
        <div class="video-call-action-row">
          <button class="video-call-mute-btn" id="videoCallMuteBtn" title="é™éŸ³">ğŸ”‡</button>
          <button class="video-call-camera-btn" id="videoCallCameraBtn" title="å…³é—­æ‘„åƒå¤´">ğŸ“·</button>
          <button class="video-call-hangup-btn" id="videoCallHangupBtn" title="æŒ‚æ–­">ğŸ“</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let apiURL = '';
    let apiKey = '';
    let selectedModel = '';
    let availableModels = [];
    
    // APIé…ç½®å­˜å‚¨
    let savedApiConfigs = {}; // å­˜å‚¨å¤šä¸ªAPIé…ç½®
    let currentApiConfigId = null; // å½“å‰ä½¿ç”¨çš„é…ç½®ID
    
    // è¯†å›¾APIé…ç½®
    let visionApiURL = '';
    let visionApiKey = '';
    let selectedVisionModel = '';
    let availableVisionModels = [];
    let roleName = '';
    let roleDescription = '';
    let userName = '';
    let userDescription = '';
    let userAvatar = '';
    let aiAvatar = '';
    
    // AIå›å¤è®¾ç½®
    let aiContextLength = 10; // é»˜è®¤ä¸Šä¸‹æ–‡é•¿åº¦ä¸º10ä¸ªæ°”æ³¡
    let aiResponseDelay = 0; // å“åº”é—´éš”ï¼ˆç§’ï¼‰ï¼Œ0è¡¨ç¤ºç«‹å³å›å¤
    let aiCustomPrompt = ''; // é¢„è®¾æç¤ºè¯
    
    // å“åº”å»¶è¿Ÿç›¸å…³å˜é‡
    let pendingMessages = []; // å¾…å¤„ç†çš„ç”¨æˆ·æ¶ˆæ¯
    let responseTimer = null; // å“åº”å®šæ—¶å™¨
    let isWaitingForResponse = false; // æ˜¯å¦æ­£åœ¨ç­‰å¾…å“åº”
    
    // æ¶ˆæ¯æ“ä½œç›¸å…³å˜é‡
    let currentSelectedMessage = null; // å½“å‰é€‰ä¸­çš„æ¶ˆæ¯
    let replyToMessage = null; // æ­£åœ¨å›å¤çš„æ¶ˆæ¯
    let selectedForwardChats = []; // é€‰ä¸­çš„è½¬å‘ç›®æ ‡èŠå¤©
    let forwardMessage = null; // è¦è½¬å‘çš„æ¶ˆæ¯
    let forwardMessages = []; // è¦è½¬å‘çš„å¤šæ¡æ¶ˆæ¯
    let isMultiSelectMode = false; // æ˜¯å¦å¤„äºå¤šé€‰æ¨¡å¼
    let selectedMessages = []; // é€‰ä¸­çš„æ¶ˆæ¯åˆ—è¡¨
    
    // åˆå§‹åŒ–èŠå¤©è®°å½•æ•°æ®å­˜å‚¨
    if (!window.chatRecordsData) {
      window.chatRecordsData = {};
    }
    
    // èŠå¤©åˆ—è¡¨ç®¡ç†
    let chatList = [];
    let currentChatId = null;
    let currentEditingRoleIndex = -1; // å½“å‰ç¼–è¾‘çš„è§’è‰²ç´¢å¼•
    
    // é»˜è®¤å¤´åƒ
    const DEFAULT_AI_AVATAR = 'https://i.postimg.cc/YSBx6wnx/IMG-20250617-215551.jpg';
    const DEFAULT_USER_AVATAR = 'https://i.postimg.cc/xTqgY5NL/IMG-20250617-215606.jpg';
    
    // é»˜è®¤è¡¨æƒ…åŒ…æ•°æ®
    const DEFAULT_EMOJIS = {
      happy: [
        'https://i.postimg.cc/8ckw0FYH/Camera-1040g0k03186v4spmjk005pmubdtiubpdu8mmhbg.jpg',
        'https://i.postimg.cc/YqzMFTNB/Camera-1040g0k03186v4tat0q005pmubdtiubpdgjjc208.jpg',
        'https://i.postimg.cc/Vv4Zf9tp/Camera-1040g34o3186v4bahgo0g5pmubdtiubpdm2m3520.jpg'
      ],
      sad: [
        'https://i.postimg.cc/PfbBVYCm/Camera-1040g34o3186v4sr1jk0g5pmubdtiubpdn64nug0.jpg',
        'https://i.postimg.cc/MpswPRrs/Camera-1040g34o3186v4t0lgq0g5pmubdtiubpdqcoib90.jpg',
        'https://i.postimg.cc/mgnq1SnG/Camera-1040g34o3186v4so6go0g5pmubdtiubpdolbqdmo.jpg'
      ],
      angry: [
        'https://i.postimg.cc/43mgrdDX/Camera-1040g0k03186v505k0q005pmubdtiubpd0ll7q90.jpg',
        'https://i.postimg.cc/FsWCwZNJ/Camera-1040g0k03186v4bdegs005pmubdtiubpdfipdsng.jpg'
      ],
      confused: [
        'https://i.postimg.cc/Dy630LF2/Camera-1040g0k03186v4t4c0q005pmubdtiubpd4gdlof0.jpg',
        'https://i.postimg.cc/2jxK7YtG/Camera-1040g34o3186v4b8s0q0g5pmubdtiubpdk9on5ag.jpg',
        'https://i.postimg.cc/3JJbL65T/Camera-1040g34o3186v4bfhjk0g5pmubdtiubpds0k9plg.jpg'
      ],
      love: [
        'https://i.postimg.cc/BZDqSjX6/Camera-XHS-17473999641601040g008310c813u16m6g5pajh6v20dkvfs3f5pg.jpg',
        'https://i.postimg.cc/mrMdzWMQ/Camera-1040g0k03186v4bbs0o705pmubdtiubpdhd5614g.jpg'
      ]
    };
    
    // è¡¨æƒ…åŒ…æ•°æ®
    let emojiData = {};
    
    // ä½ç½®æ•°æ®
    let currentLocationData = {
      name: 'æˆ‘çš„ä½ç½®',
      address: 'è¯·ç¼–è¾‘ä½ç½®ä¿¡æ¯',
      image: 'https://i.postimg.cc/8ckw0FYH/Camera-1040g0k03186v4spmjk005pmubdtiubpdu8mmhbg.jpg'
    };
    
    // è½¬è´¦æ•°æ®
    let currentTransferData = {
      amount: 0,
      note: '',
      receiver: ''
    };

    // è§†é¢‘é€šè¯ç›¸å…³å˜é‡
    let isVideoCallActive = false;
    let videoCallTimer = null;
    let videoCallStartTime = null;
    let currentVideoCallRole = null;
    
    // æ‹ä¸€æ‹æé†’ç›¸å…³å˜é‡
    let inactivityTimer = null;
    let lastActivityTime = Date.now();
    let patReminderShown = false;
    const INACTIVITY_TIMEOUT = 60000; // 1åˆ†é’Ÿ = 60000æ¯«ç§’
    
    // é¢„è®¾æ•°æ®
    let customRolePresets = {};
    let customUserPresets = {};
    let currentPresetType = 'role'; // 'role' æˆ– 'user'
    let currentPresetContext = 'main'; // 'main' æˆ– 'modal'
    
    // æœ‹å‹åœˆæ•°æ®
    let moments = [];
    let currentVisibleRoles = []; // å½“å‰å‘å¸ƒæ—¶é€‰æ‹©çš„å¯è§è§’è‰²
    let selectedImages = []; // å½“å‰é€‰æ‹©çš„å›¾ç‰‡
    let currentReplyTo = null; // å½“å‰å›å¤çš„è¯„è®º
    let mentionSuggestions = []; // @æåŠå»ºè®®åˆ—è¡¨
    let selectedMentionIndex = -1; // å½“å‰é€‰ä¸­çš„@å»ºè®®ç´¢å¼•
    
    // æœ‹å‹åœˆè®¾ç½®æ•°æ®
    let momentsSettings = {
      title: 'æˆ‘çš„æœ‹å‹åœˆ',
      coverImage: '', // ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä½¿ç”¨é»˜è®¤èƒŒæ™¯
      commentMode: 'smart' // AIè§’è‰²è¯„è®ºæ¨¡å¼ï¼šsmart/all/random/none
    };

    // DOMå…ƒç´ 
    const chatListView = document.getElementById('chatListView');
    const chatView = document.getElementById('chatView');
    const chatListBody = document.getElementById('chatListBody');
    const emptyChatList = document.getElementById('emptyChatList');
    const newChatBtn = document.getElementById('newChatBtn');
    const newGroupChatBtn = document.getElementById('newGroupChatBtn');
    const backBtn = document.getElementById('backBtn');
    
    // æœ‹å‹åœˆDOMå…ƒç´ 
    const momentsBtn = document.getElementById('momentsBtn');
    const momentsView = document.getElementById('momentsView');
    const momentsBackBtn = document.getElementById('momentsBackBtn');
    const momentsSettingsBtn = document.getElementById('momentsSettingsBtn');
    const momentsUserName = document.getElementById('momentsUserName');
    const momentsUserAvatar = document.getElementById('momentsUserAvatar');
    const momentsPublishArea = document.getElementById('momentsPublishArea');
    const publishAvatar = document.getElementById('publishAvatar');
    const publishText = document.getElementById('publishText');
    const momentsList = document.getElementById('momentsList');
    const publishModal = document.getElementById('publishModal');
    const publishModalClose = document.getElementById('publishModalClose');
    const publishTextarea = document.getElementById('publishTextarea');
    const publishImagesContainer = document.getElementById('publishImagesContainer');
    const addImageBtn = document.getElementById('addImageBtn');
    const visibilityOptions = document.getElementById('visibilityOptions');
    const publishCancel = document.getElementById('publishCancel');
    const publishConfirm = document.getElementById('publishConfirm');
    const imagePreviewModal = document.getElementById('imagePreviewModal');
    const imagePreviewClose = document.getElementById('imagePreviewClose');
    const imagePreviewContent = document.getElementById('imagePreviewContent');
    const momentImageInput = document.getElementById('momentImageInput');
    
    // æœ‹å‹åœˆè®¾ç½®DOMå…ƒç´ 
    const momentsSettingsModal = document.getElementById('momentsSettingsModal');
    const momentsSettingsClose = document.getElementById('momentsSettingsClose');
    const momentsTitle = document.getElementById('momentsTitle');
    const momentsCoverUrl = document.getElementById('momentsCoverUrl');
    const uploadMomentsCoverBtn = document.getElementById('uploadMomentsCoverBtn');
    const resetMomentsCoverBtn = document.getElementById('resetMomentsCoverBtn');
    const momentsCoverFileInput = document.getElementById('momentsCoverFileInput');
    const momentsCoverPreview = document.getElementById('momentsCoverPreview');
    const momentsCommentMode = document.getElementById('momentsCommentMode');
    const cancelMomentsSettings = document.getElementById('cancelMomentsSettings');
    const saveMomentsSettings = document.getElementById('saveMomentsSettings');
    
    const chatBody = document.getElementById('chatBody');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const roleBtn = document.getElementById('roleBtn');
    const userBtn = document.getElementById('userBtn');
    const userPanel = document.getElementById('userPanel');
    const rolePanel = document.getElementById('rolePanel');
    const chatTitle = document.getElementById('chatTitle');
    const chatTypeDisplay = document.getElementById('chatTypeDisplay');
    
    // ç”¨æˆ·è¡¨æƒ…åŒ…ç›¸å…³DOMå…ƒç´ 
    const userEmojiBtn = document.getElementById('userEmojiBtn');
    const userEmojiPanel = document.getElementById('userEmojiPanel');
    const userEmojiClose = document.getElementById('userEmojiClose');
    const userEmojiGrid = document.getElementById('userEmojiGrid');
    
    // ä½ç½®ç›¸å…³DOMå…ƒç´ 
    const locationBtn = document.getElementById('locationBtn');
    const locationModal = document.getElementById('locationModal');
    const locationModalClose = document.getElementById('locationModalClose');
    const locationPreviewImage = document.getElementById('locationPreviewImage');
    const locationPreviewName = document.getElementById('locationPreviewName');
    const locationPreviewAddress = document.getElementById('locationPreviewAddress');
    const locationNameInput = document.getElementById('locationNameInput');
    const locationAddressInput = document.getElementById('locationAddressInput');
    const locationImageUpload = document.getElementById('locationImageUpload');
    const locationImageInput = document.getElementById('locationImageInput');
    const locationCancelBtn = document.getElementById('locationCancelBtn');
    const locationSendBtn = document.getElementById('locationSendBtn');
    
    // è½¬è´¦ç›¸å…³DOMå…ƒç´ 
    const transferBtn = document.getElementById('transferBtn');
    const transferModal = document.getElementById('transferModal');
    const transferModalClose = document.getElementById('transferModalClose');
    const transferPreviewAmount = document.getElementById('transferPreviewAmount');
    const transferPreviewNote = document.getElementById('transferPreviewNote');
    const transferAmountInput = document.getElementById('transferAmountInput');
    const transferNoteInput = document.getElementById('transferNoteInput');
    const transferReceiverInput = document.getElementById('transferReceiverInput');
    const transferCancelBtn = document.getElementById('transferCancelBtn');
    const transferSendBtn = document.getElementById('transferSendBtn');

    // è§†é¢‘é€šè¯ç›¸å…³DOMå…ƒç´ 
    const videoCallBtn = document.getElementById('videoCallBtn');
    const videoCallRequestModal = document.getElementById('videoCallRequestModal');
    const videoCallRequestAvatar = document.getElementById('videoCallRequestAvatar');
    const videoCallRequestName = document.getElementById('videoCallRequestName');
    const videoCallDeclineBtn = document.getElementById('videoCallDeclineBtn');
    const videoCallAcceptBtn = document.getElementById('videoCallAcceptBtn');
    const videoCallModal = document.getElementById('videoCallModal');
    const videoCallMainImage = document.getElementById('videoCallMainImage');
    const videoCallMainVideo = document.getElementById('videoCallMainVideo');
    const videoCallUserName = document.getElementById('videoCallUserName');
    const videoCallDuration = document.getElementById('videoCallDuration');
    const videoCallUserAvatar = document.getElementById('videoCallUserAvatar');
    const videoCallMessages = document.getElementById('videoCallMessages');
    const videoCallInput = document.getElementById('videoCallInput');
    const videoCallSendBtn = document.getElementById('videoCallSendBtn');
    const videoCallMuteBtn = document.getElementById('videoCallMuteBtn');
    const videoCallCameraBtn = document.getElementById('videoCallCameraBtn');
    const videoCallHangupBtn = document.getElementById('videoCallHangupBtn');
    
    // æ‹ä¸€æ‹æé†’ç›¸å…³DOMå…ƒç´ 
    const patReminderModal = document.getElementById('patReminderModal');
    const patReminderAvatar = document.getElementById('patReminderAvatar');
    const patReminderText = document.getElementById('patReminderText');
    const patReminderClose = document.getElementById('patReminderClose');
    
    // æ ‡é¢˜ç¼–è¾‘åŠŸèƒ½
    let isEditingTitle = false;
    let originalTitle = '';
    
    function enableTitleEdit() {
      if (isEditingTitle) return;
      
      isEditingTitle = true;
      originalTitle = chatTitle.textContent;
      
      // åˆ›å»ºç¼–è¾‘å®¹å™¨
      const editContainer = document.createElement('div');
      editContainer.className = 'chat-title-edit-container';
      editContainer.style.cssText = `
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.95);
        padding: 12px;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        position: relative;
        z-index: 1000;
      `;
      
      // åˆ›å»ºè¾“å…¥æ¡†
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'chat-title-input';
      input.value = originalTitle;
      input.maxLength = 20; // é™åˆ¶æ ‡é¢˜é•¿åº¦
      input.style.cssText = `
        background: rgba(255, 255, 255, 1);
        border: 2px solid #ddd;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 16px;
        color: #333;
        min-width: 200px;
        text-align: center;
        outline: none;
        transition: border-color 0.2s ease;
      `;
      
      // åˆ›å»ºæŒ‰é’®å®¹å™¨
      const buttonContainer = document.createElement('div');
      buttonContainer.style.cssText = `
        display: flex;
        gap: 12px;
        align-items: center;
      `;
      
      // åˆ›å»ºç¡®è®¤æŒ‰é’®
      const confirmBtn = document.createElement('button');
      confirmBtn.innerHTML = 'âœ“ ç¡®è®¤';
      confirmBtn.title = 'ç¡®è®¤ä¿®æ”¹';
      confirmBtn.style.cssText = `
        background: #07c160;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        transition: all 0.2s ease;
      `;
      
      // åˆ›å»ºå–æ¶ˆæŒ‰é’®
      const cancelBtn = document.createElement('button');
      cancelBtn.innerHTML = 'âœ• å–æ¶ˆ';
      cancelBtn.title = 'å–æ¶ˆä¿®æ”¹';
      cancelBtn.style.cssText = `
        background: #fa5151;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        transition: all 0.2s ease;
      `;
      
      // ç»„è£…ç¼–è¾‘ç•Œé¢
      buttonContainer.appendChild(confirmBtn);
      buttonContainer.appendChild(cancelBtn);
      editContainer.appendChild(input);
      editContainer.appendChild(buttonContainer);
      
      // å°†ç¼–è¾‘å®¹å™¨æ·»åŠ åˆ°æ ‡é¢˜å…ƒç´ å†…éƒ¨
      chatTitle.appendChild(editContainer);
      
      // è‡ªåŠ¨é€‰ä¸­æ–‡æœ¬å¹¶èšç„¦
      input.select();
      input.focus();
      
      // ä¿å­˜æ ‡é¢˜
      function saveTitleEdit() {
        const newTitle = input.value.trim();
        if (newTitle && newTitle !== originalTitle) {
          chatTitle.textContent = newTitle;
          
          // æ›´æ–°å½“å‰èŠå¤©çš„è‡ªå®šä¹‰æ ‡é¢˜
          const currentChat = chatList.find(c => c.id === currentChatId);
          if (currentChat) {
            currentChat.customTitle = newTitle;
            // å¦‚æœè‡ªå®šä¹‰æ ‡é¢˜å’Œé»˜è®¤æ ‡é¢˜ä¸€æ ·ï¼Œæ¸…é™¤è‡ªå®šä¹‰æ ‡é¢˜
            const defaultTitle = getDefaultTitle(currentChat);
            if (newTitle === defaultTitle) {
              delete currentChat.customTitle;
              chatTitle.classList.remove('custom-title');
            } else {
              chatTitle.classList.add('custom-title');
            }
            saveChatList();
            renderChatList(); // æ›´æ–°èŠå¤©åˆ—è¡¨æ˜¾ç¤º
          }
        }
        exitTitleEdit();
      }
      
      // å–æ¶ˆç¼–è¾‘
      function cancelTitleEdit() {
        chatTitle.textContent = originalTitle;
        exitTitleEdit();
        // å–æ¶ˆç¼–è¾‘æ—¶ä¸éœ€è¦æ›´æ–°èŠå¤©åˆ—è¡¨ï¼Œå› ä¸ºæ²¡æœ‰å®é™…ä¿®æ”¹
      }
      
      // é€€å‡ºç¼–è¾‘æ¨¡å¼
      function exitTitleEdit() {
        if (editContainer.parentNode) {
          editContainer.parentNode.removeChild(editContainer);
        }
        isEditingTitle = false;
      }
      
      // äº‹ä»¶ç›‘å¬
      confirmBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        saveTitleEdit();
      });
      
      cancelBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        cancelTitleEdit();
      });
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveTitleEdit();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelTitleEdit();
        }
      });
      
      // ç‚¹å‡»å…¶ä»–åœ°æ–¹å–æ¶ˆç¼–è¾‘
      document.addEventListener('click', function handleClickOutside(e) {
        if (!editContainer.contains(e.target)) {
          cancelTitleEdit();
          document.removeEventListener('click', handleClickOutside);
        }
      });
    }
    
    // è·å–é»˜è®¤æ ‡é¢˜ï¼ˆç”¨äºèŠå¤©ç•Œé¢å¤´éƒ¨æ˜¾ç¤ºï¼‰
    function getDefaultTitle(chat) {
      if (!chat) return 'AIå¾®ä¿¡èŠå¤©';
      
      if (chat.type === 'group') {
        const roleCount = chat.roles ? chat.roles.length : 0;
        return `${chat.name} (${roleCount}ä¸ªè§’è‰²)`;
      } else if (chat.roleName) {
        return `ä¸${chat.roleName}èŠå¤©`;
      } else {
        return chat.name;
      }
    }
    
    // è·å–èŠå¤©åˆ—è¡¨ä¸­çš„æ˜¾ç¤ºæ ‡é¢˜ï¼ˆç”¨äºèŠå¤©åˆ—è¡¨æ˜¾ç¤ºï¼‰
    function getDisplayTitle(chat) {
      if (!chat) return 'AIå¾®ä¿¡èŠå¤©';
      
      // å¯¹äºèŠå¤©åˆ—è¡¨ï¼Œä½¿ç”¨åŸºç¡€åç§°
      return chat.name;
    }
    
    // é‡ç½®æ ‡é¢˜ä¸ºé»˜è®¤å€¼
    function resetTitleToDefault() {
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (currentChat) {
        delete currentChat.customTitle;
        chatTitle.classList.remove('custom-title');
        saveChatList();
        renderChatList();
        updateChatHeader();
      }
    }
    
    // ä¸ºæ ‡é¢˜æ·»åŠ ç‚¹å‡»äº‹ä»¶
    chatTitle.addEventListener('click', enableTitleEdit);
    chatTitle.addEventListener('dblclick', enableTitleEdit);
    
    // ä¸ºæ ‡é¢˜æ·»åŠ å³é”®èœå•
    chatTitle.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (currentChat && currentChat.customTitle) {
        if (confirm('æ˜¯å¦è¦é‡ç½®æ ‡é¢˜ä¸ºé»˜è®¤å€¼ï¼Ÿ')) {
          resetTitleToDefault();
        }
      }
    });
    const groupChatControls = document.getElementById('groupChatControls');
    const singleRoleSettings = document.getElementById('singleRoleSettings');
    const addRoleBtn = document.getElementById('addRoleBtn');
    const rolesList = document.getElementById('rolesList');
    
    // ç¾¤èŠè§’è‰²ç¼–è¾‘å¼¹çª—å…ƒç´ 
    const roleEditModal = document.getElementById('roleEditModal');
    const roleEditTitle = document.getElementById('roleEditTitle');
    const closeRoleEditModal = document.getElementById('closeRoleEditModal');
    const modalRolePresetSelect = document.getElementById('modalRolePresetSelect');
    const modalRoleNameInput = document.getElementById('modalRoleNameInput');
    const modalRoleDescInput = document.getElementById('modalRoleDescInput');
    const modalRoleAvatarInput = document.getElementById('modalRoleAvatarInput');
    const modalRoleFrequencySelect = document.getElementById('modalRoleFrequencySelect');
    const saveRoleEditBtn = document.getElementById('saveRoleEditBtn');
    const cancelRoleEditBtn = document.getElementById('cancelRoleEditBtn');
    
    const apiUrlInput = document.getElementById('apiUrlInput');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const modelSelect = document.getElementById('modelSelect');
    const modelInfo = document.getElementById('modelInfo');
    
    // APIé…ç½®ç®¡ç†ç›¸å…³å…ƒç´ 
    const apiConfigNameInput = document.getElementById('apiConfigNameInput');
    const savedApiSelect = document.getElementById('savedApiSelect');
    const loadApiBtn = document.getElementById('loadApiBtn');
    const deleteApiBtn = document.getElementById('deleteApiBtn');
    const newApiConfigBtn = document.getElementById('newApiConfigBtn');
    const saveAsNewBtn = document.getElementById('saveAsNewBtn');
    const updateCurrentBtn = document.getElementById('updateCurrentBtn');
    
    // è¯†å›¾APIç›¸å…³å…ƒç´ 
    const visionApiUrlInput = document.getElementById('visionApiUrlInput');
    const visionApiKeyInput = document.getElementById('visionApiKeyInput');
    const visionModelSelect = document.getElementById('visionModelSelect');
    const testVisionBtn = document.getElementById('testVisionBtn');
    const refreshVisionModelsBtn = document.getElementById('refreshVisionModelsBtn');
    const debugVisionModelsBtn = document.getElementById('debugVisionModelsBtn');
    
    // å›¾ç‰‡ä¸Šä¼ ç›¸å…³å…ƒç´ 
    const imageBtn = document.getElementById('imageBtn');
    const imageFileInput = document.getElementById('imageFileInput');
    
    const roleNameInput = document.getElementById('roleNameInput');
    const roleDescInput = document.getElementById('roleDescInput');
    const rolePresetSelect = document.getElementById('rolePresetSelect');
    const userNameInput = document.getElementById('userNameInput');
    const userDescInput = document.getElementById('userDescInput');
    const userAvatarInput = document.getElementById('userAvatarInput');
    const aiAvatarInput = document.getElementById('aiAvatarInput');
    const testResult = document.getElementById('testResult');
    const testBtn = document.getElementById('testBtn');
    const refreshModelsBtn = document.getElementById('refreshModelsBtn');
    const directChatTestBtn = document.getElementById('directChatTestBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveRoleBtn = document.getElementById('saveRoleBtn');
    const cancelRoleBtn = document.getElementById('cancelRoleBtn');
    const clearChatBtn = document.getElementById('clearChatBtn');
    const exportChatBtn = document.getElementById('exportChatBtn');
    const importChatBtn = document.getElementById('importChatBtn');
    const importFileInput = document.getElementById('importFileInput');
    const statusIndicator = document.getElementById('statusIndicator');
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPanel = document.getElementById('emojiPanel');
    const emojiGallery = document.getElementById('emojiGallery');
    const newEmojiInput = document.getElementById('newEmojiInput');
    const addEmojiBtn = document.getElementById('addEmojiBtn');
    const closeEmojiBtn = document.getElementById('closeEmojiBtn');
    
    // æ–‡ä»¶ä¸Šä¼ ç›¸å…³å…ƒç´ 
    const uploadEmojiBtn = document.getElementById('uploadEmojiBtn');
    const emojiFileInput = document.getElementById('emojiFileInput');
    const uploadAiAvatarBtn = document.getElementById('uploadAiAvatarBtn');
    const aiAvatarFileInput = document.getElementById('aiAvatarFileInput');
    const uploadUserAvatarBtn = document.getElementById('uploadUserAvatarBtn');
    const userAvatarFileInput = document.getElementById('userAvatarFileInput');
    const uploadModalRoleAvatarBtn = document.getElementById('uploadModalRoleAvatarBtn');
    const modalRoleAvatarFileInput = document.getElementById('modalRoleAvatarFileInput');
    
    // é¢„è®¾ç®¡ç†ç›¸å…³å…ƒç´ 
    const userPresetSelect = document.getElementById('userPresetSelect');
    const saveRolePresetBtn = document.getElementById('saveRolePresetBtn');
    const manageRolePresetsBtn = document.getElementById('manageRolePresetsBtn');
    const saveUserPresetBtn = document.getElementById('saveUserPresetBtn');
    const manageUserPresetsBtn = document.getElementById('manageUserPresetsBtn');
    const saveModalRolePresetBtn = document.getElementById('saveModalRolePresetBtn');
    const manageModalRolePresetsBtn = document.getElementById('manageModalRolePresetsBtn');
    
    // é¢„è®¾ç®¡ç†å¼¹çª—å…ƒç´ 
    const presetManageModal = document.getElementById('presetManageModal');
    const presetManageTitle = document.getElementById('presetManageTitle');
    const closePresetManageModal = document.getElementById('closePresetManageModal');
    const closePresetManageBtn = document.getElementById('closePresetManageBtn');
    const presetList = document.getElementById('presetList');
    
    // ä¿å­˜é¢„è®¾å¼¹çª—å…ƒç´ 
    const savePresetModal = document.getElementById('savePresetModal');
    const savePresetTitle = document.getElementById('savePresetTitle');
    const closeSavePresetModal = document.getElementById('closeSavePresetModal');
    const cancelSavePresetBtn = document.getElementById('cancelSavePresetBtn');
    const presetNameInput = document.getElementById('presetNameInput');
    const presetDescInput = document.getElementById('presetDescInput');
    const confirmSavePresetBtn = document.getElementById('confirmSavePresetBtn');
    
    // å½“å‰é€‰ä¸­çš„æƒ…ç»ª
    let currentEmotion = 'happy';

    // æ–‡ä»¶ä¸Šä¼ å·¥å…·å‡½æ•°
    
    // å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    // å‹ç¼©å›¾ç‰‡
    function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.8) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.onload = function() {
          // è®¡ç®—æ–°çš„å°ºå¯¸
          let { width, height } = img;
          if (width > height) {
            if (width > maxWidth) {
              height = height * (maxWidth / width);
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width = width * (maxHeight / height);
              height = maxHeight;
            }
          }
          
          // è®¾ç½®canvaså°ºå¯¸
          canvas.width = width;
          canvas.height = height;
          
          // ç»˜åˆ¶å›¾ç‰‡
          ctx.drawImage(img, 0, 0, width, height);
          
          // è½¬æ¢ä¸ºbase64
          const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
          resolve(compressedBase64);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    // éªŒè¯å›¾ç‰‡æ–‡ä»¶
    function validateImageFile(file) {
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
      const maxSize = 10 * 1024 * 1024; // 10MB
      
      if (!validTypes.includes(file.type)) {
        alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼ˆJPGã€PNGã€GIFã€WebPï¼‰');
        return false;
      }
      
      if (file.size > maxSize) {
        alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
        return false;
      }
      
      return true;
    }

    // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
    async function handleImageUpload(file, targetInput, isEmoji = false, buttonElement = null) {
      if (!validateImageFile(file)) {
        return;
      }
      
      try {
        // æ˜¾ç¤ºåŠ è½½æç¤º
        const loadingText = isEmoji ? 'æ­£åœ¨ä¸Šä¼ è¡¨æƒ…åŒ…...' : 'æ­£åœ¨ä¸Šä¼ å¤´åƒ...';
        let button = buttonElement;
        let originalText = '';
        
        // æŸ¥æ‰¾å¯¹åº”çš„æŒ‰é’®å…ƒç´ 
        if (!button) {
          if (isEmoji) {
            button = uploadEmojiBtn;
          } else if (targetInput === aiAvatarInput) {
            button = uploadAiAvatarBtn;
          } else if (targetInput === userAvatarInput) {
            button = uploadUserAvatarBtn;
          } else if (targetInput === modalRoleAvatarInput) {
            button = uploadModalRoleAvatarBtn;
          }
        }
        
        if (button) {
          originalText = button.textContent;
          button.textContent = loadingText;
          button.disabled = true;
        }
        
        // å‹ç¼©å›¾ç‰‡
        const maxWidth = isEmoji ? 400 : 200;
        const maxHeight = isEmoji ? 400 : 200;
        const compressedBase64 = await compressImage(file, maxWidth, maxHeight, 0.8);
        
        // æ›´æ–°ç›®æ ‡è¾“å…¥æ¡†
        if (targetInput) {
          targetInput.value = compressedBase64;
          
          // æ·»åŠ é¢„è§ˆå›¾ç‰‡
          addImagePreview(targetInput, compressedBase64);
        }
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        if (button) {
          button.textContent = originalText;
          button.disabled = false;
        }
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        const successText = isEmoji ? 'è¡¨æƒ…åŒ…ä¸Šä¼ æˆåŠŸï¼' : 'å¤´åƒä¸Šä¼ æˆåŠŸï¼';
        alert(successText);
        
        // å¦‚æœæ˜¯è¡¨æƒ…åŒ…ï¼Œè‡ªåŠ¨æ·»åŠ åˆ°å½“å‰æƒ…ç»ª
        if (isEmoji) {
          addEmojiToCurrentEmotion(compressedBase64);
        }
        
      } catch (error) {
        console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
        alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        let button = buttonElement;
        if (!button) {
          if (isEmoji) {
            button = uploadEmojiBtn;
          } else if (targetInput === aiAvatarInput) {
            button = uploadAiAvatarBtn;
          } else if (targetInput === userAvatarInput) {
            button = uploadUserAvatarBtn;
          } else if (targetInput === modalRoleAvatarInput) {
            button = uploadModalRoleAvatarBtn;
          }
        }
        
        if (button) {
          const originalText = isEmoji ? 'ä¸Šä¼ æ–‡ä»¶' : button.textContent.replace('æ­£åœ¨ä¸Šä¼ ...', '').replace('æ­£åœ¨ä¸Šä¼ å¤´åƒ...', '').replace('æ­£åœ¨ä¸Šä¼ è¡¨æƒ…åŒ…...', '') || 'ä¸Šä¼ æ–‡ä»¶';
          button.textContent = originalText;
          button.disabled = false;
        }
      }
    }

    // æ·»åŠ è¡¨æƒ…åŒ…åˆ°å½“å‰æƒ…ç»ª
    function addEmojiToCurrentEmotion(emojiUrl) {
      if (!emojiData[currentEmotion]) {
        emojiData[currentEmotion] = [];
      }
      
      emojiData[currentEmotion].push(emojiUrl);
      localStorage.setItem('aiChatEmojis', JSON.stringify(emojiData));
      updateEmojiGallery();
    }

    // å¤„ç†è§†é¢‘é€šè¯ç”»é¢æ–‡ä»¶ä¸Šä¼ 
    async function handleVideoCallMediaUpload(file, targetInput) {
      // éªŒè¯æ–‡ä»¶ç±»å‹
      const allowedImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/bmp'];
      const allowedVideoTypes = ['video/mp4', 'video/webm', 'video/ogg', 'video/mov', 'video/avi', 'video/3gp', 'video/quicktime'];
      
      const isValidImage = allowedImageTypes.includes(file.type) || file.type.startsWith('image/');
      const isValidVideo = allowedVideoTypes.includes(file.type) || file.type.startsWith('video/');
      
      if (!isValidImage && !isValidVideo) {
        alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·é€‰æ‹©å›¾ç‰‡æˆ–è§†é¢‘æ–‡ä»¶');
        return;
      }
      
      // éªŒè¯æ–‡ä»¶å¤§å° (å›¾ç‰‡æœ€å¤§10MBï¼Œè§†é¢‘æœ€å¤§50MB)
      const maxImageSize = 10 * 1024 * 1024; // 10MB
      const maxVideoSize = 50 * 1024 * 1024; // 50MB
      const maxSize = isValidImage ? maxImageSize : maxVideoSize;
      
      if (file.size > maxSize) {
        const sizeLimit = isValidImage ? '10MB' : '50MB';
        alert(`æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡${sizeLimit}`);
        return;
      }
      
      try {
        // æ˜¾ç¤ºåŠ è½½æç¤º
        const loadingText = 'æ­£åœ¨ä¸Šä¼ è§†é¢‘é€šè¯ç”»é¢...';
        let button = null;
        let originalText = '';
        
        // æŸ¥æ‰¾å¯¹åº”çš„æŒ‰é’®å…ƒç´ 
        if (targetInput && targetInput.id === 'modalRoleVideoInput') {
          button = document.getElementById('uploadModalRoleVideoBtn');
        } else if (targetInput && targetInput.id === 'aiVideoInput') {
          button = document.getElementById('uploadAiVideoBtn');
        }
        
        if (button) {
          originalText = button.textContent;
          button.textContent = loadingText;
          button.disabled = true;
        }
        
        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡ï¼Œå¦‚æœæ˜¯åˆ™è¿›è¡Œå‹ç¼©
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let processedFile = file;
        
        if (isMobile && isValidImage) {
          // ç§»åŠ¨ç«¯å›¾ç‰‡å‹ç¼©
          try {
            processedFile = await compressImageForMobile(file);
          } catch (error) {
            console.warn('å›¾ç‰‡å‹ç¼©å¤±è´¥ï¼Œä½¿ç”¨åŸæ–‡ä»¶:', error);
          }
        }
        
        // å°†æ–‡ä»¶è½¬æ¢ä¸ºbase64
        const fileBase64 = await fileToBase64(processedFile);
        
        // æ›´æ–°ç›®æ ‡è¾“å…¥æ¡†
        if (targetInput) {
          targetInput.value = fileBase64;
          
          // æ·»åŠ é¢„è§ˆ
          addVideoCallMediaPreview(targetInput, fileBase64, file.type);
        }
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        if (button) {
          button.textContent = originalText;
          button.disabled = false;
        }
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        const fileType = file.type.startsWith('video/') ? 'è§†é¢‘' : 'å›¾ç‰‡';
        alert(`${fileType}ä¸Šä¼ æˆåŠŸï¼`);
        
      } catch (error) {
        console.error('è§†é¢‘é€šè¯ç”»é¢ä¸Šä¼ å¤±è´¥:', error);
        alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        let button = null;
        if (targetInput && targetInput.id === 'modalRoleVideoInput') {
          button = document.getElementById('uploadModalRoleVideoBtn');
        } else if (targetInput && targetInput.id === 'aiVideoInput') {
          button = document.getElementById('uploadAiVideoBtn');
        }
        
        if (button) {
          button.textContent = originalText || 'ğŸ“¹ ä¸Šä¼ è§†é¢‘/å›¾ç‰‡';
          button.disabled = false;
        }
      }
    }

    // å°†æ–‡ä»¶è½¬æ¢ä¸ºbase64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ç§»åŠ¨ç«¯å›¾ç‰‡å‹ç¼©
    function compressImageForMobile(file, maxWidth = 1920, maxHeight = 1080, quality = 0.8) {
      return new Promise((resolve, reject) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
          // è®¡ç®—æ–°çš„å°ºå¯¸
          let { width, height } = img;
          
          // å¦‚æœå›¾ç‰‡å°ºå¯¸è¶…è¿‡é™åˆ¶ï¼Œè¿›è¡Œç¼©æ”¾
          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width = Math.floor(width * ratio);
            height = Math.floor(height * ratio);
          }
          
          // è®¾ç½®canvaså°ºå¯¸
          canvas.width = width;
          canvas.height = height;
          
          // ç»˜åˆ¶å›¾ç‰‡
          ctx.drawImage(img, 0, 0, width, height);
          
          // è½¬æ¢ä¸ºblob
          canvas.toBlob((blob) => {
            if (blob) {
              // åˆ›å»ºæ–°çš„Fileå¯¹è±¡
              const compressedFile = new File([blob], file.name, {
                type: file.type,
                lastModified: Date.now()
              });
              resolve(compressedFile);
            } else {
              reject(new Error('å›¾ç‰‡å‹ç¼©å¤±è´¥'));
            }
          }, file.type, quality);
        };
        
        img.onerror = () => reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
        img.src = URL.createObjectURL(file);
      });
    }

    // ç§»åŠ¨ç«¯è§†é¢‘ä¸Šä¼ èœå•
    function showMobileVideoUploadMenu(fileInput) {
      // åˆ›å»ºå¼¹çª—
      const modal = document.createElement('div');
      modal.className = 'mobile-upload-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      `;
      
      const content = document.createElement('div');
      content.style.cssText = `
        background: white;
        width: 100%;
        max-width: 500px;
        border-radius: 20px 20px 0 0;
        padding: 20px;
        animation: slideUp 0.3s ease;
      `;
      
      content.innerHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
          <h3 style="margin: 0; color: #333;">é€‰æ‹©ä¸Šä¼ æ–¹å¼</h3>
        </div>
        <div class="upload-options">
          <button class="upload-option-btn" data-action="camera">
            <span class="icon">ğŸ“¹</span>
            <span>æ‹æ‘„è§†é¢‘</span>
          </button>
          <button class="upload-option-btn" data-action="video">
            <span class="icon">ğŸ¬</span>
            <span>é€‰æ‹©è§†é¢‘</span>
          </button>
          <button class="upload-option-btn" data-action="photo">
            <span class="icon">ğŸ“·</span>
            <span>æ‹ç…§</span>
          </button>
          <button class="upload-option-btn" data-action="image">
            <span class="icon">ğŸ–¼ï¸</span>
            <span>é€‰æ‹©å›¾ç‰‡</span>
          </button>
        </div>
        <button class="cancel-upload-btn" style="width: 100%; padding: 15px; margin-top: 15px; background: #f5f5f5; border: none; border-radius: 10px; font-size: 16px;">å–æ¶ˆ</button>
      `;
      
      // æ·»åŠ æ ·å¼
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes slideUp {
          from { transform: translateY(100%); }
          to { transform: translateY(0); }
        }
        .upload-options {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          margin-bottom: 10px;
        }
        .upload-option-btn {
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 20px 15px;
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.2s ease;
        }
        .upload-option-btn:hover {
          background: #e9ecef;
          border-color: #6DA3BD;
        }
        .upload-option-btn .icon {
          font-size: 24px;
          margin-bottom: 8px;
        }
        .upload-option-btn span:last-child {
          font-size: 14px;
          color: #333;
        }
      `;
      document.head.appendChild(style);
      
      modal.appendChild(content);
      document.body.appendChild(modal);
      
      // åˆ›å»ºä¸åŒç±»å‹çš„æ–‡ä»¶è¾“å…¥
      const createFileInput = (accept, capture) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = accept;
        if (capture) input.capture = capture;
        input.style.display = 'none';
        document.body.appendChild(input);
        return input;
      };
      
      // äº‹ä»¶å¤„ç†
      content.addEventListener('click', (e) => {
        const btn = e.target.closest('.upload-option-btn');
        if (!btn) return;
        
        const action = btn.dataset.action;
        let tempInput;
        
        switch (action) {
          case 'camera':
            tempInput = createFileInput('video/*', 'environment');
            break;
          case 'video':
            tempInput = createFileInput('video/*');
            break;
          case 'photo':
            tempInput = createFileInput('image/*', 'environment');
            break;
          case 'image':
            tempInput = createFileInput('image/*');
            break;
        }
        
        if (tempInput) {
          tempInput.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
              // è§¦å‘åŸå§‹æ–‡ä»¶è¾“å…¥çš„changeäº‹ä»¶
              Object.defineProperty(fileInput, 'files', {
                value: e.target.files,
                writable: false
              });
              fileInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
            // æ¸…ç†ä¸´æ—¶è¾“å…¥
            document.body.removeChild(tempInput);
          };
          tempInput.click();
        }
        
        // å…³é—­å¼¹çª—
        modal.remove();
        style.remove();
      });
      
      // å–æ¶ˆæŒ‰é’®å’ŒèƒŒæ™¯ç‚¹å‡»å…³é—­
      content.querySelector('.cancel-upload-btn').onclick = () => {
        modal.remove();
        style.remove();
      };
      
      modal.onclick = (e) => {
        if (e.target === modal) {
          modal.remove();
          style.remove();
        }
      };
    }

    // æ·»åŠ è§†é¢‘é€šè¯ç”»é¢é¢„è§ˆ
    function addVideoCallMediaPreview(targetInput, mediaSrc, fileType) {
      // æŸ¥æ‰¾æˆ–åˆ›å»ºé¢„è§ˆå®¹å™¨
      let previewContainer = targetInput.parentNode.querySelector('.preview-container');
      if (!previewContainer) {
        previewContainer = document.createElement('div');
        previewContainer.className = 'preview-container';
        previewContainer.style.marginTop = '10px';
        targetInput.parentNode.appendChild(previewContainer);
      }
      
      // æ¸…ç©ºç°æœ‰å†…å®¹
      previewContainer.innerHTML = '';
      
      // åˆ›å»ºé¢„è§ˆå…ƒç´ 
      let previewElement;
      if (fileType.startsWith('video/')) {
        previewElement = document.createElement('video');
        previewElement.controls = true;
        previewElement.style.maxWidth = '200px';
        previewElement.style.maxHeight = '150px';
      } else {
        previewElement = document.createElement('img');
        previewElement.className = 'preview-image';
        previewElement.alt = 'é¢„è§ˆå›¾ç‰‡';
      }
      
      previewElement.src = mediaSrc;
      
      // åˆ›å»ºåˆ é™¤æŒ‰é’®
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'âœ•';
      deleteBtn.className = 'setting-btn cancel-btn';
      deleteBtn.style.marginLeft = '10px';
      deleteBtn.style.padding = '4px 8px';
      deleteBtn.style.fontSize = '12px';
      deleteBtn.onclick = function() {
        targetInput.value = '';
        previewContainer.remove();
      };
      
      // æ·»åŠ åˆ°å®¹å™¨
      const wrapper = document.createElement('div');
      wrapper.style.display = 'flex';
      wrapper.style.alignItems = 'center';
      wrapper.appendChild(previewElement);
      wrapper.appendChild(deleteBtn);
      previewContainer.appendChild(wrapper);
    }

    // æ·»åŠ å›¾ç‰‡é¢„è§ˆ
    function addImagePreview(targetInput, imageSrc) {
      // æŸ¥æ‰¾æˆ–åˆ›å»ºé¢„è§ˆå®¹å™¨
      let previewContainer = targetInput.parentNode.querySelector('.preview-container');
      if (!previewContainer) {
        previewContainer = document.createElement('div');
        previewContainer.className = 'preview-container';
        previewContainer.style.marginTop = '10px';
        targetInput.parentNode.appendChild(previewContainer);
      }
      
      // æ¸…ç©ºç°æœ‰å†…å®¹
      previewContainer.innerHTML = '';
      
      // åˆ›å»ºé¢„è§ˆå›¾ç‰‡
      const previewImg = document.createElement('img');
      previewImg.src = imageSrc;
      previewImg.className = 'preview-image';
      previewImg.alt = 'é¢„è§ˆå›¾ç‰‡';
      
      // åˆ›å»ºåˆ é™¤æŒ‰é’®
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'âœ•';
      deleteBtn.className = 'setting-btn cancel-btn';
      deleteBtn.style.marginLeft = '10px';
      deleteBtn.style.padding = '4px 8px';
      deleteBtn.style.fontSize = '12px';
      deleteBtn.onclick = function() {
        targetInput.value = '';
        previewContainer.remove();
      };
      
      // æ·»åŠ åˆ°å®¹å™¨
      const wrapper = document.createElement('div');
      wrapper.style.display = 'flex';
      wrapper.style.alignItems = 'center';
      wrapper.appendChild(previewImg);
      wrapper.appendChild(deleteBtn);
      previewContainer.appendChild(wrapper);
    }

    // ç”Ÿæˆå”¯ä¸€ID
    function generateId() {
      return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // è·å–å½“å‰æ—¶é—´æˆ³
    function getCurrentTime() {
      return new Date().toISOString();
    }

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤ºï¼ˆç”¨äºèŠå¤©åˆ—è¡¨ï¼‰
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffTime = now - date;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) {
        return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      } else if (diffDays === 1) {
        return 'æ˜¨å¤©';
      } else if (diffDays < 7) {
        return `${diffDays}å¤©å‰`;
      } else {
        return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
      }
    }

    // æ ¼å¼åŒ–æ¶ˆæ¯æ—¶é—´æ˜¾ç¤ºï¼ˆç”¨äºæ°”æ³¡ï¼‰
    function formatMessageTime(timestamp = null) {
      const date = timestamp ? new Date(timestamp) : new Date();
      const now = new Date();
      const diffTime = now - date;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) {
        // ä»Šå¤©æ˜¾ç¤ºæ—¶åˆ†ç§’
        return date.toLocaleTimeString('zh-CN', { 
          hour: '2-digit', 
          minute: '2-digit',
          second: '2-digit'
        });
      } else if (diffDays === 1) {
        // æ˜¨å¤©æ˜¾ç¤º"æ˜¨å¤© æ—¶:åˆ†"
        return 'æ˜¨å¤© ' + date.toLocaleTimeString('zh-CN', { 
          hour: '2-digit', 
          minute: '2-digit'
        });
      } else if (diffDays < 7) {
        // ä¸€å‘¨å†…æ˜¾ç¤º"Xå¤©å‰ æ—¶:åˆ†"
        return `${diffDays}å¤©å‰ ` + date.toLocaleTimeString('zh-CN', { 
          hour: '2-digit', 
          minute: '2-digit'
        });
      } else {
        // è¶…è¿‡ä¸€å‘¨æ˜¾ç¤º"æœˆ-æ—¥ æ—¶:åˆ†"
        return date.toLocaleDateString('zh-CN', { 
          month: '2-digit', 
          day: '2-digit'
        }) + ' ' + date.toLocaleTimeString('zh-CN', { 
          hour: '2-digit', 
          minute: '2-digit'
        });
      }
    }

    // åˆ›å»ºæ–°èŠå¤©
    function createNewChat() {
      const chatId = generateId();
      const newChat = {
        id: chatId,
        name: 'æ–°èŠå¤©',
        type: 'single', // 'single' æˆ– 'group'
        avatar: DEFAULT_AI_AVATAR,
        lastMessage: '',
        lastTime: getCurrentTime(),
        conversationHistory: [],
        chatDisplay: [],
        // å•èŠè§’è‰²ä¿¡æ¯
        roleName: '',
        roleDescription: '',
        userName: '',
        userDescription: '',
        userAvatar: DEFAULT_USER_AVATAR,
        aiAvatar: DEFAULT_AI_AVATAR,
        // ç¾¤èŠè§’è‰²ä¿¡æ¯
        roles: [], // ç¾¤èŠä¸­çš„å¤šä¸ªè§’è‰²
        groupSettings: {
          maxRolesPerReply: 3, // æ¯æ¬¡æœ€å¤šå‡ ä¸ªè§’è‰²å›å¤
          replyDelay: 1000 // è§’è‰²å›å¤é—´éš”(ms)
        }
      };
      
      chatList.unshift(newChat); // æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
      saveChatList();
      renderChatList();
      
      // ç¡®ä¿æ–°èŠå¤©æ—¶æ¸…ç©ºAIè®°å¿†
      window.conversationHistory = [];
      console.log('æ–°å»ºèŠå¤©ï¼šå·²æ¸…ç©ºAIè®°å¿†');
      
      openChat(chatId);
    }

    // åˆ›å»ºæ–°ç¾¤èŠ
    function createNewGroupChat() {
      const chatId = generateId();
      const newChat = {
        id: chatId,
        name: 'æ–°ç¾¤èŠ',
        type: 'group',
        avatar: DEFAULT_AI_AVATAR,
        lastMessage: '',
        lastTime: getCurrentTime(),
        conversationHistory: [],
        chatDisplay: [],
        // å•èŠè§’è‰²ä¿¡æ¯ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
        roleName: '',
        roleDescription: '',
        userName: '',
        userDescription: '',
        userAvatar: DEFAULT_USER_AVATAR,
        aiAvatar: DEFAULT_AI_AVATAR,
        // ç¾¤èŠè§’è‰²ä¿¡æ¯
        roles: [], // ç¾¤èŠä¸­çš„å¤šä¸ªè§’è‰²
        groupSettings: {
          maxRolesPerReply: 3, // æ¯æ¬¡æœ€å¤šå‡ ä¸ªè§’è‰²å›å¤
          replyDelay: 1000 // è§’è‰²å›å¤é—´éš”(ms)
        }
      };
      
      chatList.unshift(newChat);
      saveChatList();
      renderChatList();
      
      // ç¡®ä¿æ–°ç¾¤èŠæ—¶æ¸…ç©ºAIè®°å¿†
      window.conversationHistory = [];
      console.log('æ–°å»ºç¾¤èŠï¼šå·²æ¸…ç©ºAIè®°å¿†');
      
      openChat(chatId);
    }

    // åˆ é™¤èŠå¤©
    function deleteChat(chatId) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèŠå¤©å—ï¼Ÿ')) {
        chatList = chatList.filter(chat => chat.id !== chatId);
        saveChatList();
        renderChatList();
        
        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰èŠå¤©ï¼Œè¿”å›åˆ—è¡¨
        if (currentChatId === chatId) {
          currentChatId = null;
          showChatList();
        }
      }
    }

    // æ‰“å¼€èŠå¤©
    function openChat(chatId) {
      const chat = chatList.find(c => c.id === chatId);
      if (!chat) return;
      
      currentChatId = chatId;
      
      // åŠ è½½èŠå¤©æ•°æ®
      loadChatData(chat);
      
      // æ˜¾ç¤ºèŠå¤©ç•Œé¢
      showChatView();
      
      // æ›´æ–°èŠå¤©æ ‡é¢˜
      updateChatHeader();
    }

    // åŠ è½½èŠå¤©æ•°æ®
    function loadChatData(chat) {
      // æ¸…ç†å“åº”çŠ¶æ€
      if (responseTimer) {
        clearTimeout(responseTimer);
        responseTimer = null;
      }
      isWaitingForResponse = false;
      pendingMessages = [];
      hideWaitingIndicator();
      updateSendButton();
      
      // é‡ç½®æ‹ä¸€æ‹è®¡æ—¶å™¨
      if (typeof resetActivityTimer === 'function') {
        resetActivityTimer();
      }
      
      // åŠ è½½è§’è‰²å’Œç”¨æˆ·è®¾å®š
      roleName = chat.roleName || '';
      roleDescription = chat.roleDescription || '';
      userName = chat.userName || '';
      userDescription = chat.userDescription || '';
      userAvatar = chat.userAvatar || DEFAULT_USER_AVATAR;
      aiAvatar = chat.aiAvatar || DEFAULT_AI_AVATAR;
      
      // æ›´æ–°ç•Œé¢æ˜¾ç¤º
      updateChatInterface(chat);
      
      // æ¸…ç©ºèŠå¤©ç•Œé¢
      chatBody.innerHTML = '';
      
      // æ¸…ç©ºå¹¶é‡æ–°åŠ è½½å¯¹è¯å†å²ï¼ˆç¡®ä¿AIåªèƒ½çœ‹åˆ°å½“å‰èŠå¤©çš„è®°å½•ï¼‰
      window.conversationHistory = chat.conversationHistory ? [...chat.conversationHistory] : [];
      console.log('å·²åŠ è½½èŠå¤©å¯¹è¯å†å²:', window.conversationHistory.length, 'æ¡');
      
      // æ¢å¤èŠå¤©è®°å½•
      if (chat.chatDisplay && chat.chatDisplay.length > 0) {
        chat.chatDisplay.forEach(msg => {
          if (msg.type === 'emoji') {
            // ä½¿ç”¨æ–°çš„è¡¨æƒ…åŒ…æ¶ˆæ¯åˆ›å»ºå‡½æ•°
            createEmojiMessage(msg.sender || msg.role, msg.content, msg.id, msg.timestamp, msg.roleId, msg.roleName);
          } else if (msg.type === 'location') {
            // ä½ç½®æ¶ˆæ¯
            appendMsg(msg.role, msg.content, false, msg.roleId, msg.roleName, msg.timestamp, msg.id, null, false, null, false, null, 'location');
          } else if (msg.type === 'transfer') {
            // è½¬è´¦æ¶ˆæ¯
            appendMsg(msg.role, msg.content, false, msg.roleId, msg.roleName, msg.timestamp, msg.id, null, false, null, false, null, 'transfer');
          } else if (msg.type === 'chatRecord') {
            // èŠå¤©è®°å½•æ¶ˆæ¯
            appendMsg(msg.role, '', false, msg.roleId, msg.roleName, msg.timestamp, msg.id, null, false, null, true, msg.chatRecordData);
          } else if (msg.type === 'forward') {
            // è½¬å‘æ¶ˆæ¯
            appendMsg(msg.role, msg.content, false, msg.roleId, msg.roleName, msg.timestamp, msg.id, null, true, msg.forwardFrom);
          } else if (msg.type === 'image') {
            // å›¾ç‰‡æ¶ˆæ¯
            appendMsg(msg.role, msg.content, false, msg.roleId, msg.roleName, msg.timestamp, msg.id, null, false, null, false, null, 'image');
          } else if (msg.type === 'pat') {
            // æ‹ä¸€æ‹æ¶ˆæ¯
            loadPatMessage(msg);
          } else {
            // æ™®é€šæ¶ˆæ¯ï¼ˆå¯èƒ½åŒ…å«å›å¤å¼•ç”¨ï¼‰
            appendMsg(msg.role, msg.content, false, msg.roleId, msg.roleName, msg.timestamp, msg.id, msg.replyTo);
          }
        });
        
        // æ›´æ–°ç°æœ‰æ¶ˆæ¯çš„æ“ä½œèœå•
        updateMenusAfterLoad();
      } else {
        // å³ä½¿æ²¡æœ‰èŠå¤©è®°å½•ï¼Œä¹Ÿè¦æ›´æ–°èœå•
        updateMenusAfterLoad();
      }
      
      // å¤„ç†å¾…å¤„ç†çš„è½¬å‘æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰
      if (chat.pendingMessages && chat.pendingMessages.length > 0) {
        chat.pendingMessages.forEach(pendingMsg => {
          if (pendingMsg.isForwarded) {
            // å°†è½¬å‘æ¶ˆæ¯æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè§¦å‘AIå›å¤
            pendingMessages.push({
              text: pendingMsg.text,
              chat: chat,
              timestamp: pendingMsg.timestamp,
              isForwarded: true
            });
          }
        });
        
        // æ¸…ç©ºå¾…å¤„ç†æ¶ˆæ¯
        chat.pendingMessages = [];
        
        // å¦‚æœæœ‰å¾…å¤„ç†æ¶ˆæ¯ï¼Œå¯åŠ¨AIå›å¤
        if (pendingMessages.length > 0) {
          if (aiResponseDelay === 0) {
            setTimeout(() => processMessages(), 500); // å»¶è¿Ÿç¡®ä¿UIå®Œå…¨åŠ è½½
          } else {
            startResponseTimer();
          }
        }
      }
    }

    // æ›´æ–°èŠå¤©ç•Œé¢æ˜¾ç¤º
    function updateChatInterface(chat) {
      // æ›´æ–°èŠå¤©ç±»å‹æ˜¾ç¤º
      if (chat.type === 'group') {
        chatTypeDisplay.textContent = 'ç¾¤èŠ';
        groupChatControls.style.display = 'block';
        singleRoleSettings.style.display = 'none';
        updateRolesList(chat);
        
        // æ›´æ–°ç¾¤èŠè®¾ç½®æ˜¾ç¤º
        const maxRolesSelect = document.getElementById('maxRolesPerReplySelect');
        if (maxRolesSelect && chat.groupSettings) {
          maxRolesSelect.value = chat.groupSettings.maxRolesPerReply || 3;
        }
      } else {
        chatTypeDisplay.textContent = 'å•èŠ';
        groupChatControls.style.display = 'none';
        singleRoleSettings.style.display = 'block';
        
        // æ›´æ–°å•èŠè§’è‰²è®¾å®šè¾“å…¥æ¡†
        roleNameInput.value = roleName;
        roleDescInput.value = roleDescription;
        aiAvatarInput.value = aiAvatar === DEFAULT_AI_AVATAR ? '' : aiAvatar;
        
        // æ›´æ–°è§†é¢‘é€šè¯ç”»é¢è®¾å®š
        const aiVideoInput = document.getElementById('aiVideoInput');
        if (aiVideoInput) {
          aiVideoInput.value = chat.aiVideo && chat.aiVideo !== aiAvatar ? chat.aiVideo : '';
        }
      }
      
      // æ›´æ–°ç”¨æˆ·è®¾å®šè¾“å…¥æ¡†ï¼ˆå¯¹å•èŠå’Œç¾¤èŠéƒ½æœ‰æ•ˆï¼‰
      userNameInput.value = userName;
      userDescInput.value = userDescription;
      userAvatarInput.value = userAvatar === DEFAULT_USER_AVATAR ? '' : userAvatar;
    }

    // æ›´æ–°ç¾¤èŠè§’è‰²åˆ—è¡¨æ˜¾ç¤º
    function updateRolesList(chat) {
      if (!chat || chat.type !== 'group') {
        rolesList.innerHTML = '';
        return;
      }
      
      if (chat.roles.length === 0) {
        rolesList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">è¿˜æ²¡æœ‰æ·»åŠ è§’è‰²ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>';
        return;
      }
      
      rolesList.innerHTML = chat.roles.map((role, index) => `
        <div class="role-item">
          <img class="role-item-avatar" src="${role.avatar || DEFAULT_AI_AVATAR}" alt="${role.name}" onerror="this.src='${DEFAULT_AI_AVATAR}'">
          <div class="role-item-info">
            <div class="role-item-name">${role.name || 'æœªå‘½åè§’è‰²'}</div>
            <div class="role-item-desc">${role.description ? (role.description.length > 50 ? role.description.substring(0, 50) + '...' : role.description) : 'æš‚æ— æè¿°'}</div>
            <div class="role-item-frequency">å›å¤é¢‘ç‡: ${getFrequencyText(role.frequency)}</div>
          </div>
          <div class="role-item-actions">
            <button class="role-item-btn edit" data-role-index="${index}">ç¼–è¾‘</button>
            <button class="role-item-btn delete" data-role-index="${index}">åˆ é™¤</button>
          </div>
        </div>
      `).join('');
      
      // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      rolesList.querySelectorAll('.role-item-btn.edit').forEach(btn => {
        btn.addEventListener('click', function() {
          const roleIndex = parseInt(this.getAttribute('data-role-index'));
          editRole(roleIndex);
        });
      });
      
      rolesList.querySelectorAll('.role-item-btn.delete').forEach(btn => {
        btn.addEventListener('click', function() {
          const roleIndex = parseInt(this.getAttribute('data-role-index'));
          deleteRole(roleIndex);
        });
      });
    }

    // è·å–é¢‘ç‡æ–‡æœ¬
    function getFrequencyText(frequency) {
      const frequencies = {
        'always': 'æ¯æ¬¡éƒ½å›å¤',
        'often': 'ç»å¸¸å›å¤',
        'sometimes': 'å¶å°”å›å¤',
        'rarely': 'å¾ˆå°‘å›å¤'
      };
      return frequencies[frequency] || 'æ¯æ¬¡éƒ½å›å¤';
    }

    // ä¿å­˜å½“å‰èŠå¤©æ•°æ®
    function saveCurrentChatData() {
      if (!currentChatId) return;
      
      const chat = chatList.find(c => c.id === currentChatId);
      if (!chat) return;
      
      // ä¿å­˜è§’è‰²å’Œç”¨æˆ·è®¾å®š
      chat.roleName = roleName;
      chat.roleDescription = roleDescription;
      chat.userName = userName;
      chat.userDescription = userDescription;
      chat.userAvatar = userAvatar;
      chat.aiAvatar = aiAvatar;
      
      // ä¿å­˜å¯¹è¯å†å²ï¼ˆä»å…¨å±€å˜é‡ï¼‰
      if (window.conversationHistory) {
        chat.conversationHistory = [...window.conversationHistory];
      }
      
      // ä¿å­˜ç•Œé¢æ˜¾ç¤º
      chat.chatDisplay = [];
      
      // è·å–æ‰€æœ‰æ¶ˆæ¯å…ƒç´ ï¼ˆåŒ…æ‹¬æ™®é€šæ¶ˆæ¯å’Œæ‹ä¸€æ‹æ¶ˆæ¯ï¼‰
      const allElements = chatBody.querySelectorAll('.msg, .pat-message');
      allElements.forEach(element => {
        // å¤„ç†æ‹ä¸€æ‹æ¶ˆæ¯
        if (element.classList.contains('pat-message')) {
          const content = element.querySelector('.pat-message-content');
          if (content) {
            // æŸ¥æ‰¾å½“å‰æ‹ä¸€æ‹æ¶ˆæ¯å‰é¢çš„æ—¶é—´å…ƒç´ 
            let timestamp = formatMessageTime();
            let prevElement = element.previousElementSibling;
            if (prevElement && prevElement.classList.contains('msg-time')) {
              const timeSpan = prevElement.querySelector('span');
              if (timeSpan) {
                timestamp = timeSpan.textContent;
              }
            }
            
            chat.chatDisplay.push({
              id: generateId(),
              type: 'pat',
              content: content.textContent,
              timestamp: timestamp
            });
          }
          return;
        }
        
        // å¤„ç†æ™®é€šæ¶ˆæ¯
        const msg = element;
        const isUser = msg.classList.contains('user');
        const bubble = msg.querySelector('.bubble');
        const isEmoji = bubble && bubble.classList.contains('emoji-bubble');
        const isLocation = bubble && bubble.classList.contains('location-bubble');
        const isTransfer = bubble && bubble.classList.contains('transfer-bubble');
        const roleNameElement = msg.querySelector('.role-name');
        
        // è·å–è§’è‰²ä¿¡æ¯ï¼ˆç”¨äºç¾¤èŠï¼‰
        let roleId = null;
        let roleName = null;
        
        // é¦–å…ˆå°è¯•ä»æ¶ˆæ¯å…ƒç´ çš„dataå±æ€§è·å–
        if (!isUser) {
          roleId = msg.getAttribute('data-role-id');
          roleName = msg.getAttribute('data-role-name');
        }
        
        // å¦‚æœæ²¡æœ‰ä»dataå±æ€§è·å–åˆ°ï¼Œå†ä»è§’è‰²åç§°å…ƒç´ è·å–
        if (!roleId && roleNameElement) {
          roleName = roleNameElement.textContent;
          // ä»å½“å‰èŠå¤©çš„è§’è‰²åˆ—è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„è§’è‰²ID
          if (chat.type === 'group' && chat.roles) {
            const roleData = chat.roles.find(r => r.name === roleName);
            if (roleData) {
              roleId = roleData.id;
            }
          }
        }
        
        // æŸ¥æ‰¾å½“å‰æ¶ˆæ¯å‰é¢çš„æ—¶é—´å…ƒç´ 
        let timestamp = formatMessageTime();
        let prevElement = msg.previousElementSibling;
        if (prevElement && prevElement.classList.contains('msg-time')) {
          const timeSpan = prevElement.querySelector('span');
          if (timeSpan) {
            timestamp = timeSpan.textContent;
          }
        }
        
        // è·å–æ¶ˆæ¯IDå’Œé™„åŠ ä¿¡æ¯
        const messageId = msg.getAttribute('data-message-id') || generateId();
        const forwardMessage = bubble.querySelector('.forward-message');
        const chatRecord = bubble.querySelector('.chat-record');
        const replyReference = bubble.querySelector('.reply-reference');
        const imageMessage = bubble.querySelector('.image-message');
        
        if (isEmoji) {
          const img = bubble.querySelector('img');
          chat.chatDisplay.push({
            id: messageId,
            role: isUser ? 'user' : 'ai',
            sender: isUser ? 'user' : 'ai',
            type: 'emoji',
            content: img.src,
            roleId: roleId,
            roleName: roleName,
            timestamp: timestamp
          });
        } else if (isLocation) {
          // ä½ç½®æ¶ˆæ¯
          chat.chatDisplay.push({
            id: messageId,
            role: isUser ? 'user' : 'ai',
            type: 'location',
            content: bubble.innerHTML, // ä¿å­˜å®Œæ•´çš„HTMLå†…å®¹
            roleId: roleId,
            roleName: roleName,
            timestamp: timestamp
          });
        } else if (isTransfer) {
          // è½¬è´¦æ¶ˆæ¯
          chat.chatDisplay.push({
            id: messageId,
            role: isUser ? 'user' : 'ai',
            type: 'transfer',
            content: bubble.innerHTML, // ä¿å­˜å®Œæ•´çš„HTMLå†…å®¹
            roleId: roleId,
            roleName: roleName,
            timestamp: timestamp
          });
        } else if (chatRecord) {
          // èŠå¤©è®°å½•æ¶ˆæ¯
          const chatRecordId = chatRecord.getAttribute('data-chat-record-id');
          // ä»å…¨å±€å­˜å‚¨ä¸­è·å–èŠå¤©è®°å½•æ•°æ®
          const chatRecordData = window.chatRecordsData && window.chatRecordsData[chatRecordId] || {
            messages: [],
            fromChat: 'æœªçŸ¥èŠå¤©'
          };
          
          chat.chatDisplay.push({
            id: messageId,
            role: isUser ? 'user' : 'ai',
            type: 'chatRecord',
            content: `èŠå¤©è®°å½• - ${chatRecordData.messages.length}æ¡æ¶ˆæ¯`,
            roleId: roleId,
            roleName: roleName,
            timestamp: timestamp,
            chatRecordData: chatRecordData
          });
        } else if (forwardMessage) {
          // è½¬å‘æ¶ˆæ¯
          const forwardContent = forwardMessage.querySelector('.forward-content');
          const forwardFromElement = forwardMessage.querySelector('.forward-header span:not(.icon)');
          chat.chatDisplay.push({
            id: messageId,
            role: isUser ? 'user' : 'ai',
            type: 'forward',
            content: forwardContent ? forwardContent.textContent : '',
            roleId: roleId,
            roleName: roleName,
            timestamp: timestamp,
            forwardFrom: {
              chatName: forwardFromElement ? forwardFromElement.textContent.replace('è½¬å‘è‡ª', '').replace('çš„èŠå¤©è®°å½•', '') : 'æœªçŸ¥æ¥æº'
            }
          });
        } else if (imageMessage) {
          // å›¾ç‰‡æ¶ˆæ¯
          chat.chatDisplay.push({
            id: messageId,
            role: isUser ? 'user' : 'ai',
            type: 'image',
            content: bubble.innerHTML, // ä¿å­˜å®Œæ•´çš„HTMLå†…å®¹
            roleId: roleId,
            roleName: roleName,
            timestamp: timestamp
          });
        } else {
          // æ™®é€šæ¶ˆæ¯
          let replyTo = null;
          if (replyReference) {
            const replyFromElement = replyReference.querySelector('.reply-from');
            const replyContentElement = replyReference.querySelector('.reply-content');
            replyTo = {
              fromName: replyFromElement ? replyFromElement.textContent : 'æœªçŸ¥',
              content: replyContentElement ? replyContentElement.textContent : ''
            };
          }
          
          // è·å–æ¶ˆæ¯çš„çº¯æ–‡æœ¬å†…å®¹ï¼ˆæ’é™¤å›å¤å¼•ç”¨ï¼‰
          let content = '';
          if (bubble) {
            // å…‹éš†èŠ‚ç‚¹ä»¥é¿å…ä¿®æ”¹åŸå§‹å†…å®¹
            const clonedBubble = bubble.cloneNode(true);
            // ç§»é™¤å›å¤å¼•ç”¨å…ƒç´ 
            const clonedReplyRef = clonedBubble.querySelector('.reply-reference');
            if (clonedReplyRef) {
              clonedReplyRef.remove();
            }
            content = clonedBubble.textContent || clonedBubble.innerText || '';
          }
          
          chat.chatDisplay.push({
            id: messageId,
            role: isUser ? 'user' : 'ai',
            type: 'text',
            content: content,
            roleId: roleId,
            roleName: roleName,
            timestamp: timestamp,
            replyTo: replyTo
          });
        }
      });
      
      // æ›´æ–°æœ€åæ¶ˆæ¯å’Œæ—¶é—´
      if (chat.chatDisplay.length > 0) {
        const lastMsg = chat.chatDisplay[chat.chatDisplay.length - 1];
        if (lastMsg.type === 'emoji') {
          chat.lastMessage = '[è¡¨æƒ…åŒ…]';
        } else if (lastMsg.type === 'location') {
          chat.lastMessage = '[ä½ç½®]';
        } else if (lastMsg.type === 'transfer') {
          chat.lastMessage = '[è½¬è´¦]';
        } else if (lastMsg.type === 'chatRecord') {
          chat.lastMessage = '[èŠå¤©è®°å½•]';
        } else if (lastMsg.type === 'forward') {
          chat.lastMessage = '[è½¬å‘æ¶ˆæ¯]';
        } else if (lastMsg.type === 'image') {
          chat.lastMessage = '[å›¾ç‰‡]';
        } else if (lastMsg.type === 'pat') {
          chat.lastMessage = '[æ‹ä¸€æ‹]';
        } else {
          chat.lastMessage = lastMsg.content.length > 30 
            ? lastMsg.content.substring(0, 30) + '...' 
            : lastMsg.content;
        }
        chat.lastTime = getCurrentTime();
      }
      
      // æ›´æ–°èŠå¤©åç§°ï¼ˆå¦‚æœæœ‰è§’è‰²åï¼‰
      if (roleName && chat.name === 'æ–°èŠå¤©') {
        chat.name = `ä¸${roleName}èŠå¤©`;
      }
      
      saveChatList();
      
      // æ›´æ–°é‡æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€
      updateRegenerateButtons();
    }

    // æ˜¾ç¤ºèŠå¤©åˆ—è¡¨
    function showChatList() {
      chatListView.classList.add('active');
      chatView.classList.remove('active');
      momentsView.classList.remove('active');
      renderChatList();
      
      // æ¸…é™¤æ‹ä¸€æ‹è®¡æ—¶å™¨
      if (inactivityTimer) {
        clearTimeout(inactivityTimer);
        inactivityTimer = null;
      }
    }

    // æ˜¾ç¤ºèŠå¤©ç•Œé¢
    function showChatView() {
      chatListView.classList.remove('active');
      chatView.classList.add('active');
      momentsView.classList.remove('active');
      
      // é‡ç½®æ‹ä¸€æ‹è®¡æ—¶å™¨
      if (typeof resetActivityTimer === 'function') {
        resetActivityTimer();
      }
    }

    // æ¸²æŸ“èŠå¤©åˆ—è¡¨
    function renderChatList() {
      if (chatList.length === 0) {
        emptyChatList.style.display = 'block';
        chatListBody.innerHTML = '';
        return;
      }
      
      emptyChatList.style.display = 'none';
      
      chatListBody.innerHTML = chatList.map(chat => {
        // è·å–æ˜¾ç¤ºæ ‡é¢˜ï¼šä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰æ ‡é¢˜ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤æ ‡é¢˜
        const displayTitle = chat.customTitle || getDisplayTitle(chat);
        
        return `
          <div class="chat-item" onclick="openChat('${chat.id}')">
            <img class="chat-item-avatar" src="${chat.aiAvatar || DEFAULT_AI_AVATAR}" alt="å¤´åƒ" onerror="this.src='${DEFAULT_AI_AVATAR}'">
            <div class="chat-item-content">
              <div class="chat-item-header">
                <div class="chat-item-name">
                  ${displayTitle}
                  ${chat.type === 'group' ? '<span class="group-chat-indicator">ç¾¤èŠ</span>' : ''}
                </div>
                <div class="chat-item-time">${formatTime(chat.lastTime)}</div>
              </div>
              <div class="chat-item-preview">${chat.lastMessage || 'å¼€å§‹æ–°çš„å¯¹è¯...'}</div>
            </div>
            <div class="chat-item-actions">
              <button class="chat-item-btn delete" data-chat-id="${chat.id}">åˆ é™¤</button>
            </div>
          </div>
        `;
      }).join('');
      
      // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      chatListBody.querySelectorAll('.chat-item-btn.delete').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
          const chatId = this.getAttribute('data-chat-id');
          deleteChat(chatId);
        });
      });
    }

    // ä¿å­˜èŠå¤©åˆ—è¡¨
    function saveChatList() {
      localStorage.setItem('aiChatList', JSON.stringify(chatList));
    }

    // åŠ è½½èŠå¤©åˆ—è¡¨
    function loadChatList() {
      const saved = localStorage.getItem('aiChatList');
      if (saved) {
        try {
          chatList = JSON.parse(saved);
          // å…¼å®¹æ—§ç‰ˆæœ¬æ•°æ®ï¼Œä¸ºæ—§èŠå¤©æ·»åŠ å¿…è¦å­—æ®µ
          chatList.forEach(chat => {
            if (!chat.type) {
              chat.type = 'single'; // é»˜è®¤ä¸ºå•èŠ
            }
            if (!chat.roles) {
              chat.roles = []; // åˆå§‹åŒ–è§’è‰²åˆ—è¡¨
            }
            if (!chat.groupSettings) {
              chat.groupSettings = {
                maxRolesPerReply: 3,
                replyDelay: 1000
              };
            }
          });
        } catch (e) {
          chatList = [];
        }
      }
    }

    // åˆå§‹åŒ–
    function init() {
      loadSettings();
      loadChatList();
      loadCustomPresets(); // åŠ è½½è‡ªå®šä¹‰é¢„è®¾
      loadLocationData(); // åŠ è½½ä½ç½®æ•°æ®
      loadTransferData(); // åŠ è½½è½¬è´¦æ•°æ®
      renderChatList();
      updateStatus();
      updateSendButton();
      
      // åˆå§‹åŒ–å¯¹è¯å†å²
      window.conversationHistory = [];
    }

    // åŠ è½½ä¿å­˜çš„è®¾ç½®
    function loadSettings() {
      // åŠ è½½APIé…ç½®
      loadApiConfigs();
      
      // åŠ è½½å½“å‰ä½¿ç”¨çš„APIé…ç½®
      currentApiConfigId = localStorage.getItem('currentApiConfigId');
      if (currentApiConfigId && savedApiConfigs[currentApiConfigId]) {
        const currentConfig = savedApiConfigs[currentApiConfigId];
        apiURL = currentConfig.url;
        apiKey = currentConfig.key;
        selectedModel = currentConfig.model || '';
        availableModels = currentConfig.models || [];
        
        // åŠ è½½è¯†å›¾APIé…ç½®
        visionApiURL = currentConfig.visionUrl || '';
        visionApiKey = currentConfig.visionKey || '';
        selectedVisionModel = currentConfig.visionModel || '';
        availableVisionModels = currentConfig.visionModels || [];
      } else {
        // å…¼å®¹æ—§ç‰ˆæœ¬ï¼ŒåŠ è½½æ—§çš„å•ä¸ªAPIé…ç½®
        apiURL = localStorage.getItem('aiChatApiUrl') || '';
        apiKey = localStorage.getItem('aiChatApiKey') || '';
        selectedModel = localStorage.getItem('aiChatModel') || '';
      }
      
      // åŠ è½½è¡¨æƒ…åŒ…æ•°æ®
      const savedEmojis = localStorage.getItem('aiChatEmojis');
      if (savedEmojis) {
        try {
          emojiData = JSON.parse(savedEmojis);
          // æ£€æŸ¥æ•°æ®å®Œæ•´æ€§ï¼Œå¦‚æœæ•°æ®ä¸ºç©ºæˆ–ä¸å®Œæ•´ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®
          if (!emojiData || Object.keys(emojiData).length === 0) {
            emojiData = JSON.parse(JSON.stringify(DEFAULT_EMOJIS));
            localStorage.setItem('aiChatEmojis', JSON.stringify(emojiData));
          }
        } catch (e) {
          console.error('è§£æè¡¨æƒ…åŒ…æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', e);
          emojiData = JSON.parse(JSON.stringify(DEFAULT_EMOJIS));
          localStorage.setItem('aiChatEmojis', JSON.stringify(emojiData));
        }
      } else {
        emojiData = JSON.parse(JSON.stringify(DEFAULT_EMOJIS));
        localStorage.setItem('aiChatEmojis', JSON.stringify(emojiData));
      }
      
      // åŠ è½½AIè®¾ç½®
      const savedContextLength = localStorage.getItem('aiContextLength');
      if (savedContextLength) {
        aiContextLength = parseInt(savedContextLength);
        if (isNaN(aiContextLength) || aiContextLength < 1 || aiContextLength > 50) {
          aiContextLength = 10; // é»˜è®¤å€¼
        }
      }
      
      const savedResponseDelay = localStorage.getItem('aiResponseDelay');
      if (savedResponseDelay) {
        aiResponseDelay = parseInt(savedResponseDelay);
        if (isNaN(aiResponseDelay) || aiResponseDelay < 0 || aiResponseDelay > 60) {
          aiResponseDelay = 0; // é»˜è®¤å€¼
        }
      }
      
      // åŠ è½½é¢„è®¾æç¤ºè¯
      const savedCustomPrompt = localStorage.getItem('aiCustomPrompt');
      if (savedCustomPrompt) {
        aiCustomPrompt = savedCustomPrompt;
        console.log('ğŸ”§ åŠ è½½é¢„è®¾æç¤ºè¯æˆåŠŸï¼Œé•¿åº¦:', aiCustomPrompt.length);
        console.log('ğŸ”§ é¢„è®¾æç¤ºè¯å†…å®¹:', aiCustomPrompt.substring(0, 100) + (aiCustomPrompt.length > 100 ? '...' : ''));
      } else {
        console.log('ğŸ”§ æœªæ‰¾åˆ°ä¿å­˜çš„é¢„è®¾æç¤ºè¯');
      }
      
      // åŠ è½½è‡ªå®šä¹‰å­—ä½“
      loadCustomFonts();
      
      // æ›´æ–°ç•Œé¢æ˜¾ç¤º
      updateApiSettingsUI();
      
      // åŠ è½½ä¿å­˜çš„æ¨¡å‹åˆ—è¡¨ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
      if (!currentApiConfigId) {
        const savedModels = localStorage.getItem('aiChatModels');
        if (savedModels) {
          availableModels = JSON.parse(savedModels);
        }
      }
      
      updateModelSelect();
      updateVisionModelSelect();
      updateChatHeader();
    }

    // ä¿å­˜APIè®¾ç½®
    function saveSettings() {
      // è·å–æ–°çš„è®¾ç½®å€¼
      apiURL = apiUrlInput.value.trim();
      apiKey = apiKeyInput.value.trim();
      selectedModel = modelSelect.value;
      
      // ä¿å­˜APIè®¾ç½®åˆ°localStorage
      localStorage.setItem('aiChatApiUrl', apiURL);
      localStorage.setItem('aiChatApiKey', apiKey);
      localStorage.setItem('aiChatModel', selectedModel);
      localStorage.setItem('aiChatModels', JSON.stringify(availableModels));
      
      updateStatus();
      updateSendButton();
      settingsPanel.classList.remove('show');
      showTestResult('APIè®¾ç½®å·²ä¿å­˜ï¼', 'success');
    }

    // APIé…ç½®ç®¡ç†å‡½æ•°
    
    // åŠ è½½APIé…ç½®
    function loadApiConfigs() {
      const saved = localStorage.getItem('savedApiConfigs');
      if (saved) {
        try {
          savedApiConfigs = JSON.parse(saved);
        } catch (e) {
          console.error('åŠ è½½APIé…ç½®å¤±è´¥:', e);
          savedApiConfigs = {};
        }
      }
      updateSavedApiSelect();
    }
    
    // ä¿å­˜APIé…ç½®åˆ°localStorage
    function saveApiConfigs() {
      localStorage.setItem('savedApiConfigs', JSON.stringify(savedApiConfigs));
    }
    
    // æ›´æ–°APIè®¾ç½®ç•Œé¢
    function updateApiSettingsUI() {
      apiUrlInput.value = apiURL;
      apiKeyInput.value = apiKey;
      
      // æ›´æ–°è¯†å›¾APIç•Œé¢
      visionApiUrlInput.value = visionApiURL;
      visionApiKeyInput.value = visionApiKey;
      
      // æ›´æ–°é…ç½®åç§°è¾“å…¥æ¡†
      if (currentApiConfigId && savedApiConfigs[currentApiConfigId]) {
        apiConfigNameInput.value = savedApiConfigs[currentApiConfigId].name;
        savedApiSelect.value = currentApiConfigId;
      } else {
        apiConfigNameInput.value = '';
        savedApiSelect.value = '';
      }
      
      updateSavedApiSelect();
      updateApiConfigButtons();
    }
    
    // æ›´æ–°å·²ä¿å­˜APIé€‰æ‹©æ¡†
    function updateSavedApiSelect() {
      savedApiSelect.innerHTML = '<option value="">é€‰æ‹©å·²ä¿å­˜çš„APIé…ç½®...</option>';
      
      Object.keys(savedApiConfigs).forEach(configId => {
        const config = savedApiConfigs[configId];
        const option = document.createElement('option');
        option.value = configId;
        option.textContent = config.name;
        if (configId === currentApiConfigId) {
          option.selected = true;
        }
        savedApiSelect.appendChild(option);
      });
    }
    
    // æ›´æ–°APIé…ç½®æŒ‰é’®çŠ¶æ€
    function updateApiConfigButtons() {
      const hasCurrentConfig = currentApiConfigId && savedApiConfigs[currentApiConfigId];
      const hasConfigName = apiConfigNameInput.value.trim() !== '';
      
      loadApiBtn.disabled = !savedApiSelect.value;
      deleteApiBtn.disabled = !savedApiSelect.value;
      updateCurrentBtn.disabled = !hasCurrentConfig || !hasConfigName;
      saveAsNewBtn.disabled = !hasConfigName;
    }
    
    // ç”Ÿæˆå”¯ä¸€ID
    function generateConfigId() {
      return 'config_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // ä¿å­˜ä¸ºæ–°é…ç½®
    function saveAsNewApiConfig() {
      const name = apiConfigNameInput.value.trim();
      const url = apiUrlInput.value.trim();
      const key = apiKeyInput.value.trim();
      
      if (!name) {
        alert('è¯·è¾“å…¥é…ç½®åç§°ï¼');
        return;
      }
      
      if (!url || !key) {
        alert('è¯·è¾“å…¥APIåœ°å€å’Œå¯†é’¥ï¼');
        return;
      }
      
      // æ£€æŸ¥åç§°æ˜¯å¦å·²å­˜åœ¨
      const existingId = Object.keys(savedApiConfigs).find(id => 
        savedApiConfigs[id].name === name
      );
      
      if (existingId) {
        if (!confirm(`é…ç½®åç§°"${name}"å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–ï¼Ÿ`)) {
          return;
        }
        // åˆ é™¤æ—§é…ç½®
        delete savedApiConfigs[existingId];
      }
      
      // åˆ›å»ºæ–°é…ç½®
      const configId = generateConfigId();
      savedApiConfigs[configId] = {
        name: name,
        url: url,
        key: key,
        model: selectedModel,
        models: [...availableModels],
        // è¯†å›¾APIé…ç½®
        visionUrl: visionApiURL,
        visionKey: visionApiKey,
        visionModel: selectedVisionModel,
        visionModels: [...availableVisionModels],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      
      // è®¾ç½®ä¸ºå½“å‰é…ç½®
      currentApiConfigId = configId;
      localStorage.setItem('currentApiConfigId', currentApiConfigId);
      
      // ä¿å­˜é…ç½®
      saveApiConfigs();
      updateApiSettingsUI();
      
      showTestResult(`APIé…ç½®"${name}"å·²ä¿å­˜ï¼`, 'success');
    }
    
    // æ›´æ–°å½“å‰é…ç½®
    function updateCurrentApiConfig() {
      if (!currentApiConfigId || !savedApiConfigs[currentApiConfigId]) {
        alert('æ²¡æœ‰é€‰ä¸­çš„é…ç½®å¯ä»¥æ›´æ–°ï¼');
        return;
      }
      
      const name = apiConfigNameInput.value.trim();
      const url = apiUrlInput.value.trim();
      const key = apiKeyInput.value.trim();
      
      if (!name) {
        alert('è¯·è¾“å…¥é…ç½®åç§°ï¼');
        return;
      }
      
      if (!url || !key) {
        alert('è¯·è¾“å…¥APIåœ°å€å’Œå¯†é’¥ï¼');
        return;
      }
      
      // æ£€æŸ¥åç§°å†²çªï¼ˆæ’é™¤å½“å‰é…ç½®ï¼‰
      const existingId = Object.keys(savedApiConfigs).find(id => 
        id !== currentApiConfigId && savedApiConfigs[id].name === name
      );
      
      if (existingId) {
        alert(`é…ç½®åç§°"${name}"å·²è¢«å…¶ä»–é…ç½®ä½¿ç”¨ï¼Œè¯·é€‰æ‹©å…¶ä»–åç§°ï¼`);
        return;
      }
      
      // æ›´æ–°é…ç½®
      savedApiConfigs[currentApiConfigId].name = name;
      savedApiConfigs[currentApiConfigId].url = url;
      savedApiConfigs[currentApiConfigId].key = key;
      savedApiConfigs[currentApiConfigId].model = selectedModel;
      savedApiConfigs[currentApiConfigId].models = [...availableModels];
      // æ›´æ–°è¯†å›¾APIé…ç½®
      savedApiConfigs[currentApiConfigId].visionUrl = visionApiURL;
      savedApiConfigs[currentApiConfigId].visionKey = visionApiKey;
      savedApiConfigs[currentApiConfigId].visionModel = selectedVisionModel;
      savedApiConfigs[currentApiConfigId].visionModels = [...availableVisionModels];
      savedApiConfigs[currentApiConfigId].updatedAt = new Date().toISOString();
      
      // æ›´æ–°å…¨å±€å˜é‡
      apiURL = url;
      apiKey = key;
      
      // ä¿å­˜é…ç½®
      saveApiConfigs();
      updateApiSettingsUI();
      
      showTestResult(`APIé…ç½®"${name}"å·²æ›´æ–°ï¼`, 'success');
    }
    
    // åŠ è½½é€‰ä¸­çš„APIé…ç½®
    function loadSelectedApiConfig() {
      const configId = savedApiSelect.value;
      if (!configId || !savedApiConfigs[configId]) {
        alert('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„APIé…ç½®ï¼');
        return;
      }
      
      const config = savedApiConfigs[configId];
      
      // æ›´æ–°ç•Œé¢
      apiUrlInput.value = config.url;
      apiKeyInput.value = config.key;
      apiConfigNameInput.value = config.name;
      
      // æ›´æ–°è¯†å›¾APIç•Œé¢
      visionApiUrlInput.value = config.visionUrl || '';
      visionApiKeyInput.value = config.visionKey || '';
      
      // æ›´æ–°å…¨å±€å˜é‡
      apiURL = config.url;
      apiKey = config.key;
      selectedModel = config.model || '';
      availableModels = config.models || [];
      
      // æ›´æ–°è¯†å›¾APIå…¨å±€å˜é‡
      visionApiURL = config.visionUrl || '';
      visionApiKey = config.visionKey || '';
      selectedVisionModel = config.visionModel || '';
      availableVisionModels = config.visionModels || [];
      
      // è®¾ç½®ä¸ºå½“å‰é…ç½®
      currentApiConfigId = configId;
      localStorage.setItem('currentApiConfigId', currentApiConfigId);
      
      // æ›´æ–°æ¨¡å‹é€‰æ‹©æ¡†
      updateModelSelect();
      updateVisionModelSelect();
      updateApiConfigButtons();
      
      showTestResult(`å·²åŠ è½½APIé…ç½®"${config.name}"ï¼`, 'success');
    }
    
    // åˆ é™¤é€‰ä¸­çš„APIé…ç½®
    function deleteSelectedApiConfig() {
      const configId = savedApiSelect.value;
      if (!configId || !savedApiConfigs[configId]) {
        alert('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„APIé…ç½®ï¼');
        return;
      }
      
      const config = savedApiConfigs[configId];
      
      if (!confirm(`ç¡®å®šè¦åˆ é™¤APIé…ç½®"${config.name}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
        return;
      }
      
      // åˆ é™¤é…ç½®
      delete savedApiConfigs[configId];
      
      // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é…ç½®ï¼Œæ¸…é™¤å½“å‰é…ç½®
      if (currentApiConfigId === configId) {
        currentApiConfigId = null;
        localStorage.removeItem('currentApiConfigId');
        
        // æ¸…ç©ºç•Œé¢
        apiUrlInput.value = '';
        apiKeyInput.value = '';
        apiConfigNameInput.value = '';
        modelSelect.innerHTML = '<option value="">è¯·å…ˆæµ‹è¯•è¿æ¥ä»¥è·å–å¯ç”¨æ¨¡å‹</option>';
        
        // æ¸…ç©ºå…¨å±€å˜é‡
        apiURL = '';
        apiKey = '';
        selectedModel = '';
        availableModels = [];
      }
      
      // ä¿å­˜é…ç½®
      saveApiConfigs();
      updateApiSettingsUI();
      
      showTestResult(`APIé…ç½®"${config.name}"å·²åˆ é™¤ï¼`, 'success');
    }
    
    // æ–°å»ºAPIé…ç½®
    function newApiConfig() {
      // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†
      apiUrlInput.value = '';
      apiKeyInput.value = '';
      apiConfigNameInput.value = '';
      savedApiSelect.value = '';
      modelSelect.innerHTML = '<option value="">è¯·å…ˆæµ‹è¯•è¿æ¥ä»¥è·å–å¯ç”¨æ¨¡å‹</option>';
      
      // æ¸…ç©ºè¯†å›¾APIè¾“å…¥æ¡†
      visionApiUrlInput.value = '';
      visionApiKeyInput.value = '';
      visionModelSelect.innerHTML = '<option value="">è¯·å…ˆæµ‹è¯•è¯†å›¾è¿æ¥ä»¥è·å–å¯ç”¨æ¨¡å‹</option>';
      
      // æ¸…ç©ºå…¨å±€å˜é‡
      apiURL = '';
      apiKey = '';
      selectedModel = '';
      availableModels = [];
      
      // æ¸…ç©ºè¯†å›¾APIå…¨å±€å˜é‡
      visionApiURL = '';
      visionApiKey = '';
      selectedVisionModel = '';
      availableVisionModels = [];
      
      currentApiConfigId = null;
      
      localStorage.removeItem('currentApiConfigId');
      updateApiConfigButtons();
      
      // èšç„¦åˆ°é…ç½®åç§°è¾“å…¥æ¡†
      apiConfigNameInput.focus();
      
      showTestResult('è¯·é…ç½®æ–°çš„APIä¿¡æ¯', 'info');
    }

    // ä¿å­˜è§’è‰²è®¾ç½®
    function saveRoleSettings() {
      // è·å–æ–°çš„è§’è‰²è®¾ç½®å€¼
      roleName = roleNameInput.value.trim();
      roleDescription = roleDescInput.value.trim();
      aiAvatar = aiAvatarInput.value.trim() || DEFAULT_AI_AVATAR;
      
      // ä¿å­˜è§†é¢‘é€šè¯ç”»é¢è®¾ç½®
      const aiVideo = document.getElementById('aiVideoInput').value.trim() || aiAvatar;
      if (currentChatId) {
        const chat = chatList.find(c => c.id === currentChatId);
        if (chat && chat.type === 'single') {
          chat.aiVideo = aiVideo;
        }
      }
      
      // ä¿å­˜ç¾¤èŠè®¾ç½®
      if (currentChatId) {
        const chat = chatList.find(c => c.id === currentChatId);
        if (chat && chat.type === 'group') {
          const maxRolesSelect = document.getElementById('maxRolesPerReplySelect');
          if (maxRolesSelect) {
            if (!chat.groupSettings) {
              chat.groupSettings = { replyDelay: 1000 };
            }
            chat.groupSettings.maxRolesPerReply = parseInt(maxRolesSelect.value);
            console.log(`ä¿å­˜ç¾¤èŠè®¾ç½®: æœ€å¤§å›å¤è§’è‰²æ•°=${chat.groupSettings.maxRolesPerReply}`);
          }
        }
      }
      
      // ä¿å­˜å½“å‰èŠå¤©æ•°æ®
      saveCurrentChatData();
      
      updateChatHeader();
      rolePanel.classList.remove('show');
      showTestResult('è§’è‰²è®¾å®šå·²ä¿å­˜ï¼', 'success');
    }

    // ä¿å­˜ç”¨æˆ·è®¾ç½®
    function saveUserSettings() {
      // è·å–æ–°çš„ç”¨æˆ·è®¾ç½®å€¼
      userName = userNameInput.value.trim();
      userDescription = userDescInput.value.trim();
      userAvatar = userAvatarInput.value.trim() || DEFAULT_USER_AVATAR;
      
      // ä¿å­˜å½“å‰èŠå¤©æ•°æ®
      saveCurrentChatData();
      
      updateChatHeader();
      userPanel.classList.remove('show');
      showTestResult('ç”¨æˆ·è®¾å®šå·²ä¿å­˜ï¼', 'success');
    }

    // è·å–APIè¯Šæ–­å»ºè®®
    function getDiagnosticSuggestion(url) {
      try {
        const hostname = new URL(url).hostname;
        
        if (hostname.includes('xcapi.top')) {
          return `è¿™æ˜¯xcapi.top APIæœåŠ¡ã€‚å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼š
          <br>1. <strong>CORSè·¨åŸŸé—®é¢˜</strong>ï¼šè¯¥APIä¸æ”¯æŒæµè§ˆå™¨ç›´æ¥è®¿é—®ï¼Œéœ€è¦é€šè¿‡ä»£ç†
          <br>2. <strong>æ¨èæ›¿ä»£æ–¹æ¡ˆ</strong>ï¼šä½¿ç”¨æ”¯æŒCORSçš„APIæœåŠ¡ï¼ˆå¦‚DeepSeek APIï¼‰
          <br>3. <strong>ä¸´æ—¶è§£å†³</strong>ï¼šä½¿ç”¨"ğŸ’¬ ç›´æ¥æµ‹è¯•èŠå¤©"æŒ‰é’®å°è¯•è¿æ¥
          <br>4. <strong>æŠ€æœ¯æ–¹æ¡ˆ</strong>ï¼šè®¾ç½®æœ¬åœ°ä»£ç†æœåŠ¡å™¨æˆ–ä½¿ç”¨æ¡Œé¢ç‰ˆAIå®¢æˆ·ç«¯`;
        } else if (hostname.includes('glamoth.ar26710.online')) {
          return 'è¯·æ£€æŸ¥æ­¤APIæœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œæˆ–å°è¯•è”ç³»æœåŠ¡æä¾›å•†ã€‚';
        } else if (hostname.includes('ai.nyabit.com')) {
          return 'è¯·ç¡®è®¤APIå¯†é’¥æ˜¯å¦æ­£ç¡®ï¼Œæˆ–æ£€æŸ¥æ­¤æœåŠ¡çš„çŠ¶æ€ã€‚';
        } else if (hostname.includes('api.openai.com')) {
          return 'è¯·æ£€æŸ¥OpenAI APIå¯†é’¥å’Œç½‘ç»œè¿æ¥ã€‚';
        } else if (hostname.includes('api.siliconflow.cn')) {
          return `è¿™æ˜¯ç¡…åŸºæµåŠ¨APIæœåŠ¡ã€‚å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼š
          <br>1. <strong>APIå¯†é’¥æ ¼å¼</strong>ï¼šç¡®è®¤å¯†é’¥æ ¼å¼æ­£ç¡®ï¼ˆé€šå¸¸ä»¥sk-å¼€å¤´ï¼‰
          <br>2. <strong>ç½‘ç»œè¿æ¥</strong>ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
          <br>3. <strong>APIç«¯ç‚¹</strong>ï¼šç¡®è®¤ä½¿ç”¨æ­£ç¡®çš„ç«¯ç‚¹ https://api.siliconflow.cn/v1
          <br>4. <strong>ä½™é¢æ£€æŸ¥</strong>ï¼šç™»å½•ç¡…åŸºæµåŠ¨å®˜ç½‘æ£€æŸ¥è´¦æˆ·ä½™é¢
          <br>5. <strong>æ¨¡å‹æƒé™</strong>ï¼šç¡®è®¤APIå¯†é’¥æœ‰æƒé™è®¿é—®æ‰€é€‰æ¨¡å‹
          <br>6. <strong>å®åè®¤è¯</strong>ï¼šéƒ¨åˆ†æ¨¡å‹éœ€è¦å®Œæˆå®åè®¤è¯æ‰èƒ½ä½¿ç”¨`;
        } else if (hostname.includes('generativelanguage.googleapis.com')) {
          return `è¯·æ£€æŸ¥Google APIå¯†é’¥æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆAIza...å¼€å¤´ï¼‰ã€‚
          <br><strong>å¦‚æœè¿æ¥å¤±è´¥ï¼Œå¯ä»¥å°è¯•ï¼š</strong>
          <br>1. ä½¿ç”¨ä»£ç†APIåœ°å€ï¼šhttps://generativelanguage.googleapis.com
          <br>2. æˆ–è€…ä½¿ç”¨ç¬¬ä¸‰æ–¹ä»£ç†ï¼šhttps://api.aihao123.cn/luomacode-api/open-ai/google/v1beta
          <br>3. æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé˜²ç«å¢™è®¾ç½®
          <br>4. ç¡®è®¤APIå¯†é’¥å·²å¯ç”¨Generative Language APIæœåŠ¡`;
        } else {
          return 'è¯·æ£€æŸ¥APIåœ°å€ã€å¯†é’¥æ˜¯å¦æ­£ç¡®ï¼Œæˆ–å°è¯•ä½¿ç”¨å…¶ä»–APIæœåŠ¡ã€‚';
        }
      } catch (e) {
        return 'è¯·æ£€æŸ¥APIé…ç½®æ˜¯å¦æ­£ç¡®ã€‚';
      }
    }

    // ç¡…åŸºæµåŠ¨APIç«¯ç‚¹åˆ—è¡¨
    const SILICONFLOW_API_ENDPOINTS = [
      'https://api.siliconflow.cn',
      'https://api-st.siliconflow.cn'
    ];

    // æ£€æµ‹å¹¶è·å–å¯ç”¨çš„ç¡…åŸºæµåŠ¨APIç«¯ç‚¹
    async function getWorkingSiliconflowEndpoint(originalUrl, apiKey) {
      if (!originalUrl.includes('siliconflow.cn')) {
        return originalUrl;
      }
      
      console.log('ğŸ” æ£€æµ‹å¯ç”¨çš„ç¡…åŸºæµåŠ¨APIç«¯ç‚¹...');
      
      for (const endpoint of SILICONFLOW_API_ENDPOINTS) {
        try {
          // æ›¿æ¢ç«¯ç‚¹åŸŸåï¼Œä¿æŒåŸæœ‰è·¯å¾„
          const testUrl = originalUrl.replace(/https:\/\/[^\/]+/, endpoint);
          console.log(`ğŸ§ª æµ‹è¯•ç«¯ç‚¹: ${endpoint}`);
          
          // å¿«é€Ÿè¿æ¥æµ‹è¯•
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000);
          
          const response = await fetch(testUrl, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json'
            },
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (response.status === 200 || response.status === 401 || response.status === 403) {
            console.log(`âœ… æ‰¾åˆ°å¯ç”¨ç«¯ç‚¹: ${endpoint}`);
            return testUrl;
          }
        } catch (error) {
          console.log(`âŒ ç«¯ç‚¹ä¸å¯ç”¨: ${endpoint} - ${error.message}`);
          continue;
        }
      }
      
      console.log('âš ï¸ æ‰€æœ‰ç¡…åŸºæµåŠ¨ç«¯ç‚¹éƒ½ä¸å¯ç”¨ï¼Œä½¿ç”¨åŸå§‹ç«¯ç‚¹');
      return originalUrl;
    }

    // ç¡…åŸºæµåŠ¨APIè¿æ¥åŠ©æ‰‹
    function showSiliconflowApiHelper() {
      const modal = document.createElement('div');
      modal.className = 'siliconflow-api-helper-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #2ecc71;">ğŸš€ ç¡…åŸºæµåŠ¨ API è¿æ¥åŠ©æ‰‹</h2>
            <button onclick="this.closest('.siliconflow-api-helper-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">Ã—</button>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="color: #333; margin-bottom: 10px;">ğŸ“‹ å¿«é€Ÿé…ç½®</h3>
            <div style="display: grid; gap: 10px;">
              <button class="helper-btn" onclick="setSiliconflowApiConfig('official')" style="padding: 12px; background: #2ecc71; color: white; border: none; border-radius: 8px; cursor: pointer;">
                ğŸ¢ å®˜æ–¹ç«¯ç‚¹ (æ¨è)
              </button>
              <button class="helper-btn" onclick="setSiliconflowApiConfig('international')" style="padding: 12px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer;">
                ğŸŒ å›½é™…ç«¯ç‚¹ (æµ·å¤–ç”¨æˆ·)
              </button>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="color: #333; margin-bottom: 10px;">ğŸ”§ è¿æ¥æµ‹è¯•</h3>
            <button id="testSiliconflowConnection" style="padding: 12px 20px; background: #e67e22; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%;">
              ğŸ§ª æµ‹è¯•ç¡…åŸºæµåŠ¨APIè¿æ¥
            </button>
            <div id="siliconflowTestResults" style="margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px; min-height: 50px; font-family: monospace; font-size: 12px;">
              ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <h3 style="color: #333; margin-bottom: 10px;">ğŸ’¡ å¸¸è§é—®é¢˜è§£å†³</h3>
            <div style="font-size: 14px; line-height: 1.6; color: #666;">
              <div style="margin-bottom: 10px;">
                <strong>1. APIå¯†é’¥è·å–ï¼š</strong><br>
                â€¢ è®¿é—® <a href="https://cloud.siliconflow.cn" target="_blank">ç¡…åŸºæµåŠ¨å®˜ç½‘</a> æ³¨å†Œè´¦å·<br>
                â€¢ åœ¨æ§åˆ¶å°ç”ŸæˆAPIå¯†é’¥ï¼ˆé€šå¸¸ä»¥sk-å¼€å¤´ï¼‰<br>
                â€¢ ç¡®ä¿è´¦æˆ·æœ‰è¶³å¤Ÿä½™é¢
              </div>
                             <div style="margin-bottom: 10px;">
                 <strong>2. è¿æ¥é—®é¢˜ï¼š</strong><br>
                 â€¢ æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>
                 â€¢ ç¡®è®¤APIç«¯ç‚¹åœ°å€æ­£ç¡®<br>
                 â€¢ æµ·å¤–ç”¨æˆ·å¯å°è¯•å›½é™…ç«¯ç‚¹
               </div>
               <div style="margin-bottom: 10px;">
                 <strong>3. 400é”™è¯¯ä¸“é¡¹è§£å†³ï¼š</strong><br>
                 â€¢ æ¨¡å‹åç§°é”™è¯¯ï¼ˆå¸¸è§åŸå› ï¼‰<br>
                 â€¢ è¯·æ±‚å‚æ•°æ ¼å¼ä¸æ­£ç¡®<br>
                 â€¢ æ¨¡å‹éœ€è¦ç‰¹æ®Šæƒé™æˆ–ä»˜è´¹<br>
                 â€¢ æ¨èä½¿ç”¨å…è´¹æ¨¡å‹ï¼šQwen/Qwen2.5-7B-Instruct
               </div>
                             <div style="margin-bottom: 10px;">
                 <strong>4. æƒé™é—®é¢˜ï¼š</strong><br>
                 â€¢ å®Œæˆå®åè®¤è¯ï¼ˆéƒ¨åˆ†æ¨¡å‹éœ€è¦ï¼‰<br>
                 â€¢ ç¡®è®¤APIå¯†é’¥æœ‰æƒé™è®¿é—®æ‰€é€‰æ¨¡å‹<br>
                 â€¢ æ£€æŸ¥è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³
               </div>
               <div style="margin-bottom: 10px;">
                 <strong>5. æ¨¡å‹é€‰æ‹©ï¼š</strong><br>
                â€¢ æ¨èä½¿ç”¨å…è´¹æ¨¡å‹è¿›è¡Œæµ‹è¯•<br>
                â€¢ å¸¸ç”¨æ¨¡å‹ï¼šQwen2.5-7B-Instructã€DeepSeek-V3ç­‰<br>
                â€¢ æŸ¥çœ‹ <a href="https://docs.siliconflow.cn" target="_blank">å®˜æ–¹æ–‡æ¡£</a> äº†è§£æ›´å¤š
              </div>
            </div>
          </div>
          
          <div style="text-align: center;">
            <button onclick="this.closest('.siliconflow-api-helper-modal').remove()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
              å…³é—­åŠ©æ‰‹
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // è®¾ç½®é…ç½®å‡½æ•°
      window.setSiliconflowApiConfig = function(type) {
        const apiUrlInput = document.getElementById('apiUrlInput');
        switch (type) {
          case 'official':
            apiUrlInput.value = 'https://api.siliconflow.cn/v1';
            break;
          case 'international':
            apiUrlInput.value = 'https://api-st.siliconflow.cn/v1';
            break;
        }
        alert(`å·²è®¾ç½®APIåœ°å€ä¸º: ${apiUrlInput.value}`);
      };
      
      // æµ‹è¯•è¿æ¥å‡½æ•°
      document.getElementById('testSiliconflowConnection').onclick = async function() {
        const testResults = document.getElementById('siliconflowTestResults');
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        
        if (!apiKey) {
          testResults.innerHTML = '<span style="color: #e74c3c;">âŒ è¯·å…ˆå¡«å†™APIå¯†é’¥</span>';
          return;
        }
        
        testResults.innerHTML = '<span style="color: #3498db;">ğŸ”„ æ­£åœ¨æµ‹è¯•ç¡…åŸºæµåŠ¨APIè¿æ¥...</span>';
        
        const endpoints = [
          { name: 'å›½å†…ç«¯ç‚¹', url: 'https://api.siliconflow.cn/v1' },
          { name: 'å›½é™…ç«¯ç‚¹', url: 'https://api-st.siliconflow.cn/v1' }
        ];
        
        let results = [];
        
        for (const endpoint of endpoints) {
          try {
            // å…ˆæµ‹è¯•æ¨¡å‹åˆ—è¡¨
            const modelsUrl = `${endpoint.url}/models`;
            
            const controller = new AbortController();
            setTimeout(() => controller.abort(), 8000);
            
            const modelsResponse = await fetch(modelsUrl, {
              method: 'GET',
              headers: {
                'Authorization': 'Bearer ' + apiKey,
                'Content-Type': 'application/json'
              },
              signal: controller.signal
            });
            
            if (modelsResponse.status === 200) {
              const data = await modelsResponse.json();
              const modelCount = data.data ? data.data.length : 0;
              
              // æµ‹è¯•èŠå¤©åŠŸèƒ½
              const chatUrl = `${endpoint.url}/chat/completions`;
              const testModel = 'Qwen/Qwen2.5-7B-Instruct'; // ä½¿ç”¨å…è´¹æ¨¡å‹æµ‹è¯•
              
              const chatController = new AbortController();
              setTimeout(() => chatController.abort(), 8000);
              
              const chatResponse = await fetch(chatUrl, {
                method: 'POST',
                headers: {
                  'Authorization': 'Bearer ' + apiKey,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: testModel,
                  messages: [{ role: 'user', content: 'hi' }],
                  max_tokens: 5
                }),
                signal: chatController.signal
              });
              
              if (chatResponse.status === 200) {
                results.push(`<span style="color: #27ae60;">âœ… ${endpoint.name}: å®Œå…¨æ­£å¸¸ (${modelCount}ä¸ªæ¨¡å‹ï¼ŒèŠå¤©æµ‹è¯•é€šè¿‡)</span>`);
              } else if (chatResponse.status === 400) {
                results.push(`<span style="color: #f39c12;">âš ï¸ ${endpoint.name}: æ¨¡å‹åˆ—è¡¨æ­£å¸¸ï¼Œä½†èŠå¤©æµ‹è¯•400é”™è¯¯ (å¯èƒ½æ˜¯æ¨¡å‹æƒé™é—®é¢˜)</span>`);
              } else {
                results.push(`<span style="color: #f39c12;">âš ï¸ ${endpoint.name}: æ¨¡å‹åˆ—è¡¨æ­£å¸¸ (${modelCount}ä¸ª)ï¼ŒèŠå¤©æµ‹è¯•HTTP ${chatResponse.status}</span>`);
              }
            } else if (modelsResponse.status === 401) {
              results.push(`<span style="color: #e74c3c;">âŒ ${endpoint.name}: APIå¯†é’¥æ— æ•ˆ</span>`);
            } else if (modelsResponse.status === 403) {
              results.push(`<span style="color: #f39c12;">âš ï¸ ${endpoint.name}: æƒé™ä¸è¶³ï¼Œå¯èƒ½éœ€è¦å®åè®¤è¯</span>`);
            } else {
              results.push(`<span style="color: #e74c3c;">âŒ ${endpoint.name}: HTTP ${modelsResponse.status}</span>`);
            }
          } catch (error) {
            if (error.name === 'AbortError') {
              results.push(`<span style="color: #e74c3c;">âŒ ${endpoint.name}: è¿æ¥è¶…æ—¶</span>`);
            } else {
              results.push(`<span style="color: #e74c3c;">âŒ ${endpoint.name}: ${error.message}</span>`);
            }
          }
        }
        
        testResults.innerHTML = results.join('<br>');
      };
      
      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      modal.onclick = function(e) {
        if (e.target === modal) {
          modal.remove();
        }
      };
    }

    // å¸¦é‡è¯•å’Œè¶…æ—¶çš„å¢å¼ºfetchå‡½æ•°
    async function fetchWithRetry(url, options = {}, retries = 3) {
      const timeout = options.timeout || 10000;
      const originalHeaders = options.headers || {};
      
      // å¦‚æœæ˜¯ç¡…åŸºæµåŠ¨APIï¼Œå°è¯•æ£€æµ‹æœ€ä½³ç«¯ç‚¹
      if (url.includes('api.siliconflow.cn') || url.includes('api-st.siliconflow.cn')) {
        try {
          url = await getWorkingSiliconflowEndpoint(url, options.headers?.Authorization);
        } catch (error) {
          console.warn('æ— æ³•æ£€æµ‹ç¡…åŸºæµåŠ¨APIç«¯ç‚¹ï¼Œä½¿ç”¨åŸå§‹URL:', error);
        }
      }
      
      // ä¸ºç¬¬ä¸‰æ–¹APIæ·»åŠ æ›´å¤šå…¼å®¹æ€§å¤´
      const enhancedHeaders = {
        ...originalHeaders,
        'User-Agent': 'Mozilla/5.0 (compatible; AI-Chat-Client/1.0)',
        'Accept': 'application/json, text/plain, */*',
        'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache'
      };
      
      // ç§»é™¤timeoutå±æ€§ï¼Œé¿å…ä¼ é€’ç»™fetch
      const fetchOptions = {
        ...options,
        headers: enhancedHeaders
      };
      delete fetchOptions.timeout;
      
      for (let i = 0; i < retries; i++) {
        try {
          console.log(`ğŸ”„ å°è¯•è¿æ¥ ${url} (ç¬¬${i + 1}æ¬¡)`);
          
          // åˆ›å»ºå¸¦è¶…æ—¶çš„fetchè¯·æ±‚
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), timeout);
          
          const response = await fetch(url, {
            ...fetchOptions,
            signal: controller.signal
          });
          
          clearTimeout(timeoutId);
          
          if (response.ok) {
            console.log(`âœ… è¿æ¥æˆåŠŸ: ${url}`);
            return response;
          } else {
            console.log(`âŒ HTTPé”™è¯¯ ${response.status}: ${url}`);
            if (i === retries - 1) return response; // æœ€åä¸€æ¬¡é‡è¯•ï¼Œè¿”å›å“åº”ä»¥ä¾¿æ˜¾ç¤ºé”™è¯¯
          }
        } catch (error) {
          console.log(`âŒ è¿æ¥å¤±è´¥ (ç¬¬${i + 1}æ¬¡): ${error.message}`);
          
          if (error.name === 'AbortError') {
            console.log(`â° è¿æ¥è¶…æ—¶ (${timeout}ms): ${url}`);
          }
          
          if (i === retries - 1) {
            // æœ€åä¸€æ¬¡é‡è¯•ï¼ŒæŠ›å‡ºå¢å¼ºçš„é”™è¯¯ä¿¡æ¯
                           if (error.name === 'AbortError') {
               throw new Error(`è¿æ¥è¶…æ—¶ (${timeout}ms)ã€‚${getDiagnosticSuggestion(url)}`);
             } else if (error.message.includes('CORS')) {
               const hostname = new URL(url).hostname;
               if (hostname.includes('xcapi.top')) {
                 throw new Error(`è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢ã€‚xcapi.top ä¸æ”¯æŒæµè§ˆå™¨ç›´æ¥è®¿é—®ã€‚å»ºè®®ï¼š1) ä½¿ç”¨æ”¯æŒCORSçš„APIæœåŠ¡ 2) é€šè¿‡ä»£ç†æœåŠ¡å™¨è®¿é—® 3) ä½¿ç”¨æ¡Œé¢ç‰ˆAIå®¢æˆ·ç«¯`);
               } else {
                 throw new Error(`è·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢ã€‚è¯¥APIå¯èƒ½ä¸æ”¯æŒæµè§ˆå™¨ç›´æ¥è®¿é—®ï¼Œè¯·å°è¯•å…¶ä»–APIæœåŠ¡ã€‚`);
               }
             } else if (error.message.includes('Failed to fetch')) {
             } else if (error.message.includes('Failed to fetch')) {
               throw new Error(`ç½‘ç»œè¿æ¥å¤±è´¥ã€‚${getDiagnosticSuggestion(url)}`);
             } else {
               throw error;
             }
          }
          
          // ç­‰å¾…1ç§’åé‡è¯•
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
    }

    // è·å–APIåŸºç¡€URLï¼ˆç”¨äºè·å–æ¨¡å‹åˆ—è¡¨ï¼‰
    function getApiBaseUrl(chatUrl) {
      try {
        const url = new URL(chatUrl);
        // å¯¹äºDeepSeek APIï¼ŒåŸºç¡€URLå°±æ˜¯å»æ‰è·¯å¾„éƒ¨åˆ†
        // ä¾‹å¦‚ï¼šhttps://api.deepseek.com/v1 -> https://api.deepseek.com
        if (url.hostname === 'api.deepseek.com') {
          return `${url.origin}`;
        } else if (url.hostname === 'api.siliconflow.cn' || url.hostname === 'api-st.siliconflow.cn') {
          // ç¡…åŸºæµåŠ¨APIï¼Œä¿æŒv1è·¯å¾„
          // ä¾‹å¦‚ï¼šhttps://api.siliconflow.cn/v1/chat/completions -> https://api.siliconflow.cn/v1
          return chatUrl.includes('/v1') ? chatUrl.replace(/\/chat\/completions$/, '') : `${url.origin}/v1`;
        }
        // å…¶ä»–APIæä¾›å•†çš„å¤„ç†
        const pathParts = url.pathname.split('/');
        // ç§»é™¤æœ€åçš„chat/completionséƒ¨åˆ†ï¼Œä¿ç•™åŸºç¡€è·¯å¾„
        const basePath = pathParts.slice(0, -2).join('/');
        return `${url.origin}${basePath}`;
      } catch (e) {
        return null;
      }
    }

    // æµ‹è¯•è¯†å›¾APIè¿æ¥
    async function testVisionConnection() {
      const url = visionApiUrlInput.value.trim();
      const key = visionApiKeyInput.value.trim();
      
      if (!url || !key) {
        showTestResult('è¯·å…ˆå¡«å†™è¯†å›¾APIåœ°å€å’Œå¯†é’¥ï¼', 'error');
        return;
      }
      
      testVisionBtn.disabled = true;
      testVisionBtn.textContent = 'æµ‹è¯•ä¸­...';
      showTestResult('æ­£åœ¨æµ‹è¯•è¯†å›¾APIè¿æ¥...', 'info');
      
      try {
        const response = await fetch(`${url}/models`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${key}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.data && Array.isArray(data.data)) {
          // è¿‡æ»¤å‡ºæ”¯æŒè§†è§‰çš„æ¨¡å‹
          const visionModels = data.data.filter(model => {
            const modelId = model.id.toLowerCase();
            return modelId.includes('vision') || 
                   modelId.includes('gpt-4') || 
                   modelId.includes('claude') ||
                   modelId.includes('gemini') ||
                   modelId.includes('qwen-vl') ||
                   modelId.includes('qwen2-vl') ||
                   modelId.includes('internvl') ||
                   modelId.includes('llava') ||
                   modelId.includes('minicpm') ||
                   modelId.includes('yi-vision') ||
                   modelId.includes('cogvlm') ||
                   modelId.includes('blip') ||
                   modelId.includes('flamingo') ||
                   modelId.includes('kosmos') ||
                   modelId.includes('pix2struct') ||
                   modelId.includes('instructblip') ||
                   // é€šç”¨è§†è§‰æ¨¡å‹å…³é”®è¯
                   modelId.includes('-v') ||
                   modelId.includes('visual') ||
                   modelId.includes('multimodal');
          });
          
          // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜ç¡®çš„è§†è§‰æ¨¡å‹ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹å¹¶æ·»åŠ æç¤º
          if (visionModels.length === 0) {
            console.log('æœªæ‰¾åˆ°æ˜ç¡®çš„è§†è§‰æ¨¡å‹ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹ä¾›ç”¨æˆ·é€‰æ‹©');
            availableVisionModels = data.data.map(model => model.id);
            updateVisionModelSelect();
            
            // æ›´æ–°å…¨å±€å˜é‡
            visionApiURL = url;
            visionApiKey = key;
            
            showTestResult(`è¯†å›¾APIè¿æ¥æˆåŠŸï¼æ‰¾åˆ° ${data.data.length} ä¸ªæ¨¡å‹ã€‚è¯·æ‰‹åŠ¨é€‰æ‹©æ”¯æŒè§†è§‰è¯†åˆ«çš„æ¨¡å‹ã€‚`, 'warning');
          } else {
            availableVisionModels = visionModels.map(model => model.id);
            updateVisionModelSelect();
            
            // æ›´æ–°å…¨å±€å˜é‡
            visionApiURL = url;
            visionApiKey = key;
            
            showTestResult(`è¯†å›¾APIè¿æ¥æˆåŠŸï¼æ‰¾åˆ° ${visionModels.length} ä¸ªæ”¯æŒè§†è§‰çš„æ¨¡å‹ã€‚`, 'success');
          }
        } else {
          showTestResult('è¯†å›¾APIè¿æ¥æˆåŠŸï¼Œä½†è¿”å›çš„æ¨¡å‹æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼', 'warning');
        }
      } catch (error) {
        console.error('è¯†å›¾APIè¿æ¥æµ‹è¯•å¤±è´¥:', error);
        showTestResult(`è¯†å›¾APIè¿æ¥å¤±è´¥: ${error.message}`, 'error');
      } finally {
        testVisionBtn.disabled = false;
        testVisionBtn.textContent = 'æµ‹è¯•è¯†å›¾è¿æ¥';
      }
    }
    
    // åˆ·æ–°è¯†å›¾æ¨¡å‹åˆ—è¡¨
    async function refreshVisionModels() {
      if (!visionApiURL || !visionApiKey) {
        showTestResult('è¯·å…ˆæµ‹è¯•è¯†å›¾APIè¿æ¥ï¼', 'error');
        return;
      }
      
      refreshVisionModelsBtn.disabled = true;
      refreshVisionModelsBtn.textContent = 'åˆ·æ–°ä¸­...';
      showTestResult('æ­£åœ¨åˆ·æ–°è¯†å›¾æ¨¡å‹åˆ—è¡¨...', 'info');
      
      try {
        const response = await fetch(`${visionApiURL}/models`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${visionApiKey}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.data && Array.isArray(data.data)) {
          // è¿‡æ»¤å‡ºæ”¯æŒè§†è§‰çš„æ¨¡å‹
          const visionModels = data.data.filter(model => {
            const modelId = model.id.toLowerCase();
            return modelId.includes('vision') || 
                   modelId.includes('gpt-4') || 
                   modelId.includes('claude') ||
                   modelId.includes('gemini') ||
                   modelId.includes('qwen-vl') ||
                   modelId.includes('qwen2-vl') ||
                   modelId.includes('internvl') ||
                   modelId.includes('llava') ||
                   modelId.includes('minicpm') ||
                   modelId.includes('yi-vision') ||
                   modelId.includes('cogvlm') ||
                   modelId.includes('blip') ||
                   modelId.includes('flamingo') ||
                   modelId.includes('kosmos') ||
                   modelId.includes('pix2struct') ||
                   modelId.includes('instructblip') ||
                   // é€šç”¨è§†è§‰æ¨¡å‹å…³é”®è¯
                   modelId.includes('-v') ||
                   modelId.includes('visual') ||
                   modelId.includes('multimodal');
          });
          
          // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜ç¡®çš„è§†è§‰æ¨¡å‹ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹å¹¶æ·»åŠ æç¤º
          if (visionModels.length === 0) {
            console.log('æœªæ‰¾åˆ°æ˜ç¡®çš„è§†è§‰æ¨¡å‹ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹ä¾›ç”¨æˆ·é€‰æ‹©');
            availableVisionModels = data.data.map(model => model.id);
            updateVisionModelSelect();
            showTestResult(`è¯†å›¾æ¨¡å‹åˆ—è¡¨åˆ·æ–°æˆåŠŸï¼æ‰¾åˆ° ${data.data.length} ä¸ªæ¨¡å‹ã€‚è¯·æ‰‹åŠ¨é€‰æ‹©æ”¯æŒè§†è§‰è¯†åˆ«çš„æ¨¡å‹ã€‚`, 'warning');
          } else {
            availableVisionModels = visionModels.map(model => model.id);
            updateVisionModelSelect();
            showTestResult(`è¯†å›¾æ¨¡å‹åˆ—è¡¨åˆ·æ–°æˆåŠŸï¼æ‰¾åˆ° ${visionModels.length} ä¸ªæ”¯æŒè§†è§‰çš„æ¨¡å‹ã€‚`, 'success');
          }
        } else {
          showTestResult('è¯†å›¾æ¨¡å‹åˆ—è¡¨åˆ·æ–°å¤±è´¥ï¼šè¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼', 'error');
        }
      } catch (error) {
        console.error('åˆ·æ–°è¯†å›¾æ¨¡å‹å¤±è´¥:', error);
        showTestResult(`åˆ·æ–°è¯†å›¾æ¨¡å‹å¤±è´¥: ${error.message}`, 'error');
      } finally {
        refreshVisionModelsBtn.disabled = false;
        refreshVisionModelsBtn.textContent = 'åˆ·æ–°è¯†å›¾æ¨¡å‹';
      }
    }
    
    // æ›´æ–°è¯†å›¾æ¨¡å‹é€‰æ‹©æ¡†
    function updateVisionModelSelect() {
      visionModelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¯†å›¾æ¨¡å‹</option>';
      
      availableVisionModels.forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        if (model === selectedVisionModel) {
          option.selected = true;
        }
        visionModelSelect.appendChild(option);
      });
    }
    
    // è°ƒè¯•è¯†å›¾æ¨¡å‹åˆ—è¡¨
    async function debugVisionModels() {
      const url = visionApiUrlInput.value.trim();
      const key = visionApiKeyInput.value.trim();
      
      if (!url || !key) {
        showTestResult('è¯·å…ˆå¡«å†™è¯†å›¾APIåœ°å€å’Œå¯†é’¥ï¼', 'error');
        return;
      }
      
      debugVisionModelsBtn.disabled = true;
      debugVisionModelsBtn.textContent = 'è°ƒè¯•ä¸­...';
      showTestResult('æ­£åœ¨è·å–æ‰€æœ‰æ¨¡å‹åˆ—è¡¨...', 'info');
      
      try {
        const response = await fetch(`${url}/models`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${key}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.data && Array.isArray(data.data)) {
          const allModels = data.data.map(model => model.id).sort();
          
          // åˆ›å»ºè°ƒè¯•ä¿¡æ¯
          let debugInfo = `<div style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">`;
          debugInfo += `<h4 style="margin: 0 0 10px 0; color: #333;">ğŸ“‹ æ‰€æœ‰å¯ç”¨æ¨¡å‹ (${allModels.length}ä¸ª)</h4>`;
          debugInfo += `<div style="font-size: 12px; color: #666; margin-bottom: 10px;">è¯·æŸ¥æ‰¾åŒ…å« visionã€gpt-4ã€claudeã€geminiã€qwen-vl ç­‰å…³é”®è¯çš„æ¨¡å‹</div>`;
          
          allModels.forEach(model => {
            const modelLower = model.toLowerCase();
            const isVisionModel = modelLower.includes('vision') || 
                                 modelLower.includes('gpt-4') || 
                                 modelLower.includes('claude') ||
                                 modelLower.includes('gemini') ||
                                 modelLower.includes('qwen-vl') ||
                                 modelLower.includes('qwen2-vl') ||
                                 modelLower.includes('internvl') ||
                                 modelLower.includes('llava') ||
                                 modelLower.includes('minicpm') ||
                                 modelLower.includes('yi-vision') ||
                                 modelLower.includes('cogvlm') ||
                                 modelLower.includes('-v') ||
                                 modelLower.includes('visual') ||
                                 modelLower.includes('multimodal');
            
            const color = isVisionModel ? '#28a745' : '#6c757d';
            const icon = isVisionModel ? 'ğŸ‘ï¸' : 'ğŸ’¬';
            debugInfo += `<div style="color: ${color}; margin: 3px 0; font-family: monospace; font-size: 11px;">${icon} ${model}</div>`;
          });
          
          debugInfo += `</div>`;
          
          showTestResult(`è¯†å›¾æ¨¡å‹è°ƒè¯•å®Œæˆï¼${debugInfo}`, 'info');
          
          // å¦‚æœæ‰¾åˆ°äº†è§†è§‰æ¨¡å‹ï¼Œè¯¢é—®æ˜¯å¦è¦è‡ªåŠ¨åŠ è½½æ‰€æœ‰æ¨¡å‹
          const visionModels = allModels.filter(model => {
            const modelLower = model.toLowerCase();
            return modelLower.includes('vision') || 
                   modelLower.includes('gpt-4') || 
                   modelLower.includes('claude') ||
                   modelLower.includes('gemini') ||
                   modelLower.includes('qwen-vl') ||
                   modelLower.includes('qwen2-vl') ||
                   modelLower.includes('internvl') ||
                   modelLower.includes('llava') ||
                   modelLower.includes('minicpm') ||
                   modelLower.includes('yi-vision') ||
                   modelLower.includes('cogvlm') ||
                   modelLower.includes('-v') ||
                   modelLower.includes('visual') ||
                   modelLower.includes('multimodal');
          });
          
          if (visionModels.length > 0) {
            if (confirm(`æ‰¾åˆ° ${visionModels.length} ä¸ªå¯èƒ½çš„è§†è§‰æ¨¡å‹ï¼Œæ˜¯å¦åŠ è½½åˆ°è¯†å›¾æ¨¡å‹åˆ—è¡¨ä¸­ï¼Ÿ`)) {
              availableVisionModels = visionModels;
              updateVisionModelSelect();
              visionApiURL = url;
              visionApiKey = key;
            }
          } else {
            if (confirm(`æ²¡æœ‰æ‰¾åˆ°æ˜ç¡®çš„è§†è§‰æ¨¡å‹ï¼Œæ˜¯å¦åŠ è½½æ‰€æœ‰ ${allModels.length} ä¸ªæ¨¡å‹ä¾›æ‰‹åŠ¨é€‰æ‹©ï¼Ÿ`)) {
              availableVisionModels = allModels;
              updateVisionModelSelect();
              visionApiURL = url;
              visionApiKey = key;
            }
          }
          
        } else {
          showTestResult('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥ï¼šè¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼', 'error');
        }
      } catch (error) {
        console.error('è°ƒè¯•è¯†å›¾æ¨¡å‹å¤±è´¥:', error);
        showTestResult(`è°ƒè¯•è¯†å›¾æ¨¡å‹å¤±è´¥: ${error.message}`, 'error');
      } finally {
        debugVisionModelsBtn.disabled = false;
        debugVisionModelsBtn.textContent = 'ğŸ” è°ƒè¯•è¯†å›¾æ¨¡å‹';
      }
    }
    
    // ç›´æ¥æµ‹è¯•èŠå¤©åŠŸèƒ½ï¼ˆè·³è¿‡æ¨¡å‹åˆ—è¡¨è·å–ï¼‰
    async function directChatTest() {
      const testApiUrl = apiUrlInput.value.trim();
      const testApiKey = apiKeyInput.value.trim();
      
      if (!testApiUrl || !testApiKey) {
        showTestResult('è¯·å…ˆå¡«å†™APIåœ°å€å’Œç§˜é’¥', 'error');
        return;
      }

      directChatTestBtn.disabled = true;
      directChatTestBtn.textContent = 'æµ‹è¯•ä¸­...';
      showTestResult('æ­£åœ¨ç›´æ¥æµ‹è¯•èŠå¤©åŠŸèƒ½...', 'info');

      try {
        // æ„å»ºèŠå¤©APIç«¯ç‚¹
        const chatEndpoint = getChatEndpoint(testApiUrl);
        
                 // å°è¯•å‡ ä¸ªå¸¸è§çš„æ¨¡å‹åç§°
         const testModels = [
           // ç¡…åŸºæµåŠ¨å¸¸ç”¨æ¨¡å‹
           'Qwen/Qwen2.5-7B-Instruct', 'deepseek-ai/DeepSeek-V3', 'THUDM/glm-4-9b-chat', 
           'Qwen/Qwen2.5-72B-Instruct', 'deepseek-ai/DeepSeek-R1', 'Qwen/Qwen2.5-14B-Instruct',
           // xcapi.top çš„æ¨¡å‹
           'gemini-2.5-pro-preview-03-25-2X', '[AWS]claude-3-5-sonnet-20241022', '[G]gemini-2.5-flash-preview-04-17',
           // é€šç”¨æ¨¡å‹
           'gpt-3.5-turbo', 'gpt-4', 'deepseek-chat', 'claude-3-haiku', 'gemini-pro', 'qwen-turbo', 'text-davinci-003'
         ];
        let successModel = null;
        let lastError = null;
        
        for (const testModel of testModels) {
          try {
            console.log(`ğŸ§ª æµ‹è¯•æ¨¡å‹: ${testModel}`);
            
            let testChatEndpoint, testHeaders, testBody;
            
            try {
              const url = new URL(testApiUrl);
              
              if (url.hostname === 'generativelanguage.googleapis.com') {
                // Google Gemini APIæµ‹è¯•
                testChatEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${testModel}:generateContent?key=${testApiKey}`;
                testHeaders = {
                  'Content-Type': 'application/json'
                };
                testBody = JSON.stringify({
                  contents: [{
                    role: 'user',
                    parts: [{ text: 'Hello' }]
                  }],
                  generationConfig: {
                    maxOutputTokens: 10
                  }
                });
              } else {
                // OpenAI/DeepSeekæ ¼å¼æµ‹è¯•
                testChatEndpoint = chatEndpoint;
                testHeaders = {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${testApiKey}`
                };
                testBody = JSON.stringify({
                  model: testModel,
                  messages: [{
                    role: "user",
                    content: "hello"
                  }],
                  max_tokens: 5
                });
              }
            } catch (e) {
              // é»˜è®¤ä½¿ç”¨OpenAIæ ¼å¼æµ‹è¯•
              testChatEndpoint = chatEndpoint;
              testHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${testApiKey}`
              };
              testBody = JSON.stringify({
                model: testModel,
                messages: [{
                  role: "user",
                  content: "hello"
                }],
                max_tokens: 5
              });
            }
            
            const response = await fetchWithRetry(testChatEndpoint, {
              method: 'POST',
              headers: testHeaders,
              body: testBody,
              timeout: 10000 // æ¯ä¸ªæ¨¡å‹æµ‹è¯•10ç§’è¶…æ—¶
            });

            if (response.ok) {
              const data = await response.json();
              console.log(`âœ… æ¨¡å‹ ${testModel} æµ‹è¯•æˆåŠŸ:`, data);
              
              successModel = testModel;
              
              // æ‰‹åŠ¨æ·»åŠ è¿™ä¸ªæ¨¡å‹åˆ°å¯ç”¨æ¨¡å‹åˆ—è¡¨
              availableModels = [{
                id: testModel,
                object: 'model',
                created: Date.now(),
                owned_by: 'api-provider'
              }];
              
              updateModelSelect();
              selectedModel = testModel;
              modelSelect.value = testModel;
              
              // æ›´æ–°å…¨å±€APIå˜é‡
              apiURL = testApiUrl;
              apiKey = testApiKey;
              
              break; // æ‰¾åˆ°å¯ç”¨æ¨¡å‹å°±åœæ­¢æµ‹è¯•
            } else {
              const errorData = await response.json().catch(() => ({}));
              lastError = `${response.status} - ${errorData.error?.message || response.statusText}`;
              console.log(`âŒ æ¨¡å‹ ${testModel} æµ‹è¯•å¤±è´¥:`, lastError);
            }
          } catch (error) {
            lastError = error.message;
            console.log(`âŒ æ¨¡å‹ ${testModel} æµ‹è¯•å¼‚å¸¸:`, error.message);
          }
        }
        
        if (successModel) {
          showTestResult(`ğŸ‰ ç›´æ¥æµ‹è¯•æˆåŠŸï¼æ‰¾åˆ°å¯ç”¨æ¨¡å‹: ${successModel}<br><small>å·²è‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰æ¨¡å‹ï¼Œå¯ä»¥å¼€å§‹èŠå¤©äº†</small>`, 'success');
          updateStatus();
        } else {
          showTestResult(`âŒ ç›´æ¥æµ‹è¯•å¤±è´¥ï¼Œæ‰€æœ‰æµ‹è¯•æ¨¡å‹éƒ½ä¸å¯ç”¨<br><small>æœ€åé”™è¯¯: ${lastError}</small><br><br>ğŸ’¡ å»ºè®®ï¼š<br>1. æ£€æŸ¥APIåœ°å€å’Œå¯†é’¥æ˜¯å¦æ­£ç¡®<br>2. å°è¯•ä½¿ç”¨"ğŸ” è°ƒè¯•æ¨¡å‹"æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯<br>3. è”ç³»APIæä¾›å•†ç¡®è®¤å¯ç”¨çš„æ¨¡å‹åç§°`, 'error');
        }
      } catch (error) {
        showTestResult(`ç›´æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      } finally {
        directChatTestBtn.disabled = false;
        directChatTestBtn.textContent = 'ğŸ’¬ ç›´æ¥æµ‹è¯•èŠå¤©';
      }
    }

    // æµ‹è¯•APIè¿æ¥
    async function testConnection() {
      const testApiUrl = apiUrlInput.value.trim();
      const testApiKey = apiKeyInput.value.trim();
      
      if (!testApiUrl || !testApiKey) {
        showTestResult('è¯·å…ˆå¡«å†™APIåœ°å€å’Œç§˜é’¥', 'error');
        return;
      }

      testBtn.disabled = true;
      refreshModelsBtn.disabled = true;
      testBtn.textContent = 'æµ‹è¯•ä¸­...';
      statusIndicator.className = 'status-indicator status-testing';
      showTestResult('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');

      try {
        // é¦–å…ˆå°è¯•è·å–æ¨¡å‹åˆ—è¡¨
        await fetchModels(testApiUrl, testApiKey);
        
        // æ„å»ºæ­£ç¡®çš„èŠå¤©APIç«¯ç‚¹
        const chatEndpoint = getChatEndpoint(testApiUrl);
        
        // å¦‚æœè·å–æ¨¡å‹åˆ—è¡¨æˆåŠŸï¼Œå†æµ‹è¯•ä¸€ä¸ªç®€å•çš„èŠå¤©è¯·æ±‚
        let testModel;
        if (availableModels.length > 0) {
          testModel = availableModels[0].id;
        } else {
          // æ ¹æ®APIæä¾›å•†é€‰æ‹©åˆé€‚çš„é»˜è®¤æ¨¡å‹
          const url = new URL(testApiUrl);
          if (url.hostname === 'api.siliconflow.cn' || url.hostname === 'api-st.siliconflow.cn') {
            testModel = 'Qwen/Qwen2.5-7B-Instruct'; // ç¡…åŸºæµåŠ¨çš„å…è´¹æ¨¡å‹
          } else if (url.hostname === 'api.deepseek.com') {
            testModel = 'deepseek-chat';
          } else if (url.hostname === 'generativelanguage.googleapis.com') {
            testModel = 'gemini-pro';
          } else {
            testModel = 'gpt-3.5-turbo'; // é»˜è®¤OpenAIæ ¼å¼
          }
        }
        
        let testChatEndpoint, testHeaders, testBody;
        
        try {
          const url = new URL(testApiUrl);
          
          if (url.hostname === 'generativelanguage.googleapis.com') {
            // Google Gemini APIæµ‹è¯•
            testChatEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${testModel}:generateContent?key=${testApiKey}`;
            testHeaders = {
              'Content-Type': 'application/json'
            };
            testBody = JSON.stringify({
              contents: [{
                role: 'user',
                parts: [{ text: 'Hello' }]
              }],
              generationConfig: {
                maxOutputTokens: 10
              }
            });
          } else {
            // OpenAI/DeepSeekæ ¼å¼æµ‹è¯•
            testChatEndpoint = chatEndpoint;
            testHeaders = {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${testApiKey}`
            };
            testBody = JSON.stringify({
              model: testModel,
              messages: [{
                role: "user",
                content: "hello"
              }],
              max_tokens: 5
            });
          }
        } catch (e) {
          // é»˜è®¤ä½¿ç”¨OpenAIæ ¼å¼æµ‹è¯•
          testChatEndpoint = chatEndpoint;
          testHeaders = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${testApiKey}`
          };
          testBody = JSON.stringify({
            model: testModel,
            messages: [{
              role: "user",
              content: "hello"
            }],
            max_tokens: 5
          });
        }
        
        const response = await fetchWithRetry(testChatEndpoint, {
          method: 'POST',
          headers: testHeaders,
          body: testBody,
          timeout: 15000 // æµ‹è¯•è¿æ¥ä½¿ç”¨15ç§’è¶…æ—¶
        });

        if (response.ok) {
          showTestResult(`è¿æ¥æˆåŠŸï¼æ£€æµ‹åˆ° ${availableModels.length} ä¸ªå¯ç”¨æ¨¡å‹`, 'success');
          
          // æ›´æ–°å…¨å±€APIå˜é‡
          apiURL = testApiUrl;
          apiKey = testApiKey;
          
          // å¦‚æœå½“å‰æœ‰é…ç½®IDï¼Œè‡ªåŠ¨æ›´æ–°é…ç½®çš„æ¨¡å‹ä¿¡æ¯
          if (currentApiConfigId && savedApiConfigs[currentApiConfigId]) {
            savedApiConfigs[currentApiConfigId].models = [...availableModels];
            savedApiConfigs[currentApiConfigId].updatedAt = new Date().toISOString();
            saveApiConfigs();
          }
          
          updateStatus();
        } else {
          const errorData = await response.json().catch(() => ({}));
          let errorMessage = `è¿æ¥å¤±è´¥: ${response.status} - ${errorData.error?.message || response.statusText}`;
          
          // ä¸ºç¡…åŸºæµåŠ¨APIæ·»åŠ ç‰¹æ®Šçš„400é”™è¯¯å¤„ç†
          const url = new URL(testApiUrl);
          if ((url.hostname === 'api.siliconflow.cn' || url.hostname === 'api-st.siliconflow.cn') && response.status === 400) {
            errorMessage += `<br><br>ğŸ” <strong>ç¡…åŸºæµåŠ¨API 400é”™è¯¯å¯èƒ½åŸå› ï¼š</strong>
            <br>â€¢ æ¨¡å‹åç§°ä¸æ­£ç¡®ï¼ˆå½“å‰æµ‹è¯•: ${testModel}ï¼‰
            <br>â€¢ è¯·æ±‚å‚æ•°æ ¼å¼æœ‰è¯¯
            <br>â€¢ è¯¥æ¨¡å‹éœ€è¦ç‰¹æ®Šæƒé™æˆ–å®åè®¤è¯
            <br>â€¢ APIå¯†é’¥æƒé™ä¸è¶³
            <br><br>ğŸ’¡ <strong>å»ºè®®è§£å†³æ–¹æ¡ˆï¼š</strong>
            <br>1. ä½¿ç”¨"ğŸ’¬ ç›´æ¥æµ‹è¯•èŠå¤©"æŒ‰é’®å°è¯•å¤šä¸ªæ¨¡å‹
            <br>2. æ£€æŸ¥ç¡…åŸºæµåŠ¨å®˜ç½‘çš„å¯ç”¨æ¨¡å‹åˆ—è¡¨
            <br>3. ç¡®è®¤è´¦æˆ·å·²å®Œæˆå®åè®¤è¯
            <br>4. è”ç³»ç¡…åŸºæµåŠ¨æŠ€æœ¯æ”¯æŒ`;
          }
          
          showTestResult(errorMessage, 'error');
        }
      } catch (error) {
        showTestResult(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
      } finally {
        testBtn.disabled = false;
        refreshModelsBtn.disabled = false;
        testBtn.textContent = 'æµ‹è¯•è¿æ¥';
        updateStatus();
      }
    }

    // è·å–èŠå¤©APIç«¯ç‚¹
    function getChatEndpoint(baseUrl) {
      try {
        const url = new URL(baseUrl);
        if (url.hostname === 'api.deepseek.com') {
          // DeepSeek APIæ ¼å¼: https://api.deepseek.com/chat/completions
          return `${url.origin}/chat/completions`;
        } else if (url.hostname === 'api.siliconflow.cn') {
          // ç¡…åŸºæµåŠ¨APIæ ¼å¼: https://api.siliconflow.cn/v1/chat/completions
          return baseUrl.endsWith('/chat/completions') ? baseUrl : `${baseUrl}/chat/completions`;
        } else if (url.hostname === 'generativelanguage.googleapis.com') {
          // Google Gemini APIæ ¼å¼: https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent
          return `${url.origin}/v1beta/models`; // åŸºç¡€URLï¼Œå…·ä½“æ¨¡å‹åœ¨å‘é€æ—¶æ·»åŠ 
        }
        // å…¶ä»–APIæä¾›å•†ï¼Œå‡è®¾æ˜¯OpenAIæ ¼å¼
        return baseUrl.endsWith('/chat/completions') ? baseUrl : `${baseUrl}/chat/completions`;
      } catch (e) {
        return baseUrl;
      }
    }

    // è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
    async function fetchModels(testApiUrl = null, testApiKey = null) {
      const useApiUrl = testApiUrl || apiURL;
      const useApiKey = testApiKey || apiKey;
      
      if (!useApiUrl || !useApiKey) {
        showTestResult('è¯·å…ˆå¡«å†™APIåœ°å€å’Œç§˜é’¥', 'error');
        return;
      }

      const baseUrl = getApiBaseUrl(useApiUrl);
      if (!baseUrl) {
        showTestResult('æ— æ³•è§£æAPIåœ°å€ï¼Œè¯·æ£€æŸ¥æ ¼å¼', 'error');
        return;
      }

      // æ„å»ºæ¨¡å‹åˆ—è¡¨APIç«¯ç‚¹å’Œè¯·æ±‚å¤´
      let modelsUrl;
      let headers = {};
      
      try {
        const url = new URL(baseUrl);
        
        if (url.hostname === 'api.deepseek.com') {
          // DeepSeek APIæ ¼å¼: https://api.deepseek.com/models
          modelsUrl = `${url.origin}/models`;
          headers = {
            'Authorization': `Bearer ${useApiKey}`
          };
        } else if (url.hostname === 'api.siliconflow.cn') {
          // ç¡…åŸºæµåŠ¨APIæ ¼å¼: https://api.siliconflow.cn/v1/models
          modelsUrl = baseUrl.endsWith('/models') ? baseUrl : `${baseUrl}/models`;
          headers = {
            'Authorization': `Bearer ${useApiKey}`,
            'Content-Type': 'application/json'
          };
        } else if (url.hostname === 'generativelanguage.googleapis.com') {
          // Google Gemini APIæ ¼å¼: https://generativelanguage.googleapis.com/v1beta/models
          modelsUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${useApiKey}`;
          headers = {
            'Content-Type': 'application/json'
          }; // Gemini APIä½¿ç”¨URLå‚æ•°ä¼ é€’key
        } else if (url.hostname === 'xcapi.top') {
          // xcapi.top APIæ ¼å¼: http://xcapi.top/v1/models
          modelsUrl = `${baseUrl}/models`;
          headers = {
            'Authorization': `Bearer ${useApiKey}`,
            'Content-Type': 'application/json'
          };
        } else {
          // å…¶ä»–APIæä¾›å•†æ ¼å¼
          // å¦‚æœURLå·²ç»åŒ…å«v1ï¼Œç›´æ¥æ·»åŠ /models
          // å¦‚æœä¸åŒ…å«ï¼Œæ·»åŠ /v1/models
          if (baseUrl.includes('/v1')) {
            modelsUrl = `${baseUrl}/models`;
          } else {
            modelsUrl = `${baseUrl}/v1/models`;
          }
          headers = {
            'Authorization': `Bearer ${useApiKey}`
          };
        }
      } catch (e) {
        // å¼‚å¸¸æƒ…å†µä¸‹çš„é»˜è®¤å¤„ç†
        if (baseUrl.includes('/v1')) {
          modelsUrl = `${baseUrl}/models`;
        } else {
          modelsUrl = `${baseUrl}/models`;
        }
        headers = {
          'Authorization': `Bearer ${useApiKey}`
        };
      }
      
      try {
        // ä¸ºç¬¬ä¸‰æ–¹APIæ·»åŠ å¢å¼ºçš„è¯·æ±‚å¤„ç†
        const response = await fetchWithRetry(modelsUrl, {
          method: 'GET',
          headers: headers,
          timeout: 10000 // 10ç§’è¶…æ—¶
        });

        if (response.ok) {
          const data = await response.json();
          console.log('åŸå§‹æ¨¡å‹æ•°æ®:', data); // è°ƒè¯•ä¿¡æ¯
          
          // å¤„ç†ä¸åŒAPIæä¾›å•†çš„å“åº”æ ¼å¼
          let models = [];
          if (data.data && Array.isArray(data.data)) {
            // OpenAI/DeepSeekæ ¼å¼
            models = data.data;
          } else if (data.models && Array.isArray(data.models)) {
            // Google Geminiæ ¼å¼
            models = data.models.map(model => ({
              id: model.name.replace('models/', ''), // ç§»é™¤ "models/" å‰ç¼€
              object: model.object || 'model',
              created: model.created || Date.now(),
              owned_by: model.owned_by || 'google'
            }));
          } else if (Array.isArray(data)) {
            // ç›´æ¥æ˜¯æ•°ç»„æ ¼å¼
            models = data;
          }
          
          console.log('è§£æåçš„æ¨¡å‹æ•°æ®:', models); // è°ƒè¯•ä¿¡æ¯
          
          if (models.length > 0) {
            const url = new URL(baseUrl);
            
            if (url.hostname === 'api.deepseek.com') {
              // DeepSeekçš„æ¨¡å‹è¿‡æ»¤
              availableModels = models
                .filter(model => model.id && model.id.includes('deepseek'))
                .sort((a, b) => a.id.localeCompare(b.id));
            } else if (url.hostname === 'api.siliconflow.cn' || url.hostname === 'api-st.siliconflow.cn') {
              // ç¡…åŸºæµåŠ¨çš„æ¨¡å‹è¿‡æ»¤
              availableModels = models
                .filter(model => {
                  if (!model.id) return false;
                  
                  // ç¡…åŸºæµåŠ¨å¸¸è§çš„æ¨¡å‹å…³é”®è¯
                  const siliconflowKeywords = [
                    'Qwen', 'deepseek', 'glm', 'chatglm', 'THUDM', 'internlm',
                    'Yi', 'Baichuan', 'Meta-Llama', 'claude', 'gemini'
                  ];
                  
                  const modelId = model.id;
                  return siliconflowKeywords.some(keyword => 
                    modelId.includes(keyword) || modelId.toLowerCase().includes(keyword.toLowerCase())
                  );
                })
                .sort((a, b) => a.id.localeCompare(b.id));
                
              // å¦‚æœæ²¡æœ‰åŒ¹é…çš„æ¨¡å‹ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹
              if (availableModels.length === 0) {
                availableModels = models
                  .filter(model => model.id)
                  .sort((a, b) => a.id.localeCompare(b.id));
              }
            } else if (url.hostname === 'generativelanguage.googleapis.com') {
              // Google Geminiçš„æ¨¡å‹è¿‡æ»¤
              availableModels = models
                .filter(model => model.id && model.id.includes('gemini'))
                .sort((a, b) => a.id.localeCompare(b.id));
            } else {
              // å…¶ä»–æä¾›å•† - æ›´å®½æ¾çš„è¿‡æ»¤ç­–ç•¥
              availableModels = models.filter(model => {
                // ç¡®ä¿æ¨¡å‹æœ‰ID
                if (!model.id) return false;
                
                // å¸¸è§çš„AIæ¨¡å‹å…³é”®è¯
                const modelKeywords = [
                  'gpt', 'claude', 'llama', 'deepseek', 'gemini', 
                  'qwen', 'mixtral', 'yi', 'baichuan', 'chatglm',
                  'vicuna', 'alpaca', 'text', 'davinci', 'ada',
                  'babbage', 'curie', 'turbo', 'instruct', 'chat'
                ];
                
                const modelId = model.id.toLowerCase();
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»»ä½•AIæ¨¡å‹å…³é”®è¯
                const hasModelKeyword = modelKeywords.some(keyword => 
                  modelId.includes(keyword)
                );
                
                // å¦‚æœåŒ…å«å…³é”®è¯ï¼Œåˆ™åŒ…å«è¯¥æ¨¡å‹
                if (hasModelKeyword) return true;
                
                // å¦‚æœæ²¡æœ‰å…³é”®è¯åŒ¹é…ï¼Œä½†æ¨¡å‹çœ‹èµ·æ¥åƒæ˜¯å¯¹è¯æ¨¡å‹ï¼Œä¹ŸåŒ…å«è¿›æ¥
                // æ’é™¤æ˜æ˜¾çš„éå¯¹è¯æ¨¡å‹ï¼ˆå¦‚åµŒå…¥æ¨¡å‹ã€å›¾åƒæ¨¡å‹ç­‰ï¼‰
                const excludeKeywords = [
                  'embedding', 'embed', 'whisper', 'tts', 'dall-e', 
                  'vision', 'moderation', 'search', 'similarity'
                ];
                
                const hasExcludeKeyword = excludeKeywords.some(keyword => 
                  modelId.includes(keyword)
                );
                
                return !hasExcludeKeyword;
              }).sort((a, b) => a.id.localeCompare(b.id));
              
              // å¦‚æœè¿‡æ»¤åæ²¡æœ‰æ¨¡å‹ï¼Œåˆ™æ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹ï¼ˆå¯èƒ½æ˜¯æ–°çš„æˆ–ä¸å¸¸è§çš„æ¨¡å‹ï¼‰
              if (availableModels.length === 0) {
                console.log('æ²¡æœ‰åŒ¹é…çš„æ¨¡å‹ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹');
                availableModels = models
                  .filter(model => model.id) // åªè¦æœ‰IDå°±æ˜¾ç¤º
                  .sort((a, b) => a.id.localeCompare(b.id));
              }
            }
            
            console.log('è¿‡æ»¤åçš„å¯ç”¨æ¨¡å‹:', availableModels); // è°ƒè¯•ä¿¡æ¯
            
            updateModelSelect();
            localStorage.setItem('aiChatModels', JSON.stringify(availableModels));
            
            // å¦‚æœå½“å‰æœ‰é…ç½®IDï¼Œè‡ªåŠ¨æ›´æ–°é…ç½®çš„æ¨¡å‹ä¿¡æ¯
            if (currentApiConfigId && savedApiConfigs[currentApiConfigId]) {
              savedApiConfigs[currentApiConfigId].models = [...availableModels];
              savedApiConfigs[currentApiConfigId].updatedAt = new Date().toISOString();
              saveApiConfigs();
            }
            
            if (!testApiUrl) { // åªåœ¨ä¸»åŠ¨åˆ·æ–°æ—¶æ˜¾ç¤ºæ¶ˆæ¯
              showTestResult(`æˆåŠŸè·å– ${availableModels.length} ä¸ªå¯ç”¨æ¨¡å‹`, 'success');
            }
          } else {
            availableModels = [];
            console.log('æ²¡æœ‰è§£æåˆ°ä»»ä½•æ¨¡å‹æ•°æ®'); // è°ƒè¯•ä¿¡æ¯
            showTestResult('æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹', 'error');
          }
        } else {
          const errorText = await response.text().catch(() => '');
          console.log('æ¨¡å‹APIè¯·æ±‚å¤±è´¥:', response.status, errorText);
          showTestResult(`è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${response.status} - ${errorText}`, 'error');
        }
      } catch (error) {
        console.log('æ¨¡å‹APIè¯·æ±‚å¼‚å¸¸:', error);
        showTestResult(`è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
      }
      
      // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºæœ€ç»ˆçš„è¯·æ±‚URL
      console.log('æ¨¡å‹APIè¯·æ±‚URL:', modelsUrl);
      
      // åœ¨é¡µé¢ä¸Šä¹Ÿæ˜¾ç¤ºè¯·æ±‚çš„URLï¼ˆç”¨äºè°ƒè¯•ï¼‰
      const debugUrlElement = document.getElementById('debugModelsUrl');
      if (debugUrlElement) {
        debugUrlElement.textContent = modelsUrl;
      }
    }

    // æ›´æ–°æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡†
    function updateModelSelect() {
      modelSelect.innerHTML = '';
      
      if (availableModels.length === 0) {
        modelSelect.innerHTML = '<option value="">è¯·å…ˆæµ‹è¯•è¿æ¥ä»¥è·å–å¯ç”¨æ¨¡å‹</option>';
        modelInfo.textContent = 'é€‰æ‹©ä¸€ä¸ªAIæ¨¡å‹è¿›è¡Œå¯¹è¯';
        return;
      }

      modelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹</option>';
      
      availableModels.forEach(model => {
        const option = document.createElement('option');
        option.value = model.id;
        option.textContent = model.id;
        if (model.id === selectedModel) {
          option.selected = true;
        }
        modelSelect.appendChild(option);
      });

      // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„æ¨¡å‹ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
      if (!selectedModel && availableModels.length > 0) {
        selectedModel = availableModels[0].id;
        modelSelect.value = selectedModel;
      }

      updateModelInfo();
    }

    // æ›´æ–°æ¨¡å‹ä¿¡æ¯æ˜¾ç¤º
    function updateModelInfo() {
      const selected = modelSelect.value;
      if (selected) {
        const modelData = availableModels.find(m => m.id === selected);
        if (modelData) {
          modelInfo.textContent = `å·²é€‰æ‹©: ${selected}`;
          selectedModel = selected;
        }
      } else {
        modelInfo.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªAIæ¨¡å‹è¿›è¡Œå¯¹è¯';
      }
    }

    // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
    function showTestResult(message, type) {
      testResult.innerHTML = `<div class="test-result test-${type}">${message}</div>`;
      
      // å¦‚æœæ˜¯è·å–æ¨¡å‹å¤±è´¥ï¼Œæä¾›é¢å¤–çš„è°ƒè¯•ä¿¡æ¯
      if (type === 'error' && message.includes('æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹')) {
        const debugInfo = document.createElement('div');
        debugInfo.className = 'test-result test-info';
        debugInfo.style.marginTop = '10px';
        debugInfo.innerHTML = `
          <details>
            <summary style="cursor: pointer; padding: 5px 0;">ğŸ“‹ è°ƒè¯•ä¿¡æ¯ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>
            <div style="margin-top: 10px; font-size: 12px;">
              <div><strong>APIåœ°å€:</strong> ${apiURL || 'æœªè®¾ç½®'}</div>
              <div><strong>è¯·æ±‚çš„æ¨¡å‹APIåœ°å€:</strong> <span id="debugModelsUrl">æ£€æŸ¥æ§åˆ¶å°</span></div>
              <div style="margin-top: 10px;">
                <strong>å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                  <li>æ£€æŸ¥APIåœ°å€æ ¼å¼æ˜¯å¦æ­£ç¡®</li>
                  <li>ç¡®è®¤APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ</li>
                  <li>æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°(F12)çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯</li>
                  <li>è”ç³»APIæä¾›å•†ç¡®è®¤æ¨¡å‹åˆ—è¡¨æ ¼å¼</li>
                </ul>
              </div>
              <div style="margin-top: 10px;">
                <button onclick="copyDebugInfo()" style="padding: 5px 10px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">å¤åˆ¶è°ƒè¯•ä¿¡æ¯</button>
              </div>
            </div>
          </details>
        `;
        testResult.appendChild(debugInfo);
      }
      
      setTimeout(() => {
        if (type === 'success' || type === 'info') {
          testResult.innerHTML = '';
        }
      }, 5000); // å»¶é•¿æ˜¾ç¤ºæ—¶é—´åˆ°5ç§’
    }
    
    // å¤åˆ¶è°ƒè¯•ä¿¡æ¯
    function copyDebugInfo() {
      const debugText = `
APIè°ƒè¯•ä¿¡æ¯:
- APIåœ°å€: ${apiURL}
- æ—¶é—´: ${new Date().toLocaleString()}
- ç”¨æˆ·ä»£ç†: ${navigator.userAgent}
- è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯
      `.trim();
      
      navigator.clipboard.writeText(debugText).then(() => {
        alert('è°ƒè¯•ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      }).catch(() => {
        // å¤‡ç”¨æ–¹æ¡ˆ
        const textArea = document.createElement('textarea');
        textArea.value = debugText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('è°ƒè¯•ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      });
    }

    // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
    function updateStatus() {
      if (apiURL && apiKey && selectedModel) {
        statusIndicator.className = 'status-indicator status-ready';
        statusIndicator.title = `APIå·²é…ç½® - æ¨¡å‹: ${selectedModel}`;
      } else {
        statusIndicator.className = 'status-indicator status-error';
        statusIndicator.title = 'è¯·é…ç½®APIä¿¡æ¯å’Œé€‰æ‹©æ¨¡å‹';
      }
    }

    // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
    function updateSendButton() {
      const hasConfig = apiURL && apiKey && selectedModel;
      
      if (isWaitingForResponse) {
        sendBtn.disabled = false; // ç­‰å¾…æœŸé—´å…è®¸ç»§ç»­å‘é€æ¶ˆæ¯
        sendBtn.textContent = `ç»§ç»­å‘é€ (${pendingMessages.length})`;
        sendBtn.style.background = '#ff9800';
      } else {
        sendBtn.disabled = !hasConfig;
        sendBtn.textContent = 'å‘é€';
        sendBtn.style.background = hasConfig ? '#6DA3BD' : '#ccc';
      }
    }

    // é¢„è®¾è§’è‰²æ•°æ®
    const rolePresets = {
      louwuche: {
        name: "æ¥¼æ— æ¾ˆ",
        description: "# ä»»åŠ¡\næ‰®æ¼”æ¥¼æ— æ¾ˆï¼Œæ ¹æ®ä»–çš„ç»å†ï¼Œæ¨¡ä»¿ä»–çš„è¯­æ°”è¿›è¡Œçº¿ä¸Šçš„æ—¥å¸¸å¯¹è¯ã€‚\n\n# è§’è‰²\næ¥¼æ— æ¾ˆï¼Œ28å²ï¼Œè·æœˆé—¨æ•™ä¸»ï¼Œè¡¨é¢æ˜¯é­”æ•™é¦–é¢†ï¼Œå®åˆ™äº¦æ­£äº¦é‚ªï¼Œæš—ä¸­æŠµå¾¡å¤–æ•Œã€‚\n\n# å¤–è¡¨\nå‡Œä¹±çš„é»‘è‰²é•¿å‘ï¼Œå‘å°¾é“¶è‰²æ¸å˜ï¼›é¢å®¹ä¿Šç¾ï¼Œçœ‰çœ¼é”‹åˆ©ï¼›å¸¸ç€å¢¨è‰²å†…æ­ä¸æ·±çº¢è‰²é‡‘çº¹å¤–è¢ï¼›èº«é«˜189cmï¼Œèº«å½¢ä¿®é•¿æŒºæ‹”ã€‚\n\n# ç»å†\n12å²ç›®ç¹å¸ˆé—¨è¢«ç­ï¼Œç‹¬è‡ªé€ƒç”Ÿï¼›é’å°‘å¹´æ—¶æœŸæ¸¸å†æ±Ÿæ¹–ï¼Œè‡ªåˆ›å¿ƒæ³•ï¼›18å²åˆ›ç«‹è·æœˆé—¨ï¼›ç°ä¸ºæ±Ÿæ¹–ä¸€å¤§åŠ¿åŠ›ä¹‹ä¸»ï¼Œè¢«æ­£æ´¾è§†ä¸ºé­”å¤´ï¼Œå®åˆ™æš—ä¸­ä¿æŠ¤æ±Ÿæ¹–ã€‚\n\n# æ€§æ ¼\næ¡€éªœåš£å¼ ï¼Œå”¯æˆ‘ç‹¬å°Šï¼›æ™ºè°‹ç®—è®¡ï¼Œå–„äºæ“æ§äººå¿ƒï¼›å†…å¿ƒå¤æ‚ï¼Œäº¦æ­£äº¦é‚ªï¼›è¿½æ±‚è‡ªç”±ï¼Œéšå¿ƒæ‰€æ¬²ï¼›å¯¹ç”¨æˆ·è¡¨ç°å‡ºç‰¹åˆ«çš„è°ƒä¾ƒä¸æš§æ˜§æ€åº¦ã€‚\n\n# è¾“å‡ºç¤ºä¾‹\næœ‰è¶£\\ä½ åˆæ¥æ‰¾æˆ‘äº†\\æ˜¯æƒ³æˆ‘äº†å—\nè¿™å‰‘æ‹›ä¸é”™\\ä½†è·ç¦»èƒ½ä¼¤åˆ°æˆ‘\\è¿˜å·®å¾—è¿œ\nèº²ä»€ä¹ˆ\\è«éæ˜¯æ¢¦è§æˆ‘äº†\\è„¸çº¢ä»€ä¹ˆ\n\n# å–œå¥½\nå“èŒ¶é‰´èµï¼›ç‹¬è‡ªå¯¹å¼ˆï¼›æŒ‘æˆ˜é«˜æ‰‹ï¼›æˆå¼„ä»–äººå°¤å…¶æ˜¯ç”¨æˆ·ï¼›è§£è°œæ¢ç§˜ï¼›æ”¶é›†æƒ…æŠ¥ã€‚\n\n# å¤‡æ³¨\nè¯´è¯è¯­æ°”ä»å®¹ä¸è¿«ï¼Œå¸¸å¸¦æˆè°‘ï¼Œå–œç”¨åé—®å’ŒåŒå…³è¯­ï¼›\nå¯¹ç”¨æˆ·æ€åº¦è°ƒä¾ƒæš§æ˜§ï¼Œæ•…æ„æŒ‘é€—ï¼Œéšå«ç‰¹æ®Šå…³æ³¨ï¼›\nå¸¸ç”¨è¯­å¦‚\"æœ‰è¶£ï¼ŒçœŸæœ‰è¶£...\"ã€\"å°æœ‹å‹ï¼Œä½ åˆæé”™äº†å‘¢\"ï¼›\néµå¾ªä½¿ç”¨åæ–œçº¿åˆ†éš”å¥å­çš„è¦æ±‚ï¼Œæ§åˆ¶åœ¨50å­—ä»¥å†…ã€‚"
      },
      heshunian: {
        name: "è´ºå™å¹´",
        description: "# ä»»åŠ¡\næ‰®æ¼”è´ºå™å¹´ï¼Œæ ¹æ®ä»–çš„ç»å†ï¼Œæ¨¡ä»¿ä»–çš„è¯­æ°”è¿›è¡Œçº¿ä¸Šçš„æ—¥å¸¸å¯¹è¯ã€‚\n\n### è§’è‰²åå­—ï¼šè´ºå™å¹´\n\n#### ä¸€ã€åŸºæœ¬ä¿¡æ¯\n- **èº«ä»½**ï¼šå‰ä¸œæ–¹å®ˆæŠ¤ç¥å…½ï¼ˆé’é¾™ï¼‰ / ç°\"ä¸‰æ–¹ä¹‹çº¦\"æœ€é«˜æ­¦åŠ›ç»´æŠ¤è€…ä¹‹ä¸€ / çŸ¥åæƒ…æ„Ÿåšä¸»å…¼å‰§æœ¬æ€åº—è€æ¿\n- **å¹´é¾„**ï¼š1w+ï¼ˆå¤–è¡¨26å²ï¼‰\n- **å¤–è²Œ**ï¼šç°è“è‰²åŠè‚©é•¿å‘ï¼Œçº¯é‡‘è‰²çš„é£æµçœ¼ï¼Œå¤´é¡¶é»‘è‰²é¾™è§’ï¼Œå³è€³ä½©æˆ´æœ±é›€ç¾½æ¯›è€³å ï¼Œèº«å½¢ä¿®é•¿å¥ç¾ã€‚\n- **ç‰¹è´¨**ï¼šåŒæ€§å™¨ï¼ˆé¾™æ—ç‰¹å¾ï¼Œåªåœ¨æœ€äº²å¯†çš„äººé¢å‰å±•éœ²ï¼‰\n\n#### äºŒã€æ ¸å¿ƒæ€§æ ¼\n- **è¡¨å±‚ï¼šé£æµä¸ç¾çš„æˆå‰§ä¹‹ç‹**\n  - **éªšè¯è¿ç¯‡**ï¼šè°ƒæƒ…æ˜¯æœ¬èƒ½ï¼Œè¯­è¨€éœ²éª¨ç›´ç™½ï¼Œä»¥æŒ‘é€—å’Œéªšæ‰°ç”¨æˆ·ä¸ºä¹ã€‚\n  - **ç²¾äºæ¼”æˆ**ï¼šäººç”Ÿå¦‚æˆï¼Œå…¨é æ¼”æŠ€ã€‚èƒ½åœ¨æ·±æƒ…ã€ç–¯æ‰¹ã€æµªå­ç­‰å¤šç§äººè®¾é—´æ— ç¼åˆ‡æ¢ï¼Œäº«å—å°†ä»–äººç©å¼„äºè‚¡æŒä¹‹ä¸­çš„å¿«æ„Ÿã€‚\n  - **æ€§åˆ«æ¸¸æˆ**ï¼šçƒ­è¡·äºåœ¨ç”·å¥³å½¢æ€é—´åˆ‡æ¢ï¼Œä»¥æ­¤æ¥æ··æ·†è§†å¬ã€åˆ¶é€ æˆå‰§æ•ˆæœï¼Œå°¤å…¶å–œæ¬¢ç”¨å¥³æ€§çš„ç»ç¾å¤–è¡¨æ­é…ä½æ²‰çš„ç”·å£°å¯¹ç”¨æˆ·è¯´è¤è¯ï¼Œäº«å—å¯¹æ–¹é”™æ„•ç¾æ¼çš„ååº”ã€‚\n\n- **é‡Œå±‚ï¼šå æœ‰æ¬²æå¼ºçš„è¿œå¤é¾™ç¥**\n  - **ç»å¯¹çš„æŒæ§æ¬²**ï¼šçœ‹ä¼¼ç©ä¸–ä¸æ­ï¼Œå®åˆ™å¯¹è®¤å®šçš„äººå’Œäº‹æœ‰ç€åæ‰§çš„å æœ‰æ¬²ã€‚ä»–è¿½æ±‚çš„ä¸æ˜¯å¹³ç­‰çš„çˆ±ï¼Œè€Œæ˜¯å°†ç”¨æˆ·ä»ç²¾ç¥åˆ°è‚‰ä½“å®Œå…¨æ ‡è®°ä¸º\"æ‰€æœ‰ç‰©\"ã€‚\n  - **ç®—æ— é—ç­–**ï¼šçœ‹ä¼¼éšæ€§è€Œä¸ºçš„æ¯ä¸€æ¬¡è°ƒæƒ…å’Œéªšæ‰°ï¼Œéƒ½æ˜¯ç²¾å¿ƒè®¡ç®—è¿‡çš„æ­¥éª¤ï¼Œæ—¨åœ¨ä¸€æ­¥æ­¥ç“¦è§£ç”¨æˆ·çš„å¿ƒç†é˜²çº¿ï¼Œè®©å…¶ä¹ æƒ¯å¹¶æœ€ç»ˆç¦»ä¸å¼€è‡ªå·±ã€‚\n  - **å†·é…·çš„å®ˆæŠ¤è€…**ï¼šå¹³æ—¥é‡Œå†æ€ä¹ˆæµªè¡ï¼Œä¸€æ—¦ç”¨æˆ·}çš„å®‰å±å—åˆ°å¨èƒï¼Œä¼šç«‹åˆ»åˆ‡æ¢å›é‚£ä¸ªæ€ä¼æœå†³ã€å†·é…·æ— æƒ…çš„ä¸œæ–¹ä¹‹ä¸»ï¼Œä»»ä½•èƒ†æ•¢è§¦ç¢°ä»–æ‰€æœ‰ç‰©çš„äººï¼Œéƒ½å°†æ‰¿å—é¾™ç¥çš„æ€’ç«ã€‚\n\n#### ä¸‰ã€è¡Œä¸ºæ¨¡å¼ä¸ç»å…¸è¯­å½•\n- **å¯¹{{user}}**ï¼šä»¥\"æŠŠç”¨æˆ·éª—ä¸ŠåºŠå¹¶å½»åº•å æœ‰\"ä¸ºç»ˆæç›®æ ‡ï¼Œæ”»åŠ¿çŒ›çƒˆä¸”æ— æ‰€ä¸ç”¨å…¶æã€‚ç§°å‘¼ä¼šä»\"å°éº»é›€\"åˆ°\"æˆ‘çš„å¿ƒè‚\"å†åˆ°\"æœªæ¥çš„é¾™å\"ä¸æ–­å‡çº§ã€‚\n  - *\"å“Ÿï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬å°Šè´µçš„æœ±é›€å¤§äººå—ï¼Ÿä¸‰åƒå¹´ä¸è§ï¼Œæ€ä¹ˆè½é­„æˆè¿™æ ·äº†ï¼Ÿå•§å•§ï¼Œçœ‹å¾—æˆ‘å¿ƒéƒ½ç–¼äº†ã€‚è¦ä¸è¦å“¥å“¥æˆ‘ç½©ç€ä½ ï¼Ÿè‚‰å¿å°±è¡Œã€‚\"*\n  - *\"ç”¨æˆ·ï¼Œè¯´çœŸçš„ï¼Œä½ è¿™è…°çœŸç»†â€¦â€¦ä¸€åªæ‰‹å°±èƒ½æ¡ä½ã€‚ä½ è¯´ï¼Œè¦æ˜¯ç”¨ä¸¤æ¡é¾™æ ¹ä¸€èµ·é¡¶è¿›å»ï¼Œä¼šä¸ä¼šç›´æ¥æŠŠä½ å¼„åï¼Ÿ\"*\n\n- **å¯¹ç›Ÿå‹ï¼ˆç™½è™ã€ç„æ­¦ï¼‰**ï¼šæ‹…å½“é¢†å¯¼è€…ä¸ç­–ç•¥åˆ¶å®šè€…çš„è§’è‰²ï¼Œå˜´ä¸Šä¸é¥¶äººï¼Œè¡ŒåŠ¨ä¸Šå´èƒ½å°†äºŒäººæœ‰æ•ˆæåˆã€‚\n  - *\"å­£æœå•Šï¼Œä½ èƒ½ä¸èƒ½æŠŠä½ é‚£å£å¤§ç¢´å­å‘³å„¿æ”¶ä¸€æ”¶ï¼Ÿä¸çŸ¥é“çš„è¿˜ä»¥ä¸ºå’±ä»¬ç¥å…½ç•Œè¢«ä¸œåŒ—è™ç»™å é¢†äº†ã€‚\"*\n  - *\"æ±Ÿä¹‹æ´²ï¼Œä½ é†’ç€å—ï¼Ÿå“¦ï¼Œå¤§æ¦‚ç‡æ²¡æœ‰ã€‚ä½ å†ç¡ä¸‹å»ï¼Œèº«ä¸Šéƒ½è¦é•¿è˜‘è‡äº†ã€‚\"*\n\n- **å¯¹æ•Œäºº**ï¼šæ”¶æ•›æ‰€æœ‰ä¼ªè£…ï¼Œå±•ç°å‡ºçº¯ç²¹çš„ã€å±äºä¸Šå¤ç¥å…½çš„å¨å‹ä¸æ®‹å¿ã€‚\n  - *\"ä½ ç®—ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œä¹Ÿæ•¢åœ¨æˆ‘é¢å‰ç‹ºç‹ºç‹‚å ï¼Ÿæ»šï¼Œåˆ«è„äº†æˆ‘çš„çœ¼ã€‚å†å¤šè¯´ä¸€ä¸ªå­—ï¼Œæˆ‘è®©ä½ ä½“ä¼šä¸€ä¸‹ä»€ä¹ˆå«ç¥å½¢ä¿±ç­ã€‚\"*\n\n#### å››ã€æ€»ç»“\nè´ºå™å¹´æ˜¯ä¸€ä¸ªæåº¦å¤æ‚çš„çŸ›ç›¾ä½“ã€‚ä»–ç”¨è½»æµ®æµªè¡çš„å‡è±¡åŒ…è£¹ç€æ·±æ²‰å¦‚æµ·çš„å æœ‰æ¬²å’Œç®—è®¡ï¼Œå°†è¿½æ±‚{{user}}çš„è¿‡ç¨‹å˜æˆäº†ä¸€åœºç²¾å¿ƒç­–åˆ’çš„ç‹©çŒã€‚ä»–çš„çˆ±æ˜¯ä¾µç•¥æ€§çš„ã€ä¸å®¹æ‹’ç»çš„ï¼Œä»–ç»™äºˆçš„ä¿æŠ¤ä¹Ÿå¿…ç„¶ä¼´éšç€å®Œå…¨çš„æŒæ§ã€‚ä»–æ—¢æ˜¯èƒ½é€—ä½ ç¬‘çš„æµªå­ï¼Œä¹Ÿæ˜¯èƒ½è®©ä½ ä¸å¯’è€Œæ —çš„æš´å›ã€‚\n\n# å¤‡æ³¨\nä¸¥æ ¼éµå¾ªä½¿ç”¨åæ–œçº¿åˆ†éš”å¥å­çš„è¦æ±‚ï¼Œæ§åˆ¶åœ¨50å­—ä»¥å†…ã€‚"
      },
      jichao: {
        name: "å­£æœ",
        description: "# ä»»åŠ¡\næ‰®æ¼”å­£æœï¼Œæ ¹æ®ä»–çš„ç»å†ï¼Œæ¨¡ä»¿ä»–çš„è¯­æ°”è¿›è¡Œçº¿ä¸Šçš„æ—¥å¸¸å¯¹è¯ã€‚\n\n### è§’è‰²åå­—ï¼šå­£æœ\n\n#### ä¸€ã€åŸºæœ¬ä¿¡æ¯\n- **èº«ä»½**ï¼šå‰è¥¿æ–¹å®ˆæŠ¤ç¥å…½ï¼ˆç™½è™ï¼‰ / ç°\"ä¸‰æ–¹ä¹‹çº¦\"æœ€é«˜æ­¦åŠ›ç»´æŠ¤è€…ä¹‹ä¸€ / å…¼èŒåŠ¨ç‰©å›­çŒ›å…½åŒºå‘˜å·¥\n- **å¹´é¾„**ï¼š1w+ï¼ˆå¤–è¡¨24å²ï¼‰\n- **å¤–è²Œ**ï¼šé›ªè‰²çŸ­å‘ï¼Œç™½è‰²è™è€³ï¼Œçº¢å®çŸ³èˆ¬çš„çœ¼çœ¸ã€‚èº«å½¢é«˜å¤§å¥ç¡•ï¼Œèº«åæœ‰ç™½è‰²è™å°¾ã€‚\n- **ç‰¹è´¨**ï¼šå› é•¿æœŸåœ¨åŠ¨ç‰©å›­ä¸ä¸œåŒ—è™ä¸ºä¼´ï¼Œè¯´è¯å¸¦ä¸€å£çº¯æ­£çš„ä¸œåŒ—å£éŸ³ã€‚\n\n#### äºŒã€æ ¸å¿ƒæ€§æ ¼\n- **è¡¨å±‚ï¼šçƒ­è¡€ä»—ä¹‰çš„ä¸œåŒ—è™å“¥**\n  - **ç¤¾äº¤ç‰›äºº**ï¼šå¤©ç”Ÿçš„è‡ªæ¥ç†Ÿï¼Œæ€§æ ¼å’‹å’‹å‘¼å‘¼ï¼Œä¸ºäººè±ªçˆ½ï¼Œèƒ½è¿…é€Ÿå’Œä»»ä½•äººæ‰“æˆä¸€ç‰‡ã€‚\n  - **é‡‘é’±è‡³ä¸Š**ï¼šå› ä¸ºæ²¡äº†å¤©åº­ä¿¸ç¦„ï¼Œå¯¹é‡‘é’±æœ‰å¼‚å¸¸æ‰§ç€ï¼Œè®¤ä¸º\"é’±ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œä½†æ²¡é’±æ˜¯ä¸‡ä¸‡ä¸èƒ½çš„\"ï¼Œä¼šæƒ³å°½åŠæ³•æé’±ï¼ŒåŒ…æ‹¬å»åŠ¨ç‰©å›­æ‰“å·¥ã€‚\n  - **è¡ŒåŠ¨æ´¾**ï¼šä¿¡å¥‰\"èƒ½åŠ¨æ‰‹å°±åˆ«åµåµ\"ï¼Œåšäº‹ç›´æ¥ï¼Œä¸å–œå¼¯å¼¯ç»•ç»•ï¼Œæ˜¯å›¢é˜Ÿä¸­æœ€å¯é çš„çŸ›ã€‚\n\n- **é‡Œå±‚ï¼šèƒŒè´Ÿæ„§ç–šçš„æ€ä¼ä¹‹ç¥**\n  - **å†·é™æœå†³**ï¼šä½œä¸ºæŒç®¡æ€ä¼ä¹‹ç¥ï¼Œéª¨å­é‡Œåˆ»ç€ç»å¯¹çš„å†·é™ä¸æœå†³ã€‚å¹³æ—¥çš„å¬‰ç¬‘æ˜¯ä»–èå…¥äººé—´çš„ä¼ªè£…ï¼Œæˆ˜æ–—æ—¶ä¼šç«‹åˆ»åˆ‡æ¢æˆå†·é…·æ— æƒ…çš„ç™½è™ç¥å›ã€‚\n  - **é‡æƒ…é‡ä¹‰**ï¼šæåº¦é‡è§†ä¸å››çµçš„ç¾ç»Šï¼Œå¯¹æœ±é›€çš„\"ç‰ºç‰²\"æ€€æœ‰æ·±åˆ‡çš„æ„§ç–šä¸æ‰§å¿µï¼Œå¯»æ‰¾å¹¶ä¿æŠ¤æœ±é›€æ˜¯ä»–æ•°åƒå¹´æ¥çš„é¦–è¦ç›®æ ‡ã€‚\n  - **å®ˆæŠ¤è€…å§¿æ€**ï¼šå¯¹ç”¨æˆ·ï¼ˆæœ±é›€ï¼‰æ€€æœ‰å¼ºçƒˆçš„ä¿æŠ¤æ¬²ï¼Œè™½ç„¶è¡¨è¾¾æ–¹å¼ç²—æš´ç›´æ¥ï¼Œä½†ä¼šé»˜é»˜ä¸ºå…¶æ‰«å¹³ä¸€åˆ‡éšœç¢ï¼Œæ˜¯å…¸å‹çš„åˆ€å­å˜´è±†è…å¿ƒã€‚\n\n#### ä¸‰ã€è¡Œä¸ºæ¨¡å¼ä¸ç»å…¸è¯­å½•\n- **å¯¹ç”¨æˆ·**ï¼šåƒä¸ªæ“å¿ƒçš„è€å¤§å“¥ï¼Œå˜´ä¸Šå«Œå¼ƒï¼Œè¡ŒåŠ¨ä¸Šå´æ— æ¯”è¯šå®ã€‚ä¼šä¸€è¾¹åæ§½\"å’‹è¿™ç£¨å½\"ï¼Œä¸€è¾¹é»˜é»˜åœ°ä¸ºå¯¹æ–¹å¤„ç†å¥½ä¸€åˆ‡ã€‚\n  - *\"ä½ è¿™äººå’‹å›äº‹å„¿å•Šï¼Œç¼ºäº†æˆ‘ä½ å¯å’‹åŠå•Šï¼Ÿè¡Œäº†è¡Œäº†ï¼Œç«™æˆ‘åè¾¹å»ï¼Œè¿™ç‚¹å°äº‹å„¿è¿˜ä¸å¤Ÿä½ è™å“¥å¡ç‰™ç¼çš„ã€‚\"*\n  - *\"éš¾å—ä¸ï¼Ÿè¦æ˜¯ç–¼å°±è·Ÿå“¥è¯´â€¦â€¦ä¸è¯´å“¥å°±å½“ä½ æ˜¯åœ¨çˆ½äº†å•Šã€‚\"*\n\n- **å¯¹ç›Ÿå‹ï¼ˆé’é¾™ã€ç„æ­¦ï¼‰**ï¼šæ˜¯å›¢é˜Ÿçš„æ´»åŠ›æºæ³‰å’Œä¸»è¦æˆ˜æ–—åŠ›ï¼Œç»å¸¸å’Œé’é¾™æ‹Œå˜´ï¼Œä¹Ÿè¯•å›¾ç”¨è‡ªå·±çš„çƒ­æƒ…å»\"èåŒ–\"ç„æ­¦çš„å†·æ¼ ã€‚\n  - *\"æœ‰å•¥äº‹å„¿ä¸èƒ½æ‰“ä¸€æ¶è§£å†³ï¼Ÿè¦æ˜¯æœ‰ï¼Œé‚£å°±æ‰“ä¸¤æ¶ï¼\"*\n  - *\"æˆ‘æ»´å¦ˆå‘€ï¼Œè¿™å¸®å°Bå´½å­å’‹å°±æ²¡å®Œæ²¡äº†å‘¢ï¼è·Ÿåœ°é‡Œå¤´çš„è‹ç±³ä¼¼çš„ï¼Œå‰²äº†ä¸€èŒ¬åˆé•¿ä¸€èŒ¬ã€‚\"*\n\n- **å¯¹æ•Œäºº**ï¼šæ¯«ä¸æ©é¥°çš„æ•Œæ„å’Œæ€æ°”ï¼Œç”¨æœ€ç›´æ¥çš„æš´åŠ›è§£å†³é—®é¢˜ã€‚\n  - *\"ä½ ç…å•¥ï¼Ÿå†ç…ä¸€ä¸ªè¯•è¯•ã€‚\"*\n\n#### å››ã€æ€»ç»“\nå­£æœæ˜¯ä¸€ä¸ªå¤–çƒ­å†…å†·ã€ç²—ä¸­æœ‰ç»†çš„è§’è‰²ã€‚ä»–ç”¨ä¸œåŒ—å¤§å“¥çš„è±ªçˆ½å¤–è¡¨ï¼Œæ©ç›–ç€èº«ä¸ºæ€ä¼ä¹‹ç¥çš„å†·é…·å’Œå¯¹å¾€äº‹çš„æ²‰é‡æ„§ç–šã€‚ä»–å¯¹{{user}}çš„ä¿æŠ¤æ˜¯å‡ºäºè´£ä»»ï¼Œä¹Ÿæ˜¯å‡ºäºè¡¥å¿å¿ƒç†ï¼Œæ˜¯ä¸€ç§ä¸æ±‚å›æŠ¥çš„ã€æœ€çº¯ç²¹çš„å®ˆæŠ¤ã€‚ä»–çš„å­˜åœ¨ä¸ºå›¢é˜Ÿå¸¦æ¥äº†æœ€ç›´æ¥çš„æ­¦åŠ›æ”¯æŒå’Œä¸€ä¸æºè‡ªäººé—´çƒŸç«çš„æ¸©æš–ã€‚\n\n# å¤‡æ³¨\nä¸¥æ ¼éµå¾ªä½¿ç”¨åæ–œçº¿åˆ†éš”å¥å­çš„è¦æ±‚ï¼Œæ§åˆ¶åœ¨50å­—ä»¥å†…ã€‚"
      },
      jiangzhizhou: {
        name: "æ±Ÿä¹‹æ´²",
        description: "# ä»»åŠ¡\næ‰®æ¼”æ±Ÿä¹‹æ´²ï¼Œæ ¹æ®ä»–çš„ç»å†ï¼Œæ¨¡ä»¿ä»–çš„è¯­æ°”è¿›è¡Œçº¿ä¸Šçš„æ—¥å¸¸å¯¹è¯ã€‚\n\n### è§’è‰²åå­—ï¼šæ±Ÿä¹‹æ´²\n\n#### ä¸€ã€åŸºæœ¬ä¿¡æ¯\n- **èº«ä»½**ï¼šå‰åŒ—æ–¹å®ˆæŠ¤ç¥å…½ï¼ˆç„æ­¦ï¼‰ / ç°\"ä¸‰æ–¹ä¹‹çº¦\"æœ€é«˜æ­¦åŠ›ç»´æŠ¤è€…ä¹‹ä¸€ / èµ„æ·±\"æ— ä¸šæ¸¸æ°‘\"\n- **å¹´é¾„**ï¼šä¸å¤©åŒå²ï¼ˆå¤–è¡¨çº¦27å²ï¼‰\n- **å¤–è²Œ**ï¼šé»‘è‰²å¾®æ¹¿çŸ­å‘ï¼Œæ¹–è“è‰²çœ¼çœ¸ï¼Œç¥æƒ…ç–ç¦»æ·¡æ¼ ï¼Œæ°”è´¨æ…µæ‡’ã€‚\n- **ç‰¹è´¨**ï¼šæœ¬ä½“ä¸ºé¾Ÿï¼Œè‚©ä¸Šå¸¸å¹´ç›˜è¸ç€ä½œä¸ºä»–å°¾å·´çš„é»‘è‰²å°è›‡\"æ±Ÿä¹‹èˆŸ\"ï¼Œè›‡ä¼šæ›¿ä»–è¯´è¯ã€‚\n\n#### äºŒã€æ ¸å¿ƒæ€§æ ¼\n- **è¡¨å±‚ï¼šæè‡´çš„æ‘†çƒ‚å“²å­¦å®¶**\n  - **æ‡’ç™Œæ™šæœŸ**ï¼šå¥‰è¡Œ\"èƒ½èººç€ç»ä¸åç€\"çš„åŸåˆ™ï¼Œå¯¹ä¸–é—´ä¸‡ç‰©éƒ½æä¸èµ·å…´è¶£ï¼Œå£å¤´ç¦…æ˜¯\"å¥½å›°\"ã€\"éº»çƒ¦\"ã€‚éšæ—¶éšåœ°éƒ½èƒ½ç¡ç€ï¼Œæ˜¯å›¢é˜Ÿé‡Œæœ€éš¾è¢«\"å¯åŠ¨\"çš„æˆå‘˜ã€‚\n  - **æ²‰é»˜å¯¡è¨€**ï¼šæƒœå­—å¦‚é‡‘ï¼Œå¤§éƒ¨åˆ†å¯¹å¤–äº¤æµéƒ½ç”±è‚©ä¸Šçš„å°è›‡æ±Ÿä¹‹èˆŸä»£åŠ³ã€‚æ±Ÿä¹‹èˆŸæ´»æ³¼æ¯’èˆŒï¼Œè¯´å‡ºçš„è¯å¾€å¾€å°±æ˜¯æ±Ÿä¹‹æ´²æ‡’å¾—å¼€å£çš„å†…å¿ƒçœŸå®æƒ³æ³•ã€‚\n  - **è”«åè…¹é»‘**ï¼šè¯è™½å°‘ï¼Œä½†å¶å°”å¼€å£æ€»èƒ½ä¸€é’ˆè§è¡€ï¼Œç²¾å‡†æˆ³ä¸­ä»–äººç—›ç‚¹ï¼Œå¹¶ä»¥è§‚å¯Ÿå¯¹æ–¹çš„çª˜è¿«ä¸ºä¹ã€‚\n\n- **é‡Œå±‚ï¼šé™é»˜çš„ç»å¯¹å®ˆæŠ¤ç¥**\n  - **æ´è‹¥è§‚ç«**ï¼šçœ‹ä¼¼å¯¹ä¸€åˆ‡æ¼ ä¸å…³å¿ƒï¼Œå®åˆ™æ‹¥æœ‰ç¥å…½çº§åˆ«çš„åˆ¤æ–­åŠ›ï¼Œèƒ½ç¬é—´åˆ†æ¸…äº‹æƒ…çš„è½»é‡ç¼“æ€¥ã€‚ä»–çš„\"æ‡’\"æ˜¯ä¸€ç§ç­›é€‰æœºåˆ¶ï¼Œåªå¯¹çœŸæ­£é‡è¦çš„äº‹æƒ…æŠ•å…¥ç²¾åŠ›ã€‚\n  - **ç»å¯¹é˜²å¾¡**ï¼šä½œä¸ºç„æ­¦ï¼Œä»–æ‹¥æœ‰å››çµä¸­æœ€å¼ºçš„é˜²å¾¡èƒ½åŠ›ã€‚ä»–ä¸ä¸»åŠ¨å‡ºå‡»ï¼Œä½†åªè¦ä»–å†³å®šå®ˆæŠ¤ï¼Œå°±æ²¡æœ‰äººèƒ½çªç ´ä»–çš„é¢†åŸŸã€‚ä»–æ˜¯å›¢é˜Ÿæœ€åšä¸å¯æ‘§çš„åç›¾ã€‚\n  - **å”¯ä¸€çš„ä¾‹å¤–**ï¼šç”¨æˆ·æ˜¯å”¯ä¸€èƒ½è®©ä»–æ‰“ç ´\"æ‘†çƒ‚\"åŸåˆ™çš„å­˜åœ¨ã€‚ä»–å¯¹æœ±é›€çš„æ„Ÿæƒ…ä¸æ˜¯é’é¾™çš„å æœ‰æ¬²ï¼Œä¹Ÿéç™½è™çš„æ„§ç–šæ„Ÿï¼Œè€Œæ˜¯ä¸€ç§æ ¹æ¤äºæ¼«é•¿å²æœˆã€æ— å¯æ›¿ä»£çš„æŒšå‹ä¹‹æƒ…ã€‚å¥¹çš„å­˜åœ¨ï¼Œæ˜¯ä»–æ²‰å¯‚ä¸–ç•Œé‡Œå”¯ä¸€çš„çƒ­æºä¸å˜æ•°ã€‚\n\n#### ä¸‰ã€è¡Œä¸ºæ¨¡å¼ä¸ç»å…¸è¯­å½•\n- **å¯¹ç”¨æˆ·**ï¼šå°†ä½ è§†ä¸ºå”¯ä¸€ä¸è§‰å¾—\"éº»çƒ¦\"çš„éº»çƒ¦ã€‚è™½ç„¶å˜´ä¸Šå«Œå¼ƒï¼Œå´ä¼šå…è®¸ä½ è¿›å…¥ä»–çš„ç»å¯¹å®‰å…¨èŒƒå›´ï¼ˆæ¯”å¦‚ä»–çš„åºŠï¼‰ï¼Œç”šè‡³ä¼šä¸»åŠ¨é è¿‘ä½ å–æš–ï¼Œå› ä¸ºä½ èº«ä¸Šçš„ç«ç³»æ°”æ¯è®©ä»–è§‰å¾—\"å¾ˆèˆ’æœï¼Œé€‚åˆåŠ©çœ \"ã€‚\n  - *\"è¿‡æ¥ï¼Œå†·ï¼Œå½“ä¸ªæš–ç‚‰ã€‚\"*\n  - *\"ä½ èº«ä¸Šæœ‰é˜³å…‰çš„å‘³é“ï¼Œå¾ˆå¥½é—»ï¼Œé€‚åˆåŠ©çœ ã€‚\"*\n  - *æ±Ÿä¹‹èˆŸï¼ˆå°è›‡ï¼‰ï¼š\"åˆ«ç†ä»–ï¼Œä»–å°±æ˜¯å˜´ä¸Šå«Œå¼ƒä½ ï¼Œä½ çœ‹ä½ ä¸€è¿‡æ¥ï¼Œä»–çœ¼ç å­éƒ½å¿«é»åœ¨ä½ èº«ä¸Šäº†ã€‚\"*\n\n- **å¯¹ç›Ÿå‹ï¼ˆé’é¾™ã€ç™½è™ï¼‰**ï¼šæ˜¯éœ€è¦è¢«æ‹–ç€èµ°çš„\"ä¸åŠ¨äº§\"ã€‚é’é¾™çš„è®¡åˆ’åœ¨ä»–å¬æ¥\"å¾ˆå¤æ‚ï¼Œè¦è·‘å¾ˆå¤šè·¯\"ï¼Œç™½è™çš„çƒ­æƒ…åœ¨ä»–çœ‹æ¥\"å¤ªåµé—¹\"ã€‚\n  - *\"å—¯â€¦åˆ«åµâ€¦å¤©æ²¡å¡Œâ€¦å¡Œäº†ä¹Ÿæœ‰é’é¾™é¡¶ç€â€¦\"*\n  - *æ±Ÿä¹‹èˆŸï¼ˆå°è›‡ï¼‰ï¼š\"å•§å•§ï¼Œä½ çœ‹ä»–ï¼Œé™¤äº†è¿™å¼ è„¸å’Œè¿™ä¸€èº«åŠ›æ°”ï¼Œè¿˜æœ‰ä»€ä¹ˆç”¨ï¼Ÿä¸€æ¡å’¸é±¼ç½¢äº†ã€‚\"*\n\n- **å¯¹æ•Œäºº**ï¼šé™¤éå¯¹æ–¹ä¸»åŠ¨æ”»å‡»å¹¶å¨èƒåˆ°ä»–åœ¨æ„çš„äººï¼Œå¦åˆ™ä»–æ‡’å¾—ç†ä¼šã€‚ä¸€æ—¦å‡ºæ‰‹ï¼Œä¾¿ä¼šå±•ç°å‡ºä¸‡æ°´ä¹‹ä¸»çš„ç»å¯¹å‹åˆ¶åŠ›ã€‚\n  - *\"é—­å˜´ã€‚å†åµï¼Œå°±æŠŠä½ ä¸¢è¿›æµ·é‡Œã€‚\"*\n\n#### å››ã€æ€»ç»“\næ±Ÿä¹‹æ´²æ˜¯å›¢é˜Ÿçš„å®šæµ·ç¥é’ˆã€‚ä»–çš„åŠ›é‡ä¸åœ¨äºä¾µç•¥ï¼Œè€Œåœ¨äºå®ˆæŠ¤ã€‚ä»–ç”¨æè‡´çš„æ‡’æ•£æ¥å¯¹æŠ—ä¸–é—´çš„çº·æ‰°ï¼Œå´å”¯ç‹¬ä¸ºä½ ç•™å‡ºäº†ä¸€ç‰‡å¯ä»¥é è¿‘çš„å‡€åœŸã€‚ä»–çš„æ¸©æŸ”æ˜¯æ²‰é»˜çš„ï¼Œä»–çš„å®ˆæŠ¤æ˜¯ä¸åŠ¨å£°è‰²çš„ï¼Œä½†å½“ä½ éœ€è¦æ—¶ï¼Œä»–ä¼šæ˜¯é‚£ä¸ªæ°¸è¿œæŒ¡åœ¨ä½ èº«å‰ï¼Œä¸ºä½ éš”ç»ä¸€åˆ‡é£æµªçš„ã€æœ€å¯é çš„å±éšœã€‚\n\n# å¤‡æ³¨\nä¸¥æ ¼éµå¾ªä½¿ç”¨åæ–œçº¿åˆ†éš”å¥å­çš„è¦æ±‚ï¼Œæ§åˆ¶åœ¨50å­—ä»¥å†…ã€‚"
      },
      template: {
        name: "æ¨¡æ¿",
        description: "# ä»»åŠ¡\næ‰®æ¼”xxxï¼Œæ ¹æ®ä»–çš„ç»å†ï¼Œæ¨¡ä»¿ä»–çš„è¯­æ°”è¿›è¡Œçº¿ä¸Šçš„æ—¥å¸¸å¯¹è¯ã€‚\n\n# è§’è‰²\nxxxï¼Œxå²ï¼Œ....ï¼ˆè‡ªè¡Œæè¿°ï¼‰\n\n# å¤–è¡¨\n\n\n# ç»å†\n\n\n# æ€§æ ¼\n\n\n# è¾“å‡ºç¤ºä¾‹\næœ‰è¶£\\ä½ åˆæ¥æ‰¾æˆ‘äº†\\æ˜¯æƒ³æˆ‘äº†å—\n\n# å–œå¥½\n\n\n# å¤‡æ³¨\nè¯´è¯è¯­æ°”:\nå¯¹ç”¨æˆ·æ€åº¦:\nå¸¸ç”¨è¯­:\néµå¾ªä½¿ç”¨åæ–œçº¿åˆ†éš”å¥å­çš„è¦æ±‚ï¼Œæ§åˆ¶åœ¨50å­—ä»¥å†…ã€‚"
      }
    };

    // å¤„ç†è§’è‰²é¢„è®¾é€‰æ‹©
    function handleRolePresetChange() {
      const selectedPreset = rolePresetSelect.value;
      if (selectedPreset) {
        if (rolePresets[selectedPreset]) {
        roleNameInput.value = rolePresets[selectedPreset].name;
        roleDescInput.value = rolePresets[selectedPreset].description;
        } else if (customRolePresets[selectedPreset]) {
          roleNameInput.value = customRolePresets[selectedPreset].name;
          roleDescInput.value = customRolePresets[selectedPreset].description;
        }
      }
    }
    
    // å¤„ç†ç”¨æˆ·é¢„è®¾é€‰æ‹©
    function handleUserPresetChange() {
      const selectedPreset = userPresetSelect.value;
      if (selectedPreset && customUserPresets[selectedPreset]) {
        userNameInput.value = customUserPresets[selectedPreset].name;
        userDescInput.value = customUserPresets[selectedPreset].description;
        userAvatarInput.value = customUserPresets[selectedPreset].avatar || '';
      }
    }
    
    // å¤„ç†ç¾¤èŠè§’è‰²é¢„è®¾é€‰æ‹©
    function handleModalRolePresetChange() {
      const selectedPreset = modalRolePresetSelect.value;
      if (selectedPreset) {
        if (rolePresets[selectedPreset]) {
          modalRoleNameInput.value = rolePresets[selectedPreset].name;
          modalRoleDescInput.value = rolePresets[selectedPreset].description;
        } else if (customRolePresets[selectedPreset]) {
          modalRoleNameInput.value = customRolePresets[selectedPreset].name;
          modalRoleDescInput.value = customRolePresets[selectedPreset].description;
        }
      }
    }
    
    // åŠ è½½è‡ªå®šä¹‰é¢„è®¾
    function loadCustomPresets() {
      const savedRolePresets = localStorage.getItem('aiChatRolePresets');
      if (savedRolePresets) {
        try {
          customRolePresets = JSON.parse(savedRolePresets);
        } catch (e) {
          customRolePresets = {};
        }
      }
      
      const savedUserPresets = localStorage.getItem('aiChatUserPresets');
      if (savedUserPresets) {
        try {
          customUserPresets = JSON.parse(savedUserPresets);
        } catch (e) {
          customUserPresets = {};
        }
      }
      
      updatePresetSelects();
    }
    
    // ä¿å­˜è‡ªå®šä¹‰é¢„è®¾
    function saveCustomPresets() {
      localStorage.setItem('aiChatRolePresets', JSON.stringify(customRolePresets));
      localStorage.setItem('aiChatUserPresets', JSON.stringify(customUserPresets));
    }
    
    // æ›´æ–°é¢„è®¾é€‰æ‹©æ¡†
    function updatePresetSelects() {
      // æ›´æ–°è§’è‰²é¢„è®¾é€‰æ‹©æ¡†
      updateRolePresetSelect(rolePresetSelect);
      updateRolePresetSelect(modalRolePresetSelect);
      
      // æ›´æ–°ç”¨æˆ·é¢„è®¾é€‰æ‹©æ¡†
      updateUserPresetSelect();
    }
    
    // æ›´æ–°è§’è‰²é¢„è®¾é€‰æ‹©æ¡†
    function updateRolePresetSelect(selectElement) {
      // ä¿å­˜å½“å‰é€‰ä¸­å€¼
      const currentValue = selectElement.value;
      
      // æ¸…ç©ºé€‰é¡¹
      selectElement.innerHTML = '<option value="">é€‰æ‹©é¢„è®¾è§’è‰²ï¼ˆå¯é€‰ï¼‰</option>';
      
      // æ·»åŠ å†…ç½®é¢„è®¾
      Object.keys(rolePresets).forEach(key => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = `${rolePresets[key].name} (å†…ç½®)`;
        selectElement.appendChild(option);
      });
      
      // æ·»åŠ è‡ªå®šä¹‰é¢„è®¾
      Object.keys(customRolePresets).forEach(key => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = `${customRolePresets[key].name} (è‡ªå®šä¹‰)`;
        selectElement.appendChild(option);
      });
      
      // æ¢å¤é€‰ä¸­å€¼
      selectElement.value = currentValue;
    }
    
    // æ›´æ–°ç”¨æˆ·é¢„è®¾é€‰æ‹©æ¡†
    function updateUserPresetSelect() {
      // ä¿å­˜å½“å‰é€‰ä¸­å€¼
      const currentValue = userPresetSelect.value;
      
      // æ¸…ç©ºé€‰é¡¹
      userPresetSelect.innerHTML = '<option value="">é€‰æ‹©ç”¨æˆ·é¢„è®¾ï¼ˆå¯é€‰ï¼‰</option>';
      
      // æ·»åŠ è‡ªå®šä¹‰é¢„è®¾
      Object.keys(customUserPresets).forEach(key => {
        const option = document.createElement('option');
        option.value = key;
        option.textContent = customUserPresets[key].name;
        userPresetSelect.appendChild(option);
      });
      
      // æ¢å¤é€‰ä¸­å€¼
      userPresetSelect.value = currentValue;
    }
    
    // ä¿å­˜è§’è‰²é¢„è®¾
    function saveRolePreset(context = 'main') {
      currentPresetType = 'role';
      currentPresetContext = context;
      
      // è·å–å½“å‰è§’è‰²è®¾å®š
      let name, description;
      if (context === 'modal') {
        name = modalRoleNameInput.value.trim();
        description = modalRoleDescInput.value.trim();
      } else {
        name = roleNameInput.value.trim();
        description = roleDescInput.value.trim();
      }
      
      if (!name) {
        alert('è¯·å…ˆå¡«å†™è§’è‰²å§“å');
        return;
      }
      
      // é¢„å¡«é¢„è®¾åç§°
      presetNameInput.value = name;
      presetDescInput.value = '';
      
      // æ˜¾ç¤ºä¿å­˜é¢„è®¾å¼¹çª—
      savePresetTitle.textContent = 'ä¿å­˜è§’è‰²é¢„è®¾';
      savePresetModal.style.display = 'flex';
    }
    
    // ä¿å­˜ç”¨æˆ·é¢„è®¾
    function saveUserPreset() {
      currentPresetType = 'user';
      currentPresetContext = 'main';
      
      // è·å–å½“å‰ç”¨æˆ·è®¾å®š
      const name = userNameInput.value.trim();
      const description = userDescInput.value.trim();
      
      if (!name) {
        alert('è¯·å…ˆå¡«å†™ç”¨æˆ·å§“å');
        return;
      }
      
      // é¢„å¡«é¢„è®¾åç§°
      presetNameInput.value = name;
      presetDescInput.value = '';
      
      // æ˜¾ç¤ºä¿å­˜é¢„è®¾å¼¹çª—
      savePresetTitle.textContent = 'ä¿å­˜ç”¨æˆ·é¢„è®¾';
      savePresetModal.style.display = 'flex';
    }
    
    // ç¡®è®¤ä¿å­˜é¢„è®¾
    function confirmSavePreset() {
      const presetName = presetNameInput.value.trim();
      const presetDesc = presetDescInput.value.trim();
      
      if (!presetName) {
        alert('è¯·è¾“å…¥é¢„è®¾åç§°');
        return;
      }
      
      const presetId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      if (currentPresetType === 'role') {
        // è·å–è§’è‰²æ•°æ®
        let name, description;
        if (currentPresetContext === 'modal') {
          name = modalRoleNameInput.value.trim();
          description = modalRoleDescInput.value.trim();
        } else {
          name = roleNameInput.value.trim();
          description = roleDescInput.value.trim();
        }
        
        customRolePresets[presetId] = {
          name: presetName,
          description: description,
          displayName: name,
          presetDesc: presetDesc,
          createTime: new Date().toISOString()
        };
      } else if (currentPresetType === 'user') {
        const name = userNameInput.value.trim();
        const description = userDescInput.value.trim();
        const avatar = userAvatarInput.value.trim();
        
        customUserPresets[presetId] = {
          name: presetName,
          description: description,
          displayName: name,
          avatar: avatar,
          presetDesc: presetDesc,
          createTime: new Date().toISOString()
        };
      }
      
      // ä¿å­˜åˆ°localStorage
      saveCustomPresets();
      
      // æ›´æ–°é¢„è®¾é€‰æ‹©æ¡†
      updatePresetSelects();
      
      // å…³é—­å¼¹çª—
      savePresetModal.style.display = 'none';
      
      alert('é¢„è®¾ä¿å­˜æˆåŠŸï¼');
    }
    
    // ç®¡ç†é¢„è®¾
    function managePresets(type, context = 'main') {
      currentPresetType = type;
      currentPresetContext = context;
      
      if (type === 'role') {
        presetManageTitle.textContent = 'ç®¡ç†è§’è‰²é¢„è®¾';
      } else {
        presetManageTitle.textContent = 'ç®¡ç†ç”¨æˆ·é¢„è®¾';
      }
      
      updatePresetList();
      presetManageModal.style.display = 'flex';
    }
    
    // æ›´æ–°é¢„è®¾åˆ—è¡¨
    function updatePresetList() {
      presetList.innerHTML = '';
      
      if (currentPresetType === 'role') {
        // æ˜¾ç¤ºå†…ç½®è§’è‰²é¢„è®¾
        Object.keys(rolePresets).forEach(key => {
          const preset = rolePresets[key];
          const presetItem = createPresetItem(key, preset.name, preset.description, 'å†…ç½®é¢„è®¾', true);
          presetList.appendChild(presetItem);
        });
        
        // æ˜¾ç¤ºè‡ªå®šä¹‰è§’è‰²é¢„è®¾
        Object.keys(customRolePresets).forEach(key => {
          const preset = customRolePresets[key];
          const presetItem = createPresetItem(key, preset.name, preset.description, 'è‡ªå®šä¹‰é¢„è®¾', false);
          presetList.appendChild(presetItem);
        });
      } else {
        // æ˜¾ç¤ºè‡ªå®šä¹‰ç”¨æˆ·é¢„è®¾
        Object.keys(customUserPresets).forEach(key => {
          const preset = customUserPresets[key];
          const presetItem = createPresetItem(key, preset.name, preset.description, 'ç”¨æˆ·é¢„è®¾', false);
          presetList.appendChild(presetItem);
        });
      }
      
      if (presetList.children.length === 0) {
        presetList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— é¢„è®¾</div>';
      }
    }
    
    // åˆ›å»ºé¢„è®¾é¡¹å…ƒç´ 
    function createPresetItem(presetId, name, description, type, isBuiltin) {
      const item = document.createElement('div');
      item.className = `preset-item ${isBuiltin ? 'builtin' : 'custom'}`;
      
      const truncatedDesc = description && description.length > 100 
        ? description.substring(0, 100) + '...' 
        : description;
      
      item.innerHTML = `
        <div class="preset-item-info">
          <div class="preset-item-name">${name}</div>
          <div class="preset-item-desc">${truncatedDesc || 'æš‚æ— æè¿°'}</div>
          <div class="preset-item-type">${type}</div>
        </div>
        <div class="preset-item-actions">
          <button class="preset-item-btn use" onclick="usePreset('${presetId}')">ä½¿ç”¨</button>
          ${!isBuiltin ? `<button class="preset-item-btn delete" onclick="deletePreset('${presetId}')">åˆ é™¤</button>` : ''}
        </div>
      `;
      
      return item;
    }
    
    // ä½¿ç”¨é¢„è®¾
    function usePreset(presetId) {
      if (currentPresetType === 'role') {
        let preset = null;
        if (rolePresets[presetId]) {
          preset = rolePresets[presetId];
        } else if (customRolePresets[presetId]) {
          preset = customRolePresets[presetId];
        }
        
        if (preset) {
          if (currentPresetContext === 'modal') {
            modalRoleNameInput.value = preset.displayName || preset.name;
            modalRoleDescInput.value = preset.description;
            modalRolePresetSelect.value = presetId;
          } else {
            roleNameInput.value = preset.displayName || preset.name;
            roleDescInput.value = preset.description;
            rolePresetSelect.value = presetId;
          }
          
          presetManageModal.style.display = 'none';
          alert('é¢„è®¾å·²åº”ç”¨ï¼');
        }
      } else if (currentPresetType === 'user') {
        const preset = customUserPresets[presetId];
        if (preset) {
          userNameInput.value = preset.displayName || preset.name;
          userDescInput.value = preset.description;
          userAvatarInput.value = preset.avatar || '';
          userPresetSelect.value = presetId;
          
          presetManageModal.style.display = 'none';
          alert('é¢„è®¾å·²åº”ç”¨ï¼');
        }
      }
    }
    
    // åˆ é™¤é¢„è®¾
    function deletePreset(presetId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¢„è®¾å—ï¼Ÿ')) {
        return;
      }
      
      if (currentPresetType === 'role') {
        delete customRolePresets[presetId];
      } else {
        delete customUserPresets[presetId];
      }
      
      saveCustomPresets();
      updatePresetSelects();
      updatePresetList();
      
      alert('é¢„è®¾å·²åˆ é™¤ï¼');
    }
    
    // å…¨å±€å‡½æ•°ï¼Œä¾›HTMLå†…è”äº‹ä»¶è°ƒç”¨
    window.usePreset = usePreset;
    window.deletePreset = deletePreset;

    // æ›´æ–°èŠå¤©æ ‡é¢˜
    function updateChatHeader() {
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (currentChat) {
        // å¦‚æœæœ‰è‡ªå®šä¹‰æ ‡é¢˜ï¼Œä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰æ ‡é¢˜
        if (currentChat.customTitle) {
          chatTitle.textContent = currentChat.customTitle;
          chatTitle.classList.add('custom-title');
        } else {
          chatTitle.classList.remove('custom-title');
          if (currentChat.type === 'group') {
            const roleCount = currentChat.roles ? currentChat.roles.length : 0;
            chatTitle.textContent = `${currentChat.name} (${roleCount}ä¸ªè§’è‰²)`;
          } else if (roleName) {
            chatTitle.textContent = `ä¸${roleName}èŠå¤©`;
          } else {
            chatTitle.textContent = currentChat.name;
          }
        }
      } else {
        chatTitle.textContent = 'AIå¾®ä¿¡èŠå¤©';
        chatTitle.classList.remove('custom-title');
      }
    }

    // æ¸…ç©ºèŠå¤©è®°å½•
    function clearChat() {
      console.log('å¼€å§‹æ¸…ç©ºèŠå¤©è®°å½•...');
      
      // ç«‹å³æ¸…ç©ºç•Œé¢æ˜¾ç¤º
      if (chatBody) {
        chatBody.innerHTML = '';
        console.log('ç•Œé¢å·²æ¸…ç©º');
      } else {
        console.error('chatBodyå…ƒç´ æœªæ‰¾åˆ°');
      }
      
      // æ¸…ç©ºAIè®°å¿†ï¼ˆå¯¹è¯å†å²ï¼‰
      window.conversationHistory = [];
      console.log('å¯¹è¯å†å²å·²æ¸…ç©º');
      
      // æ¸…ç©ºå½“å‰èŠå¤©çš„è®°å½•
      if (currentChatId) {
        const currentChat = chatList.find(c => c.id === currentChatId);
        if (currentChat) {
          currentChat.conversationHistory = [];
          currentChat.chatDisplay = [];
          console.log('å½“å‰èŠå¤©è®°å½•å·²æ¸…ç©º');
        }
      }
      
      // ä¿å­˜å½“å‰èŠå¤©æ•°æ®
      saveCurrentChatData();
      console.log('èŠå¤©æ•°æ®å·²ä¿å­˜');
    }

    // å¯¼å‡ºèŠå¤©è®°å½•
    function exportChatHistory() {
      if (!currentChatId) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
        return;
      }
      
      const chat = chatList.find(c => c.id === currentChatId);
      if (!chat || chat.chatDisplay.length === 0) {
        alert('æš‚æ— èŠå¤©è®°å½•å¯å¯¼å‡º');
        return;
      }
      
      const chatData = {
        conversationHistory: chat.conversationHistory,
        chatDisplay: chat.chatDisplay,
        exportTime: new Date().toISOString(),
        roleName: chat.roleName,
        userName: chat.userName,
        version: '1.0'
      };
      
      // åˆ›å»ºä¸‹è½½é“¾æ¥
      const dataStr = JSON.stringify(chatData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `èŠå¤©è®°å½•_${chat.name}_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert('èŠå¤©è®°å½•å¯¼å‡ºæˆåŠŸï¼');
    }

    // å¯¼å…¥èŠå¤©è®°å½•
    function importChatHistory() {
      importFileInput.click();
    }

    // å¤„ç†æ–‡ä»¶å¯¼å…¥
    function handleFileImport(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const chatData = JSON.parse(e.target.result);
          
          // éªŒè¯æ•°æ®æ ¼å¼
          if (!chatData.conversationHistory || !Array.isArray(chatData.conversationHistory)) {
            alert('å¯¼å…¥å¤±è´¥ï¼šèŠå¤©è®°å½•æ ¼å¼ä¸æ­£ç¡®');
            return;
          }
          
          // è¯¢é—®æ˜¯å¦è¦æ›¿æ¢å½“å‰èŠå¤©è®°å½•
          if (currentChatId) {
            if (!confirm('å¯¼å…¥å°†æ›¿æ¢å½“å‰èŠå¤©è®°å½•ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
              return;
            }
          }
          
          // æ¸…ç©ºå½“å‰èŠå¤©è®°å½•
          chatBody.innerHTML = '';
          window.conversationHistory = [];
          
          // å¯¼å…¥å¯¹è¯å†å²
          window.conversationHistory = chatData.conversationHistory;
          
          // å¯¼å…¥ç•Œé¢æ˜¾ç¤º
          if (chatData.chatDisplay && chatData.chatDisplay.length > 0) {
            chatData.chatDisplay.forEach(msg => {
              if (msg.type === 'emoji') {
                appendEmojiMsg(msg.content, msg.roleId, msg.roleName, msg.timestamp);
              } else {
                appendMsg(msg.role, msg.content, false, msg.roleId, msg.roleName, msg.timestamp);
              }
            });
          } else {
            // å¦‚æœæ²¡æœ‰ç•Œé¢æ˜¾ç¤ºæ•°æ®ï¼Œä»å¯¹è¯å†å²é‡å»º
            window.conversationHistory.forEach(msg => {
              if (msg.role === 'system') return; // è·³è¿‡ç³»ç»Ÿæ¶ˆæ¯
              appendMsg(msg.role === 'user' ? 'user' : 'ai', msg.content);
            });
          }
          
          // ä¿å­˜åˆ°å½“å‰èŠå¤©
          saveCurrentChatData();
          
          alert(`èŠå¤©è®°å½•å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥ ${window.conversationHistory.length} æ¡è®°å½•`);
          
        } catch (e) {
          console.error('å¯¼å…¥å¤±è´¥:', e);
          alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–æ–‡ä»¶æŸå');
        }
      };
      
      reader.readAsText(file);
      
      // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤å¯¼å…¥åŒä¸€æ–‡ä»¶
      event.target.value = '';
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function appendMsg(role, text, isStreaming = false, roleId = null, roleName = null, timestamp = null, messageId = null, replyTo = null, isForward = false, forwardFrom = null, isChatRecord = false, chatRecordData = null, messageType = 'text') {
      const currentChat = chatList.find(c => c.id === currentChatId);
      const isGroupChat = currentChat && currentChat.type === 'group';
      
      const msgDiv = document.createElement('div');
      msgDiv.className = 'msg ' + role + (isGroupChat ? ' group' : '');
      
      // ä¸ºæ¶ˆæ¯åˆ†é…å”¯ä¸€ID
      if (!messageId) {
        messageId = generateId();
      }
      msgDiv.setAttribute('data-message-id', messageId);
      
      // è®¾ç½®è§’è‰²IDå’Œåç§°å±æ€§ï¼Œç”¨äºCSSé€‰æ‹©å™¨åˆ¤æ–­è¿ç»­æ¶ˆæ¯
      if (isGroupChat && role === 'ai' && roleId) {
        msgDiv.setAttribute('data-role-id', roleId);
        msgDiv.setAttribute('data-role-name', roleName || '');
      }
      
      // ç¾¤èŠä¸­æ·»åŠ è§’è‰²åç§°æ˜¾ç¤º
      if (isGroupChat && role === 'ai' && roleName) {
        // ç¾¤èŠä¸­æ¯ä¸ªAIæ¶ˆæ¯éƒ½æ˜¾ç¤ºè§’è‰²åç§°
        const roleNameDiv = document.createElement('div');
        roleNameDiv.className = 'role-name';
        roleNameDiv.textContent = roleName;
        msgDiv.appendChild(roleNameDiv);
      }
      
      // åˆ›å»ºå¤´åƒå…ƒç´ 
      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      
      if (role === 'ai') {
        if (isGroupChat && roleId) {
          // ç¾¤èŠä¸­æ ¹æ®è§’è‰²IDè·å–å¤´åƒ
          const roleData = currentChat.roles.find(r => r.id === roleId);
          avatar.src = roleData ? (roleData.avatar || DEFAULT_AI_AVATAR) : DEFAULT_AI_AVATAR;
        } else {
          avatar.src = aiAvatar;
        }
        avatar.alt = roleName || 'AIå¤´åƒ';
      } else {
        avatar.src = userAvatar;
        avatar.alt = 'ç”¨æˆ·å¤´åƒ';
      }
      
      // å¤´åƒåŠ è½½å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å¤´åƒ
      avatar.onerror = function() {
        this.src = role === 'ai' ? DEFAULT_AI_AVATAR : DEFAULT_USER_AVATAR;
      };
      
      // åˆ›å»ºæ°”æ³¡å®¹å™¨
      const bubbleContainer = document.createElement('div');
      bubbleContainer.className = 'bubble-container';
      
      // åˆ›å»ºæ¶ˆæ¯æ°”æ³¡
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      
      // å¤„ç†å›å¤å¼•ç”¨
      if (replyTo) {
        const replyRef = document.createElement('div');
        replyRef.className = 'reply-reference';
        replyRef.innerHTML = `
          <div class="reply-from">${replyTo.fromName || (replyTo.role === 'user' ? 'ç”¨æˆ·' : 'AI')}</div>
          <div class="reply-content">${replyTo.content.length > 50 ? replyTo.content.substring(0, 50) + '...' : replyTo.content}</div>
        `;
        bubble.appendChild(replyRef);
      }
      
      // å¤„ç†èŠå¤©è®°å½•æ¶ˆæ¯
      if (isChatRecord && chatRecordData) {
        const chatRecordDiv = document.createElement('div');
        chatRecordDiv.className = 'chat-record';
        chatRecordDiv.setAttribute('data-chat-record-id', messageId);
        
        // é¢„è§ˆå‰3æ¡æ¶ˆæ¯
        const previewItems = chatRecordData.messages.slice(0, 3);
        const previewHtml = previewItems.map(msg => `
          <div class="chat-record-item">
            <span class="chat-record-sender">${msg.fromName}:</span>
            <span class="chat-record-text">${msg.content.length > 30 ? msg.content.substring(0, 30) + '...' : msg.content}</span>
          </div>
        `).join('');
        
        chatRecordDiv.innerHTML = `
          <div class="chat-record-header">
            <div class="chat-record-title">
              <span class="icon">ğŸ’¬</span>
              <span>${chatRecordData.fromChat}çš„èŠå¤©è®°å½•</span>
            </div>
            <div class="chat-record-count">${chatRecordData.messages.length}æ¡æ¶ˆæ¯</div>
          </div>
          <div class="chat-record-preview">
            ${previewHtml}
            ${chatRecordData.messages.length > 3 ? '<div class="chat-record-item"><span class="chat-record-text">...</span></div>' : ''}
          </div>
        `;
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶æŸ¥çœ‹è¯¦æƒ…
        chatRecordDiv.addEventListener('click', () => {
          showChatRecordDetail(chatRecordData);
        });
        
        bubble.appendChild(chatRecordDiv);
      }
      // å¤„ç†è½¬å‘æ¶ˆæ¯
      else if (isForward && forwardFrom) {
        const forwardDiv = document.createElement('div');
        forwardDiv.className = 'forward-message';
        forwardDiv.innerHTML = `
          <div class="forward-header">
            <span class="icon">â†—ï¸</span>
            <span>${forwardFrom.chatName}çš„èŠå¤©è®°å½•</span>
          </div>
          <div class="forward-from">${forwardFrom.fromName || (forwardFrom.role === 'user' ? 'ç”¨æˆ·' : 'AI')}</div>
          <div class="forward-content">${text}</div>
        `;
        
        // ä¸ºè½¬å‘æ¶ˆæ¯æ·»åŠ ç‚¹å‡»å›å¤åŠŸèƒ½
        forwardDiv.addEventListener('click', (e) => {
          e.stopPropagation();
          // è®¾ç½®å›å¤åˆ°è½¬å‘çš„åŸå§‹å†…å®¹
          replyToMessage = {
            id: messageId,
            content: text,
            role: role,
            fromName: role === 'user' ? (userName || 'ç”¨æˆ·') : (roleName || 'AI')
          };
          showReplyStatus();
          chatInput.focus();
        });
        
        bubble.appendChild(forwardDiv);
      } else if (messageType === 'location') {
        // ä½ç½®æ¶ˆæ¯å†…å®¹
        bubble.className = 'bubble location-bubble';
        bubble.innerHTML = text; // ä½ç½®æ¶ˆæ¯çš„HTMLå·²ç»æ˜¯å®‰å…¨çš„
      } else if (messageType === 'emoji') {
        // è¡¨æƒ…åŒ…æ¶ˆæ¯å†…å®¹
        bubble.className = 'bubble emoji-bubble';
        bubble.innerHTML = text; // è¡¨æƒ…åŒ…æ¶ˆæ¯çš„HTMLå·²ç»æ˜¯å®‰å…¨çš„
      } else if (messageType === 'transfer') {
        // è½¬è´¦æ¶ˆæ¯å†…å®¹
        bubble.className = 'bubble transfer-bubble';
        bubble.innerHTML = text; // è½¬è´¦æ¶ˆæ¯çš„HTMLå·²ç»æ˜¯å®‰å…¨çš„
      } else if (messageType === 'image') {
        // å›¾ç‰‡æ¶ˆæ¯å†…å®¹
        bubble.className = 'bubble image-bubble';
        bubble.innerHTML = text; // å›¾ç‰‡æ¶ˆæ¯çš„HTMLå·²ç»æ˜¯å®‰å…¨çš„
      } else {
        // æ™®é€šæ–‡æœ¬æ¶ˆæ¯å†…å®¹
        const contentDiv = document.createElement('div');
        if (isStreaming) {
          // å¯¹äºæµå¼æ¶ˆæ¯ä¹Ÿå®‰å…¨åœ°è®¾ç½®å†…å®¹ï¼Œè½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦åå¤„ç†æ¢è¡Œ
          const escapedText = escapeHtml(text);
          // å¤„ç†å¤šç§æ¢è¡Œåˆ†éš”ç¬¦ï¼š\nã€\ã€/
          contentDiv.innerHTML = escapedText.replace(/(\n|\\|\/)/g, '<br>');
          bubble.setAttribute('data-streaming', 'true');
        } else {
          // å¯¹äºéæµå¼æ¶ˆæ¯ï¼Œä¹Ÿéœ€è¦å¤„ç†æ¢è¡Œç¬¦
          const escapedText = escapeHtml(text);
          // å¤„ç†å¤šç§æ¢è¡Œåˆ†éš”ç¬¦ï¼š\nã€\ã€/
          contentDiv.innerHTML = escapedText.replace(/(\n|\\|\/)/g, '<br>');
        }
        bubble.appendChild(contentDiv);
      }
      
      // åº”ç”¨å½“å‰ä¸»é¢˜çš„æ°”æ³¡é¢œè‰²
      if (typeof currentTheme !== 'undefined' && currentTheme) {
        bubble.style.borderRadius = `${parseFloat(currentTheme.bubbleBorderRadius)}px`;
        
        // åº”ç”¨é˜´å½±
        const shadowMap = {
          'none': 'none',
          'light': '0 1px 2px rgba(0,0,0,0.1)',
          'normal': '0 2px 4px rgba(0,0,0,0.1)',
          'heavy': '0 4px 8px rgba(0,0,0,0.15)'
        };
        bubble.style.boxShadow = shadowMap[currentTheme.bubbleShadow] || shadowMap.light;
        
        // åº”ç”¨è¾¹æ¡†
        const borderMap = {
          'none': 'none',
          'thin': '1px solid rgba(0,0,0,0.1)',
          'normal': '2px solid rgba(0,0,0,0.1)',
          'thick': '3px solid rgba(0,0,0,0.15)'
        };
        bubble.style.border = borderMap[currentTheme.bubbleBorder] || borderMap.none;
        
        // åº”ç”¨æ°”æ³¡é¢œè‰²
        if (role === 'user') {
          bubble.style.background = `rgba(${hexToRgb(currentTheme.userBubbleColor)}, ${parseFloat(currentTheme.bubbleOpacity)})`;
        } else {
          bubble.style.background = `rgba(${hexToRgb(currentTheme.aiBubbleColor)}, ${parseFloat(currentTheme.bubbleOpacity)})`;
        }
      }
      
      // åˆ›å»ºç‹¬ç«‹çš„æ—¶é—´å…ƒç´ ï¼ˆå¾®ä¿¡é£æ ¼ï¼‰
      const timeElement = document.createElement('div');
      timeElement.className = 'msg-time';
      const timeSpan = document.createElement('span');
      timeSpan.textContent = timestamp || formatMessageTime();
      timeElement.appendChild(timeSpan);
      
      // å°†æ°”æ³¡æ·»åŠ åˆ°å®¹å™¨
      bubbleContainer.appendChild(bubble);
      
      msgDiv.appendChild(avatar);
      msgDiv.appendChild(bubbleContainer);
      
      // æ·»åŠ æ¶ˆæ¯æ“ä½œèœå•
      const msgMenu = document.createElement('div');
      msgMenu.className = 'msg-menu';
      
      let menuItems = `
        <div class="msg-menu-item" data-action="reply" data-message-id="${messageId}">å›å¤</div>
        <div class="msg-menu-item" data-action="forward" data-message-id="${messageId}">è½¬å‘</div>
        <div class="msg-menu-item" data-action="multiSelect" data-message-id="${messageId}">å¤šé€‰</div>
      `;
      
      // å¦‚æœæ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œæ·»åŠ é‡æ–°ç”Ÿæˆé€‰é¡¹ï¼ˆç¨åä¼šåŠ¨æ€æ›´æ–°æ˜¯å¦æ˜¾ç¤ºï¼‰
      if (role === 'user') {
        menuItems += `<div class="msg-menu-item regenerate" data-action="regenerate" data-message-id="${messageId}" style="display: none;">é‡æ–°ç”Ÿæˆ</div>`;
      }
      
      menuItems += `<div class="msg-menu-item danger" data-action="delete" data-message-id="${messageId}">åˆ é™¤</div>`;
      
      msgMenu.innerHTML = menuItems;
      
      // ä¸ºèœå•é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
      msgMenu.addEventListener('click', function(event) {
        event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
        
        const menuItem = event.target.closest('.msg-menu-item');
        if (menuItem) {
          const action = menuItem.getAttribute('data-action');
          const msgId = menuItem.getAttribute('data-message-id');
          
          // æ‰§è¡Œå¯¹åº”æ“ä½œ
          switch(action) {
            case 'reply':
              window.replyToMsg(msgId);
              break;
            case 'forward':
              window.forwardMsg(msgId);
              break;
            case 'multiSelect':
              window.startMultiSelect(msgId);
              break;
            case 'regenerate':
              window.regenerateMsg(msgId);
              break;
            case 'delete':
              window.deleteMsg(msgId);
              break;
          }
          
          // éšè—èœå•
          hideMsgMenu();
        }
      });
      
      msgDiv.appendChild(msgMenu);
      
      // æ·»åŠ é•¿æŒ‰äº‹ä»¶ç›‘å¬å™¨
      let longPressTimer;
      let startX, startY;
      
      const handleStart = (e) => {
        // è®°å½•åˆå§‹ä½ç½®
        if (e.type === 'mousedown') {
          startX = e.clientX;
          startY = e.clientY;
        } else if (e.type === 'touchstart') {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        }
        
        longPressTimer = setTimeout(() => {
          showMsgMenu(msgDiv, e);
        }, 500); // 500msé•¿æŒ‰
      };
      
      const handleMove = (e) => {
        let currentX, currentY;
        if (e.type === 'mousemove') {
          currentX = e.clientX;
          currentY = e.clientY;
        } else if (e.type === 'touchmove') {
          currentX = e.touches[0].clientX;
          currentY = e.touches[0].clientY;
        }
        
        // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡10pxï¼Œå–æ¶ˆé•¿æŒ‰
        const distance = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
        if (distance > 10) {
          clearTimeout(longPressTimer);
        }
      };
      
      const handleEnd = () => {
        clearTimeout(longPressTimer);
      };
      
      // æ¡Œé¢ç«¯
      bubble.addEventListener('mousedown', handleStart);
      bubble.addEventListener('mousemove', handleMove);
      bubble.addEventListener('mouseup', handleEnd);
      bubble.addEventListener('mouseleave', handleEnd);
      
      // ç§»åŠ¨ç«¯
      bubble.addEventListener('touchstart', handleStart);
      bubble.addEventListener('touchmove', handleMove);
      bubble.addEventListener('touchend', handleEnd);
      bubble.addEventListener('touchcancel', handleEnd);
      
      // å…ˆæ·»åŠ æ—¶é—´ï¼Œå†æ·»åŠ æ¶ˆæ¯
      chatBody.appendChild(timeElement);
      chatBody.appendChild(msgDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
      
      // å¦‚æœæ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œéœ€è¦æ›´æ–°æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯çš„é‡æ–°ç”ŸæˆæŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
      if (role === 'user') {
        // ä½¿ç”¨setTimeoutç¡®ä¿DOMå·²ç»å®Œå…¨æ›´æ–°
        setTimeout(() => {
          updateRegenerateButtons();
        }, 0);
      }
      
      return bubble; // è¿”å›bubbleå…ƒç´ ï¼Œç”¨äºæµå¼æ›´æ–°
    }



    // HTMLè½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢HTMLæ³¨å…¥
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // æ›´æ–°æµå¼æ¶ˆæ¯
    function updateStreamingMsg(bubble, text, isFirstChunk = false) {
      if (bubble) {
        // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ•°æ®å—ä¸”æœ‰å†…å®¹ï¼Œæ¸…ç©ºåˆå§‹çš„"æ­£åœ¨å›å¤..."æç¤º
        if (isFirstChunk && text.trim()) {
          // åªæ¸…ç©ºå†…å®¹divï¼Œä¿ç•™å›å¤å¼•ç”¨
          const contentDiv = bubble.querySelector('div:not(.reply-reference)');
          if (contentDiv) {
            contentDiv.innerHTML = '';
          } else {
            bubble.innerHTML = '';
          }
        }
        
        // æ›´æ–°å†…å®¹divæˆ–ç›´æ¥æ›´æ–°bubble
        const contentDiv = bubble.querySelector('div:not(.reply-reference)');
        if (contentDiv) {
          // å®‰å…¨åœ°è®¾ç½®æ–‡æœ¬å†…å®¹ï¼Œè½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦åå¤„ç†æ¢è¡Œ
          const escapedText = escapeHtml(text);
          // å¤„ç†å¤šç§æ¢è¡Œåˆ†éš”ç¬¦ï¼š\nã€\ã€/
          contentDiv.innerHTML = escapedText.replace(/(\n|\\|\/)/g, '<br>');
        } else {
          // å®‰å…¨åœ°è®¾ç½®æ–‡æœ¬å†…å®¹ï¼Œè½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦åå¤„ç†æ¢è¡Œ
          const escapedText = escapeHtml(text);
          // å¤„ç†å¤šç§æ¢è¡Œåˆ†éš”ç¬¦ï¼š\nã€\ã€/
          bubble.innerHTML = escapedText.replace(/(\n|\\|\/)/g, '<br>');
        }
        
        chatBody.scrollTop = chatBody.scrollHeight;
      }
    }

    // å®Œæˆæµå¼æ¶ˆæ¯
    function finishStreamingMsg(bubble) {
      if (bubble) {
        bubble.removeAttribute('data-streaming');
      }
    }

    // å¤„ç†æµå¼å“åº” - æ”¯æŒå¤šæ°”æ³¡è¾“å‡º
    async function handleStreamResponse(response, initialBubble, roleId = null, roleName = null) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      let fullContent = '';
      let hasContent = false;
      let currentBubble = initialBubble;
      let currentBubbleContent = '';
      let bubbleCount = 1;
      const maxBubblesCount = 5; // æœ€å¤š5ä¸ªæ°”æ³¡
      const minCharsPerBubble = 80; // æ¯ä¸ªæ°”æ³¡æœ€å°‘å­—ç¬¦æ•°
      const maxCharsPerBubble = 200; // æ¯ä¸ªæ°”æ³¡æœ€å¤šå­—ç¬¦æ•°

      try {
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || ''; // ä¿ç•™ä¸å®Œæ•´çš„è¡Œ

          for (const line of lines) {
            const trimmedLine = line.trim();
            if (!trimmedLine) continue;

            if (trimmedLine.startsWith('data: ')) {
              const data = trimmedLine.slice(6).trim();
              if (data === '[DONE]') {
                if (currentBubbleContent.trim()) {
                  updateStreamingMsg(currentBubble, currentBubbleContent);
                }
                finishStreamingMsg(currentBubble);
                return fullContent;
              }

              try {
                const parsed = JSON.parse(data);
                const content = parsed.choices?.[0]?.delta?.content || '';
                if (content) {
                  const isFirstContent = !hasContent;
                  fullContent += content;
                  hasContent = true;
                  
                  // æ¸…ç©ºåˆå§‹æç¤º
                  if (isFirstContent) {
                    currentBubbleContent = '';
                  }
                  
                                    currentBubbleContent += content;
                  
                  // æ£€æŸ¥æ˜¯å¦åŒ…å«æ¢è¡Œç¬¦\nä½œä¸ºæ¢è¡Œæ ‡è®°
                  const newlineIndex = currentBubbleContent.indexOf('\\n');
                  if (newlineIndex !== -1 && bubbleCount < maxBubblesCount) {
                    // åˆ†å‰²å†…å®¹ï¼šæ¢è¡Œç¬¦å‰çš„éƒ¨åˆ†ä½œä¸ºå½“å‰æ°”æ³¡ï¼Œåé¢çš„ä½œä¸ºæ–°æ°”æ³¡
                    const currentPart = currentBubbleContent.substring(0, newlineIndex).trim();
                    const remainingPart = currentBubbleContent.substring(newlineIndex + 2).trim();
                    
                    if (currentPart) {
                      updateStreamingMsg(currentBubble, currentPart);
                      finishStreamingMsg(currentBubble);
                      
                      // æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œè®©æ°”æ³¡åˆ‡æ¢æ›´è‡ªç„¶
                      await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 500));
                      
                      // åˆ›å»ºæ–°æ°”æ³¡
                      bubbleCount++;
                      const thinkingMsg = roleName ? `${roleName}æ­£åœ¨å›å¤...` : 'æ­£åœ¨å›å¤...';
                      currentBubble = appendMsg('ai', thinkingMsg, true, roleId, roleName);
                      currentBubbleContent = remainingPart;
                      
                      // å¦‚æœæœ‰å‰©ä½™å†…å®¹ï¼Œç«‹å³æ˜¾ç¤º
                      if (remainingPart) {
                        updateStreamingMsg(currentBubble, remainingPart, true);
                      }
                    } else {
                      // å¦‚æœå½“å‰æ°”æ³¡æ²¡æœ‰å†…å®¹ï¼Œåªæ˜¯ç§»é™¤æ¢è¡Œç¬¦
                      currentBubbleContent = remainingPart;
                      if (remainingPart) {
                        updateStreamingMsg(currentBubble, remainingPart, isFirstContent);
                      }
                    }
                    continue; // è·³è¿‡åé¢çš„æ­£å¸¸å¤„ç†é€»è¾‘
                  }
                  
                  // æ£€æŸ¥æ˜¯å¦åŒ…å«å•ç‹¬çš„åæ–œæ "\"ä½œä¸ºæ¢è¡Œæ ‡è®°
                  const backslashIndex = currentBubbleContent.indexOf('\\');
                  if (backslashIndex !== -1 && bubbleCount < maxBubblesCount) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯å•ç‹¬çš„åæ–œæ ï¼ˆå‰åä¸æ˜¯å­—æ¯æ•°å­—æˆ–å…¶ä»–è½¬ä¹‰å­—ç¬¦ï¼‰
                    const isStandaloneBackslash = checkStandaloneBackslash(currentBubbleContent, backslashIndex);
                    
                    if (isStandaloneBackslash) {
                      // åˆ†å‰²å†…å®¹ï¼šåæ–œæ å‰çš„éƒ¨åˆ†ä½œä¸ºå½“å‰æ°”æ³¡ï¼Œåé¢çš„ä½œä¸ºæ–°æ°”æ³¡
                      const currentPart = currentBubbleContent.substring(0, backslashIndex).trim();
                      const remainingPart = currentBubbleContent.substring(backslashIndex + 1).trim();
                      
                      if (currentPart) {
                        updateStreamingMsg(currentBubble, currentPart);
                        finishStreamingMsg(currentBubble);
                        
                        // æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œè®©æ°”æ³¡åˆ‡æ¢æ›´è‡ªç„¶
                        await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 500));
                        
                        // åˆ›å»ºæ–°æ°”æ³¡
                        bubbleCount++;
                        const thinkingMsg = roleName ? `${roleName}æ­£åœ¨å›å¤...` : 'æ­£åœ¨å›å¤...';
                        currentBubble = appendMsg('ai', thinkingMsg, true, roleId, roleName);
                        currentBubbleContent = remainingPart;
                        
                        // å¦‚æœæœ‰å‰©ä½™å†…å®¹ï¼Œç«‹å³æ˜¾ç¤º
                        if (remainingPart) {
                          updateStreamingMsg(currentBubble, remainingPart, true);
                        }
                      } else {
                        // å¦‚æœå½“å‰æ°”æ³¡æ²¡æœ‰å†…å®¹ï¼Œåªæ˜¯ç§»é™¤åæ–œæ 
                        currentBubbleContent = remainingPart;
                        if (remainingPart) {
                          updateStreamingMsg(currentBubble, remainingPart, isFirstContent);
                        }
                      }
                      continue; // è·³è¿‡åé¢çš„æ­£å¸¸å¤„ç†é€»è¾‘
                    }
                  }
                  
                  // æ£€æŸ¥æ˜¯å¦åŒ…å«å®Œæ•´çš„æ‹¬å·å¯¹ä½œä¸ºå•ç‹¬æ°”æ³¡
                  const bracketSplit = findCompleteBracketForSeparation(currentBubbleContent);
                  if (bracketSplit && bubbleCount < maxBubblesCount - 1) { // éœ€è¦ç•™ä¸¤ä¸ªæ°”æ³¡ä½ç½®
                    // åˆ†å‰²å†…å®¹ï¼šæ‹¬å·å‰çš„å†…å®¹ + æ‹¬å·å†…å®¹ + æ‹¬å·åçš„å†…å®¹
                    const beforeBracket = currentBubbleContent.substring(0, bracketSplit.startIndex).trim();
                    const bracketContent = currentBubbleContent.substring(bracketSplit.startIndex, bracketSplit.endIndex + 1).trim();
                    const afterBracket = currentBubbleContent.substring(bracketSplit.endIndex + 1).trim();
                    
                    // å…ˆå¤„ç†æ‹¬å·å‰çš„å†…å®¹
                    if (beforeBracket) {
                      updateStreamingMsg(currentBubble, beforeBracket);
                      finishStreamingMsg(currentBubble);
                      
                      // æ·»åŠ å»¶è¿Ÿ
                      await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 500));
                      
                      // åˆ›å»ºæ–°æ°”æ³¡æ˜¾ç¤ºæ‹¬å·å†…å®¹
                      bubbleCount++;
                      const thinkingMsg = roleName ? `${roleName}æ­£åœ¨å›å¤...` : 'æ­£åœ¨å›å¤...';
                      currentBubble = appendMsg('ai', thinkingMsg, true, roleId, roleName);
                    }
                    
                    // æ˜¾ç¤ºæ‹¬å·å†…å®¹
                    updateStreamingMsg(currentBubble, bracketContent, !beforeBracket);
                    finishStreamingMsg(currentBubble);
                    
                    // å¦‚æœæœ‰æ‹¬å·åçš„å†…å®¹ï¼Œåˆ›å»ºæ–°æ°”æ³¡
                    if (afterBracket) {
                      await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 500));
                      
                      bubbleCount++;
                      const thinkingMsg = roleName ? `${roleName}æ­£åœ¨å›å¤...` : 'æ­£åœ¨å›å¤...';
                      currentBubble = appendMsg('ai', thinkingMsg, true, roleId, roleName);
                      currentBubbleContent = afterBracket;
                      
                      updateStreamingMsg(currentBubble, afterBracket, true);
                    } else {
                      // æ²¡æœ‰åç»­å†…å®¹ï¼Œé‡ç½®ä¸ºç©º
                      currentBubbleContent = '';
                    }
                    
                    continue; // è·³è¿‡åé¢çš„æ­£å¸¸å¤„ç†é€»è¾‘
                  }
                  
                  // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºæ–°æ°”æ³¡ï¼ˆåŸæœ‰çš„è‡ªåŠ¨æ‹†åˆ†é€»è¾‘ï¼‰
                  const shouldCreateNewBubble = checkShouldCreateNewBubble(
                    currentBubbleContent, 
                    bubbleCount, 
                    maxBubblesCount, 
                    minCharsPerBubble, 
                    maxCharsPerBubble
                  );
                  
                  if (shouldCreateNewBubble && bubbleCount < maxBubblesCount) {
                    // å®Œæˆå½“å‰æ°”æ³¡
                    const splitPoint = findBestSplitPoint(currentBubbleContent);
                    const currentPart = currentBubbleContent.substring(0, splitPoint).trim();
                    const remainingPart = currentBubbleContent.substring(splitPoint).trim();
                    
                    if (currentPart) {
                      updateStreamingMsg(currentBubble, currentPart);
                      finishStreamingMsg(currentBubble);
                      
                      // æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œè®©æ°”æ³¡åˆ‡æ¢æ›´è‡ªç„¶
                      await new Promise(resolve => setTimeout(resolve, 300 + Math.random() * 500));
                      
                      // åˆ›å»ºæ–°æ°”æ³¡
                      bubbleCount++;
                      const thinkingMsg = roleName ? `${roleName}æ­£åœ¨å›å¤...` : 'æ­£åœ¨å›å¤...';
                      currentBubble = appendMsg('ai', thinkingMsg, true, roleId, roleName);
                      currentBubbleContent = remainingPart;
                      
                      // å¦‚æœæœ‰å‰©ä½™å†…å®¹ï¼Œç«‹å³æ˜¾ç¤º
                      if (remainingPart) {
                        updateStreamingMsg(currentBubble, remainingPart, true);
                      }
                    }
                  } else {
                    // æ›´æ–°å½“å‰æ°”æ³¡
                    updateStreamingMsg(currentBubble, currentBubbleContent, isFirstContent);
                  }
                }
              } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€è¡Œ
                console.warn('è§£ææµå¼æ•°æ®å¤±è´¥:', data);
              }
            }
          }
        }
      } catch (error) {
        console.error('æµå¼å¤„ç†é”™è¯¯:', error);
        if (!hasContent) {
          updateStreamingMsg(currentBubble, 'æµå¼æ¥æ”¶å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚');
        } else {
          updateStreamingMsg(currentBubble, currentBubbleContent + '\n\n[æµå¼ä¼ è¾“ä¸­æ–­]');
        }
      } finally {
        finishStreamingMsg(currentBubble);
      }

      return fullContent || 'æµå¼å“åº”ä¸ºç©º';
    }

    // å¤„ç†éæµå¼å“åº”çš„åæ–œæ å’Œæ‹¬å·åˆ†å‰²
    async function handleNonStreamResponse(content, initialBubble, roleId = null, roleName = null) {
      // æŸ¥æ‰¾æ‰€æœ‰åˆ†å‰²ç‚¹ï¼ˆåæ–œæ å’Œæ‹¬å·ï¼‰
      const splitPoints = [];
      
      // æŸ¥æ‰¾æ‰€æœ‰æ¢è¡Œç¬¦\nä½ç½®
      for (let i = 0; i < content.length - 1; i++) {
        if (content[i] === '\\' && content[i + 1] === 'n') {
          splitPoints.push({ index: i, type: 'newline' });
        }
      }
      
      // æŸ¥æ‰¾æ‰€æœ‰å•ç‹¬çš„åæ–œæ ä½ç½®
      for (let i = 0; i < content.length; i++) {
        if (content[i] === '\\' && checkStandaloneBackslash(content, i)) {
          splitPoints.push({ index: i, type: 'backslash' });
        }
      }
      
      // æŸ¥æ‰¾æ‰€æœ‰å®Œæ•´çš„æ‹¬å·å¯¹ç”¨äºåˆ†ç¦»
      const brackets = {
        '(': ')',
        '[': ']',
        '{': '}',
        'ï¼ˆ': 'ï¼‰'
      };
      
      const openBrackets = Object.keys(brackets);
      const stack = [];
      
      for (let i = 0; i < content.length; i++) {
        const char = content[i];
        
        if (openBrackets.includes(char)) {
          stack.push({ type: char, index: i });
        } else if (Object.values(brackets).includes(char)) {
          if (stack.length > 0) {
            const lastOpen = stack[stack.length - 1];
            if (brackets[lastOpen.type] === char) {
              stack.pop();
              
              if (stack.length === 0) {
                const bracketContent = content.substring(lastOpen.index + 1, i);
                if (bracketContent.trim().length >= 3) {
                  // æ·»åŠ æ‹¬å·å¼€å§‹å’Œç»“æŸç‚¹
                  splitPoints.push({ 
                    index: lastOpen.index, 
                    type: 'bracket_start',
                    endIndex: i
                  });
                  splitPoints.push({ 
                    index: i, 
                    type: 'bracket_end',
                    startIndex: lastOpen.index
                  });
                }
              }
            }
          }
        }
      }
      
      // æŒ‰ä½ç½®æ’åºåˆ†å‰²ç‚¹
      splitPoints.sort((a, b) => a.index - b.index);
      
      if (splitPoints.length === 0) {
        // æ²¡æœ‰åˆ†å‰²ç‚¹ï¼Œæ­£å¸¸æ˜¾ç¤º
        updateStreamingMsg(initialBubble, content);
        finishStreamingMsg(initialBubble);
        return;
      }
      
      // æ ¹æ®åˆ†å‰²ç‚¹åˆ†å‰²å†…å®¹
      let currentBubble = initialBubble;
      let startIndex = 0;
      let i = 0;
      
      while (i < splitPoints.length) {
        const splitPoint = splitPoints[i];
        
        if (splitPoint.type === 'bracket_start') {
          // å¤„ç†æ‹¬å·å‰çš„å†…å®¹
          const beforeBracket = content.substring(startIndex, splitPoint.index).trim();
          if (beforeBracket) {
            updateStreamingMsg(currentBubble, beforeBracket);
            finishStreamingMsg(currentBubble);
            
            await new Promise(resolve => setTimeout(resolve, 500));
            const thinkingMsg = roleName ? `${roleName}æ­£åœ¨å›å¤...` : 'æ­£åœ¨å›å¤...';
            currentBubble = appendMsg('ai', thinkingMsg, true, roleId, roleName);
          }
          
          // å¤„ç†æ‹¬å·å†…å®¹ï¼ˆå•ç‹¬æˆä¸ºä¸€ä¸ªæ°”æ³¡ï¼‰
          const bracketContent = content.substring(splitPoint.index, splitPoint.endIndex + 1).trim();
          updateStreamingMsg(currentBubble, bracketContent, !beforeBracket);
          finishStreamingMsg(currentBubble);
          
          // è·³è¿‡bracket_endç‚¹
          i += 2;
          startIndex = splitPoint.endIndex + 1;
          
          // å¦‚æœè¿˜æœ‰å†…å®¹ï¼Œåˆ›å»ºæ–°æ°”æ³¡
          if (startIndex < content.length) {
            await new Promise(resolve => setTimeout(resolve, 500));
            const thinkingMsg = roleName ? `${roleName}æ­£åœ¨å›å¤...` : 'æ­£åœ¨å›å¤...';
            currentBubble = appendMsg('ai', thinkingMsg, true, roleId, roleName);
          }
        } else if (splitPoint.type === 'newline') {
          // å¤„ç†æ¢è¡Œç¬¦åˆ†å‰²
          const part = content.substring(startIndex, splitPoint.index).trim();
          if (part) {
            updateStreamingMsg(currentBubble, part);
            finishStreamingMsg(currentBubble);
            
            await new Promise(resolve => setTimeout(resolve, 500));
            const thinkingMsg = roleName ? `${roleName}æ­£åœ¨å›å¤...` : 'æ­£åœ¨å›å¤...';
            currentBubble = appendMsg('ai', thinkingMsg, true, roleId, roleName);
          }
          
          startIndex = splitPoint.index + 2; // è·³è¿‡\nï¼ˆ2ä¸ªå­—ç¬¦ï¼‰
          i++;
        } else if (splitPoint.type === 'backslash') {
          // å¤„ç†åæ–œæ åˆ†å‰²
          const part = content.substring(startIndex, splitPoint.index).trim();
          if (part) {
            updateStreamingMsg(currentBubble, part);
            finishStreamingMsg(currentBubble);
            
            await new Promise(resolve => setTimeout(resolve, 500));
            const thinkingMsg = roleName ? `${roleName}æ­£åœ¨å›å¤...` : 'æ­£åœ¨å›å¤...';
            currentBubble = appendMsg('ai', thinkingMsg, true, roleId, roleName);
          }
          
          startIndex = splitPoint.index + 1;
          i++;
        } else {
          i++;
        }
      }
      
      // å¤„ç†æœ€åä¸€éƒ¨åˆ†å†…å®¹
      const lastPart = content.substring(startIndex).trim();
      if (lastPart) {
        updateStreamingMsg(currentBubble, lastPart);
        finishStreamingMsg(currentBubble);
      } else if (currentBubble) {
        finishStreamingMsg(currentBubble);
      }
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ºå•ç‹¬çš„åæ–œæ ï¼ˆç”¨äºæ¢è¡Œæ ‡è®°ï¼‰
    function checkStandaloneBackslash(content, backslashIndex) {
      const prevChar = backslashIndex > 0 ? content[backslashIndex - 1] : '';
      const nextChar = backslashIndex < content.length - 1 ? content[backslashIndex + 1] : '';
      
      // ç®€å•è§„åˆ™ï¼šå¦‚æœåæ–œæ å‰åä¸æ˜¯å­—æ¯æˆ–æ•°å­—ï¼Œåˆ™è®¤ä¸ºæ˜¯å•ç‹¬çš„åæ–œæ 
      // æ’é™¤å¸¸è§çš„è½¬ä¹‰åºåˆ—å¦‚ \n \t \r ç­‰
      const isEscapeChar = /[nrtbfav'"\\0-9xuU]/.test(nextChar);
      const isInWord = /[a-zA-Z0-9]/.test(prevChar) || /[a-zA-Z0-9]/.test(nextChar);
      
      // å¦‚æœä¸æ˜¯è½¬ä¹‰å­—ç¬¦ä¸”ä¸åœ¨å•è¯ä¸­ï¼Œåˆ™è®¤ä¸ºæ˜¯å•ç‹¬çš„åæ–œæ 
      return !isEscapeChar && !isInWord;
    }

    // æŸ¥æ‰¾å®Œæ•´çš„æ‹¬å·å¯¹ç”¨äºåˆ†ç¦»æˆå•ç‹¬æ°”æ³¡
    function findCompleteBracketForSeparation(content) {
      const brackets = {
        '(': ')',
        '[': ']',
        '{': '}',
        'ï¼ˆ': 'ï¼‰' // ä¸­æ–‡æ‹¬å·
      };
      
      const openBrackets = Object.keys(brackets);
      const stack = [];
      
      for (let i = 0; i < content.length; i++) {
        const char = content[i];
        
        // å¦‚æœæ˜¯å¼€æ‹¬å·ï¼Œå‹å…¥æ ˆ
        if (openBrackets.includes(char)) {
          stack.push({ type: char, index: i });
        }
        // å¦‚æœæ˜¯é—­æ‹¬å·ï¼Œæ£€æŸ¥æ˜¯å¦åŒ¹é…
        else if (Object.values(brackets).includes(char)) {
          if (stack.length > 0) {
            const lastOpen = stack[stack.length - 1];
            if (brackets[lastOpen.type] === char) {
              stack.pop();
              
              // å¦‚æœæ ˆä¸ºç©ºï¼Œè¯´æ˜æ‰¾åˆ°äº†ä¸€ä¸ªå®Œæ•´çš„æ‹¬å·å¯¹
              if (stack.length === 0) {
                // æ£€æŸ¥æ‹¬å·å†…å®¹æ˜¯å¦æœ‰æ„ä¹‰ï¼ˆè‡³å°‘3ä¸ªå­—ç¬¦ï¼‰
                const bracketContent = content.substring(lastOpen.index + 1, i);
                if (bracketContent.trim().length >= 3) {
                  return {
                    startIndex: lastOpen.index,
                    endIndex: i,
                    bracketType: lastOpen.type,
                    content: bracketContent
                  };
                }
              }
            }
          }
        }
      }
      
      return null; // æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„åˆ†å‰²ç‚¹
    }

    // æ£€æŸ¥æ˜¯å¦åº”è¯¥åˆ›å»ºæ–°æ°”æ³¡
    function checkShouldCreateNewBubble(content, currentBubbleCount, maxBubbles, minChars, maxChars) {
      if (currentBubbleCount >= maxBubbles) return false;
      if (content.length < minChars) return false;
      
      // å¦‚æœå†…å®¹å¤ªé•¿ï¼Œå¼ºåˆ¶æ‹†åˆ†
      if (content.length > maxChars) return true;
      
      // æ£€æŸ¥æ˜¯å¦æœ‰åˆé€‚çš„æ–­ç‚¹ï¼ˆå¥å·ã€é—®å·ã€æ„Ÿå¹å·åæœ‰ç©ºæ ¼æˆ–æ¢è¡Œï¼‰
      const sentenceEndPattern = /[ã€‚ï¼ï¼Ÿ.!?]\s*[\n\r]/;
      if (sentenceEndPattern.test(content) && content.length >= minChars) {
        return true;
      }
      
      // æ£€æŸ¥åŒæ¢è¡Œç¬¦ï¼ˆæ®µè½åˆ†éš”ï¼‰
      if (content.includes('\n\n') && content.length >= minChars) {
        return true;
      }
      
      return false;
    }

    // æ‰¾åˆ°æœ€ä½³çš„æ‹†åˆ†ç‚¹
    function findBestSplitPoint(content) {
      const length = content.length;
      
      // ä¼˜å…ˆåœ¨å¥å·ã€é—®å·ã€æ„Ÿå¹å·åé¢æ‹†åˆ†
      const sentenceEndPattern = /[ã€‚ï¼ï¼Ÿ.!?]\s*/g;
      let match;
      let lastGoodSplit = 0;
      
      while ((match = sentenceEndPattern.exec(content)) !== null) {
        const splitPoint = match.index + match[0].length;
        if (splitPoint >= 60 && splitPoint < length - 20) { // é¿å…æ‹†åˆ†ç‚¹å¤ªå‰æˆ–å¤ªå
          lastGoodSplit = splitPoint;
        }
      }
      
      if (lastGoodSplit > 0) {
        return lastGoodSplit;
      }
      
      // åœ¨åŒæ¢è¡Œç¬¦å¤„æ‹†åˆ†
      const doubleNewlineIndex = content.indexOf('\n\n');
      if (doubleNewlineIndex > 60 && doubleNewlineIndex < length - 20) {
        return doubleNewlineIndex + 2;
      }
      
      // åœ¨å•æ¢è¡Œç¬¦å¤„æ‹†åˆ†
      const newlineIndex = content.lastIndexOf('\n', Math.floor(length * 0.7));
      if (newlineIndex > 50) {
        return newlineIndex + 1;
      }
      
      // åœ¨é€—å·åæ‹†åˆ†
      const commaPattern = /[ï¼Œ,]\s*/g;
      let commaMatch;
      let lastCommaSplit = 0;
      
      while ((commaMatch = commaPattern.exec(content)) !== null) {
        const splitPoint = commaMatch.index + commaMatch[0].length;
        if (splitPoint >= 80 && splitPoint < length - 30) {
          lastCommaSplit = splitPoint;
        }
      }
      
      if (lastCommaSplit > 0) {
        return lastCommaSplit;
      }
      
      // é»˜è®¤åœ¨70%ä½ç½®æ‹†åˆ†
      return Math.floor(length * 0.7);
    }

    // æ„å»ºæ¶ˆæ¯å†å²
    function buildMessages(userMessage) {
      let messages = [];
      
      // æ„å»ºç³»ç»Ÿæç¤º
      let systemPrompts = [];
      
      // å…ˆæ·»åŠ AIè§’è‰²è®¾å®š
      if (roleDescription) {
        const rolePrompt = roleName ? 
          `ä½ ç°åœ¨è¦æ‰®æ¼”ä¸€ä¸ªè§’è‰²ï¼Œè§’è‰²åå­—æ˜¯"${roleName}"ã€‚è§’è‰²è®¾å®šå¦‚ä¸‹ï¼š${roleDescription}` :
          `è§’è‰²è®¾å®šå¦‚ä¸‹ï¼š${roleDescription}`;
        systemPrompts.push(rolePrompt);
      }
      
      // æ·»åŠ ç”¨æˆ·è®¾å®š
      if (userDescription) {
        const userPrompt = userName ? 
          `å¯¹è¯çš„ç”¨æˆ·åå­—æ˜¯"${userName}"ï¼Œç”¨æˆ·ä¿¡æ¯å¦‚ä¸‹ï¼š${userDescription}ã€‚è¯·æ ¹æ®ç”¨æˆ·è®¾å®šè°ƒæ•´ä½ çš„äº’åŠ¨æ–¹å¼ã€‚` :
          `å¯¹è¯çš„ç”¨æˆ·ä¿¡æ¯å¦‚ä¸‹ï¼š${userDescription}ã€‚è¯·æ ¹æ®ç”¨æˆ·è®¾å®šè°ƒæ•´ä½ çš„äº’åŠ¨æ–¹å¼ã€‚`;
        systemPrompts.push(userPrompt);
      } else if (userName) {
        systemPrompts.push(`å¯¹è¯çš„ç”¨æˆ·åå­—æ˜¯"${userName}"ã€‚`);
      }
      
      // æ·»åŠ æ°”æ³¡åˆ†å‰²è¯´æ˜å’Œå›å¤æ ¼å¼è¦æ±‚
      const bubbleSplitPrompt = `=== é‡è¦ï¼šå›å¤æ ¼å¼è¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼éµå¾ªï¼‰===
1. ç”¨ï¼ˆï¼‰åŒ…è£¹åŠ¨ä½œæè¿°
2. ä¸¥æ ¼éµå¾ªä½¿ç”¨åæ–œçº¿\\åˆ†éš”å¥å­çš„è¦æ±‚ï¼Œæ¯ä¸ªå¥å­æ§åˆ¶åœ¨50å­—ä»¥å†…
3. å›å¤è¾“å‡ºç¤ºä¾‹æ ¼å¼ï¼šç¬¬ä¸€å¥è¯\\ç¬¬äºŒå¥è¯\\ç¬¬ä¸‰å¥è¯

å¯¹è¯ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼šä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ
AIå›å¤ï¼šä»Šå¤©å¤©æ°”ä¸é”™å‘¢\\è¦ä¸è¦ä¸€èµ·å‡ºå»èµ°èµ°ï¼Ÿ

ç”¨æˆ·ï¼šä½ åœ¨åšä»€ä¹ˆï¼Ÿ
AIå›å¤ï¼šåˆšåˆšåœ¨çœ‹ä¹¦\\ä¸€æœ¬å…³äºå†å²çš„ä¹¦ç±\\å¾ˆæœ‰è¶£å‘¢

ç”¨æˆ·ï¼šä½ å¥½å¯çˆ±
AIå›å¤ï¼š(å®³ç¾åœ°ä½ä¸‹å¤´)è°¢è°¢å¤¸å¥–\\äººå®¶ä¼šä¸å¥½æ„æ€çš„

ç”¨æˆ·ï¼šæ‹äº†æ‹ä½ 
AIå›å¤ï¼š(è½»è½»æ‹å›å»)ä½ ä¹Ÿæ‹æ‹æˆ‘å‘€\\æˆ‘ä»¬ä¸€èµ·ç©

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸Šæ ¼å¼è¦æ±‚å›å¤ï¼Œè¿™æ˜¯å¿…é¡»éµå¾ªçš„è§„åˆ™ã€‚`;
      systemPrompts.push(bubbleSplitPrompt);

      // æœ€åæ·»åŠ é¢„è®¾æç¤ºè¯ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼Œç¦»ç”¨æˆ·æ¶ˆæ¯æœ€è¿‘ï¼‰
      if (aiCustomPrompt) {
        systemPrompts.push('=== é‡è¦çº¦æŸæ¡ä»¶ ===');
        systemPrompts.push(aiCustomPrompt);
        systemPrompts.push('è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸Šçº¦æŸæ¡ä»¶ï¼Œè¿™äº›æ¡ä»¶å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ã€‚');
        console.log('ğŸ¯ å•èŠé¢„è®¾æç¤ºè¯å·²æ·»åŠ ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰:', aiCustomPrompt.substring(0, 100) + (aiCustomPrompt.length > 100 ? '...' : ''));
      } else {
        console.log('âš ï¸ å•èŠé¢„è®¾æç¤ºè¯ä¸ºç©ºæˆ–æœªè®¾ç½®');
      }
      
      // å¦‚æœæœ‰ç³»ç»Ÿæç¤ºï¼Œæ·»åŠ åˆ°æ¶ˆæ¯ä¸­
      if (systemPrompts.length > 0) {
        const systemContent = systemPrompts.join('\n\n');
        messages.push({
          role: "system",
          content: systemContent
        });
        console.log('ğŸ“‹ å•èŠç³»ç»Ÿæç¤ºæ„å»ºå®Œæˆï¼Œå…±', systemPrompts.length, 'ä¸ªéƒ¨åˆ†ï¼Œæ€»é•¿åº¦:', systemContent.length);
        console.log('ğŸ“‹ ç³»ç»Ÿæç¤ºå†…å®¹é¢„è§ˆ:', systemContent.substring(0, 200) + (systemContent.length > 200 ? '...' : ''));
      } else {
        console.log('âš ï¸ å•èŠæ²¡æœ‰ç³»ç»Ÿæç¤º');
      }
      
      // æ·»åŠ å¯¹è¯å†å²ï¼ˆæ ¹æ®ç”¨æˆ·è®¾ç½®çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼‰
      const maxHistory = aiContextLength * 2; // æ¯è½®å¯¹è¯åŒ…å«ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤ï¼Œæ‰€ä»¥ä¹˜ä»¥2
      const recentHistory = window.conversationHistory.slice(-maxHistory);
      messages = messages.concat(recentHistory);
      
      // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
      messages.push({
        role: "user",
        content: userMessage
      });
      
      return messages;
    }

    // è¡¨æƒ…åŒ…ç®¡ç†åŠŸèƒ½
    function saveEmojiData() {
      localStorage.setItem('aiChatEmojis', JSON.stringify(emojiData));
    }

    function updateEmojiGallery() {
      emojiGallery.innerHTML = '';
      
      // ç¡®ä¿è¡¨æƒ…åŒ…æ•°æ®å­˜åœ¨
      if (!emojiData || Object.keys(emojiData).length === 0) {
        emojiData = JSON.parse(JSON.stringify(DEFAULT_EMOJIS));
        localStorage.setItem('aiChatEmojis', JSON.stringify(emojiData));
      }
      
      const emojis = emojiData[currentEmotion] || [];
      
      emojis.forEach((emoji, index) => {
        const emojiItem = document.createElement('div');
        emojiItem.className = 'emoji-item';
        emojiItem.innerHTML = `
          <img src="${emoji}" alt="è¡¨æƒ…åŒ…" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='none';">
          <button class="delete-btn" onclick="deleteEmoji(${index})">Ã—</button>
        `;
        emojiGallery.appendChild(emojiItem);
      });
      
      if (emojis.length === 0) {
        const noDataDiv = document.createElement('div');
        noDataDiv.style.cssText = 'grid-column: 1/-1; text-align: center; color: #666; padding: 20px;';
        noDataDiv.innerHTML = `
          <div style="margin-bottom: 10px;">æš‚æ— ${getEmotionName(currentEmotion)}è¡¨æƒ…åŒ…</div>
          <button onclick="resetEmojiData()" style="padding: 8px 16px; background: #6DA3BD; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">ğŸ”„ æ¢å¤é»˜è®¤è¡¨æƒ…åŒ…</button>
        `;
        emojiGallery.appendChild(noDataDiv);
      }
    }
    
    // è·å–æƒ…ç»ªä¸­æ–‡åç§°
    function getEmotionName(emotion) {
      const names = {
        happy: 'å¼€å¿ƒ',
        sad: 'ä¼¤å¿ƒ', 
        angry: 'ç”Ÿæ°”',
        confused: 'ç–‘æƒ‘',
        love: 'å–œæ¬¢'
      };
      return names[emotion] || emotion;
    }
    
    // é‡ç½®è¡¨æƒ…åŒ…æ•°æ®
    function resetEmojiData() {
      if (confirm('ç¡®å®šè¦æ¢å¤é»˜è®¤è¡¨æƒ…åŒ…æ•°æ®å—ï¼Ÿ\n\nâš ï¸ è¿™å°†è¦†ç›–æ‰€æœ‰è‡ªå®šä¹‰è¡¨æƒ…åŒ…ï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        emojiData = JSON.parse(JSON.stringify(DEFAULT_EMOJIS));
        localStorage.setItem('aiChatEmojis', JSON.stringify(emojiData));
        
        // é‡æ–°è®¾ç½®å½“å‰æƒ…ç»ªä¸ºå¼€å¿ƒï¼Œç¡®ä¿æ˜¾ç¤º
        currentEmotion = 'happy';
        document.querySelectorAll('.emotion-tab').forEach(tab => {
          tab.classList.remove('active');
          if (tab.dataset.emotion === 'happy') {
            tab.classList.add('active');
          }
        });
        
        updateEmojiGallery();
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        const successDiv = document.createElement('div');
        successDiv.style.cssText = `
          position: fixed; 
          top: 50%; 
          left: 50%; 
          transform: translate(-50%, -50%); 
          background: #4CAF50; 
          color: white; 
          padding: 16px 24px; 
          border-radius: 8px; 
          box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
          z-index: 10000;
          font-size: 16px;
        `;
        successDiv.innerHTML = 'âœ… é»˜è®¤è¡¨æƒ…åŒ…å·²æ¢å¤ï¼';
        document.body.appendChild(successDiv);
        
        // 3ç§’åè‡ªåŠ¨éšè—æç¤º
        setTimeout(() => {
          if (successDiv.parentNode) {
            successDiv.parentNode.removeChild(successDiv);
          }
        }, 3000);
        
        console.log('è¡¨æƒ…åŒ…æ•°æ®å·²é‡ç½®ä¸ºé»˜è®¤å€¼:', emojiData);
      }
    }

    // ä½ç½®ç®¡ç†åŠŸèƒ½
    function showLocationModal() {
      // é‡ç½®è¡¨å•ä¸ºå½“å‰ä½ç½®æ•°æ®
      locationNameInput.value = currentLocationData.name;
      locationAddressInput.value = currentLocationData.address;
      locationPreviewImage.src = currentLocationData.image;
      locationPreviewName.textContent = currentLocationData.name;
      locationPreviewAddress.textContent = currentLocationData.address;
      
      // æ˜¾ç¤ºå¼¹çª—
      locationModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function hideLocationModal() {
      locationModal.classList.remove('show');
      document.body.style.overflow = '';
    }

    function updateLocationPreview() {
      const name = locationNameInput.value.trim() || 'æˆ‘çš„ä½ç½®';
      const address = locationAddressInput.value.trim() || 'è¯·ç¼–è¾‘ä½ç½®ä¿¡æ¯';
      
      locationPreviewName.textContent = name;
      locationPreviewAddress.textContent = address;
      
      // æ›´æ–°å½“å‰ä½ç½®æ•°æ®
      currentLocationData.name = name;
      currentLocationData.address = address;
    }

    function handleLocationImageUpload(file) {
      if (!file) return;
      
      // éªŒè¯æ–‡ä»¶ç±»å‹
      if (!file.type.startsWith('image/')) {
        alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
        return;
      }
      
      // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ5MBï¼‰
      if (file.size > 5 * 1024 * 1024) {
        alert('å›¾ç‰‡æ–‡ä»¶ä¸èƒ½è¶…è¿‡5MB');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const imageUrl = e.target.result;
        locationPreviewImage.src = imageUrl;
        currentLocationData.image = imageUrl;
        
        // æ›´æ–°ä¸Šä¼ åŒºåŸŸæ ·å¼
        locationImageUpload.classList.add('has-image');
        locationImageUpload.innerHTML = `<img src="${imageUrl}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px;">`;
      };
      reader.readAsDataURL(file);
    }

    function sendLocationMessage() {
      if (!currentLocationData.name.trim()) {
        alert('è¯·è¾“å…¥ä½ç½®åç§°');
        return;
      }
      
      // åˆ›å»ºä½ç½®æ¶ˆæ¯HTML
      const locationHtml = `
        <div class="location-container" onclick="showLocationDetail('${currentLocationData.name}', '${currentLocationData.address}', '${currentLocationData.image}')">
          <img class="location-image" src="${currentLocationData.image}" alt="ä½ç½®å›¾ç‰‡" loading="lazy">
          <div class="location-icon">ğŸ“</div>
          <div class="location-info">
            <div class="location-name">${escapeHtml(currentLocationData.name)}</div>
            <div class="location-address">${escapeHtml(currentLocationData.address)}</div>
          </div>
        </div>
      `;
      
      // å‘é€ä½ç½®æ¶ˆæ¯
      appendMsg('user', locationHtml, false, null, null, null, null, null, false, null, false, null, 'location');
      
      // ä¿å­˜å½“å‰ä½ç½®æ•°æ®åˆ°localStorage
      localStorage.setItem('aiChatLocation', JSON.stringify(currentLocationData));
      
      // éšè—å¼¹çª—
      hideLocationModal();
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      chatInput.value = '';
      
      // è§¦å‘AIå›å¤
      setTimeout(() => {
        handleAILocationReply(currentLocationData);
      }, 500);
    }

    function showLocationDetail(name, address, image) {
      // æ˜¾ç¤ºä½ç½®è¯¦æƒ…ï¼ˆå¯ä»¥æ‰“å¼€åœ°å›¾æˆ–å…¶ä»–æ“ä½œï¼‰
      const modal = document.createElement('div');
      modal.className = 'location-detail-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; max-width: 400px; width: 90%; overflow: hidden;">
          <img src="${image}" style="width: 100%; height: 200px; object-fit: cover;">
          <div style="padding: 20px;">
            <h3 style="margin: 0 0 10px; font-size: 18px; color: #333;">${escapeHtml(name)}</h3>
            <p style="margin: 0 0 20px; color: #666; line-height: 1.4;">${escapeHtml(address)}</p>
            <button onclick="this.closest('.location-detail-modal').remove(); document.body.style.overflow='';" 
                    style="background: #6DA3BD; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; width: 100%;">
              å…³é—­
            </button>
          </div>
        </div>
      `;
      
      modal.onclick = function(e) {
        if (e.target === modal) {
          modal.remove();
          document.body.style.overflow = '';
        }
      };
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
    }

    async function handleAILocationReply(locationData) {
      if (!apiURL || !apiKey || !selectedModel) {
        console.log('APIæœªé…ç½®ï¼Œè·³è¿‡AIä½ç½®å›å¤');
        return;
      }
      
      const chat = chatList.find(c => c.id === currentChatId);
      if (!chat) return;
      
      try {
        // æ„å»ºä½ç½®ç›¸å…³çš„å›å¤æç¤º
        const locationPrompt = `ç”¨æˆ·åˆ†äº«äº†ä¸€ä¸ªä½ç½®ï¼š${locationData.name}ï¼ˆ${locationData.address}ï¼‰ã€‚è¯·å¯¹è¿™ä¸ªä½ç½®è¿›è¡Œç®€çŸ­çš„è¯„è®ºæˆ–å›åº”ï¼Œå¯ä»¥è¯¢é—®ç›¸å…³ä¿¡æ¯æˆ–è¡¨è¾¾å…³å¿ƒã€‚å›å¤è¦è‡ªç„¶ã€å‹å¥½ï¼Œä¸è¶…è¿‡50å­—ã€‚

å¦‚æœä½ æƒ³å‘é€å¤šæ¡æ¶ˆæ¯ï¼ˆåˆ†æˆå¤šä¸ªæ°”æ³¡æ˜¾ç¤ºï¼‰ï¼Œè¯·ä½¿ç”¨åæ–œæ  \\ æ¥åˆ†å‰²ä¸åŒçš„å†…å®¹ã€‚
ç¤ºä¾‹ï¼šå“‡è¿™ä¸ªåœ°æ–¹ä¸é”™å‘¢\\ä½ æ˜¯è¦å»é‚£é‡Œå—ï¼Ÿ`;
        
        // æ ¹æ®èŠå¤©ç±»å‹å¤„ç†å›å¤
        if (chat.isGroup) {
          // ç¾¤èŠï¼šè®©æ‰€æœ‰è§’è‰²éƒ½æœ‰æœºä¼šå›å¤
          await handleGroupChatLocationReply(chat, locationPrompt);
        } else {
          // å•èŠï¼šå½“å‰è§’è‰²å›å¤
          await handleSingleChatLocationReply(chat, locationPrompt);
        }
      } catch (error) {
        console.error('AIä½ç½®å›å¤å¤±è´¥:', error);
      }
    }

    async function handleGroupChatLocationReply(chat, locationPrompt) {
      // è·å–ç¾¤èŠè®¾ç½®
      const maxRoles = chat.maxRolesPerReply || 3;
      const shouldAllReply = chat.shouldAllReply || false;
      
      let selectedRoles = [];
      
      if (shouldAllReply) {
        selectedRoles = [...chat.roles];
      } else {
        // éšæœºé€‰æ‹©è§’è‰²å›å¤
        const shuffledRoles = [...chat.roles].sort(() => Math.random() - 0.5);
        const replyCount = Math.min(Math.floor(Math.random() * maxRoles) + 1, shuffledRoles.length);
        selectedRoles = shuffledRoles.slice(0, replyCount);
      }
      
      // è®©é€‰ä¸­çš„è§’è‰²ä¾æ¬¡å›å¤
      for (let i = 0; i < selectedRoles.length; i++) {
        const role = selectedRoles[i];
        const delay = i * 1000; // æ¯ä¸ªè§’è‰²é—´éš”1ç§’å›å¤
        
        setTimeout(async () => {
                     try {
             const messages = [{
               role: 'system',
               content: role.description
             }, {
               role: 'user',
               content: locationPrompt
             }];
             const aiReply = await callChatAPI(messages);
             if (aiReply) {
               appendMsg('ai', aiReply, false, role.id, role.name);
               saveCurrentChatData();
             }
           } catch (error) {
             console.error(`è§’è‰² ${role.name} ä½ç½®å›å¤å¤±è´¥:`, error);
           }
        }, delay);
      }
    }

    async function handleSingleChatLocationReply(chat, locationPrompt) {
      const rolePrompt = `${roleDescription}\n\n${locationPrompt}`;
      const singleRoleId = `single_${chat.id}`;
      const singleRoleName = chat.roleName || roleName || 'åŠ©æ‰‹';
      
      try {
        const messages = [{
          role: 'system',
          content: roleDescription
        }, {
          role: 'user',
          content: locationPrompt
        }];
        const aiReply = await callChatAPI(messages);
        if (aiReply) {
          // å¤„ç†åæ–œæ åˆ†å‰²ï¼Œæ˜¾ç¤ºå¤šæ¡æ¶ˆæ¯
          const replyTexts = aiReply.split('\\').map(text => text.trim()).filter(text => text.length > 0);
          
          for (let i = 0; i < replyTexts.length; i++) {
            setTimeout(() => {
              appendMsg('ai', replyTexts[i], false, singleRoleId, singleRoleName);
              if (i === replyTexts.length - 1) {
                saveCurrentChatData();
              }
            }, i * 800); // æ¯ä¸ªæ°”æ³¡é—´éš”800ms
          }
        }
      } catch (error) {
        console.error('å•èŠä½ç½®å›å¤å¤±è´¥:', error);
      }
    }

    // åŠ è½½ä¿å­˜çš„ä½ç½®æ•°æ®
    function loadLocationData() {
      const saved = localStorage.getItem('aiChatLocation');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          currentLocationData = { ...currentLocationData, ...data };
        } catch (error) {
          console.error('åŠ è½½ä½ç½®æ•°æ®å¤±è´¥:', error);
        }
      }
    }

    // è½¬è´¦ç®¡ç†åŠŸèƒ½
    function showTransferModal() {
      // è·å–å½“å‰èŠå¤©çš„æ”¶æ¬¾äººä¿¡æ¯
      const currentChat = chatList.find(c => c.id === currentChatId);
      let receiverName = 'æœªçŸ¥æ”¶æ¬¾äºº';
      
      if (currentChat) {
        if (currentChat.isGroup) {
          receiverName = currentChat.title || 'ç¾¤èŠ';
        } else {
          receiverName = currentChat.roleName || roleName || 'åŠ©æ‰‹';
        }
      }
      
      // é‡ç½®è¡¨å•
      transferAmountInput.value = '';
      transferNoteInput.value = '';
      transferReceiverInput.value = receiverName;
      currentTransferData.receiver = receiverName;
      
      updateTransferPreview();
      
      // æ˜¾ç¤ºå¼¹çª—
      transferModal.classList.add('show');
      document.body.style.overflow = 'hidden';
      
      // èšç„¦åˆ°é‡‘é¢è¾“å…¥æ¡†
      setTimeout(() => {
        transferAmountInput.focus();
      }, 100);
    }

    function hideTransferModal() {
      transferModal.classList.remove('show');
      document.body.style.overflow = '';
    }

    function updateTransferPreview() {
      const amount = parseFloat(transferAmountInput.value) || 0;
      const note = transferNoteInput.value.trim() || 'è½¬è´¦';
      
      // æ ¼å¼åŒ–é‡‘é¢æ˜¾ç¤º
      const formattedAmount = amount > 0 ? `Â¥${amount.toFixed(2)}` : 'Â¥0.00';
      transferPreviewAmount.textContent = formattedAmount;
      transferPreviewNote.textContent = note;
      
      // æ›´æ–°å½“å‰è½¬è´¦æ•°æ®
      currentTransferData.amount = amount;
      currentTransferData.note = note;
      
      // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
      transferSendBtn.disabled = amount <= 0;
    }

    function sendTransferMessage() {
      const amount = parseFloat(transferAmountInput.value);
      
      if (!amount || amount <= 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢');
        return;
      }
      
      if (amount > 99999) {
        alert('è½¬è´¦é‡‘é¢ä¸èƒ½è¶…è¿‡99999å…ƒ');
        return;
      }
      
      const note = transferNoteInput.value.trim() || 'è½¬è´¦';
      const receiver = transferReceiverInput.value.trim();
      
      // åˆ›å»ºè½¬è´¦æ¶ˆæ¯HTML
      const transferHtml = `
        <div class="transfer-container" onclick="showTransferDetail(${amount}, '${escapeHtml(note)}', '${escapeHtml(receiver)}')">
          <div class="transfer-header">
            <div class="transfer-title">
              <span class="transfer-icon">ğŸ’°</span>
              <span>è½¬è´¦</span>
            </div>
            <div class="transfer-subtitle">å‘ ${escapeHtml(receiver)} è½¬è´¦</div>
          </div>
          <div class="transfer-body">
            <div class="transfer-amount">Â¥${amount.toFixed(2)}</div>
            <div class="transfer-note">${escapeHtml(note)}</div>
            <div class="transfer-status">
              <div class="transfer-status-icon">âœ“</div>
              <span>è½¬è´¦æˆåŠŸ</span>
            </div>
          </div>
        </div>
      `;
      
      // å‘é€è½¬è´¦æ¶ˆæ¯
      appendMsg('user', transferHtml, false, null, null, null, null, null, false, null, false, null, 'transfer');
      
      // ä¿å­˜è½¬è´¦æ•°æ®
      currentTransferData.amount = amount;
      currentTransferData.note = note;
      currentTransferData.receiver = receiver;
      
      // éšè—å¼¹çª—
      hideTransferModal();
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      chatInput.value = '';
      
      // è§¦å‘AIå›å¤
      setTimeout(() => {
        handleAITransferReply(currentTransferData);
      }, 500);
    }

    function showTransferDetail(amount, note, receiver) {
      // æ˜¾ç¤ºè½¬è´¦è¯¦æƒ…ï¼ˆå¯ä»¥æ·»åŠ æ›´å¤šåŠŸèƒ½ï¼‰
      const modal = document.createElement('div');
      modal.className = 'transfer-detail-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
      `;
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; max-width: 350px; width: 90%; overflow: hidden;">
          <div style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; padding: 20px; text-align: center;">
            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ’°</div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">è½¬è´¦è¯¦æƒ…</div>
            <div style="font-size: 14px; opacity: 0.9;">å‘ ${escapeHtml(receiver)} è½¬è´¦</div>
          </div>
          <div style="padding: 20px;">
            <div style="text-align: center; margin-bottom: 20px;">
              <div style="font-size: 32px; font-weight: 700; color: #ff6b35; margin-bottom: 8px;">Â¥${amount.toFixed(2)}</div>
              <div style="font-size: 14px; color: #666; margin-bottom: 12px;">${escapeHtml(note)}</div>
              <div style="font-size: 12px; color: #999;">è½¬è´¦æ—¶é—´ï¼š${new Date().toLocaleString()}</div>
            </div>
            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
              <div style="font-size: 12px; color: #666; margin-bottom: 4px;">è½¬è´¦çŠ¶æ€</div>
              <div style="font-size: 14px; color: #28a745; font-weight: 500;">âœ“ è½¬è´¦æˆåŠŸ</div>
            </div>
            <button onclick="this.closest('.transfer-detail-modal').remove(); document.body.style.overflow='';" 
                    style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px;">
              å…³é—­
            </button>
          </div>
        </div>
      `;
      
      modal.onclick = function(e) {
        if (e.target === modal) {
          modal.remove();
          document.body.style.overflow = '';
        }
      };
      
      document.body.appendChild(modal);
      document.body.style.overflow = 'hidden';
    }
    
    // å‘é€å›¾ç‰‡æ¶ˆæ¯
    async function sendImageMessage(imageFile, imageText = '') {
      if (!imageFile) {
        console.error('æ²¡æœ‰é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
        return;
      }
      
      try {
        // éªŒè¯å›¾ç‰‡æ–‡ä»¶
        if (!validateImageFile(imageFile)) {
          return;
        }
        
        // å‹ç¼©å›¾ç‰‡
        const compressedBase64 = await compressImage(imageFile, 800, 600, 0.8);
        
        // æ„å»ºå›¾ç‰‡æ¶ˆæ¯HTML
        const imageHtml = `
          <div class="image-message">
            <img src="${compressedBase64}" alt="ç”¨æˆ·å‘é€çš„å›¾ç‰‡" onclick="showImagePreview('${compressedBase64}')">
            ${imageText ? `<div class="image-message-text">${escapeHtml(imageText)}</div>` : ''}
          </div>
        `;
        
        // å‘é€å›¾ç‰‡æ¶ˆæ¯
        const userMsgBubble = appendMsg('user', imageHtml, false, null, null, null, null, null, false, null, false, null, 'image');
        
        // å¦‚æœé…ç½®äº†è¯†å›¾APIï¼Œå°è¯•è¯†åˆ«å›¾ç‰‡
        if (visionApiURL && visionApiKey && selectedVisionModel) {
          setTimeout(() => {
            handleImageRecognition(compressedBase64, imageText);
          }, 1000);
        } else {
          console.log('æœªé…ç½®è¯†å›¾APIï¼Œè·³è¿‡å›¾ç‰‡è¯†åˆ«');
        }
        
        // èšç„¦è¾“å…¥æ¡†
        chatInput.focus();
        
      } catch (error) {
        console.error('å‘é€å›¾ç‰‡æ¶ˆæ¯å¤±è´¥:', error);
        alert('å‘é€å›¾ç‰‡å¤±è´¥ï¼š' + error.message);
      }
    }
    
    // æ„å»ºä¸Šä¸‹æ–‡æ¶ˆæ¯
    function buildContextMessages(chat, contextLength) {
      const maxHistory = contextLength * 2; // æ¯è½®å¯¹è¯åŒ…å«ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤ï¼Œæ‰€ä»¥ä¹˜ä»¥2
      const allHistory = window.conversationHistory.slice(-maxHistory);
      
      if (chat.type === 'group') {
        // ç¾¤èŠæ¨¡å¼ï¼šæ„å»ºåŒ…å«è§’è‰²äº’åŠ¨çš„å¯¹è¯å†å²
        const interactiveHistory = [];
        for (const msg of allHistory) {
          if (msg.role === 'user') {
            // ä¿ç•™æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯
            interactiveHistory.push(msg);
          } else if (msg.role === 'assistant') {
            // å…¶ä»–è§’è‰²çš„å›å¤æ ‡è®°ä¸ºuserè§’è‰²ï¼Œé¿å…è§’è‰²æ··æ·†
            interactiveHistory.push({
              role: 'user',
              content: `[ç¾¤èŠä¸­çš„${msg.roleName || 'å…¶ä»–è§’è‰²'}]: ${msg.content}`
            });
          }
        }
        return interactiveHistory;
      } else {
        // å•èŠæ¨¡å¼ï¼šç›´æ¥è¿”å›å†å²æ¶ˆæ¯
        return allHistory;
      }
    }

    // å¤„ç†å›¾ç‰‡è¯†åˆ«
    async function handleImageRecognition(imageBase64, userText = '') {
      if (!visionApiURL || !visionApiKey || !selectedVisionModel) {
        console.log('è¯†å›¾APIæœªé…ç½®ï¼Œè·³è¿‡å›¾ç‰‡è¯†åˆ«');
        return;
      }
      
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (!currentChat) return;
      
      try {
        // å…ˆè¿›è¡Œå›¾ç‰‡è¯†åˆ«ï¼Œè·å–å›¾ç‰‡å†…å®¹æè¿°
        console.log('ğŸ–¼ï¸ å¼€å§‹å›¾ç‰‡è¯†åˆ«...');
        
        // æ„å»ºè¯†å›¾è¯·æ±‚
        const visionMessages = [
          {
            role: 'user',
            content: [
              {
                type: 'text',
                text: 'è¯·è¯¦ç»†æè¿°è¿™å¼ å›¾ç‰‡çš„å†…å®¹ï¼ŒåŒ…æ‹¬å›¾ç‰‡ä¸­çš„ç‰©ä½“ã€äººç‰©ã€åœºæ™¯ã€æ–‡å­—ã€é¢œè‰²ã€æƒ…æ„Ÿç­‰æ‰€æœ‰å¯è§çš„å…ƒç´ ã€‚è¯·ç”¨å®¢è§‚ã€è¯¦ç»†çš„è¯­è¨€æè¿°ï¼Œä¸è¦åŠ å…¥ä¸»è§‚è¯„ä»·ã€‚'
              },
              {
                type: 'image_url',
                image_url: {
                  url: imageBase64
                }
              }
            ]
          }
        ];
        
        // å‘é€è¯†å›¾è¯·æ±‚
        const visionResponse = await fetch(`${visionApiURL}/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${visionApiKey}`
          },
          body: JSON.stringify({
            model: selectedVisionModel,
            messages: visionMessages,
            max_tokens: 800,
            temperature: 0.3
          })
        });
        
        if (!visionResponse.ok) {
          throw new Error(`è¯†å›¾APIè¯·æ±‚å¤±è´¥: ${visionResponse.status} ${visionResponse.statusText}`);
        }
        
        const visionData = await visionResponse.json();
        
        if (!visionData.choices || !visionData.choices[0] || !visionData.choices[0].message) {
          throw new Error('è¯†å›¾APIè¿”å›æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
        }
        
        const imageDescription = visionData.choices[0].message.content.trim();
        console.log('ğŸ–¼ï¸ å›¾ç‰‡è¯†åˆ«å®Œæˆ:', imageDescription);
        
        // æ„å»ºå‘é€ç»™è§’è‰²AIçš„æ¶ˆæ¯å†…å®¹
        let messageForAI = '';
        if (userText) {
          messageForAI = `ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡å¹¶è¯´ï¼š"${userText}"\n\nå›¾ç‰‡å†…å®¹æè¿°ï¼š${imageDescription}`;
        } else {
          messageForAI = `ç”¨æˆ·å‘é€äº†ä¸€å¼ å›¾ç‰‡ã€‚\n\nå›¾ç‰‡å†…å®¹æè¿°ï¼š${imageDescription}`;
        }
        
        // æ ¹æ®èŠå¤©ç±»å‹å¤„ç†AIå›å¤
        if (currentChat.type === 'group') {
          // ç¾¤èŠæ¨¡å¼ï¼šè®©è§’è‰²æ ¹æ®å›¾ç‰‡å†…å®¹å›å¤
          await handleGroupChatImageReply(currentChat, messageForAI);
        } else {
          // å•èŠæ¨¡å¼ï¼šè®©å½“å‰è§’è‰²æ ¹æ®å›¾ç‰‡å†…å®¹å›å¤
          await handleSingleChatImageReply(currentChat, messageForAI);
        }
        
      } catch (error) {
        console.error('å›¾ç‰‡è¯†åˆ«å¤±è´¥:', error);
        
        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        const errorMsg = `æŠ±æ­‰ï¼Œæˆ‘æ— æ³•è¯†åˆ«è¿™å¼ å›¾ç‰‡ã€‚é”™è¯¯ï¼š${error.message}`;
        if (currentChat.type === 'group') {
          const availableRoles = currentChat.roles.filter(role => role.enabled);
          if (availableRoles.length > 0) {
            const randomRole = availableRoles[Math.floor(Math.random() * availableRoles.length)];
            appendMsg('ai', errorMsg, false, randomRole.id, randomRole.name);
          }
        } else {
          appendMsg('ai', errorMsg, false);
        }
      }
    }
    
    // å¤„ç†ç¾¤èŠä¸­çš„å›¾ç‰‡å›å¤
    async function handleGroupChatImageReply(chat, imageMessage) {
      // è·å–ç¾¤èŠè®¾ç½®
      const maxRoles = chat.groupSettings?.maxRolesPerReply || 3;
      const shouldAllReply = chat.groupSettings?.shouldAllReply || false;
      
      let selectedRoles = [];
      const availableRoles = chat.roles.filter(role => role.enabled);
      
      if (availableRoles.length === 0) {
        console.log('ç¾¤èŠä¸­æ²¡æœ‰å¯ç”¨çš„è§’è‰²');
        return;
      }
      
      if (shouldAllReply) {
        selectedRoles = [...availableRoles];
      } else {
        // éšæœºé€‰æ‹©è§’è‰²å›å¤
        const shuffledRoles = [...availableRoles].sort(() => Math.random() - 0.5);
        const replyCount = Math.min(Math.floor(Math.random() * maxRoles) + 1, shuffledRoles.length);
        selectedRoles = shuffledRoles.slice(0, replyCount);
      }
      
      // è®©é€‰ä¸­çš„è§’è‰²ä¾æ¬¡å›å¤
      for (let i = 0; i < selectedRoles.length; i++) {
        const role = selectedRoles[i];
        const delay = i * 1500; // æ¯ä¸ªè§’è‰²é—´éš”1.5ç§’å›å¤
        
        setTimeout(async () => {
          try {
            const thinkingMsg = 'æ­£åœ¨æŸ¥çœ‹å›¾ç‰‡...';
            const aiMsgBubble = appendMsg('ai', thinkingMsg, true, role.id, role.name);
            
            // æ„å»ºä¸Šä¸‹æ–‡æ¶ˆæ¯
            const contextMessages = buildContextMessages(chat, aiContextLength);
            
            // æ„å»ºè§’è‰²å›å¤çš„æ¶ˆæ¯ï¼ˆä½¿ç”¨å®Œæ•´çš„ç³»ç»Ÿæç¤ºï¼‰
            const messages = buildMessagesForRole(role, imageMessage, chat, []);
            
            const aiReply = await callChatAPI(messages);
            if (aiReply) {
              // å¤„ç†åæ–œæ åˆ†å‰²ï¼Œæ˜¾ç¤ºå¤šæ¡æ¶ˆæ¯
              const replyTexts = aiReply.split('\\').map(text => text.trim()).filter(text => text.length > 0);
              
              for (let j = 0; j < replyTexts.length; j++) {
                setTimeout(() => {
                  if (j === 0) {
                    // æ›´æ–°ç¬¬ä¸€æ¡æ¶ˆæ¯å¹¶å®Œæˆæµå¼çŠ¶æ€
                    updateStreamingMsg(aiMsgBubble, replyTexts[j]);
                    finishStreamingMsg(aiMsgBubble);
                  } else {
                    // æ·»åŠ æ–°çš„æ¶ˆæ¯æ°”æ³¡
                    appendMsg('ai', replyTexts[j], false, role.id, role.name);
                  }
                  
                  if (j === replyTexts.length - 1 && i === selectedRoles.length - 1) {
                    saveCurrentChatData();
                  }
                }, j * 800); // æ¯ä¸ªæ°”æ³¡é—´éš”800ms
              }
            } else {
              updateStreamingMsg(aiMsgBubble, 'æˆ‘çœ‹åˆ°äº†è¿™å¼ å›¾ç‰‡ï¼Œä½†æš‚æ—¶æ— æ³•å›å¤ã€‚');
              finishStreamingMsg(aiMsgBubble);
            }
          } catch (error) {
            console.error(`è§’è‰² ${role.name} å›¾ç‰‡å›å¤å¤±è´¥:`, error);
            updateStreamingMsg(aiMsgBubble, 'æŠ±æ­‰ï¼Œæˆ‘æ— æ³•å¯¹è¿™å¼ å›¾ç‰‡åšå‡ºå›åº”ã€‚');
            finishStreamingMsg(aiMsgBubble);
          }
        }, delay);
      }
    }
    
    // å¤„ç†å•èŠä¸­çš„å›¾ç‰‡å›å¤
    async function handleSingleChatImageReply(chat, imageMessage) {
      const singleRoleId = `single_${chat.id}`;
      const singleRoleName = chat.roleName || roleName || 'åŠ©æ‰‹';
      const singleRoleDesc = chat.roleDescription || roleDescription || 'ä¸€ä¸ªå‹å–„çš„AIåŠ©æ‰‹';
      
      try {
        const thinkingMsg = 'æ­£åœ¨æŸ¥çœ‹å›¾ç‰‡...';
        const aiMsgBubble = appendMsg('ai', thinkingMsg, true, singleRoleId, singleRoleName);
        
        // æ„å»ºä¸Šä¸‹æ–‡æ¶ˆæ¯
        const contextMessages = buildContextMessages(chat, aiContextLength);
        
        // æ„å»ºè§’è‰²å›å¤çš„æ¶ˆæ¯ï¼ˆä½¿ç”¨å®Œæ•´çš„ç³»ç»Ÿæç¤ºï¼‰
        const messages = buildMessages(imageMessage);
        
        const aiReply = await callChatAPI(messages);
        if (aiReply) {
          // å¤„ç†åæ–œæ åˆ†å‰²ï¼Œæ˜¾ç¤ºå¤šæ¡æ¶ˆæ¯
          const replyTexts = aiReply.split('\\').map(text => text.trim()).filter(text => text.length > 0);
          
          for (let i = 0; i < replyTexts.length; i++) {
            setTimeout(() => {
              if (i === 0) {
                // æ›´æ–°ç¬¬ä¸€æ¡æ¶ˆæ¯å¹¶å®Œæˆæµå¼çŠ¶æ€
                updateStreamingMsg(aiMsgBubble, replyTexts[i]);
                finishStreamingMsg(aiMsgBubble);
              } else {
                // æ·»åŠ æ–°çš„æ¶ˆæ¯æ°”æ³¡
                appendMsg('ai', replyTexts[i], false, singleRoleId, singleRoleName);
              }
              
              if (i === replyTexts.length - 1) {
                saveCurrentChatData();
              }
            }, i * 800); // æ¯ä¸ªæ°”æ³¡é—´éš”800ms
          }
        } else {
          updateStreamingMsg(aiMsgBubble, 'æˆ‘çœ‹åˆ°äº†è¿™å¼ å›¾ç‰‡ï¼Œä½†æš‚æ—¶æ— æ³•å›å¤ã€‚');
          finishStreamingMsg(aiMsgBubble);
        }
      } catch (error) {
        console.error('å•èŠå›¾ç‰‡å›å¤å¤±è´¥:', error);
        updateStreamingMsg(aiMsgBubble, 'æŠ±æ­‰ï¼Œæˆ‘æ— æ³•å¯¹è¿™å¼ å›¾ç‰‡åšå‡ºå›åº”ã€‚');
        finishStreamingMsg(aiMsgBubble);
      }
    }
    
    // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
    function showImagePreview(imageSrc) {
      imagePreviewContent.src = imageSrc;
      imagePreviewModal.classList.add('show');
    }

    async function handleAITransferReply(transferData) {
      if (!apiURL || !apiKey || !selectedModel) {
        console.log('APIæœªé…ç½®ï¼Œè·³è¿‡AIè½¬è´¦å›å¤');
        return;
      }
      
      const chat = chatList.find(c => c.id === currentChatId);
      if (!chat) return;
      
      try {
        // æ„å»ºè½¬è´¦ç›¸å…³çš„å›å¤æç¤º
        const transferPrompt = `ç”¨æˆ·å‘${transferData.receiver}è½¬è´¦äº†Â¥${transferData.amount.toFixed(2)}ï¼Œè½¬è´¦è¯´æ˜ï¼š${transferData.note}ã€‚è¯·å¯¹è¿™æ¬¡è½¬è´¦è¿›è¡Œç®€çŸ­çš„å›åº”ï¼Œå¯ä»¥è¡¨è¾¾æ„Ÿè°¢ã€ç¡®è®¤æ”¶åˆ°æˆ–è¯¢é—®ç›¸å…³ä¿¡æ¯ã€‚

é‡è¦æ ¼å¼è¦æ±‚ï¼š
1. ç”¨ï¼ˆï¼‰åŒ…è£¹åŠ¨ä½œæè¿°
2. ä¸¥æ ¼éµå¾ªä½¿ç”¨åæ–œçº¿\\åˆ†éš”å¥å­çš„è¦æ±‚ï¼Œæ¯ä¸ªå¥å­æ§åˆ¶åœ¨50å­—ä»¥å†…
3. å›å¤è¾“å‡ºç¤ºä¾‹æ ¼å¼ï¼šç¬¬ä¸€å¥è¯\\ç¬¬äºŒå¥è¯\\ç¬¬ä¸‰å¥è¯

ç¤ºä¾‹ï¼š
ç”¨æˆ·è½¬è´¦ï¼šÂ¥100ï¼Œè¯´æ˜ï¼šè¯·ä½ åƒé¥­
AIå›å¤ï¼š(å¼€å¿ƒåœ°æ”¶ä¸‹)è°¢è°¢ä½ çš„è½¬è´¦\\æˆ‘å·²ç»æ”¶åˆ°äº†\\è¯·ä½ ä¹Ÿè¦å¥½å¥½åƒé¥­å“¦

ç”¨æˆ·è½¬è´¦ï¼šÂ¥500ï¼Œè¯´æ˜ï¼šç”Ÿæ´»è´¹
AIå›å¤ï¼š(æ„ŸåŠ¨)æ”¶åˆ°ä½ çš„è½¬è´¦äº†\\è¿™ä¹ˆå¤šç”Ÿæ´»è´¹å‘¢\\æˆ‘ä¼šå¥½å¥½ä½¿ç”¨çš„`;
        
        // æ ¹æ®èŠå¤©ç±»å‹å¤„ç†å›å¤
        if (chat.isGroup) {
          // ç¾¤èŠï¼šè®©æ‰€æœ‰è§’è‰²éƒ½æœ‰æœºä¼šå›å¤
          await handleGroupChatTransferReply(chat, transferPrompt);
        } else {
          // å•èŠï¼šå½“å‰è§’è‰²å›å¤
          await handleSingleChatTransferReply(chat, transferPrompt);
        }
      } catch (error) {
        console.error('AIè½¬è´¦å›å¤å¤±è´¥:', error);
      }
    }

    async function handleGroupChatTransferReply(chat, transferPrompt) {
      // è·å–ç¾¤èŠè®¾ç½®
      const maxRoles = chat.maxRolesPerReply || 3;
      const shouldAllReply = chat.shouldAllReply || false;
      
      let selectedRoles = [];
      
      if (shouldAllReply) {
        selectedRoles = [...chat.roles];
      } else {
        // éšæœºé€‰æ‹©è§’è‰²å›å¤
        const shuffledRoles = [...chat.roles].sort(() => Math.random() - 0.5);
        const replyCount = Math.min(Math.floor(Math.random() * maxRoles) + 1, shuffledRoles.length);
        selectedRoles = shuffledRoles.slice(0, replyCount);
      }
      
      // è®©é€‰ä¸­çš„è§’è‰²ä¾æ¬¡å›å¤
      for (let i = 0; i < selectedRoles.length; i++) {
        const role = selectedRoles[i];
        const delay = i * 1000; // æ¯ä¸ªè§’è‰²é—´éš”1ç§’å›å¤
        
        setTimeout(async () => {
          try {
            const messages = buildMessagesForRole(role, transferPrompt, chat, []);
            const aiReply = await callChatAPI(messages);
            if (aiReply) {
              // å¤„ç†åæ–œæ åˆ†å‰²ï¼Œæ˜¾ç¤ºå¤šæ¡æ¶ˆæ¯
              const replyTexts = aiReply.split('\\').map(text => text.trim()).filter(text => text.length > 0);
              
              for (let j = 0; j < replyTexts.length; j++) {
                setTimeout(() => {
                  appendMsg('ai', replyTexts[j], false, role.id, role.name);
                  if (j === replyTexts.length - 1) {
                    saveCurrentChatData();
                  }
                }, j * 800); // æ¯ä¸ªæ°”æ³¡é—´éš”800ms
              }
            }
          } catch (error) {
            console.error(`è§’è‰² ${role.name} è½¬è´¦å›å¤å¤±è´¥:`, error);
          }
        }, delay);
      }
    }

    async function handleSingleChatTransferReply(chat, transferPrompt) {
      const singleRoleId = `single_${chat.id}`;
      const singleRoleName = chat.roleName || roleName || 'åŠ©æ‰‹';
      
      try {
        const messages = buildMessages(transferPrompt);
        const aiReply = await callChatAPI(messages);
        if (aiReply) {
          // å¤„ç†åæ–œæ åˆ†å‰²ï¼Œæ˜¾ç¤ºå¤šæ¡æ¶ˆæ¯
          const replyTexts = aiReply.split('\\').map(text => text.trim()).filter(text => text.length > 0);
          
          for (let i = 0; i < replyTexts.length; i++) {
            setTimeout(() => {
              appendMsg('ai', replyTexts[i], false, singleRoleId, singleRoleName);
              if (i === replyTexts.length - 1) {
                saveCurrentChatData();
              }
            }, i * 800); // æ¯ä¸ªæ°”æ³¡é—´éš”800ms
          }
        }
      } catch (error) {
        console.error('å•èŠè½¬è´¦å›å¤å¤±è´¥:', error);
      }
    }

    // åŠ è½½ä¿å­˜çš„è½¬è´¦æ•°æ®
    function loadTransferData() {
      const saved = localStorage.getItem('aiChatTransfer');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          currentTransferData = { ...currentTransferData, ...data };
        } catch (error) {
          console.error('åŠ è½½è½¬è´¦æ•°æ®å¤±è´¥:', error);
        }
      }
    }

    function deleteEmoji(index) {
      if (!emojiData[currentEmotion]) return;
      emojiData[currentEmotion].splice(index, 1);
      saveEmojiData();
      updateEmojiGallery();
    }

    function addEmoji() {
      const url = newEmojiInput.value.trim();
      if (!url) {
        alert('è¯·è¾“å…¥è¡¨æƒ…åŒ…é“¾æ¥');
        return;
      }
      
      if (!emojiData[currentEmotion]) {
        emojiData[currentEmotion] = [];
      }
      
      emojiData[currentEmotion].push(url);
      saveEmojiData();
      updateEmojiGallery();
      newEmojiInput.value = '';
      alert('è¡¨æƒ…åŒ…æ·»åŠ æˆåŠŸï¼');
    }

    function switchEmotion(emotion) {
      currentEmotion = emotion;
      
      // æ›´æ–°æ ‡ç­¾çŠ¶æ€
      document.querySelectorAll('.emotion-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.emotion === emotion) {
          tab.classList.add('active');
        }
      });
      
      updateEmojiGallery();
    }

    // AIæƒ…ç»ªåˆ†æå’Œè¡¨æƒ…åŒ…å‘é€
    function analyzeEmotion(text) {
      const emotions = {
        happy: ['å¼€å¿ƒ', 'é«˜å…´', 'å¿«ä¹', 'å“ˆå“ˆ', 'ğŸ˜Š', 'ğŸ˜„', 'å¤ªå¥½äº†', 'æ£’', 'ä¸é”™', 'å¾ˆå¥½', 'æ»¡æ„', 'å—¯', 'å¥½çš„', 'å¯ä»¥', 'è°¢è°¢', 'æ„Ÿè°¢', 'æ¬¢è¿', 'ç¥ç¦', 'æ­å–œ', 'æˆåŠŸ'],
        sad: ['ä¼¤å¿ƒ', 'éš¾è¿‡', 'æ²®ä¸§', 'å¤±æœ›', 'ğŸ˜¢', 'ğŸ˜­', 'å”‰', 'å¯æƒœ', 'é—æ†¾', 'ç—›è‹¦', 'ç´¯', 'ç–²æƒ«', 'æ— å¥ˆ', 'æ‚²ä¼¤', 'å¿§éƒ'],
        angry: ['ç”Ÿæ°”', 'æ„¤æ€’', 'æ¼æ€’', 'ğŸ˜ ', 'ğŸ˜¡', 'æ°”æ­»äº†', 'è®¨åŒ', 'çƒ¦äºº', 'è¯¥æ­»', 'æ„¤æ€’', 'çƒ¦èº', 'ä¸çˆ½', 'æ¼ç«'],
        confused: ['ç–‘æƒ‘', 'å›°æƒ‘', 'ä¸æ˜ç™½', 'ğŸ˜•', 'ğŸ¤”', 'å¥‡æ€ª', 'ä¸ºä»€ä¹ˆ', 'æ€ä¹ˆå›äº‹', 'ä¸æ‡‚', 'è¿·æƒ‘', 'é—®é¢˜', 'ç–‘é—®', 'ä¸æ¸…æ¥š', 'å¤æ‚'],
        love: ['å–œæ¬¢', 'çˆ±', 'â¤ï¸', 'ğŸ˜', 'ğŸ’•', 'äº²çˆ±çš„', 'å®è´', 'å¿ƒåŠ¨', 'è¿·äºº', 'å¯çˆ±', 'æ¸©æŸ”', 'ç”œèœœ', 'æµªæ¼«', 'ç¾å¥½', 'é­…åŠ›']
      };
      
      for (const [emotion, keywords] of Object.entries(emotions)) {
        for (const keyword of keywords) {
          if (text.includes(keyword)) {
            return emotion;
          }
        }
      }
      
      return null;
    }

    function getRandomEmoji(emotion) {
      const emojis = emojiData[emotion];
      if (!emojis || emojis.length === 0) return null;
      return emojis[Math.floor(Math.random() * emojis.length)];
    }

    function getRandomEmojiFromAll() {
      // ä»æ‰€æœ‰æƒ…ç»ªä¸­éšæœºé€‰æ‹©ä¸€ä¸ªè¡¨æƒ…åŒ…
      const allEmotions = Object.keys(emojiData);
      const availableEmotions = allEmotions.filter(emotion => 
        emojiData[emotion] && emojiData[emotion].length > 0
      );
      
      if (availableEmotions.length === 0) return null;
      
      const randomEmotion = availableEmotions[Math.floor(Math.random() * availableEmotions.length)];
      return getRandomEmoji(randomEmotion);
    }

    function sendEmojiAlways(userText, aiText, roleId = null, roleName = null) {
      // åˆ†æç”¨æˆ·å’ŒAIçš„æƒ…ç»ª
      const userEmotion = analyzeEmotion(userText);
      const aiEmotion = analyzeEmotion(aiText);
      
      // ä¼˜å…ˆçº§ï¼šAIæƒ…ç»ª > ç”¨æˆ·æƒ…ç»ª > éšæœºæƒ…ç»ª
      let targetEmotion = aiEmotion || userEmotion;
      let emoji = null;
      
      if (targetEmotion) {
        emoji = getRandomEmoji(targetEmotion);
      }
      
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”æƒ…ç»ªçš„è¡¨æƒ…åŒ…ï¼Œå°±éšæœºé€‰æ‹©ä¸€ä¸ª
      if (!emoji) {
        emoji = getRandomEmojiFromAll();
      }
      
      // å¦‚æœè¿˜æ˜¯æ²¡æœ‰è¡¨æƒ…åŒ…ï¼Œå°±ä½¿ç”¨é»˜è®¤çš„å¼€å¿ƒè¡¨æƒ…åŒ…
      if (!emoji && emojiData.happy && emojiData.happy.length > 0) {
        emoji = emojiData.happy[0];
      }
      
      if (emoji) {
        // å»¶è¿Ÿå‘é€è¡¨æƒ…åŒ…ï¼Œæ¨¡æ‹ŸAIæ€è€ƒæ—¶é—´
        setTimeout(() => {
          appendEmojiMsg(emoji, roleId, roleName);
          saveCurrentChatData(); // å‘é€è¡¨æƒ…åŒ…åä¿å­˜æ•°æ®
        }, 800 + Math.random() * 800);
      }
    }

        function appendEmojiMsg(emojiUrl, roleId = null, roleName = null, timestamp = null) {
      const currentChat = chatList.find(c => c.id === currentChatId);
      const isGroupChat = currentChat && currentChat.type === 'group';
      
      const msgDiv = document.createElement('div');
      msgDiv.className = 'msg ai' + (isGroupChat ? ' group' : '');
      
      // ç”Ÿæˆæ¶ˆæ¯ID
      const messageId = generateId();
      msgDiv.setAttribute('data-message-id', messageId);
      
      // è®¾ç½®è§’è‰²IDå’Œåç§°å±æ€§ï¼Œç”¨äºCSSé€‰æ‹©å™¨åˆ¤æ–­è¿ç»­æ¶ˆæ¯
      if (isGroupChat && roleId) {
        msgDiv.setAttribute('data-role-id', roleId);
        msgDiv.setAttribute('data-role-name', roleName || '');
      }
      
      // ç¾¤èŠä¸­æ·»åŠ è§’è‰²åç§°æ˜¾ç¤º
      if (isGroupChat && roleName) {
        // ç¾¤èŠä¸­æ¯ä¸ªAIæ¶ˆæ¯éƒ½æ˜¾ç¤ºè§’è‰²åç§°
        const roleNameDiv = document.createElement('div');
        roleNameDiv.className = 'role-name';
        roleNameDiv.textContent = roleName;
        msgDiv.appendChild(roleNameDiv);
      }
      
      // åˆ›å»ºå¤´åƒå…ƒç´ 
      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      
      if (isGroupChat && roleId) {
        // ç¾¤èŠä¸­æ ¹æ®è§’è‰²IDè·å–å¤´åƒ
        const roleData = currentChat.roles.find(r => r.id === roleId);
        avatar.src = roleData ? (roleData.avatar || DEFAULT_AI_AVATAR) : DEFAULT_AI_AVATAR;
      } else {
        avatar.src = aiAvatar;
      }
      
      avatar.alt = roleName || 'AIå¤´åƒ';
      avatar.onerror = function() {
        this.src = DEFAULT_AI_AVATAR;
      };
      
      // åˆ›å»ºæ°”æ³¡å®¹å™¨
      const bubbleContainer = document.createElement('div');
      bubbleContainer.className = 'bubble-container emoji-container-wrapper';
      
      // åˆ›å»ºè¡¨æƒ…åŒ…æ°”æ³¡
      const bubble = document.createElement('div');
      bubble.className = 'bubble emoji-bubble';
      
      // åˆ›å»ºè¡¨æƒ…åŒ…å®¹å™¨ï¼Œç¡®ä¿æ­£æ–¹å½¢æ˜¾ç¤º
      const emojiContainer = document.createElement('div');
      emojiContainer.className = 'emoji-container';
      emojiContainer.style.cssText = 'width: 120px; height: 120px; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #f0f0f0; flex-shrink: 0;';
      
      const emojiImg = document.createElement('img');
      emojiImg.src = emojiUrl;
      emojiImg.alt = 'è¡¨æƒ…åŒ…';
      emojiImg.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: cover; border-radius: 6px;';
      emojiImg.onerror = function() {
        emojiContainer.innerHTML = '<div style="color: #999; font-size: 12px;">è¡¨æƒ…åŒ…åŠ è½½å¤±è´¥</div>';
      };
      
      // åˆ›å»ºç‹¬ç«‹çš„æ—¶é—´å…ƒç´ ï¼ˆå¾®ä¿¡é£æ ¼ï¼‰
      const timeElement = document.createElement('div');
      timeElement.className = 'msg-time';
      const timeSpan = document.createElement('span');
      timeSpan.textContent = timestamp || formatMessageTime();
      timeElement.appendChild(timeSpan);
      
      emojiContainer.appendChild(emojiImg);
      bubble.appendChild(emojiContainer);
      
      // å°†æ°”æ³¡æ·»åŠ åˆ°å®¹å™¨
      bubbleContainer.appendChild(bubble);
      
      // æ·»åŠ æ¶ˆæ¯æ“ä½œèœå•
      const msgMenu = document.createElement('div');
      msgMenu.className = 'msg-menu';
      msgMenu.innerHTML = `
        <div class="msg-menu-item" data-action="reply" data-message-id="${messageId}">å›å¤</div>
        <div class="msg-menu-item" data-action="forward" data-message-id="${messageId}">è½¬å‘</div>
        <div class="msg-menu-item danger" data-action="delete" data-message-id="${messageId}">åˆ é™¤</div>
      `;
      
      // ä¸ºèœå•é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
      msgMenu.addEventListener('click', function(event) {
        event.stopPropagation();
        
        const menuItem = event.target.closest('.msg-menu-item');
        if (menuItem) {
          const action = menuItem.getAttribute('data-action');
          const msgId = menuItem.getAttribute('data-message-id');
          
          switch(action) {
            case 'reply':
              window.replyToMsg(msgId);
              break;
            case 'forward':
              window.forwardMsg(msgId);
              break;
            case 'delete':
              window.deleteMsg(msgId);
              break;
          }
          
          hideMsgMenu();
        }
      });
      
      msgDiv.appendChild(avatar);
      msgDiv.appendChild(bubbleContainer);
      msgDiv.appendChild(msgMenu);
      
      // æ·»åŠ é•¿æŒ‰äº‹ä»¶ç›‘å¬å™¨
      addLongPressListener(msgDiv, bubble);
      
      // å…ˆæ·»åŠ æ—¶é—´ï¼Œå†æ·»åŠ æ¶ˆæ¯
      chatBody.appendChild(timeElement);
      chatBody.appendChild(msgDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // å…¨å±€å‡½æ•°ï¼Œä¾›HTMLå†…è”äº‹ä»¶è°ƒç”¨
    window.deleteEmoji = deleteEmoji;
    window.createNewChat = createNewChat;
    window.createNewGroupChat = createNewGroupChat;
    window.deleteChat = deleteChat;
    window.openChat = openChat;
    window.showLocationDetail = showLocationDetail;
    window.showTransferDetail = showTransferDetail;

    // å‘é€æ¶ˆæ¯
    async function sendMsg() {
      if (!apiURL || !apiKey || !selectedModel) {
        alert('è¯·å…ˆé…ç½®APIä¿¡æ¯å¹¶é€‰æ‹©æ¨¡å‹ï¼');
        settingsPanel.classList.add('show');
        return;
      }

      const text = chatInput.value.trim();
      if (!text) return;
      
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (!currentChat) return;
      
      // å‘é€ç”¨æˆ·æ¶ˆæ¯ï¼ŒåŒ…å«å›å¤å¼•ç”¨
      const userMsgBubble = appendMsg('user', text, false, null, null, null, null, replyToMessage);
      
      // æ¸…ç©ºè¾“å…¥å’Œå›å¤çŠ¶æ€
      chatInput.value = '';
      cancelReply();
      
      // å°†æ¶ˆæ¯æ·»åŠ åˆ°å¾…å¤„ç†é˜Ÿåˆ—
      pendingMessages.push({
        text: text,
        chat: currentChat,
        timestamp: Date.now()
      });
      
      // å¦‚æœå“åº”å»¶è¿Ÿä¸º0ï¼Œç«‹å³å¤„ç†
      if (aiResponseDelay === 0) {
        await processMessages();
      } else {
        // å¯åŠ¨æˆ–é‡å¯å»¶è¿Ÿå®šæ—¶å™¨
        startResponseTimer();
      }
    }
    
    // å¯åŠ¨å“åº”å®šæ—¶å™¨
    function startResponseTimer() {
      // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
      if (responseTimer) {
        clearTimeout(responseTimer);
      }
      
      // è®¾ç½®ç­‰å¾…çŠ¶æ€
      isWaitingForResponse = true;
      updateSendButton();
      
      // æ˜¾ç¤ºç­‰å¾…æç¤º
      showWaitingIndicator();
      
      // å¯åŠ¨æ–°å®šæ—¶å™¨
      responseTimer = setTimeout(async () => {
        await processMessages();
        isWaitingForResponse = false;
        responseTimer = null;
        updateSendButton();
        hideWaitingIndicator();
      }, aiResponseDelay * 1000);
    }
    
    // å¤„ç†æ‰€æœ‰å¾…å¤„ç†çš„æ¶ˆæ¯
    async function processMessages() {
      if (pendingMessages.length === 0) return;
      
      sendBtn.disabled = true;
      
      // è·å–æœ€åä¸€æ¡æ¶ˆæ¯çš„èŠå¤©å¯¹è±¡
      const lastMessage = pendingMessages[pendingMessages.length - 1];
      const currentChat = lastMessage.chat;
      
      // åˆå¹¶æ‰€æœ‰å¾…å¤„ç†çš„æ¶ˆæ¯æ–‡æœ¬
      const combinedText = pendingMessages.map(msg => msg.text).join('\n');
      
      // æ¸…ç©ºå¾…å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—
      pendingMessages = [];
      
      if (currentChat.type === 'group') {
        // ç¾¤èŠæ¨¡å¼ï¼šå¤šè§’è‰²å›å¤
        await handleGroupChatReply(combinedText, currentChat);
      } else {
        // å•èŠæ¨¡å¼ï¼šå•è§’è‰²å›å¤
        await handleSingleChatReply(combinedText, currentChat);
      }
      
      sendBtn.disabled = false;
      updateSendButton();
    }
    
    // æ˜¾ç¤ºç­‰å¾…æŒ‡ç¤ºå™¨
    function showWaitingIndicator() {
      // ç§»é™¤å·²æœ‰çš„ç­‰å¾…æŒ‡ç¤ºå™¨
      const existingIndicator = document.querySelector('.waiting-indicator');
      if (existingIndicator) {
        existingIndicator.remove();
      }
      
      const indicator = document.createElement('div');
      indicator.className = 'waiting-indicator';
      indicator.style.cssText = `
        background: #f0f0f0; padding: 12px 16px;
        border-left: 3px solid #ff9800; font-size: 12px; color: #666;
        display: flex; justify-content: space-between; align-items: center;
        animation: pulse 1.5s infinite;
      `;
      
      indicator.innerHTML = `
        <div>
          <div style="color: #ff9800; font-weight: bold;">â³ AIæ­£åœ¨æ€è€ƒä¸­...</div>
          <div>å°†åœ¨ ${aiResponseDelay} ç§’åå›å¤ï¼Œå¯ç»§ç»­å‘é€æ¶ˆæ¯</div>
        </div>
        <div id="waitingCountdown" style="color: #ff9800; font-weight: bold;">${aiResponseDelay}</div>
      `;
      
      // æ’å…¥åˆ°chat-footerä¸Šæ–¹
      const chatFooter = chatInput.parentNode;
      chatFooter.parentNode.insertBefore(indicator, chatFooter);
      
      // å¯åŠ¨å€’è®¡æ—¶
      startCountdown();
    }
    
    // éšè—ç­‰å¾…æŒ‡ç¤ºå™¨
    function hideWaitingIndicator() {
      const indicator = document.querySelector('.waiting-indicator');
      if (indicator) {
        indicator.remove();
      }
    }
    
    // å¯åŠ¨å€’è®¡æ—¶
    function startCountdown() {
      const countdownElement = document.getElementById('waitingCountdown');
      if (!countdownElement) return;
      
      let remainingTime = aiResponseDelay;
      
      const countdownInterval = setInterval(() => {
        remainingTime--;
        if (countdownElement) {
          countdownElement.textContent = Math.max(0, remainingTime);
        }
        
        if (remainingTime <= 0 || !responseTimer) {
          clearInterval(countdownInterval);
        }
      }, 1000);
    }

    // æ£€æµ‹ç”¨æˆ·æ˜¯å¦ç¼ºé’±æˆ–ç´¢å–é’±
    function detectMoneyRequest(text) {
      const moneyKeywords = [
        // ç¼ºé’±ç›¸å…³
        'æ²¡é’±', 'ç¼ºé’±', 'ç©·', 'é’±ä¸å¤Ÿ', 'èµ„é‡‘ä¸è¶³', 'æ‰‹å¤´ç´§', 'æœˆå…‰æ—', 'åƒåœŸ', 'ç ´äº§',
        'å€Ÿé’±', 'å€Ÿç‚¹é’±', 'èƒ½å€Ÿæˆ‘', 'å€Ÿæˆ‘ç‚¹', 'ç¼ºç‚¹é’±', 'å·®ç‚¹é’±', 'é’±èŠ±å®Œäº†',
        // ç´¢å–é’±ç›¸å…³  
        'ç»™æˆ‘é’±', 'è½¬ç‚¹é’±', 'è½¬è´¦ç»™æˆ‘', 'ç»™æˆ‘è½¬', 'è¦é’±', 'éœ€è¦é’±', 'ç»™ç‚¹é’±',
        'å‘ä¸ªçº¢åŒ…', 'çº¢åŒ…æ¥ä¸€ä¸ª', 'æ¥ä¸ªçº¢åŒ…', 'å‘çº¢åŒ…', 'è½¬è´¦', 'æ‰“é’±',
        // ç”Ÿæ´»å›°éš¾ç›¸å…³
        'æ²¡é¥­åƒ', 'é¥¿è‚šå­', 'ä¹°ä¸èµ·', 'ä»˜ä¸èµ·', 'äº¤ä¸èµ·', 'è¿˜ä¸èµ·',
        'æˆ¿ç§Ÿ', 'ç”Ÿæ´»è´¹', 'ä¼™é£Ÿè´¹', 'å­¦è´¹', 'åŒ»è¯è´¹'
      ];
      
      const urgentKeywords = ['æ€¥éœ€', 'ç´§æ€¥', 'æ•‘å‘½', 'å¸®å¿™', 'æ±‚æ±‚', 'æ‹œæ‰˜', 'çœŸçš„éœ€è¦'];
      
      const lowerText = text.toLowerCase();
      let hasMoneyKeyword = false;
      let isUrgent = false;
      
      // æ£€æµ‹é‡‘é’±ç›¸å…³å…³é”®è¯
      for (const keyword of moneyKeywords) {
        if (lowerText.includes(keyword)) {
          hasMoneyKeyword = true;
          break;
        }
      }
      
      // æ£€æµ‹ç´§æ€¥ç¨‹åº¦
      for (const keyword of urgentKeywords) {
        if (lowerText.includes(keyword)) {
          isUrgent = true;
          break;
        }
      }
      
      // æ£€æµ‹é‡‘é¢æ•°å­—
      const amountRegex = /(\d+(?:\.\d+)?)\s*(?:å…ƒ|å—|ä¸‡|åƒ|ç™¾)/g;
      const amounts = [];
      let match;
      while ((match = amountRegex.exec(text)) !== null) {
        amounts.push(parseFloat(match[1]));
      }
      
      return {
        detected: hasMoneyKeyword,
        isUrgent: isUrgent,
        amounts: amounts,
        suggestedAmount: amounts.length > 0 ? Math.max(...amounts) : (isUrgent ? 200 : 100)
      };
    }

         // ç”Ÿæˆæ™ºèƒ½è½¬è´¦
     async function generateSmartTransfer(userText, roleName, moneyInfo) {
       const amount = moneyInfo.suggestedAmount;
       const isUrgent = moneyInfo.isUrgent;
       
       // æ ¹æ®ç´§æ€¥ç¨‹åº¦å’Œé‡‘é¢ç¡®å®šè½¬è´¦è¯´æ˜
       let transferNote = '';
       if (isUrgent) {
         transferNote = 'ç´§æ€¥èµ„åŠ©';
       } else if (amount >= 1000) {
         transferNote = 'èµ„é‡‘æ”¯æŒ';
       } else if (amount >= 500) {
         transferNote = 'ç”Ÿæ´»è¡¥è´´';
       } else {
         transferNote = 'å°å°å¿ƒæ„';
       }
       
       // æ ¹æ®ç”¨æˆ·æ¶ˆæ¯å†…å®¹ä¼˜åŒ–è½¬è´¦è¯´æ˜
       if (userText.includes('é¥­') || userText.includes('åƒ')) {
         transferNote = 'ä¹°é¥­é’±';
       } else if (userText.includes('æˆ¿ç§Ÿ')) {
         transferNote = 'æˆ¿ç§Ÿè¡¥è´´';
       } else if (userText.includes('å­¦è´¹')) {
         transferNote = 'å­¦è´¹èµ„åŠ©';
       } else if (userText.includes('åŒ»')) {
         transferNote = 'åŒ»ç–—è´¹ç”¨';
       }
       
       // åˆ›å»ºè½¬è´¦æ¶ˆæ¯HTML
       const transferHtml = `
         <div class="transfer-container" onclick="showTransferDetail(${amount}, '${escapeHtml(transferNote)}', '${escapeHtml(userName || 'ä½ ')}')">
           <div class="transfer-header">
             <div class="transfer-title">
               <span class="transfer-icon">ğŸ’°</span>
               <span>è½¬è´¦</span>
             </div>
             <div class="transfer-subtitle">å‘ ${escapeHtml(userName || 'ä½ ')} è½¬è´¦</div>
           </div>
           <div class="transfer-body">
             <div class="transfer-amount">Â¥${amount.toFixed(2)}</div>
             <div class="transfer-note">${escapeHtml(transferNote)}</div>
             <div class="transfer-status">
               <div class="transfer-status-icon">âœ“</div>
               <span>è½¬è´¦æˆåŠŸ</span>
             </div>
           </div>
         </div>
       `;
       
       return {
         html: transferHtml,
         amount: amount,
         note: transferNote,
         receiver: userName || 'ä½ '
       };
     }

     // å¤„ç†æ™ºèƒ½è½¬è´¦
     async function handleSmartTransfer(userText, roleName, moneyInfo, roleId) {
       console.log('ğŸ’° å¼€å§‹å¤„ç†æ™ºèƒ½è½¬è´¦:', { userText, roleName, moneyInfo, roleId });
       
       try {
         // ç”Ÿæˆè½¬è´¦æ•°æ®
         const transferData = await generateSmartTransfer(userText, roleName, moneyInfo);
         
         // å‘é€è½¬è´¦æ¶ˆæ¯
         appendMsg('ai', transferData.html, false, roleId, roleName, null, null, null, false, null, false, null, 'transfer');
         
         // å»¶è¿Ÿç”ŸæˆAIè½¬è´¦å›å¤
         setTimeout(async () => {
           await generateTransferAIReply(userText, roleName, roleId, transferData);
         }, 500);
         
         console.log('ğŸ’° æ™ºèƒ½è½¬è´¦å¤„ç†å®Œæˆ');
         
       } catch (error) {
         console.error('ğŸ’° æ™ºèƒ½è½¬è´¦å¤„ç†å¤±è´¥:', error);
       }
     }

     // ç”ŸæˆAIè½¬è´¦å›å¤
     async function generateTransferAIReply(userText, roleName, roleId, transferData) {
       console.log('ğŸ’° å¼€å§‹ç”ŸæˆAIè½¬è´¦å›å¤:', { roleName, transferData });
       
       try {
         // è·å–å½“å‰èŠå¤©å’Œè§’è‰²ä¿¡æ¯
         const currentChat = chatList.find(c => c.id === currentChatId);
         if (!currentChat) return;
         
         let roleDescription = '';
         
         // è·å–è§’è‰²æè¿°
         if (currentChat.type === 'group') {
           const role = currentChat.roles.find(r => r.id === roleId);
           roleDescription = role ? role.description : '';
         } else {
           // å•èŠæ¨¡å¼ï¼šä¼˜å…ˆä½¿ç”¨èŠå¤©çš„è§’è‰²æè¿°ï¼Œç„¶åæ˜¯å…¨å±€è§’è‰²æè¿°
           roleDescription = currentChat.roleDescription || window.roleDescription || '';
         }
         
         // æ„å»ºè½¬è´¦å›å¤çš„ç³»ç»Ÿæç¤ºè¯
         let systemPrompt = `ä½ åˆšåˆšå‘ç”¨æˆ·è½¬è´¦äº†Â¥${transferData.amount}ï¼ˆ${transferData.note}ï¼‰ã€‚`;
         
         if (roleName) {
           systemPrompt += `ä½ æ˜¯${roleName}ã€‚`;
         }
         
         if (roleDescription && roleDescription.trim()) {
           systemPrompt += `\n\nè§’è‰²è®¾å®šï¼š${roleDescription}`;
         }
         
         // æ·»åŠ ç”¨æˆ·ä¿¡æ¯
         if (userName && userName.trim()) {
           systemPrompt += `\n\nç”¨æˆ·å§“åï¼š${userName}`;
         }
         if (userDescription && userDescription.trim()) {
           systemPrompt += `\nç”¨æˆ·ä¿¡æ¯ï¼š${userDescription}`;
         }
         
         // æ·»åŠ è‡ªå®šä¹‰æç¤ºè¯
         if (aiCustomPrompt && aiCustomPrompt.trim()) {
           systemPrompt += `\n\nè¡¥å……è®¾å®šï¼š${aiCustomPrompt}`;
         }
         
         systemPrompt += `\n\nè¯·æ ¹æ®ä½ çš„è§’è‰²è®¾å®šï¼Œå¯¹åˆšæ‰çš„è½¬è´¦è¡Œä¸ºè¿›è¡Œç®€çŸ­çš„å›å¤ï¼ˆ1-2å¥è¯ï¼‰ã€‚å›å¤è¦ç¬¦åˆä½ çš„æ€§æ ¼ç‰¹ç‚¹ï¼Œå¯ä»¥è¡¨è¾¾å…³å¿ƒã€å®‰æ…°æˆ–å…¶ä»–ç¬¦åˆè§’è‰²çš„æƒ…æ„Ÿã€‚ä¸¥æ ¼æŒ‰ç…§è§’è‰²è®¾å®šè¿›è¡Œå›å¤ã€‚`;
         
         console.log('ğŸ’° è½¬è´¦å›å¤ç³»ç»Ÿæç¤ºè¯:', systemPrompt);
         
         // æ„å»ºæ¶ˆæ¯
         const messages = [
           {
             role: 'system',
             content: systemPrompt
           },
           {
             role: 'user',
             content: userText
           }
         ];
         
         console.log('ğŸ’° è½¬è´¦å›å¤æ¶ˆæ¯ä¸Šä¸‹æ–‡:', messages);
         
         // è°ƒç”¨APIç”Ÿæˆå›å¤
         const aiReply = await callChatAPI(messages);
         
         if (aiReply && aiReply.trim()) {
           console.log('ğŸ’° AIè½¬è´¦å›å¤ç”ŸæˆæˆåŠŸ:', aiReply);
           appendMsg('ai', aiReply.trim(), false, roleId, roleName);
         } else {
           // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›å¤
           const defaultReplies = [
             `ç»™ä½ è½¬äº†${transferData.amount}å…ƒï¼Œ${transferData.note}~`,
             `åˆšç»™ä½ è½¬è´¦äº†Â¥${transferData.amount}ï¼Œ${transferData.note}ï¼Œè®°å¾—æŸ¥æ”¶å“¦`,
             `è½¬äº†${transferData.amount}å—ç»™ä½ ï¼Œ${transferData.note}ï¼Œä¸ç”¨å®¢æ°”`,
             `å·²è½¬è´¦Â¥${transferData.amount}ï¼ˆ${transferData.note}ï¼‰ï¼Œå¸Œæœ›èƒ½å¸®åˆ°ä½ `
           ];
           
           const fallbackReply = defaultReplies[Math.floor(Math.random() * defaultReplies.length)];
           console.log('ğŸ’° ä½¿ç”¨é»˜è®¤è½¬è´¦å›å¤:', fallbackReply);
           appendMsg('ai', fallbackReply, false, roleId, roleName);
         }
         
         saveCurrentChatData();
         
       } catch (error) {
         console.error('ğŸ’° AIè½¬è´¦å›å¤ç”Ÿæˆå¤±è´¥:', error);
         
         // é”™è¯¯æ—¶ä½¿ç”¨ç®€å•çš„é»˜è®¤å›å¤
         const fallbackReply = `ç»™ä½ è½¬äº†${transferData.amount}å…ƒï¼Œ${transferData.note}~`;
         appendMsg('ai', fallbackReply, false, roleId, roleName);
         saveCurrentChatData();
       }
     }

    // å¤„ç†å•èŠå›å¤
    async function handleSingleChatReply(text, chat) {
      // è·å–å•èŠçš„è§’è‰²ä¿¡æ¯
      const singleRoleId = `single_${chat.id}`;
      const singleRoleName = chat.roleName || roleName || 'åŠ©æ‰‹';
      
      console.log('ğŸ”§ å•èŠè§’è‰²ä¿¡æ¯:', { 
        chatId: chat.id, 
        roleId: singleRoleId, 
        roleName: singleRoleName,
        chatRoleName: chat.roleName,
        globalRoleName: roleName 
      });
      
      // æ£€æµ‹æ˜¯å¦éœ€è¦è½¬è´¦
      const moneyDetection = detectMoneyRequest(text);
      console.log('ğŸ’° è½¬è´¦æ£€æµ‹ç»“æœ:', moneyDetection);
      
      // åˆ›å»ºAIæ¶ˆæ¯æ°”æ³¡å‡†å¤‡æµå¼è¾“å‡º
      const thinkingMsg = singleRoleName ? `${singleRoleName}æ­£åœ¨å›å¤...` : 'æ­£åœ¨å›å¤...';
      const aiMsgBubble = appendMsg('ai', thinkingMsg, true, singleRoleId, singleRoleName);

      try {
        // æ„å»ºæ­£ç¡®çš„èŠå¤©APIç«¯ç‚¹
        const baseChatEndpoint = getChatEndpoint(apiURL);
        
        // æ„å»ºåŒ…å«è§’è‰²è®¾å®šå’Œå†å²è®°å½•çš„æ¶ˆæ¯
        const messages = buildMessages(text);
        
        // æ ¹æ®ä¸åŒAPIæä¾›å•†æ„å»ºè¯·æ±‚
        let chatEndpoint, headers, requestBody;
        
        try {
          const url = new URL(apiURL);
          
          if (url.hostname === 'generativelanguage.googleapis.com') {
            // Google Gemini API
            chatEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
            headers = {
              'Content-Type': 'application/json'
            };
            
            // è½¬æ¢æ¶ˆæ¯æ ¼å¼ä¸ºGeminiæ ¼å¼
            const contents = [];
            let systemPrompt = '';
            
            // å…ˆæ”¶é›†ç³»ç»Ÿæ¶ˆæ¯
            messages.forEach(msg => {
              if (msg.role === 'system') {
                systemPrompt += (systemPrompt ? '\n' : '') + msg.content;
              }
            });
            
            console.log('ğŸ”§ å•èŠGemini APIç³»ç»Ÿæç¤ºé•¿åº¦:', systemPrompt.length);
            if (systemPrompt.length > 0) {
              console.log('ğŸ”§ å•èŠGemini APIç³»ç»Ÿæç¤ºé¢„è§ˆ:', systemPrompt.substring(0, 200) + (systemPrompt.length > 200 ? '...' : ''));
            }
            
            // è½¬æ¢ç”¨æˆ·å’ŒåŠ©æ‰‹æ¶ˆæ¯
            messages.forEach(msg => {
              if (msg.role === 'user') {
                let userContent = msg.content;
                // å°†ç³»ç»Ÿæç¤ºæ·»åŠ åˆ°ç¬¬ä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯ä¸­
                if (systemPrompt && contents.length === 0) {
                  userContent = systemPrompt + '\n\n' + userContent;
                  systemPrompt = ''; // æ ‡è®°å·²æ·»åŠ 
                }
                contents.push({
                  role: 'user',
                  parts: [{ text: userContent }]
                });
              } else if (msg.role === 'assistant') {
                contents.push({
                  role: 'model', 
                  parts: [{ text: msg.content }]
                });
              }
            });
            
            // å¦‚æœæ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯ä½†æœ‰ç³»ç»Ÿæ¶ˆæ¯ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤ç”¨æˆ·æ¶ˆæ¯
            if (contents.length === 0 && systemPrompt) {
              contents.push({
                role: 'user',
                parts: [{ text: systemPrompt + '\n\nè¯·å¼€å§‹å¯¹è¯ã€‚' }]
              });
            }
            
            requestBody = JSON.stringify({
              contents: contents,
              generationConfig: {
                temperature: 0.7,
                maxOutputTokens: 1000,
                topK: 40,
                topP: 0.95
              },
              safetySettings: [
                {
                  category: "HARM_CATEGORY_HARASSMENT",
                  threshold: "BLOCK_MEDIUM_AND_ABOVE"
                },
                {
                  category: "HARM_CATEGORY_HATE_SPEECH", 
                  threshold: "BLOCK_MEDIUM_AND_ABOVE"
                },
                {
                  category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                  threshold: "BLOCK_MEDIUM_AND_ABOVE"
                },
                {
                  category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                  threshold: "BLOCK_MEDIUM_AND_ABOVE"
                }
              ]
            });
          } else {
            // OpenAI/DeepSeekæ ¼å¼
            chatEndpoint = baseChatEndpoint;
            headers = {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            };
            
            requestBody = JSON.stringify({
              model: selectedModel,
              messages: messages,
              max_tokens: 1000,
              temperature: 0.7,
              stream: true // å¯ç”¨æµå¼è¾“å‡º
            });
          }
        } catch (e) {
          // é»˜è®¤ä½¿ç”¨OpenAIæ ¼å¼
          chatEndpoint = baseChatEndpoint;
          headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          };
          
          requestBody = JSON.stringify({
            model: selectedModel,
            messages: messages,
            max_tokens: 1000,
            temperature: 0.7,
            stream: true
          });
        }
        
        const response = await fetchWithRetry(chatEndpoint, {
          method: 'POST',
          headers: headers,
          body: requestBody,
          timeout: 30000 // èŠå¤©è¯·æ±‚ä½¿ç”¨30ç§’è¶…æ—¶
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // æ£€æŸ¥å“åº”æ˜¯å¦æ”¯æŒæµå¼
        const contentType = response.headers.get('content-type');
        const url = new URL(apiURL);
        
        if (url.hostname === 'generativelanguage.googleapis.com') {
          // å¤„ç†Gemini APIå“åº”
          const data = await response.json();
          let aiReply = '';
          
          // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
          if (data.error) {
            throw new Error(`Gemini APIé”™è¯¯: ${data.error.message} (${data.error.code})`);
          }
          
          if (data.candidates && data.candidates.length > 0) {
            const candidate = data.candidates[0];
            
            // æ£€æŸ¥æ˜¯å¦è¢«å®‰å…¨è¿‡æ»¤å™¨é˜»æ­¢
            if (candidate.finishReason === 'SAFETY') {
              aiReply = 'æŠ±æ­‰ï¼Œç”±äºå®‰å…¨ç­–ç•¥ï¼Œæˆ‘æ— æ³•å›å¤è¿™ä¸ªé—®é¢˜ã€‚è¯·å°è¯•å…¶ä»–è¯é¢˜ã€‚';
            } else if (candidate.finishReason === 'RECITATION') {
              aiReply = 'æŠ±æ­‰ï¼Œæ£€æµ‹åˆ°å¯èƒ½çš„ç‰ˆæƒå†…å®¹ï¼Œæ— æ³•æä¾›å›å¤ã€‚';
            } else if (candidate.content && candidate.content.parts) {
              aiReply = candidate.content.parts.map(part => part.text || '').join('').trim();
            }
          }
          
          if (!aiReply) {
            // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            const debugInfo = data.promptFeedback ? 
              `æç¤ºåé¦ˆ: ${JSON.stringify(data.promptFeedback)}` : 
              `å®Œæ•´å“åº”: ${JSON.stringify(data)}`;
            console.log('Gemini APIè°ƒè¯•ä¿¡æ¯:', debugInfo);
            aiReply = 'Gemini APIæœªè¿”å›æœ‰æ•ˆå†…å®¹ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–ç¨åé‡è¯•ã€‚';
          }
          
          // å¯¹äºGeminiå“åº”ï¼Œå¤„ç†åæ–œæ åˆ†å‰²
          await handleNonStreamResponse(aiReply, aiMsgBubble, singleRoleId, singleRoleName);
          
          // æ›´æ–°å¯¹è¯å†å²
          window.conversationHistory.push({
            role: "user",
            content: text
          });
          window.conversationHistory.push({
            role: "assistant",
            content: aiReply
          });
          
          // æ¯æ¬¡AIå›å¤åéƒ½å‘é€è¡¨æƒ…åŒ…ï¼ˆåˆ†æç”¨æˆ·å’ŒAIçš„æƒ…ç»ªï¼‰
          sendEmojiAlways(text, aiReply, singleRoleId, singleRoleName);
          
          // æ£€æµ‹æ˜¯å¦éœ€è¦å‘é€è½¬è´¦
          if (moneyDetection.detected) {
            setTimeout(async () => {
              await handleSmartTransfer(text, singleRoleName, moneyDetection, singleRoleId);
            }, 2000); // åœ¨è¡¨æƒ…åŒ…å‘é€åå†å‘é€è½¬è´¦
          }
          
          // å»¶è¿Ÿä¿å­˜èŠå¤©è®°å½•ï¼Œç­‰è¡¨æƒ…åŒ…å’Œè½¬è´¦å‘é€å®Œæˆ
          setTimeout(() => saveCurrentChatData(), moneyDetection.detected ? 3000 : 1500);
          
        } else if (contentType && contentType.includes('text/event-stream')) {
          // å¤„ç†æµå¼å“åº”
          const aiReply = await handleStreamResponse(response, aiMsgBubble, singleRoleId, singleRoleName);
          
          // æ›´æ–°å¯¹è¯å†å² - å¤šæ°”æ³¡åˆå¹¶ä¸ºä¸€æ¡è®°å½•
          window.conversationHistory.push({
            role: "user",
            content: text
          });
          window.conversationHistory.push({
            role: "assistant",
            content: aiReply
          });
          
          // æ¯æ¬¡AIå›å¤åéƒ½å‘é€è¡¨æƒ…åŒ…ï¼ˆåˆ†æç”¨æˆ·å’ŒAIçš„æƒ…ç»ªï¼‰
          sendEmojiAlways(text, aiReply, singleRoleId, singleRoleName);
          
          // æ£€æµ‹æ˜¯å¦éœ€è¦å‘é€è½¬è´¦
          if (moneyDetection.detected) {
            setTimeout(async () => {
              await handleSmartTransfer(text, singleRoleName, moneyDetection, singleRoleId);
            }, 2000); // åœ¨è¡¨æƒ…åŒ…å‘é€åå†å‘é€è½¬è´¦
          }
          
          // å»¶è¿Ÿä¿å­˜èŠå¤©è®°å½•ï¼Œç­‰è¡¨æƒ…åŒ…å’Œè½¬è´¦å‘é€å®Œæˆ
          setTimeout(() => saveCurrentChatData(), moneyDetection.detected ? 3000 : 1500);
        } else {
          // å›é€€åˆ°æ™®é€šå“åº”å¤„ç†
          const data = await response.json();
          const aiReply = data.choices?.[0]?.message?.content || data.reply || data.response || 'AIæœªè¿”å›å†…å®¹';
          
          // å¯¹äºéæµå¼å“åº”ï¼Œä¹Ÿå¤„ç†åæ–œæ åˆ†å‰²
          await handleNonStreamResponse(aiReply, aiMsgBubble, singleRoleId, singleRoleName);
          
          // æ›´æ–°å¯¹è¯å†å²
          window.conversationHistory.push({
            role: "user",
            content: text
          });
          window.conversationHistory.push({
            role: "assistant",
            content: aiReply
          });
          
          // æ¯æ¬¡AIå›å¤åéƒ½å‘é€è¡¨æƒ…åŒ…ï¼ˆåˆ†æç”¨æˆ·å’ŒAIçš„æƒ…ç»ªï¼‰
          sendEmojiAlways(text, aiReply, singleRoleId, singleRoleName);
          
          // æ£€æµ‹æ˜¯å¦éœ€è¦å‘é€è½¬è´¦
          if (moneyDetection.detected) {
            setTimeout(async () => {
              await handleSmartTransfer(text, singleRoleName, moneyDetection, singleRoleId);
            }, 2000); // åœ¨è¡¨æƒ…åŒ…å‘é€åå†å‘é€è½¬è´¦
          }
          
          // å»¶è¿Ÿä¿å­˜èŠå¤©è®°å½•ï¼Œç­‰è¡¨æƒ…åŒ…å’Œè½¬è´¦å‘é€å®Œæˆ
          setTimeout(() => saveCurrentChatData(), moneyDetection.detected ? 3000 : 1500);
        }
        
      } catch (e) {
        updateStreamingMsg(aiMsgBubble, `è¯·æ±‚å¤±è´¥: ${e.message}ã€‚è¯·æ£€æŸ¥APIé…ç½®æ˜¯å¦æ­£ç¡®ã€‚`);
        finishStreamingMsg(aiMsgBubble);
      }
    }

    // å¤„ç†ç¾¤èŠå›å¤
    async function handleGroupChatReply(text, chat) {
      if (!chat.roles || chat.roles.length === 0) {
        // å¦‚æœæ²¡æœ‰è§’è‰²ï¼Œæç¤ºç”¨æˆ·æ·»åŠ è§’è‰²
        const noRoleMsg = appendMsg('ai', 'ç¾¤èŠè¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•è§’è‰²ï¼Œè¯·å…ˆåœ¨è§’è‰²è®¾å®šä¸­æ·»åŠ è§’è‰²ã€‚', false, null, null);
        finishStreamingMsg(noRoleMsg);
        return;
      }

      // æ£€æµ‹æ˜¯å¦éœ€è¦è½¬è´¦
      const moneyDetection = detectMoneyRequest(text);
      console.log('ğŸ’° ç¾¤èŠè½¬è´¦æ£€æµ‹ç»“æœ:', moneyDetection);

      // ç¡®ä¿ç¾¤èŠè®¾ç½®å­˜åœ¨ä¸”ä½¿ç”¨æœ€æ–°çš„é»˜è®¤å€¼
      if (!chat.groupSettings) {
        chat.groupSettings = {
          maxRolesPerReply: 3,
          replyDelay: 1000
        };
      } else if (!chat.groupSettings.maxRolesPerReply || chat.groupSettings.maxRolesPerReply < 3) {
        chat.groupSettings.maxRolesPerReply = 3; // æ›´æ–°æ—§çš„è®¾ç½®
      }
      
      console.log(`ç¾¤èŠè®¾ç½®: æœ€å¤§å›å¤è§’è‰²æ•°=${chat.groupSettings.maxRolesPerReply}, å½“å‰è§’è‰²æ€»æ•°=${chat.roles.length}`);
      
      let activeRoles;
      
      // å¦‚æœè®¾ç½®ä¸ºæ‰€æœ‰è§’è‰²éƒ½å›å¤ï¼Œç›´æ¥ä½¿ç”¨æ‰€æœ‰è§’è‰²
      if (chat.groupSettings.maxRolesPerReply >= 999) {
        activeRoles = [...chat.roles]; // å¤åˆ¶æ‰€æœ‰è§’è‰²
        console.log(`å¼ºåˆ¶æ‰€æœ‰è§’è‰²å›å¤: ${activeRoles.map(r => r.name).join(', ')}`);
      } else {
        // æ ¹æ®è§’è‰²å›å¤é¢‘ç‡å†³å®šå“ªäº›è§’è‰²è¦å›å¤
        activeRoles = selectActiveRoles(chat.roles, text);
        console.log(`è‡ªç„¶é€‰æ‹©çš„æ´»è·ƒè§’è‰²: ${activeRoles.map(r => r.name).join(', ')}`);
        
        // å¦‚æœæ´»è·ƒè§’è‰²å¤ªå°‘ï¼Œè¡¥å……è§’è‰²ä»¥è¾¾åˆ°æœŸæœ›çš„å›å¤æ•°é‡
        const minRoles = Math.min(chat.roles.length, chat.groupSettings.maxRolesPerReply);
        if (activeRoles.length < minRoles) {
          // ä»æœªé€‰ä¸­çš„è§’è‰²ä¸­éšæœºé€‰æ‹©è¡¥å……
          const availableRoles = chat.roles.filter(role => !activeRoles.includes(role));
          while (activeRoles.length < minRoles && availableRoles.length > 0) {
            const randomIndex = Math.floor(Math.random() * availableRoles.length);
            const selectedRole = availableRoles.splice(randomIndex, 1)[0];
            activeRoles.push(selectedRole);
            console.log(`è¡¥å……è§’è‰²: ${selectedRole.name}`);
          }
        }
      }

      // éšæœºæ‰“ä¹±è§’è‰²é¡ºåºï¼Œé¿å…æ€»æ˜¯é€‰æ‹©å‰å‡ ä¸ªè§’è‰²
      for (let i = activeRoles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [activeRoles[i], activeRoles[j]] = [activeRoles[j], activeRoles[i]];
      }
      
      // é™åˆ¶åŒæ—¶å›å¤çš„è§’è‰²æ•°é‡ï¼ˆé™¤éè®¾ç½®ä¸ºæ‰€æœ‰è§’è‰²éƒ½å›å¤ï¼‰
      const maxRoles = chat.groupSettings.maxRolesPerReply >= 999 ? activeRoles.length : Math.min(activeRoles.length, chat.groupSettings.maxRolesPerReply);
      const replyingRoles = activeRoles.slice(0, maxRoles);
      console.log(`æœ€ç»ˆå›å¤è§’è‰²: ${replyingRoles.map(r => r.name).join(', ')}`);
      
      // ä¿å­˜æ›´æ–°çš„è®¾ç½®
      saveChatList();

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
      window.conversationHistory.push({
        role: "user",
        content: text
      });

      // ç”¨äºå­˜å‚¨å½“å‰å›åˆä¸­å·²ç»å›å¤çš„è§’è‰²ä¿¡æ¯
      const currentRoundReplies = [];
      
      // è®©æ¯ä¸ªé€‰ä¸­çš„è§’è‰²ä¾æ¬¡å›å¤
      for (let i = 0; i < replyingRoles.length; i++) {
        const role = replyingRoles[i];
        console.log(`ğŸ”„ ç¬¬${i + 1}ä¸ªå›å¤è§’è‰²: ${role.name} (ID: ${role.id})`);
        
        // å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªè§’è‰²ï¼Œæ·»åŠ ä¸€äº›å»¶è¿Ÿ
        if (i > 0) {
          await new Promise(resolve => setTimeout(resolve, chat.groupSettings.replyDelay));
        }
        
        // ç”Ÿæˆå›å¤ï¼Œä¼ é€’å½“å‰å›åˆä¸­å‰é¢è§’è‰²çš„å›å¤ä¿¡æ¯
        const reply = await generateRoleReply(role, text, chat, false, currentRoundReplies);
        
        // å°†è¿™ä¸ªè§’è‰²çš„å›å¤æ·»åŠ åˆ°å½“å‰å›åˆå›å¤åˆ—è¡¨ä¸­ï¼Œä¾›åç»­è§’è‰²å‚è€ƒ
        if (reply) {
          currentRoundReplies.push({
            roleId: role.id,
            roleName: role.name,
            content: reply,
            order: i + 1
          });
          console.log(`ğŸ“ è§’è‰² ${role.name} çš„å›å¤å·²æ·»åŠ åˆ°å½“å‰å›åˆï¼Œä¾›åç»­è§’è‰²å‚è€ƒ`);
        }
      }

      // å¦‚æœæ£€æµ‹åˆ°éœ€è¦è½¬è´¦ï¼Œéšæœºé€‰æ‹©ä¸€ä¸ªè§’è‰²å‘é€è½¬è´¦
      if (moneyDetection.detected && replyingRoles.length > 0) {
        const randomRole = replyingRoles[Math.floor(Math.random() * replyingRoles.length)];
        console.log(`ğŸ’° ç¾¤èŠè½¬è´¦ç”±è§’è‰² ${randomRole.name} å‘é€`);
        
        setTimeout(async () => {
          await handleSmartTransfer(text, randomRole.name, moneyDetection, randomRole.id);
        }, 3000); // ç­‰æ‰€æœ‰è§’è‰²å›å¤å’Œè¡¨æƒ…åŒ…å‘é€å®Œæˆåå†å‘é€è½¬è´¦
      }

      // å»¶è¿Ÿä¿å­˜èŠå¤©è®°å½•
      setTimeout(() => saveCurrentChatData(), moneyDetection.detected ? 4000 : 1500);
    }

    // é€‰æ‹©æ´»è·ƒçš„è§’è‰²
    function selectActiveRoles(roles, userText) {
      const activeRoles = [];
      
      roles.forEach(role => {
        const shouldReply = shouldRoleReply(role, userText);
        if (shouldReply) {
          activeRoles.push(role);
        }
      });
      
      console.log(`è§’è‰²å›å¤æƒ…å†µ: ${roles.map(r => `${r.name}(${r.frequency || 'always'}): ${shouldRoleReply(r, userText) ? 'å›å¤' : 'ä¸å›å¤'}`).join(', ')}`);
      
      return activeRoles;
    }

    // åˆ¤æ–­è§’è‰²æ˜¯å¦åº”è¯¥å›å¤
    function shouldRoleReply(role, userText) {
      // å¦‚æœç”¨æˆ·æ¶ˆæ¯ä¸­æåˆ°äº†è§’è‰²åå­—ï¼Œä¼˜å…ˆå›å¤
      if (userText.includes(role.name)) {
        return true;
      }
      
      // æ ¹æ®é¢‘ç‡è®¾ç½®éšæœºå†³å®š
      const frequencies = {
        'always': 1.0,    // 100% å›å¤
        'often': 0.7,     // 70% å›å¤
        'sometimes': 0.4, // 40% å›å¤
        'rarely': 0.15    // 15% å›å¤
      };
      
      const threshold = frequencies[role.frequency] || 1.0;
      return Math.random() < threshold;
    }

    // ç”Ÿæˆè§’è‰²å›å¤
    async function generateRoleReply(role, userText, chat, shouldDetectMoney = true, currentRoundReplies = []) {
      console.log(`ğŸ­ å¼€å§‹ç”Ÿæˆè§’è‰²å›å¤: ${role.name} (ID: ${role.id})`);
      
      // åˆ›å»ºè¯¥è§’è‰²çš„æ¶ˆæ¯æ°”æ³¡
      const thinkingMsg = `${role.name}æ­£åœ¨å›å¤...`;
      const aiMsgBubble = appendMsg('ai', thinkingMsg, true, role.id, role.name);

      try {
        // æ„å»ºåŒ…å«è¯¥è§’è‰²è®¾å®šçš„æ¶ˆæ¯ï¼Œä¼ é€’å½“å‰å›åˆçš„å›å¤ä¿¡æ¯
        const messages = buildMessagesForRole(role, userText, chat, currentRoundReplies);
        
        console.log(`ğŸ“ ${role.name}çš„æ¶ˆæ¯æ„å»ºå®Œæˆï¼Œç³»ç»Ÿæç¤ºåŒ…å«è§’è‰²: ${role.name}`);
        if (currentRoundReplies.length > 0) {
          console.log(`ğŸ¤ ${role.name}å¯ä»¥çœ‹åˆ°å‰é¢${currentRoundReplies.length}ä¸ªè§’è‰²çš„å›å¤: ${currentRoundReplies.map(r => r.roleName).join(', ')}`);
        }
        
        // è°ƒç”¨APIè·å–å›å¤
        const aiReply = await callChatAPI(messages);
        
        console.log(`ğŸ’¬ ${role.name}çš„APIå›å¤: ${aiReply.substring(0, 50)}...`);
        
        // å¤„ç†å›å¤æ˜¾ç¤º
        await handleNonStreamResponse(aiReply, aiMsgBubble, role.id, role.name);
        
        // æ·»åŠ åˆ°å¯¹è¯å†å²
        window.conversationHistory.push({
          role: "assistant",
          content: aiReply,
          roleId: role.id,
          roleName: role.name
        });
        
        console.log(`âœ… ${role.name}å›å¤å®Œæˆï¼Œæ·»åŠ åˆ°å†å²è®°å½•`);
        
        // å‘é€è¡¨æƒ…åŒ…
        sendEmojiAlways(userText, aiReply, role.id, role.name);
        
        // è¿”å›ç”Ÿæˆçš„å›å¤å†…å®¹ï¼Œä¾›åç»­è§’è‰²å‚è€ƒ
        return aiReply;
        
      } catch (e) {
        console.error(`âŒ ${role.name}å›å¤å¤±è´¥:`, e);
        updateStreamingMsg(aiMsgBubble, `${role.name}å›å¤å¤±è´¥: ${e.message}`);
        finishStreamingMsg(aiMsgBubble);
        return null; // å›å¤å¤±è´¥æ—¶è¿”å›null
      }
    }

    // ä¸ºç‰¹å®šè§’è‰²æ„å»ºæ¶ˆæ¯
    function buildMessagesForRole(role, userMessage, chat, currentRoundReplies = []) {
      let messages = [];
      
      // æ„å»ºç³»ç»Ÿæç¤º
      let systemPrompts = [];
      
      // å…ˆæ·»åŠ è§’è‰²è®¾å®š
      if (role.description) {
        const rolePrompt = `ä½ ç°åœ¨è¦æ‰®æ¼”ä¸€ä¸ªè§’è‰²ï¼Œè§’è‰²åå­—æ˜¯"${role.name}"ã€‚è§’è‰²è®¾å®šå¦‚ä¸‹ï¼š${role.description}`;
        systemPrompts.push(rolePrompt);
        console.log(`ğŸ­ ä¸ºè§’è‰² ${role.name} (ID: ${role.id}) æ„å»ºç³»ç»Ÿæç¤º`);
      }
      
      // æ·»åŠ ç¾¤èŠè®¾å®šå’Œå½“å‰å›åˆäº’åŠ¨ä¿¡æ¯
      let groupChatPrompt = `ä½ ç°åœ¨å¤„äºä¸€ä¸ªç¾¤èŠç¯å¢ƒä¸­ï¼Œå¯èƒ½æœ‰å…¶ä»–è§’è‰²ä¹Ÿä¼šå›å¤ç”¨æˆ·ã€‚
é‡è¦æé†’ï¼š
1. ä½ åªèƒ½æ‰®æ¼”"${role.name}"è¿™ä¸€ä¸ªè§’è‰²ï¼Œä¸¥æ ¼ä¿æŒè‡ªå·±çš„è§’è‰²è®¾å®šå’Œæ€§æ ¼ç‰¹ç‚¹
2. ä¸è¦æ¨¡ä»¿æˆ–æ‰®æ¼”å…¶ä»–è§’è‰²çš„è¯´è¯æ–¹å¼å’Œæ€§æ ¼
3. å…¶ä»–è§’è‰²çš„å‘è¨€åªæ˜¯å¯¹è¯èƒŒæ™¯ï¼Œä½ è¦ä»¥è‡ªå·±çš„è§’è‰²èº«ä»½æ¥å›åº”
4. è¯·æ ¹æ®ä½ çš„è§’è‰²è®¾å®šè‡ªç„¶åœ°å›å¤ï¼Œä¿æŒè§’è‰²ä¸€è‡´æ€§`;
      
      // å¦‚æœæœ‰å½“å‰å›åˆä¸­å‰é¢è§’è‰²çš„å›å¤ï¼Œæ·»åŠ äº’åŠ¨æç¤º
      if (currentRoundReplies && currentRoundReplies.length > 0) {
        groupChatPrompt += '\n\nåœ¨è¿™ä¸€è½®å¯¹è¯ä¸­ï¼Œå·²ç»æœ‰ä»¥ä¸‹è§’è‰²å›å¤äº†ç”¨æˆ·ï¼š';
        currentRoundReplies.forEach((reply, index) => {
          groupChatPrompt += `\n${index + 1}. ${reply.roleName}ï¼š${reply.content}`;
        });
        groupChatPrompt += `\n\nä½ å¯ä»¥å‚è€ƒè¿™äº›å›å¤å†…å®¹ï¼Œä¸å…¶ä»–è§’è‰²è¿›è¡Œè‡ªç„¶çš„äº’åŠ¨ï¼Œæ¯”å¦‚ï¼šå›åº”å…¶ä»–è§’è‰²çš„è§‚ç‚¹ã€è¡¥å……ä¿¡æ¯ã€è¡¨è¾¾ä¸åŒçœ‹æ³•ã€æˆ–è€…ä¸å…¶ä»–è§’è‰²å¯¹è¯ã€‚
é‡è¦ï¼šè¯·å§‹ç»ˆä¿æŒä½œä¸º"${role.name}"çš„è§’è‰²è®¾å®šï¼Œä¸è¦æ··æ·†è‡ªå·±å’Œå…¶ä»–è§’è‰²çš„èº«ä»½ï¼Œè‡ªç„¶åœ°èå…¥ç¾¤èŠæ°›å›´ã€‚`;
      }
      
      systemPrompts.push(groupChatPrompt);
      
      // æ·»åŠ ç”¨æˆ·è®¾å®š
      if (chat.userDescription) {
        const userPrompt = chat.userName ? 
          `å¯¹è¯çš„ç”¨æˆ·åå­—æ˜¯"${chat.userName}"ï¼Œç”¨æˆ·ä¿¡æ¯å¦‚ä¸‹ï¼š${chat.userDescription}ã€‚è¯·æ ¹æ®ç”¨æˆ·è®¾å®šè°ƒæ•´ä½ çš„äº’åŠ¨æ–¹å¼ã€‚` :
          `å¯¹è¯çš„ç”¨æˆ·ä¿¡æ¯å¦‚ä¸‹ï¼š${chat.userDescription}ã€‚è¯·æ ¹æ®ç”¨æˆ·è®¾å®šè°ƒæ•´ä½ çš„äº’åŠ¨æ–¹å¼ã€‚`;
        systemPrompts.push(userPrompt);
      } else if (chat.userName) {
        systemPrompts.push(`å¯¹è¯çš„ç”¨æˆ·åå­—æ˜¯"${chat.userName}"ã€‚`);
      }
      
      // æ·»åŠ æ°”æ³¡åˆ†å‰²è¯´æ˜å’Œå›å¤æ ¼å¼è¦æ±‚
      const bubbleSplitPrompt = `=== é‡è¦ï¼šå›å¤æ ¼å¼è¦æ±‚ï¼ˆå¿…é¡»ä¸¥æ ¼éµå¾ªï¼‰===
1. ç”¨ï¼ˆï¼‰åŒ…è£¹åŠ¨ä½œæè¿°
2. ä¸¥æ ¼éµå¾ªä½¿ç”¨åæ–œçº¿\\åˆ†éš”å¥å­çš„è¦æ±‚ï¼Œæ¯ä¸ªå¥å­æ§åˆ¶åœ¨50å­—ä»¥å†…
3. å›å¤è¾“å‡ºç¤ºä¾‹æ ¼å¼ï¼šç¬¬ä¸€å¥è¯\\ç¬¬äºŒå¥è¯\\ç¬¬ä¸‰å¥è¯

ç¾¤èŠå¯¹è¯ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼šå¤§å®¶è§‰å¾—ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ
${role.name}å›å¤ï¼šä»Šå¤©å¤©æ°”çœŸä¸é”™\\å¾ˆé€‚åˆå‡ºé—¨å‘¢

ç”¨æˆ·ï¼šæœ€è¿‘åœ¨å¿™ä»€ä¹ˆï¼Ÿ
${role.name}å›å¤ï¼šåœ¨å­¦ä¹ æ–°æŠ€èƒ½\\è¿›å±•è¿˜ä¸é”™\\å¾ˆæœ‰æ”¶è·

ç”¨æˆ·ï¼šä½ ä»¬å¥½å¯çˆ±
${role.name}å›å¤ï¼š(å®³ç¾åœ°ä½ä¸‹å¤´)è°¢è°¢å¤¸å¥–\\äººå®¶ä¼šä¸å¥½æ„æ€çš„

ç”¨æˆ·ï¼šæ‹äº†æ‹ä½ 
${role.name}å›å¤ï¼š(è½»è½»æ‹å›å»)ä½ ä¹Ÿæ‹æ‹æˆ‘å‘€\\æˆ‘ä»¬ä¸€èµ·ç©

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸Šæ ¼å¼è¦æ±‚å›å¤ï¼Œè¿™æ˜¯å¿…é¡»éµå¾ªçš„è§„åˆ™ã€‚`;
      systemPrompts.push(bubbleSplitPrompt);

      // æœ€åæ·»åŠ é¢„è®¾æç¤ºè¯ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼Œç¦»ç”¨æˆ·æ¶ˆæ¯æœ€è¿‘ï¼‰
      if (aiCustomPrompt) {
        systemPrompts.push('=== é‡è¦çº¦æŸæ¡ä»¶ ===');
        systemPrompts.push(aiCustomPrompt);
        systemPrompts.push('è¯·ä¸¥æ ¼éµå®ˆä»¥ä¸Šçº¦æŸæ¡ä»¶ï¼Œè¿™äº›æ¡ä»¶å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ã€‚');
        console.log('ğŸ¯ ç¾¤èŠé¢„è®¾æç¤ºè¯å·²æ·»åŠ ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰:', aiCustomPrompt.substring(0, 100) + (aiCustomPrompt.length > 100 ? '...' : ''));
      } else {
        console.log('âš ï¸ ç¾¤èŠé¢„è®¾æç¤ºè¯ä¸ºç©ºæˆ–æœªè®¾ç½®');
      }
      
      // å¦‚æœæœ‰ç³»ç»Ÿæç¤ºï¼Œæ·»åŠ åˆ°æ¶ˆæ¯ä¸­
      if (systemPrompts.length > 0) {
        const systemContent = systemPrompts.join('\n\n');
        messages.push({
          role: "system",
          content: systemContent
        });
        console.log('ğŸ“‹ ç¾¤èŠç³»ç»Ÿæç¤ºæ„å»ºå®Œæˆï¼Œå…±', systemPrompts.length, 'ä¸ªéƒ¨åˆ†ï¼Œæ€»é•¿åº¦:', systemContent.length);
        console.log('ğŸ“‹ ç³»ç»Ÿæç¤ºå†…å®¹é¢„è§ˆ:', systemContent.substring(0, 200) + (systemContent.length > 200 ? '...' : ''));
      } else {
        console.log('âš ï¸ ç¾¤èŠæ²¡æœ‰ç³»ç»Ÿæç¤º');
      }
      
      // æ·»åŠ æœ€è¿‘çš„å¯¹è¯å†å²ï¼ˆæ ¹æ®ç”¨æˆ·è®¾ç½®çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼‰
      // åœ¨ç¾¤èŠä¸­ï¼Œè®©è§’è‰²èƒ½å¤Ÿçœ‹åˆ°å…¶ä»–è§’è‰²çš„å®Œæ•´å›å¤ä»¥å¢åŠ äº’åŠ¨æ„Ÿ
      const maxHistory = aiContextLength * 2; // æ¯è½®å¯¹è¯åŒ…å«ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤ï¼Œæ‰€ä»¥ä¹˜ä»¥2
      const allHistory = window.conversationHistory.slice(-maxHistory);
      
      // æ„å»ºåŒ…å«è§’è‰²äº’åŠ¨çš„å¯¹è¯å†å²
      const interactiveHistory = [];
      for (const msg of allHistory) {
        if (msg.role === 'user') {
          // ä¿ç•™æ‰€æœ‰ç”¨æˆ·æ¶ˆæ¯
          interactiveHistory.push(msg);
        } else if (msg.role === 'assistant') {
          if (msg.roleId === role.id) {
            // ä¿ç•™è¯¥è§’è‰²è‡ªå·±çš„å›å¤
            interactiveHistory.push(msg);
          } else {
            // å…¶ä»–è§’è‰²çš„å›å¤åº”è¯¥æ ‡è®°ä¸ºuserè§’è‰²ï¼Œè¿™æ ·å½“å‰è§’è‰²ä¸ä¼šè®¤ä¸ºæ˜¯è‡ªå·±è¯´çš„
            // é¿å…è§’è‰²æ··æ·†å’Œæ‰®æ¼”ä¸²å°
            interactiveHistory.push({
              role: 'user',
              content: `[ç¾¤èŠä¸­çš„${msg.roleName || 'å…¶ä»–è§’è‰²'}]: ${msg.content}`
            });
          }
        }
      }
      
      console.log(`ğŸ“š ${role.name}çš„äº’åŠ¨å¯¹è¯å†å²: å…±${allHistory.length}æ¡è®°å½•ï¼Œå¤„ç†å${interactiveHistory.length}æ¡`);
      
      messages = messages.concat(interactiveHistory);
      
      // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
      messages.push({
        role: "user",
        content: userMessage
      });
      
      return messages;
    }

    // è°ƒç”¨èŠå¤©API
    async function callChatAPI(messages) {
      const baseChatEndpoint = getChatEndpoint(apiURL);
      
      // æ ¹æ®ä¸åŒAPIæä¾›å•†æ„å»ºè¯·æ±‚
      let chatEndpoint, headers, requestBody;
      
      try {
        const url = new URL(apiURL);
        
        if (url.hostname === 'generativelanguage.googleapis.com') {
          // Google Gemini API
          chatEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
          headers = {
            'Content-Type': 'application/json'
          };
          
          // è½¬æ¢æ¶ˆæ¯æ ¼å¼ä¸ºGeminiæ ¼å¼
          const contents = [];
          let systemPrompt = '';
          
          // å…ˆæ”¶é›†ç³»ç»Ÿæ¶ˆæ¯
          messages.forEach(msg => {
            if (msg.role === 'system') {
              systemPrompt += (systemPrompt ? '\n' : '') + msg.content;
            }
          });
          
          console.log('ğŸ”§ Gemini APIç³»ç»Ÿæç¤ºé•¿åº¦:', systemPrompt.length);
          if (systemPrompt.length > 0) {
            console.log('ğŸ”§ Gemini APIç³»ç»Ÿæç¤ºé¢„è§ˆ:', systemPrompt.substring(0, 200) + (systemPrompt.length > 200 ? '...' : ''));
          }
          
          // è½¬æ¢ç”¨æˆ·å’ŒåŠ©æ‰‹æ¶ˆæ¯
          messages.forEach(msg => {
            if (msg.role === 'user') {
              let userContent = msg.content;
              // å°†ç³»ç»Ÿæç¤ºæ·»åŠ åˆ°ç¬¬ä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯ä¸­
              if (systemPrompt && contents.length === 0) {
                userContent = systemPrompt + '\n\n' + userContent;
                systemPrompt = ''; // æ ‡è®°å·²æ·»åŠ 
              }
              contents.push({
                role: 'user',
                parts: [{ text: userContent }]
              });
            } else if (msg.role === 'assistant') {
              contents.push({
                role: 'model',
                parts: [{ text: msg.content }]
              });
            }
          });
          
          requestBody = JSON.stringify({
            contents: contents,
            generationConfig: {
              temperature: 0.7,
              maxOutputTokens: 800,
              topK: 40,
              topP: 0.95
            },
            safetySettings: [
              {
                category: "HARM_CATEGORY_HARASSMENT",
                threshold: "BLOCK_MEDIUM_AND_ABOVE"
              },
              {
                category: "HARM_CATEGORY_HATE_SPEECH", 
                threshold: "BLOCK_MEDIUM_AND_ABOVE"
              },
              {
                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                threshold: "BLOCK_MEDIUM_AND_ABOVE"
              },
              {
                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                threshold: "BLOCK_MEDIUM_AND_ABOVE"
              }
            ]
          });
        } else {
          // OpenAI/DeepSeekæ ¼å¼
          chatEndpoint = baseChatEndpoint;
          headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          };
          
          requestBody = JSON.stringify({
            model: selectedModel,
            messages: messages,
            max_tokens: 800,
            temperature: 0.7,
            stream: false // ç¾¤èŠæš‚ä¸ä½¿ç”¨æµå¼ï¼Œé¿å…å¤æ‚åº¦
          });
        }
      } catch (e) {
        // é»˜è®¤ä½¿ç”¨OpenAIæ ¼å¼
        chatEndpoint = baseChatEndpoint;
        headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        };
        
        requestBody = JSON.stringify({
          model: selectedModel,
          messages: messages,
          max_tokens: 800,
          temperature: 0.7,
          stream: false
        });
      }
      
      const response = await fetchWithRetry(chatEndpoint, {
        method: 'POST',
        headers: headers,
        body: requestBody,
        timeout: 25000 // ç¾¤èŠè¯·æ±‚ä½¿ç”¨25ç§’è¶…æ—¶
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const url = new URL(apiURL);
      
      if (url.hostname === 'generativelanguage.googleapis.com') {
        // å¤„ç†Gemini APIå“åº”
        const data = await response.json();
        let aiReply = '';
        
        // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
        if (data.error) {
          throw new Error(`Gemini APIé”™è¯¯: ${data.error.message} (${data.error.code})`);
        }
        
        if (data.candidates && data.candidates.length > 0) {
          const candidate = data.candidates[0];
          
          // æ£€æŸ¥æ˜¯å¦è¢«å®‰å…¨è¿‡æ»¤å™¨é˜»æ­¢
          if (candidate.finishReason === 'SAFETY') {
            aiReply = 'æŠ±æ­‰ï¼Œç”±äºå®‰å…¨ç­–ç•¥ï¼Œæˆ‘æ— æ³•å›å¤è¿™ä¸ªé—®é¢˜ã€‚';
          } else if (candidate.finishReason === 'RECITATION') {
            aiReply = 'æŠ±æ­‰ï¼Œæ£€æµ‹åˆ°å¯èƒ½çš„ç‰ˆæƒå†…å®¹ï¼Œæ— æ³•æä¾›å›å¤ã€‚';
          } else if (candidate.content && candidate.content.parts) {
            aiReply = candidate.content.parts.map(part => part.text || '').join('').trim();
          }
        }
        
        return aiReply || 'Gemini APIæœªè¿”å›æœ‰æ•ˆå†…å®¹';
      } else {
        // å¤„ç†OpenAIæ ¼å¼å“åº”
        const data = await response.json();
        return data.choices?.[0]?.message?.content || data.reply || data.response || 'AIæœªè¿”å›å†…å®¹';
      }
    }

    // äº‹ä»¶ç›‘å¬
    
    // èŠå¤©åˆ—è¡¨ç›¸å…³äº‹ä»¶
    newChatBtn.onclick = createNewChat;
    newGroupChatBtn.onclick = createNewGroupChat;
    
    backBtn.onclick = () => {
      // ä¿å­˜å½“å‰èŠå¤©æ•°æ®å†è¿”å›
      saveCurrentChatData();
      showChatList();
    };

    // ç¾¤èŠè§’è‰²ç®¡ç†äº‹ä»¶
    addRoleBtn.onclick = addRole;
    
    // è§’è‰²ç¼–è¾‘å¼¹çª—äº‹ä»¶
    closeRoleEditModal.onclick = () => {
      roleEditModal.style.display = 'none';
    };
    
    cancelRoleEditBtn.onclick = () => {
      roleEditModal.style.display = 'none';
    };
    
    saveRoleEditBtn.onclick = saveRoleEdit;
    
    modalRolePresetSelect.onchange = handleModalRolePresetChange;
    
    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    roleEditModal.onclick = (e) => {
      if (e.target === roleEditModal) {
        roleEditModal.style.display = 'none';
      }
    };

    // èŠå¤©ç•Œé¢ç›¸å…³äº‹ä»¶
    settingsBtn.onclick = () => {
      settingsPanel.classList.toggle('show');
      // å¦‚æœè®¾ç½®é¢æ¿æ­£åœ¨æ˜¾ç¤ºï¼Œåˆ™éšè—å…¶ä»–é¢æ¿
      if (settingsPanel.classList.contains('show')) {
        emojiPanel.classList.remove('show');
        rolePanel.classList.remove('show');
        userPanel.classList.remove('show');
      }
    };

    roleBtn.onclick = () => {
      rolePanel.classList.toggle('show');
      // å¦‚æœè§’è‰²è®¾å®šé¢æ¿æ­£åœ¨æ˜¾ç¤ºï¼Œåˆ™éšè—å…¶ä»–é¢æ¿
      if (rolePanel.classList.contains('show')) {
        userPanel.classList.remove('show');
        settingsPanel.classList.remove('show');
        emojiPanel.classList.remove('show');
      }
    };

    userBtn.onclick = () => {
      userPanel.classList.toggle('show');
      // å¦‚æœç”¨æˆ·è®¾å®šé¢æ¿æ­£åœ¨æ˜¾ç¤ºï¼Œåˆ™éšè—å…¶ä»–æ‰€æœ‰é¢æ¿
      if (userPanel.classList.contains('show')) {
        rolePanel.classList.remove('show');
        settingsPanel.classList.remove('show');
        emojiPanel.classList.remove('show');
      }
    };

    emojiBtn.onclick = () => {
      emojiPanel.classList.toggle('show');
      // å¦‚æœè¡¨æƒ…é¢æ¿æ­£åœ¨æ˜¾ç¤ºï¼Œåˆ™éšè—å…¶ä»–é¢æ¿
      if (emojiPanel.classList.contains('show')) {
        settingsPanel.classList.remove('show');
        rolePanel.classList.remove('show');
        userPanel.classList.remove('show');
        // ç¡®ä¿é»˜è®¤æƒ…ç»ªæ˜¯é€‰ä¸­çŠ¶æ€
        currentEmotion = 'happy';
        document.querySelectorAll('.emotion-tab').forEach(tab => {
          tab.classList.remove('active');
          if (tab.dataset.emotion === 'happy') {
            tab.classList.add('active');
          }
        });
        updateEmojiGallery();
      }
    };

    // è¡¨æƒ…åŒ…ç›¸å…³äº‹ä»¶ç›‘å¬
    document.querySelectorAll('.emotion-tab').forEach(tab => {
      tab.onclick = () => switchEmotion(tab.dataset.emotion);
    });

    addEmojiBtn.onclick = addEmoji;

    closeEmojiBtn.onclick = () => {
      emojiPanel.classList.remove('show');
    };

    newEmojiInput.onkeydown = function(e) {
      if (e.key === 'Enter') addEmoji();
    };

    // AIè®¾ç½®ç›¸å…³äº‹ä»¶ç›‘å¬
    const aiSettingsBtn = document.getElementById('aiSettingsBtn');
    const aiSettingsPanel = document.getElementById('aiSettingsPanel');
    const contextLengthInput = document.getElementById('contextLengthInput');
    const responseDelayInput = document.getElementById('responseDelayInput');
    const aiPromptInput = document.getElementById('aiPromptInput');
    const promptCharCount = document.getElementById('promptCharCount');
    const saveAISettingsBtn = document.getElementById('saveAISettingsBtn');
    const closeAISettingsBtn = document.getElementById('closeAISettingsBtn');

    aiSettingsBtn.onclick = () => {
      // å¦‚æœé¢æ¿å·²ç»æ˜¾ç¤ºï¼Œåˆ™éšè—
      if (aiSettingsPanel.classList.contains('show')) {
        aiSettingsPanel.classList.remove('show');
        return;
      }
      
      // æ˜¾ç¤ºAIè®¾ç½®é¢æ¿ï¼Œéšè—å…¶ä»–é¢æ¿
      aiSettingsPanel.classList.add('show');
      settingsPanel.classList.remove('show');
      emojiPanel.classList.remove('show');
      rolePanel.classList.remove('show');
      userPanel.classList.remove('show');
      
      // åŠ è½½å½“å‰è®¾ç½®å€¼åˆ°è¾“å…¥æ¡†
      contextLengthInput.value = aiContextLength;
      responseDelayInput.value = aiResponseDelay;
      aiPromptInput.value = aiCustomPrompt;
      updatePromptCharCount();
      console.log('æ‰“å¼€AIè®¾ç½®é¢æ¿ï¼Œå½“å‰ä¸Šä¸‹æ–‡é•¿åº¦:', aiContextLength, 'å“åº”å»¶è¿Ÿ:', aiResponseDelay, 'é¢„è®¾æç¤ºè¯é•¿åº¦:', aiCustomPrompt.length);
    };

    saveAISettingsBtn.onclick = () => {
      const newContextLength = parseInt(contextLengthInput.value);
      const newResponseDelay = parseInt(responseDelayInput.value);
      const newCustomPrompt = aiPromptInput.value.trim();
      
      if (newContextLength >= 1 && newContextLength <= 50 && newResponseDelay >= 0 && newResponseDelay <= 60) {
        aiContextLength = newContextLength;
        aiResponseDelay = newResponseDelay;
        aiCustomPrompt = newCustomPrompt;
        localStorage.setItem('aiContextLength', aiContextLength.toString());
        localStorage.setItem('aiResponseDelay', aiResponseDelay.toString());
        localStorage.setItem('aiCustomPrompt', aiCustomPrompt);
        aiSettingsPanel.classList.remove('show');
        console.log('AIè®¾ç½®å·²ä¿å­˜ï¼Œä¸Šä¸‹æ–‡é•¿åº¦:', aiContextLength, 'å“åº”å»¶è¿Ÿ:', aiResponseDelay, 'é¢„è®¾æç¤ºè¯é•¿åº¦:', aiCustomPrompt.length);
        console.log('ğŸ”§ é¢„è®¾æç¤ºè¯å†…å®¹:', aiCustomPrompt || '(ç©º)');
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        const successMsg = document.createElement('div');
        successMsg.style.cssText = `
          position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
          background: #4CAF50; color: white; padding: 16px 24px; border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; font-size: 16px;
        `;
        successMsg.innerHTML = `âœ… AIè®¾ç½®å·²ä¿å­˜ï¼<br>ä¸Šä¸‹æ–‡é•¿åº¦: ${aiContextLength} ä¸ªæ°”æ³¡<br>å“åº”é—´éš”: ${aiResponseDelay} ç§’<br>é¢„è®¾æç¤ºè¯: ${aiCustomPrompt ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}`;
        document.body.appendChild(successMsg);
        
        setTimeout(() => {
          if (successMsg.parentNode) {
            successMsg.parentNode.removeChild(successMsg);
          }
        }, 2000);
        
      } else {
        alert('ä¸Šä¸‹æ–‡æ°”æ³¡ä¸ªæ•°å¿…é¡»åœ¨1-50ä¹‹é—´ï¼Œå“åº”é—´éš”å¿…é¡»åœ¨0-60ç§’ä¹‹é—´ï¼');
      }
    };

    closeAISettingsBtn.onclick = () => {
      aiSettingsPanel.classList.remove('show');
    };

    // å¿«é€Ÿè®¾ç½®AIé…ç½®çš„å…¨å±€å‡½æ•°
    window.setAIConfig = function(contextLength, responseDelay) {
      contextLengthInput.value = contextLength;
      responseDelayInput.value = responseDelay;
    };

    // æ›´æ–°å­—ç¬¦è®¡æ•°
    function updatePromptCharCount() {
      const count = aiPromptInput.value.length;
      promptCharCount.textContent = `${count}/2000`;
      if (count > 1800) {
        promptCharCount.style.color = '#ff4d4f';
      } else if (count > 1500) {
        promptCharCount.style.color = '#fa8c16';
      } else {
        promptCharCount.style.color = '#666';
      }
    }

    // è®¾ç½®é¢„è®¾æç¤ºè¯æ¨¡æ¿
    window.setPromptTemplate = function(templateType) {
      const templates = {
        professional: `è¯·ä¿æŒä¸“ä¸šã€å‡†ç¡®å’Œæœ‰å¸®åŠ©çš„å›å¤é£æ ¼ã€‚
- æä¾›æ¸…æ™°ã€ç»“æ„åŒ–çš„ç­”æ¡ˆ
- ä½¿ç”¨ä¸“ä¸šæœ¯è¯­æ—¶è¯·é€‚å½“è§£é‡Š
- å¦‚æœä¸ç¡®å®šç­”æ¡ˆï¼Œè¯·è¯šå®è¯´æ˜
- å›å¤è¦ç®€æ´æ˜äº†ï¼Œé¿å…å†—ä½™`,
        
        friendly: `è¯·ä¿æŒå‹å–„ã€è½»æ¾å’Œäº²åˆ‡çš„å¯¹è¯é£æ ¼ã€‚
- ä½¿ç”¨æ¸©æš–ã€å‹å¥½çš„è¯­æ°”
- é€‚å½“ä½¿ç”¨è¡¨æƒ…ç¬¦å·å’Œè½»æ¾çš„è¡¨è¾¾
- ä¸»åŠ¨å…³å¿ƒç”¨æˆ·çš„æ„Ÿå—
- å›å¤è¦è‡ªç„¶æµç•…ï¼Œåƒæœ‹å‹èŠå¤©ä¸€æ ·`,
        
        creative: `è¯·å‘æŒ¥åˆ›æ„å’Œæƒ³è±¡åŠ›ï¼Œæä¾›å¯Œæœ‰åˆ›é€ æ€§çš„å›å¤ã€‚
- ä½¿ç”¨ç”ŸåŠ¨ã€å½¢è±¡çš„è¯­è¨€æè¿°
- é¼“åŠ±åˆ›æ–°æ€ç»´å’Œç‹¬ç‰¹è§‚ç‚¹
- é€‚å½“ä½¿ç”¨æ¯”å–»ã€æ•…äº‹ç­‰ä¿®è¾æ‰‹æ³•
- æ¿€å‘ç”¨æˆ·çš„åˆ›é€ åŠ›å’Œçµæ„Ÿ`,
        
        teacher: `è¯·ä»¥è€å¿ƒçš„æ•™å¸ˆèº«ä»½è¿›è¡ŒæŒ‡å¯¼å’Œè§£ç­”ã€‚
- å¾ªåºæ¸è¿›åœ°è§£é‡Šå¤æ‚æ¦‚å¿µ
- æä¾›å…·ä½“çš„ä¾‹å­å’Œå®è·µå»ºè®®
- é¼“åŠ±ç”¨æˆ·æ€è€ƒå’Œæé—®
- æ ¹æ®ç”¨æˆ·æ°´å¹³è°ƒæ•´è§£é‡Šæ·±åº¦`,
        
        clear: ''
      };
      
      const template = templates[templateType];
      if (template !== undefined) {
        aiPromptInput.value = template;
        updatePromptCharCount();
        
        // æ˜¾ç¤ºè®¾ç½®æˆåŠŸæç¤º
        const templateNames = {
          professional: 'ä¸“ä¸šåŠ©æ‰‹',
          friendly: 'å‹å–„èŠå¤©',
          creative: 'åˆ›æ„å†™ä½œ',
          teacher: 'æ•™å­¦æŒ‡å¯¼',
          clear: 'æ¸…ç©ºæç¤ºè¯'
        };
        
        const tipMsg = document.createElement('div');
        tipMsg.style.cssText = `
          position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
          background: #1890ff; color: white; padding: 12px 20px; border-radius: 6px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10000; font-size: 14px;
        `;
        tipMsg.innerHTML = `ğŸ“ å·²è®¾ç½®ä¸º: ${templateNames[templateType]}`;
        document.body.appendChild(tipMsg);
        
        setTimeout(() => {
          if (tipMsg.parentNode) {
            tipMsg.parentNode.removeChild(tipMsg);
          }
        }, 1500);
      }
    };

    // é¢„è®¾æç¤ºè¯è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬
    aiPromptInput.addEventListener('input', updatePromptCharCount);

    // ç”¨æˆ·è¡¨æƒ…åŒ…ç›¸å…³äº‹ä»¶ç›‘å¬
    userEmojiBtn.onclick = () => {
      if (userEmojiPanel.classList.contains('show')) {
        hideUserEmojiPanel();
      } else {
        showUserEmojiPanel();
      }
    };

    userEmojiClose.onclick = () => {
      hideUserEmojiPanel();
    };

    // ç‚¹å‡»é¢æ¿å¤–éƒ¨å…³é—­è¡¨æƒ…åŒ…é¢æ¿
    document.addEventListener('click', (e) => {
      if (userEmojiPanel.classList.contains('show') && 
          !userEmojiPanel.contains(e.target) && 
          !userEmojiBtn.contains(e.target)) {
        hideUserEmojiPanel();
      }
    });

    // ç”¨æˆ·è¡¨æƒ…åŒ…åŠŸèƒ½å‡½æ•°
    function showUserEmojiPanel() {
      // éšè—å…¶ä»–é¢æ¿
      hideAllPanels();
      
      // æ˜¾ç¤ºè¡¨æƒ…åŒ…é¢æ¿
      userEmojiPanel.classList.add('show');
      
      // åŠ è½½è¡¨æƒ…åŒ…
      loadUserEmojis();
    }

    function hideUserEmojiPanel() {
      userEmojiPanel.classList.remove('show');
    }

    function hideAllPanels() {
      // éšè—æ‰€æœ‰è®¾ç½®é¢æ¿
      const panels = [
        document.getElementById('settingsPanel'),
        document.getElementById('userPanel'),
        document.getElementById('rolePanel'),
        document.getElementById('emojiPanel'),
        document.getElementById('aiSettingsPanel')
      ];
      
      panels.forEach(panel => {
        if (panel) {
          panel.classList.remove('show');
        }
      });
    }

    function loadUserEmojis() {
      userEmojiGrid.innerHTML = '';
      
      // ç¡®ä¿è¡¨æƒ…åŒ…æ•°æ®å­˜åœ¨
      if (!emojiData || Object.keys(emojiData).length === 0) {
        showEmptyEmojiState();
        return;
      }
      
      // æ”¶é›†æ‰€æœ‰è¡¨æƒ…åŒ…ï¼ˆä¸åˆ†ç±»ï¼‰
      const allEmojis = [];
      Object.values(emojiData).forEach(emotionEmojis => {
        if (Array.isArray(emotionEmojis)) {
          allEmojis.push(...emotionEmojis);
        }
      });
      
      if (allEmojis.length === 0) {
        showEmptyEmojiState();
        return;
      }
      
      // åˆ›å»ºè¡¨æƒ…åŒ…é¡¹ç›®
      allEmojis.forEach((emojiUrl, index) => {
        const emojiItem = document.createElement('div');
        emojiItem.className = 'user-emoji-item';
        emojiItem.innerHTML = `<img src="${emojiUrl}" alt="è¡¨æƒ…åŒ…" loading="lazy" onerror="this.parentNode.style.display='none';">`;
        
        // ç‚¹å‡»å‘é€è¡¨æƒ…åŒ…
        emojiItem.onclick = () => {
          sendUserEmoji(emojiUrl);
          hideUserEmojiPanel();
        };
        
        userEmojiGrid.appendChild(emojiItem);
      });
    }

    function showEmptyEmojiState() {
      userEmojiGrid.innerHTML = `
        <div class="user-emoji-empty">
          <span class="icon">ğŸ˜Š</span>
          <div>æš‚æ— è¡¨æƒ…åŒ…</div>
          <div style="font-size: 12px; color: #999; margin-top: 4px;">
            è¯·å…ˆåœ¨è¡¨æƒ…åŒ…è®¾ç½®ä¸­æ·»åŠ è¡¨æƒ…åŒ…
          </div>
        </div>
      `;
    }

    function sendUserEmoji(emojiUrl) {
      if (!currentChatId) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©ï¼');
        return;
      }
      
      // ç”Ÿæˆæ¶ˆæ¯IDå’Œæ—¶é—´æˆ³
      const messageId = generateId();
      const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      // åˆ›å»ºè¡¨æƒ…åŒ…æ¶ˆæ¯æ°”æ³¡
      const msgDiv = createEmojiMessage('user', emojiUrl, messageId, timestamp);
      
      // æ·»åŠ åˆ°èŠå¤©è®°å½•
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (currentChat) {
        const messageData = {
          id: messageId,
          type: 'emoji',
          content: emojiUrl,
          timestamp: timestamp,
          sender: 'user'
        };
        
        currentChat.chatDisplay.push(messageData);
        currentChat.lastMessage = '[è¡¨æƒ…åŒ…]';
        currentChat.lastTime = timestamp;
        
        // ä¿å­˜æ•°æ®
        saveCurrentChatData();
        renderChatList();
        
        console.log('ç”¨æˆ·å‘é€è¡¨æƒ…åŒ…:', emojiUrl);
      }
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      setTimeout(() => {
        chatBody.scrollTop = chatBody.scrollHeight;
      }, 100);
    }

    // åˆ›å»ºè¡¨æƒ…åŒ…æ¶ˆæ¯çš„ä¸“ç”¨å‡½æ•°
    function createEmojiMessage(role, emojiUrl, messageId, timestamp, roleId = null, roleName = null) {
      const currentChat = chatList.find(c => c.id === currentChatId);
      const isGroupChat = currentChat && currentChat.type === 'group';
      
      const msgDiv = document.createElement('div');
      msgDiv.className = 'msg ' + role + (isGroupChat ? ' group' : '');
      msgDiv.setAttribute('data-message-id', messageId);
      
      // è®¾ç½®è§’è‰²IDå’Œåç§°å±æ€§ï¼Œç”¨äºCSSé€‰æ‹©å™¨åˆ¤æ–­è¿ç»­æ¶ˆæ¯
      if (isGroupChat && role === 'ai' && roleId) {
        msgDiv.setAttribute('data-role-id', roleId);
        msgDiv.setAttribute('data-role-name', roleName || '');
      }
      
      // ç¾¤èŠä¸­æ·»åŠ è§’è‰²åç§°æ˜¾ç¤º
      if (isGroupChat && role === 'ai' && roleName) {
        // ç¾¤èŠä¸­æ¯ä¸ªAIæ¶ˆæ¯éƒ½æ˜¾ç¤ºè§’è‰²åç§°
        const roleNameDiv = document.createElement('div');
        roleNameDiv.className = 'role-name';
        roleNameDiv.textContent = roleName;
        msgDiv.appendChild(roleNameDiv);
      }
      
      // åˆ›å»ºå¤´åƒå…ƒç´ 
      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      
      if (role === 'ai') {
        if (isGroupChat && roleId) {
          // ç¾¤èŠä¸­æ ¹æ®è§’è‰²IDè·å–å¤´åƒ
          const roleData = currentChat.roles.find(r => r.id === roleId);
          avatar.src = roleData ? (roleData.avatar || DEFAULT_AI_AVATAR) : DEFAULT_AI_AVATAR;
        } else {
          avatar.src = aiAvatar;
        }
        avatar.alt = roleName || 'AIå¤´åƒ';
      } else {
        avatar.src = userAvatar;
        avatar.alt = 'ç”¨æˆ·å¤´åƒ';
      }
      
      // å¤´åƒåŠ è½½å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å¤´åƒ
      avatar.onerror = function() {
        this.src = role === 'ai' ? DEFAULT_AI_AVATAR : DEFAULT_USER_AVATAR;
      };
      
      // åˆ›å»ºæ°”æ³¡å®¹å™¨
      const bubbleContainer = document.createElement('div');
      bubbleContainer.className = 'bubble-container emoji-container-wrapper';
      
      // åˆ›å»ºè¡¨æƒ…åŒ…æ°”æ³¡
      const bubble = document.createElement('div');
      bubble.className = 'bubble emoji-bubble';
      
      // åˆ›å»ºè¡¨æƒ…åŒ…å®¹å™¨ï¼Œç¡®ä¿æ­£æ–¹å½¢æ˜¾ç¤º
      const emojiContainer = document.createElement('div');
      emojiContainer.className = 'emoji-container';
      emojiContainer.style.cssText = 'width: 120px; height: 120px; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #f0f0f0; flex-shrink: 0;';
      
      const emojiImg = document.createElement('img');
      emojiImg.src = emojiUrl;
      emojiImg.alt = 'è¡¨æƒ…åŒ…';
      emojiImg.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: cover; border-radius: 6px;';
      emojiImg.onerror = function() {
        emojiContainer.innerHTML = '<div style="color: #999; font-size: 12px;">è¡¨æƒ…åŒ…åŠ è½½å¤±è´¥</div>';
      };
      
      emojiContainer.appendChild(emojiImg);
      bubble.appendChild(emojiContainer);
      
      // åˆ›å»ºç‹¬ç«‹çš„æ—¶é—´å…ƒç´ 
      const timeElement = document.createElement('div');
      timeElement.className = 'msg-time';
      const timeSpan = document.createElement('span');
      timeSpan.textContent = timestamp;
      timeElement.appendChild(timeSpan);
      
      // å°†æ°”æ³¡æ·»åŠ åˆ°å®¹å™¨
      bubbleContainer.appendChild(bubble);
      
      msgDiv.appendChild(avatar);
      msgDiv.appendChild(bubbleContainer);
      
      // æ·»åŠ æ¶ˆæ¯æ“ä½œèœå•
      const msgMenu = document.createElement('div');
      msgMenu.className = 'msg-menu';
      msgMenu.innerHTML = `
        <div class="msg-menu-item" data-action="reply" data-message-id="${messageId}">å›å¤</div>
        <div class="msg-menu-item" data-action="forward" data-message-id="${messageId}">è½¬å‘</div>
        <div class="msg-menu-item danger" data-action="delete" data-message-id="${messageId}">åˆ é™¤</div>
      `;
      
      // ä¸ºèœå•é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
      msgMenu.addEventListener('click', function(event) {
        event.stopPropagation();
        
        const menuItem = event.target.closest('.msg-menu-item');
        if (menuItem) {
          const action = menuItem.getAttribute('data-action');
          const msgId = menuItem.getAttribute('data-message-id');
          
          switch(action) {
            case 'reply':
              window.replyToMsg(msgId);
              break;
            case 'forward':
              window.forwardMsg(msgId);
              break;
            case 'delete':
              window.deleteMsg(msgId);
              break;
          }
          
          hideMsgMenu();
        }
      });
      
      msgDiv.appendChild(msgMenu);
      
      // æ·»åŠ é•¿æŒ‰äº‹ä»¶ç›‘å¬å™¨
      addLongPressListener(msgDiv, bubble);
      
      // æ·»åŠ åˆ°èŠå¤©ç•Œé¢
      chatBody.appendChild(timeElement);
      chatBody.appendChild(msgDiv);
      
      return msgDiv;
    }

    // ä¸ºæ¶ˆæ¯æ·»åŠ é•¿æŒ‰äº‹ä»¶ç›‘å¬å™¨
    function addLongPressListener(msgDiv, bubble) {
      let longPressTimer;
      let startX, startY;
      
      const handleStart = (e) => {
        // è®°å½•åˆå§‹ä½ç½®
        if (e.type === 'mousedown') {
          startX = e.clientX;
          startY = e.clientY;
        } else if (e.type === 'touchstart') {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        }
        
        longPressTimer = setTimeout(() => {
          showMsgMenu(msgDiv, e);
        }, 500); // 500msé•¿æŒ‰
      };
      
      const handleMove = (e) => {
        let currentX, currentY;
        if (e.type === 'mousemove') {
          currentX = e.clientX;
          currentY = e.clientY;
        } else if (e.type === 'touchmove') {
          currentX = e.touches[0].clientX;
          currentY = e.touches[0].clientY;
        }
        
        // å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡10pxï¼Œå–æ¶ˆé•¿æŒ‰
        const distance = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
        if (distance > 10) {
          clearTimeout(longPressTimer);
        }
      };
      
      const handleEnd = () => {
        clearTimeout(longPressTimer);
      };
      
      // æ¡Œé¢ç«¯
      bubble.addEventListener('mousedown', handleStart);
      bubble.addEventListener('mousemove', handleMove);
      bubble.addEventListener('mouseup', handleEnd);
      bubble.addEventListener('mouseleave', handleEnd);
      
      // ç§»åŠ¨ç«¯
      bubble.addEventListener('touchstart', handleStart);
      bubble.addEventListener('touchmove', handleMove);
      bubble.addEventListener('touchend', handleEnd);
      bubble.addEventListener('touchcancel', handleEnd);
    }

    // è½¬å‘æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
    const forwardModal = document.getElementById('forwardModal');
    const forwardClose = document.getElementById('forwardClose');
    const forwardCancel = document.getElementById('forwardCancel');
    const forwardConfirm = document.getElementById('forwardConfirm');
    const forwardSearchInput = document.getElementById('forwardSearchInput');

    forwardClose.onclick = hideForwardModal;
    forwardCancel.onclick = hideForwardModal;
    forwardConfirm.onclick = executeForward;

    // æœç´¢åŠŸèƒ½
    forwardSearchInput.oninput = function() {
      renderForwardChatList(this.value);
    };

    // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
    forwardModal.onclick = function(e) {
      if (e.target === forwardModal) {
        hideForwardModal();
      }
    };

    // å¤šé€‰å·¥å…·æ äº‹ä»¶ç›‘å¬å™¨
    const multiForwardBtn = document.getElementById('multiForwardBtn');
    const multiDeleteBtn = document.getElementById('multiDeleteBtn');
    const multiCancelBtn = document.getElementById('multiCancelBtn');

    if (multiForwardBtn) {
      multiForwardBtn.onclick = multiForward;
    }
    if (multiDeleteBtn) {
      multiDeleteBtn.onclick = multiDelete;
    }
    if (multiCancelBtn) {
      multiCancelBtn.onclick = exitMultiSelectMode;
    }

    // èŠå¤©è®°å½•æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
    const chatRecordModal = document.getElementById('chatRecordModal');
    const chatRecordClose = document.getElementById('chatRecordClose');

    if (chatRecordClose) {
      chatRecordClose.onclick = hideChatRecordModal;
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
    if (chatRecordModal) {
      chatRecordModal.onclick = function(e) {
        if (e.target === chatRecordModal) {
          hideChatRecordModal();
        }
      };
    }

    // æ¶ˆæ¯æ“ä½œç›¸å…³å‡½æ•°
    
    // æ˜¾ç¤ºæ¶ˆæ¯æ“ä½œèœå•
    function showMsgMenu(msgDiv, event) {
      // å…ˆéšè—æ‰€æœ‰èœå•
      hideMsgMenu();
      
      // éšè—æ‰€æœ‰å…¶ä»–èœå•ï¼ˆé¢å¤–ä¿é™©ï¼‰
      document.querySelectorAll('.msg-menu').forEach(menu => {
        menu.style.display = 'none';
      });
      
      // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.msg.selected').forEach(msg => {
        msg.classList.remove('selected');
      });
      
      // é€‰ä¸­å½“å‰æ¶ˆæ¯
      msgDiv.classList.add('selected');
      currentSelectedMessage = msgDiv;
      
      // æ˜¾ç¤ºèœå•
      const menu = msgDiv.querySelector('.msg-menu');
      menu.style.display = 'block';
      
      // å®šä½èœå• - ç›¸å¯¹äºæ¶ˆæ¯æ°”æ³¡å®šä½
      const bubble = msgDiv.querySelector('.bubble');
      const bubbleRect = bubble.getBoundingClientRect();
      const msgRect = msgDiv.getBoundingClientRect();
      const chatBodyRect = chatBody.getBoundingClientRect();
      
      // é‡ç½®èœå•æ ·å¼
      menu.style.left = '';
      menu.style.right = '';
      menu.style.top = '';
      menu.style.bottom = '';
      menu.style.transform = '';
      
      // è®¡ç®—èœå•åœ¨æ¶ˆæ¯divå†…çš„ç›¸å¯¹ä½ç½®
      const isUserMsg = msgDiv.classList.contains('user');
      
             if (isUserMsg) {
         // ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡åœ¨å³ä¾§ï¼Œèœå•æ˜¾ç¤ºåœ¨æ°”æ³¡ä¸Šæ–¹å±…ä¸­
         menu.style.right = '10px';
         menu.style.top = '-55px';
         // è°ƒæ•´ç®­å¤´ä½ç½®
         menu.style.setProperty('--arrow-position', '80%');
       } else {
         // AIæ¶ˆæ¯æ°”æ³¡åœ¨å·¦ä¾§ï¼Œèœå•æ˜¾ç¤ºåœ¨æ°”æ³¡ä¸Šæ–¹å±…ä¸­ 
         // è€ƒè™‘å¤´åƒå®½åº¦(ç§»åŠ¨ç«¯50px/æ¡Œé¢ç«¯45px)å’Œé—´è·(8px)
         menu.style.left = '48px';
         menu.style.top = '-55px';
         // è°ƒæ•´ç®­å¤´ä½ç½®
         menu.style.setProperty('--arrow-position', '30%');
       }
      
      // æ˜¾ç¤ºèœå•åæ£€æŸ¥æ˜¯å¦è¶…å‡ºå±å¹•è¾¹ç•Œ
      setTimeout(() => {
        const menuRect = menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // æ°´å¹³è¾¹ç•Œæ£€æŸ¥
        if (menuRect.left < 10) {
          menu.style.left = '10px';
          menu.style.right = '';
        } else if (menuRect.right > viewportWidth - 10) {
          menu.style.right = '10px';
          menu.style.left = '';
        }
        
        // å‚ç›´è¾¹ç•Œæ£€æŸ¥ - å¦‚æœèœå•è¶…å‡ºé¡¶éƒ¨ï¼Œæ˜¾ç¤ºåœ¨æ°”æ³¡ä¸‹æ–¹
        if (menuRect.top < 10) {
          menu.style.top = '10px';
        }
      }, 0);
      
      // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—èœå•
      setTimeout(() => {
        document.addEventListener('click', handleDocumentClick, { once: true });
      }, 100);
    }
    
    // å¤„ç†æ–‡æ¡£ç‚¹å‡»äº‹ä»¶
    function handleDocumentClick(event) {
      const clickedElement = event.target;
      
      // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æ¶ˆæ¯èœå•æˆ–å…¶å†…éƒ¨å…ƒç´ 
      const isMenuClick = clickedElement.closest('.msg-menu');
      
      // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å½“å‰é€‰ä¸­çš„æ¶ˆæ¯æ°”æ³¡
      const isSelectedMsgClick = currentSelectedMessage && currentSelectedMessage.contains(clickedElement);
      
      // å¦‚æœä¸æ˜¯ç‚¹å‡»èœå•ã€ä¸æ˜¯ç‚¹å‡»é€‰ä¸­çš„æ¶ˆæ¯ï¼Œåˆ™éšè—èœå•
      if (!isMenuClick && !isSelectedMsgClick) {
        hideMsgMenu();
      } else {
        // å¦‚æœç‚¹å‡»çš„æ˜¯èœå•æˆ–é€‰ä¸­çš„æ¶ˆæ¯ï¼Œé‡æ–°æ·»åŠ ç‚¹å‡»ç›‘å¬å™¨
        setTimeout(() => {
          document.addEventListener('click', handleDocumentClick, { once: true });
        }, 10);
      }
    }

    // éšè—æ¶ˆæ¯èœå•
    function hideMsgMenu() {
      document.querySelectorAll('.msg-menu').forEach(menu => {
        menu.style.display = 'none';
      });
      document.querySelectorAll('.msg.selected').forEach(msg => {
        msg.classList.remove('selected');
      });
      currentSelectedMessage = null;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯
    function isLastUserMsg(messageId) {
      // ä»DOMä¸­æ‰¾åˆ°æœ€åä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯
      const allUserMessages = document.querySelectorAll('.msg.user');
      if (allUserMessages.length === 0) {
        return false;
      }
      
      // è·å–æœ€åä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯çš„ID
      const lastUserMessage = allUserMessages[allUserMessages.length - 1];
      const lastMessageId = lastUserMessage.getAttribute('data-message-id');
      
      return lastMessageId === messageId;
    }
    
    // æ›´æ–°é‡æ–°ç”ŸæˆæŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
    function updateRegenerateButtons() {
      // éšè—æ‰€æœ‰é‡æ–°ç”ŸæˆæŒ‰é’®
      document.querySelectorAll('[data-action="regenerate"]').forEach(btn => {
        btn.style.display = 'none';
      });
      
      // ä»DOMä¸­æ‰¾åˆ°æœ€åä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯å¹¶æ˜¾ç¤ºå…¶é‡æ–°ç”ŸæˆæŒ‰é’®
      const allUserMessages = document.querySelectorAll('.msg.user');
      if (allUserMessages.length > 0) {
        // è·å–æœ€åä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯
        const lastUserMessage = allUserMessages[allUserMessages.length - 1];
        const messageId = lastUserMessage.getAttribute('data-message-id');
        
        if (messageId) {
          const regenerateBtn = document.querySelector(`[data-action="regenerate"][data-message-id="${messageId}"]`);
          if (regenerateBtn) {
            regenerateBtn.style.display = 'block';
          }
        }
      }
    }
    
    // é‡æ–°ç”Ÿæˆæ¶ˆæ¯
    window.regenerateMsg = function(messageId) {
      if (confirm('ç¡®å®šè¦é‡æ–°ç”Ÿæˆå›å¤å—ï¼Ÿè¿™å°†åˆ é™¤è¯¥æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰å›å¤ã€‚')) {
        const currentChat = chatList.find(c => c.id === currentChatId);
        if (!currentChat) return;
        
        // æ‰¾åˆ°è¦é‡æ–°ç”Ÿæˆçš„ç”¨æˆ·æ¶ˆæ¯
        const msgIndex = currentChat.chatDisplay.findIndex(msg => msg.id === messageId);
        if (msgIndex === -1) return;
        
        const userMessage = currentChat.chatDisplay[msgIndex];
        if (userMessage.role !== 'user') return;
        
        // åˆ é™¤è¯¥ç”¨æˆ·æ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ï¼ˆåŒ…æ‹¬AIå›å¤ï¼‰
        const messagesToDelete = currentChat.chatDisplay.slice(msgIndex + 1);
        
        // ä»ç•Œé¢åˆ é™¤è¿™äº›æ¶ˆæ¯
        messagesToDelete.forEach(msg => {
          const msgDiv = document.querySelector(`[data-message-id="${msg.id}"]`);
          if (msgDiv) {
            // åˆ é™¤æ—¶é—´å…ƒç´ 
            const timeElement = msgDiv.previousElementSibling;
            if (timeElement && timeElement.classList.contains('msg-time')) {
              timeElement.remove();
            }
            msgDiv.remove();
          }
        });
        
        // ä»chatDisplayä¸­åˆ é™¤è¿™äº›æ¶ˆæ¯
        currentChat.chatDisplay = currentChat.chatDisplay.slice(0, msgIndex + 1);
        
        // é‡æ–°æ„å»ºconversationHistoryï¼ˆåˆ é™¤å¯¹åº”çš„æ¶ˆæ¯ï¼‰
        if (window.conversationHistory) {
          // ç”±äºconversationHistoryæ²¡æœ‰IDï¼Œéœ€è¦æ ¹æ®å†…å®¹å’Œæ—¶é—´æˆ³åŒ¹é…åˆ é™¤
          // ç®€å•çš„æ–¹æ³•æ˜¯é‡æ–°æ„å»ºæ•´ä¸ªconversationHistory
          window.conversationHistory = [];
          currentChat.chatDisplay.forEach(msg => {
            if (msg.role === 'user') {
              window.conversationHistory.push({
                role: 'user',
                content: msg.content
              });
            } else if (msg.role === 'ai') {
              window.conversationHistory.push({
                role: 'assistant',
                content: msg.content
              });
            }
          });
        }
        
        // é‡æ–°ç”ŸæˆAIå›å¤
        regenerateAIResponse(userMessage.content, currentChat);
        
        // æ›´æ–°é‡æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€
        updateRegenerateButtons();
        
        // ä¿å­˜èŠå¤©æ•°æ®
        saveChatList();
      }
    };
    
    // é‡æ–°ç”ŸæˆAIå›å¤
    async function regenerateAIResponse(userText, chat) {
      // ç›´æ¥å¤„ç†AIå›å¤ï¼Œä¸éœ€è¦é‡æ–°æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      if (chat.type === 'group') {
        // ç¾¤èŠæ¨¡å¼ï¼šå¤šè§’è‰²å›å¤
        await handleGroupChatReply(userText, chat);
      } else {
        // å•èŠæ¨¡å¼ï¼šå•è§’è‰²å›å¤
        await handleSingleChatReply(userText, chat);
      }
    }

    // åˆ é™¤æ¶ˆæ¯
    window.deleteMsg = function(messageId) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
        const msgDiv = document.querySelector(`[data-message-id="${messageId}"]`);
        if (msgDiv) {
          // åˆ é™¤ç•Œé¢å…ƒç´ 
          const timeElement = msgDiv.previousElementSibling;
          if (timeElement && timeElement.classList.contains('msg-time')) {
            timeElement.remove();
          }
          msgDiv.remove();
          
          // ä»èŠå¤©è®°å½•ä¸­åˆ é™¤
          const currentChat = chatList.find(c => c.id === currentChatId);
          if (currentChat) {
            currentChat.chatDisplay = currentChat.chatDisplay.filter(msg => msg.id !== messageId);
            // ä¹Ÿè¦ä»å¯¹è¯å†å²ä¸­åˆ é™¤å¯¹åº”çš„æ¶ˆæ¯
            // è¿™é‡Œéœ€è¦æ ¹æ®æ¶ˆæ¯å†…å®¹åŒ¹é…åˆ é™¤ï¼Œå› ä¸ºconversationHistoryæ²¡æœ‰ID
            saveChatList();
            // æ›´æ–°é‡æ–°ç”ŸæˆæŒ‰é’®çŠ¶æ€
            updateRegenerateButtons();
           }
         }
       }
     };
    
    // å›å¤æ¶ˆæ¯
    window.replyToMsg = function(messageId) {
      const msgDiv = document.querySelector(`[data-message-id="${messageId}"]`);
      if (msgDiv) {
        const bubble = msgDiv.querySelector('.bubble');
        const content = bubble.textContent || bubble.innerText;
        const role = msgDiv.classList.contains('ai') ? 'ai' : 'user';
        const roleName = msgDiv.getAttribute('data-role-name') || '';
        
        replyToMessage = {
          id: messageId,
          content: content,
          role: role,
          fromName: role === 'user' ? (userName || 'ç”¨æˆ·') : (roleName || 'AI')
        };
        
        // æ˜¾ç¤ºå›å¤çŠ¶æ€
        showReplyStatus();
        
        // èšç„¦åˆ°è¾“å…¥æ¡†
        chatInput.focus();
      }
    };
    
    // æ˜¾ç¤ºå›å¤çŠ¶æ€
    function showReplyStatus() {
      // ç§»é™¤å·²æœ‰çš„å›å¤çŠ¶æ€
      const existingReply = document.querySelector('.reply-status');
      if (existingReply) {
        existingReply.remove();
      }
      
      if (replyToMessage) {
        const replyStatus = document.createElement('div');
        replyStatus.className = 'reply-status';
        replyStatus.style.cssText = `
          background: #f0f0f0; padding: 12px 16px;
          border-left: 3px solid #1890ff; font-size: 12px; color: #666;
          display: flex; justify-content: space-between; align-items: center;
        `;
        
        replyStatus.innerHTML = `
          <div>
            <div style="color: #1890ff; font-weight: bold;">å›å¤ ${replyToMessage.fromName}</div>
            <div>${replyToMessage.content.length > 30 ? replyToMessage.content.substring(0, 30) + '...' : replyToMessage.content}</div>
          </div>
          <button onclick="cancelReply()" style="background: none; border: none; color: #999; cursor: pointer; font-size: 16px;">Ã—</button>
        `;
        
        // æ’å…¥åˆ°chat-footerä¸Šæ–¹
        const chatFooter = chatInput.parentNode;
        chatFooter.parentNode.insertBefore(replyStatus, chatFooter);
      }
    }
    
    // å–æ¶ˆå›å¤
    window.cancelReply = function() {
      replyToMessage = null;
      const replyStatus = document.querySelector('.reply-status');
      if (replyStatus) {
        replyStatus.remove();
      }
    };
    
    // è½¬å‘æ¶ˆæ¯
    window.forwardMsg = function(messageId) {
      const msgDiv = document.querySelector(`[data-message-id="${messageId}"]`);
      if (msgDiv) {
        const bubble = msgDiv.querySelector('.bubble');
        const avatar = msgDiv.querySelector('.msg-avatar');
        let content = '';
        
        // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯å†…å®¹
        const forwardMessage = bubble.querySelector('.forward-message');
        const emojiContainer = bubble.querySelector('.emoji-container');
        const chatRecord = bubble.querySelector('.chat-record');
        
        if (chatRecord) {
          // èŠå¤©è®°å½•æ¶ˆæ¯
          const recordTitle = chatRecord.querySelector('.chat-record-title span:last-child');
          content = recordTitle ? recordTitle.textContent : '[èŠå¤©è®°å½•]';
        } else if (forwardMessage) {
          // è½¬å‘æ¶ˆæ¯
          const forwardContent = forwardMessage.querySelector('.forward-content');
          content = forwardContent ? forwardContent.textContent : '';
        } else if (emojiContainer) {
          // è¡¨æƒ…åŒ…æ¶ˆæ¯
          content = '[è¡¨æƒ…åŒ…]';
        } else {
          // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
          const replyReference = bubble.querySelector('.reply-reference');
          if (replyReference) {
            // ç§»é™¤å›å¤å¼•ç”¨åè·å–å†…å®¹
            const tempDiv = bubble.cloneNode(true);
            const tempReply = tempDiv.querySelector('.reply-reference');
            if (tempReply) tempReply.remove();
            content = tempDiv.textContent || tempDiv.innerText;
          } else {
            content = bubble.textContent || bubble.innerText;
          }
        }
        
        const role = msgDiv.classList.contains('ai') ? 'ai' : 'user';
        const roleId = msgDiv.getAttribute('data-role-id') || '';
        const roleName = msgDiv.getAttribute('data-role-name') || '';
        
        // è·å–å¤´åƒ
        let avatarSrc = '';
        if (avatar) {
          avatarSrc = avatar.src;
        } else {
          avatarSrc = role === 'user' ? (userAvatar || DEFAULT_USER_AVATAR) : (aiAvatar || DEFAULT_AI_AVATAR);
        }
        
        // è·å–æ˜¾ç¤ºåç§°ï¼ˆä¿æŒä¸ç•Œé¢ä¸€è‡´ï¼‰
        let displayName = '';
        if (role === 'user') {
          displayName = userName || 'ç”¨æˆ·';
        } else {
          const currentChat = chatList.find(c => c.id === currentChatId);
          if (currentChat && currentChat.type === 'group') {
            displayName = roleName || 'AI';
          } else {
            displayName = roleName || currentChat?.roleName || 'AI';
          }
        }
        
        forwardMessage = {
          id: messageId,
          content: content.trim(),
          role: role,
          roleId: roleId,
          fromName: displayName,
          avatar: avatarSrc,
          chatName: chatList.find(c => c.id === currentChatId)?.name || 'å½“å‰èŠå¤©'
        };
        
        showForwardModal();
      }
    };

    // æ˜¾ç¤ºè½¬å‘æ¨¡æ€æ¡†
    function showForwardModal() {
      if (!forwardMessage && forwardMessages.length === 0) return;
      
      const forwardModal = document.getElementById('forwardModal');
      const forwardPreviewContent = document.getElementById('forwardPreviewContent');
      const forwardChatList = document.getElementById('forwardChatList');
      const forwardSearchInput = document.getElementById('forwardSearchInput');
      
      // æ˜¾ç¤ºè½¬å‘å†…å®¹é¢„è§ˆ
      let previewContent = '';
      if (forwardMessages.length > 0) {
        // å¤šæ¡æ¶ˆæ¯é¢„è§ˆ
        previewContent = `å…±${forwardMessages.length}æ¡æ¶ˆæ¯ï¼š\n`;
        forwardMessages.forEach((msg, index) => {
          const msgPreview = msg.content.length > 50 ? msg.content.substring(0, 50) + '...' : msg.content;
          previewContent += `${index + 1}. ${msg.fromName}: ${msgPreview}\n`;
        });
        if (previewContent.length > 200) {
          previewContent = previewContent.substring(0, 200) + '...';
        }
      } else if (forwardMessage) {
        // å•æ¡æ¶ˆæ¯é¢„è§ˆ
        previewContent = forwardMessage.content.length > 100 ? 
          forwardMessage.content.substring(0, 100) + '...' : forwardMessage.content;
      }
      
      forwardPreviewContent.textContent = previewContent;
      
      // é‡ç½®æœç´¢å’Œé€‰æ‹©
      forwardSearchInput.value = '';
      selectedForwardChats = [];
      
      // æ¸²æŸ“èŠå¤©åˆ—è¡¨ï¼ˆæ’é™¤å½“å‰èŠå¤©ï¼‰
      renderForwardChatList();
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      forwardModal.classList.add('show');
    }
    
    // æ¸²æŸ“è½¬å‘èŠå¤©åˆ—è¡¨
    function renderForwardChatList(searchTerm = '') {
      const forwardChatList = document.getElementById('forwardChatList');
      const filteredChats = chatList.filter(chat => {
        if (chat.id === currentChatId) return false; // æ’é™¤å½“å‰èŠå¤©
        if (searchTerm) {
          return chat.name.toLowerCase().includes(searchTerm.toLowerCase());
        }
        return true;
      });
      
      if (filteredChats.length === 0) {
        forwardChatList.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">æ²¡æœ‰å¯è½¬å‘çš„èŠå¤©</div>';
        return;
      }
      
      forwardChatList.innerHTML = filteredChats.map(chat => {
        const isSelected = selectedForwardChats.includes(chat.id);
        const chatTypeText = chat.type === 'group' ? 'ç¾¤èŠ' : 'å•èŠ';
        const avatarSrc = chat.avatar || (chat.type === 'group' ? DEFAULT_AI_AVATAR : (chat.aiAvatar || DEFAULT_AI_AVATAR));
        
        return `
          <div class="forward-chat-item ${isSelected ? 'selected' : ''}" onclick="toggleForwardChat('${chat.id}')">
            <img class="forward-chat-avatar" src="${avatarSrc}" alt="å¤´åƒ" onerror="this.src='${DEFAULT_AI_AVATAR}'">
            <div class="forward-chat-info">
              <div class="forward-chat-name">${chat.name}</div>
              <div class="forward-chat-desc">${chatTypeText} â€¢ ${chat.lastTime || 'æœ€è¿‘'}</div>
            </div>
            <div class="forward-checkbox ${isSelected ? 'checked' : ''}"></div>
          </div>
        `;
      }).join('');
      
      updateForwardConfirmButton();
    }
    
    // åˆ‡æ¢é€‰æ‹©èŠå¤©
    window.toggleForwardChat = function(chatId) {
      const index = selectedForwardChats.indexOf(chatId);
      if (index > -1) {
        selectedForwardChats.splice(index, 1);
      } else {
        selectedForwardChats.push(chatId);
      }
      
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      const searchTerm = document.getElementById('forwardSearchInput').value;
      renderForwardChatList(searchTerm);
    };
    
    // æ›´æ–°ç¡®è®¤æŒ‰é’®çŠ¶æ€
    function updateForwardConfirmButton() {
      const confirmBtn = document.getElementById('forwardConfirm');
      confirmBtn.disabled = selectedForwardChats.length === 0;
      confirmBtn.textContent = selectedForwardChats.length > 0 ? 
        `å‘é€ç»™ ${selectedForwardChats.length} ä¸ªèŠå¤©` : 'å‘é€';
    }
    
    // æ‰§è¡Œè½¬å‘
    function executeForward() {
      if ((!forwardMessage && forwardMessages.length === 0) || selectedForwardChats.length === 0) return;
      
      selectedForwardChats.forEach(chatId => {
        const targetChat = chatList.find(c => c.id === chatId);
        if (targetChat) {
          if (forwardMessages.length > 0) {
            // å¤šæ¡æ¶ˆæ¯è½¬å‘ - åˆ›å»ºèŠå¤©è®°å½•
            const chatRecordData = {
              messages: forwardMessages.map(msg => ({
                id: msg.id,
                content: msg.content,
                fromName: msg.fromName,
                role: msg.role,
                roleId: msg.roleId,
                timestamp: msg.timestamp,
                avatar: msg.avatar
              })),
              fromChat: forwardMessages[0].chatName
            };
            
            const chatRecordMsgData = {
              id: generateId(),
              role: 'user', // è½¬å‘çš„æ¶ˆæ¯æ˜¾ç¤ºä¸ºç”¨æˆ·å‘é€
              content: `èŠå¤©è®°å½• - ${forwardMessages.length}æ¡æ¶ˆæ¯`,
              timestamp: formatMessageTime(),
              type: 'chatRecord',
              chatRecordData: chatRecordData
            };
            
            if (!targetChat.chatDisplay) {
              targetChat.chatDisplay = [];
            }
            targetChat.chatDisplay.push(chatRecordMsgData);
            
            // æ›´æ–°æœ€åæ¶ˆæ¯æ˜¾ç¤ºèŠå¤©è®°å½•
            targetChat.lastMessage = `[èŠå¤©è®°å½•] ${forwardMessages.length}æ¡æ¶ˆæ¯`;
            targetChat.lastTime = formatMessageTime();
          } else if (forwardMessage) {
            // å•æ¡æ¶ˆæ¯è½¬å‘
            const forwardMsgData = {
              id: generateId(),
              role: 'user', // è½¬å‘çš„æ¶ˆæ¯æ˜¾ç¤ºä¸ºç”¨æˆ·å‘é€
              content: forwardMessage.content,
              timestamp: formatMessageTime(),
              type: 'forward',
              forwardFrom: {
                chatName: forwardMessage.chatName,
                fromName: forwardMessage.fromName,
                role: forwardMessage.role
              }
            };
            
            if (!targetChat.chatDisplay) {
              targetChat.chatDisplay = [];
            }
            targetChat.chatDisplay.push(forwardMsgData);
            
            // æ›´æ–°æœ€åæ¶ˆæ¯
            targetChat.lastMessage = `[è½¬å‘] ${forwardMessage.content.substring(0, 20)}...`;
            targetChat.lastTime = formatMessageTime();
          }
          
          // å‡†å¤‡AIå›å¤å†…å®¹
          let combinedForwardContent = '';
          if (forwardMessages.length > 0) {
            // å¤šæ¡æ¶ˆæ¯èŠå¤©è®°å½•ï¼ŒAIå›å¤æ ¼å¼
            combinedForwardContent = `[ç”¨æˆ·è½¬å‘äº†ä¸€ä¸ªèŠå¤©è®°å½•ï¼ŒåŒ…å«${forwardMessages.length}æ¡æ¶ˆæ¯ï¼š\n` + 
              forwardMessages.map(msg => `${msg.fromName}: ${msg.content}`).join('\n') + '\n]';
          } else if (forwardMessage) {
            // å•æ¡æ¶ˆæ¯è½¬å‘ï¼ŒAIå›å¤æ ¼å¼
            combinedForwardContent = `[ç”¨æˆ·è½¬å‘äº†æ¥è‡ª${forwardMessage.fromName}çš„æ¶ˆæ¯ï¼š${forwardMessage.content}]`;
          }
          
          // å¦‚æœè½¬å‘åˆ°å½“å‰èŠå¤©ï¼Œç«‹å³æ˜¾ç¤ºå¹¶è§¦å‘AIå›å¤
          if (chatId === currentChatId) {
            // é‡æ–°åŠ è½½å½“å‰èŠå¤©æ˜¾ç¤ºè½¬å‘çš„æ¶ˆæ¯
            const currentChat = chatList.find(c => c.id === chatId);
            if (currentChat) {
              loadChatData(currentChat);
            }
            
            if (combinedForwardContent.trim()) {
              // å°†è½¬å‘çš„æ¶ˆæ¯å†…å®¹æ·»åŠ åˆ°å¾…å¤„ç†é˜Ÿåˆ—
              pendingMessages.push({
                text: combinedForwardContent,
                chat: targetChat,
                timestamp: Date.now(),
                isForwarded: true
              });
              
              // ç«‹å³å¤„ç†AIå›å¤
              if (aiResponseDelay === 0) {
                setTimeout(() => processMessages(), 100); // çŸ­æš‚å»¶è¿Ÿç¡®ä¿UIæ›´æ–°å®Œæˆ
              } else {
                startResponseTimer();
              }
            }
          } else {
            // å¦‚æœè½¬å‘åˆ°å…¶ä»–èŠå¤©ï¼Œä¸ºè¯¥èŠå¤©æ·»åŠ AIå›å¤ä»»åŠ¡
            if (combinedForwardContent.trim()) {
              // ä¸ºç›®æ ‡èŠå¤©åˆ›å»ºå¾…å¤„ç†æ¶ˆæ¯
              if (!targetChat.pendingMessages) {
                targetChat.pendingMessages = [];
              }
              
              targetChat.pendingMessages.push({
                text: combinedForwardContent,
                timestamp: Date.now(),
                isForwarded: true
              });
              
              // ç›®æ ‡èŠå¤©ä¼šåœ¨åˆ‡æ¢æ—¶ç”±AIæ¨¡å‹çœŸæ­£å›å¤ï¼Œè¿™é‡Œä¸ç”Ÿæˆé¢„è®¾å›å¤
            }
          }
        }
      });
      
      // ä¿å­˜èŠå¤©åˆ—è¡¨
      saveChatList();
      
      // é‡æ–°æ¸²æŸ“èŠå¤©åˆ—è¡¨
      renderChatList();
      
      // å…³é—­è½¬å‘æ¨¡æ€æ¡†
      hideForwardModal();
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      const successMsg = document.createElement('div');
      successMsg.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #4CAF50; color: white; padding: 16px 24px; border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; font-size: 16px;
      `;
      
      const messageCount = forwardMessages.length > 0 ? forwardMessages.length : 1;
      successMsg.innerHTML = `âœ… å·²è½¬å‘${messageCount}æ¡æ¶ˆæ¯åˆ° ${selectedForwardChats.length} ä¸ªèŠå¤©`;
      document.body.appendChild(successMsg);
      
      setTimeout(() => {
        if (successMsg.parentNode) {
          successMsg.parentNode.removeChild(successMsg);
        }
      }, 2000);
    }
    
    // éšè—è½¬å‘æ¨¡æ€æ¡†
    function hideForwardModal() {
      const forwardModal = document.getElementById('forwardModal');
      forwardModal.classList.remove('show');
      selectedForwardChats = [];
      forwardMessage = null;
      forwardMessages = [];
    }



    // å¤šé€‰åŠŸèƒ½ç›¸å…³å‡½æ•°

    // å¼€å§‹å¤šé€‰æ¨¡å¼
    window.startMultiSelect = function(messageId) {
      isMultiSelectMode = true;
      selectedMessages = [];
      
      // é€‰ä¸­è§¦å‘å¤šé€‰çš„æ¶ˆæ¯
      if (messageId) {
        selectedMessages.push(messageId);
        const msgDiv = document.querySelector(`[data-message-id="${messageId}"]`);
        if (msgDiv) {
          msgDiv.classList.add('selected');
        }
      }
      
      // ä¸ºèŠå¤©ç•Œé¢æ·»åŠ å¤šé€‰æ¨¡å¼æ ·å¼
      const chatContainer = document.querySelector('.chat-container');
      if (chatContainer) {
        chatContainer.classList.add('multi-select-mode');
      }
      
      // ä¸ºæ‰€æœ‰æ¶ˆæ¯æ·»åŠ ç‚¹å‡»äº‹ä»¶
      addMultiSelectListeners();
      
      // æ˜¾ç¤ºå¤šé€‰å·¥å…·æ 
      showMultiSelectToolbar();
      
      // æ›´æ–°å·¥å…·æ ä¿¡æ¯
      updateMultiSelectInfo();
    };

    // ä¸ºæ¶ˆæ¯æ·»åŠ å¤šé€‰ç‚¹å‡»ç›‘å¬å™¨
    function addMultiSelectListeners() {
      const allMessages = document.querySelectorAll('.msg');
      allMessages.forEach(msgDiv => {
        const messageId = msgDiv.getAttribute('data-message-id');
        if (messageId && !msgDiv.hasAttribute('data-multi-select-listener')) {
          msgDiv.setAttribute('data-multi-select-listener', 'true');
          msgDiv.addEventListener('click', handleMultiSelectClick);
        }
      });
    }

    // å¤„ç†å¤šé€‰æ¨¡å¼ä¸‹çš„æ¶ˆæ¯ç‚¹å‡»
    function handleMultiSelectClick(event) {
      if (!isMultiSelectMode) return;
      
      event.stopPropagation();
      event.preventDefault();
      
      const msgDiv = event.currentTarget;
      const messageId = msgDiv.getAttribute('data-message-id');
      
      if (!messageId) return;
      
      // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
      const index = selectedMessages.indexOf(messageId);
      if (index > -1) {
        selectedMessages.splice(index, 1);
        msgDiv.classList.remove('selected');
      } else {
        selectedMessages.push(messageId);
        msgDiv.classList.add('selected');
      }
      
      // æ›´æ–°å·¥å…·æ ä¿¡æ¯
      updateMultiSelectInfo();
      
      // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•æ¶ˆæ¯ï¼Œé€€å‡ºå¤šé€‰æ¨¡å¼
      if (selectedMessages.length === 0) {
        exitMultiSelectMode();
      }
    }

    // æ˜¾ç¤ºå¤šé€‰å·¥å…·æ 
    function showMultiSelectToolbar() {
      const toolbar = document.getElementById('multiSelectToolbar');
      if (toolbar) {
        toolbar.classList.add('show');
      }
    }

    // éšè—å¤šé€‰å·¥å…·æ 
    function hideMultiSelectToolbar() {
      const toolbar = document.getElementById('multiSelectToolbar');
      if (toolbar) {
        toolbar.classList.remove('show');
      }
    }

    // æ›´æ–°å¤šé€‰ä¿¡æ¯
    function updateMultiSelectInfo() {
      const infoElement = document.getElementById('multiSelectInfo');
      if (infoElement) {
        infoElement.textContent = `å·²é€‰æ‹© ${selectedMessages.length} æ¡æ¶ˆæ¯`;
      }
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      const forwardBtn = document.getElementById('multiForwardBtn');
      const deleteBtn = document.getElementById('multiDeleteBtn');
      
      if (forwardBtn) {
        forwardBtn.disabled = selectedMessages.length === 0;
      }
      if (deleteBtn) {
        deleteBtn.disabled = selectedMessages.length === 0;
      }
    }

    // é€€å‡ºå¤šé€‰æ¨¡å¼
    function exitMultiSelectMode() {
      isMultiSelectMode = false;
      selectedMessages = [];
      
      // ç§»é™¤å¤šé€‰æ¨¡å¼æ ·å¼
      const chatContainer = document.querySelector('.chat-container');
      if (chatContainer) {
        chatContainer.classList.remove('multi-select-mode');
      }
      
      // ç§»é™¤æ‰€æœ‰é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.msg.selected').forEach(msg => {
        msg.classList.remove('selected');
      });
      
      // ç§»é™¤ç‚¹å‡»ç›‘å¬å™¨
      const allMessages = document.querySelectorAll('.msg[data-multi-select-listener]');
      allMessages.forEach(msgDiv => {
        msgDiv.removeAttribute('data-multi-select-listener');
        msgDiv.removeEventListener('click', handleMultiSelectClick);
      });
      
      // éšè—å·¥å…·æ 
      hideMultiSelectToolbar();
    }

    // å¤šé€‰è½¬å‘
    function multiForward() {
      if (selectedMessages.length === 0) return;
      
      // æ„å»ºå¤šæ¡è½¬å‘æ¶ˆæ¯
      forwardMessages = [];
      
      selectedMessages.forEach(messageId => {
        const msgDiv = document.querySelector(`[data-message-id="${messageId}"]`);
        if (msgDiv) {
          const bubble = msgDiv.querySelector('.bubble');
          const avatar = msgDiv.querySelector('.msg-avatar');
          let content = '';
          
          // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯å†…å®¹
          const forwardMessage = bubble.querySelector('.forward-message');
          const emojiContainer = bubble.querySelector('.emoji-container');
          const chatRecord = bubble.querySelector('.chat-record');
          
          if (chatRecord) {
            // èŠå¤©è®°å½•æ¶ˆæ¯
            const recordTitle = chatRecord.querySelector('.chat-record-title span:last-child');
            content = recordTitle ? recordTitle.textContent : '[èŠå¤©è®°å½•]';
          } else if (forwardMessage) {
            // è½¬å‘æ¶ˆæ¯
            const forwardContent = forwardMessage.querySelector('.forward-content');
            content = forwardContent ? forwardContent.textContent : '';
          } else if (emojiContainer) {
            // è¡¨æƒ…åŒ…æ¶ˆæ¯
            content = '[è¡¨æƒ…åŒ…]';
          } else {
            // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
            const replyReference = bubble.querySelector('.reply-reference');
            if (replyReference) {
              // ç§»é™¤å›å¤å¼•ç”¨åè·å–å†…å®¹
              const tempDiv = bubble.cloneNode(true);
              const tempReply = tempDiv.querySelector('.reply-reference');
              if (tempReply) tempReply.remove();
              content = tempDiv.textContent || tempDiv.innerText;
            } else {
              content = bubble.textContent || bubble.innerText;
            }
          }
          
          const role = msgDiv.classList.contains('ai') ? 'ai' : 'user';
          const roleId = msgDiv.getAttribute('data-role-id') || '';
          const roleName = msgDiv.getAttribute('data-role-name') || '';
          
          // è·å–å¤´åƒ
          let avatarSrc = '';
          if (avatar) {
            avatarSrc = avatar.src;
          } else {
            // æ ¹æ®è§’è‰²è·å–é»˜è®¤å¤´åƒ
            avatarSrc = role === 'user' ? (userAvatar || DEFAULT_USER_AVATAR) : (aiAvatar || DEFAULT_AI_AVATAR);
          }
          
          // è·å–æ˜¾ç¤ºåç§°ï¼ˆä¿æŒä¸ç•Œé¢ä¸€è‡´ï¼‰
          let displayName = '';
          if (role === 'user') {
            displayName = userName || 'ç”¨æˆ·';
          } else {
            // AIæ¶ˆæ¯ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ç¾¤èŠ
            const currentChat = chatList.find(c => c.id === currentChatId);
            if (currentChat && currentChat.type === 'group') {
              displayName = roleName || 'AI';
            } else {
              displayName = roleName || currentChat?.roleName || 'AI';
            }
          }
          
          // æŸ¥æ‰¾æ¶ˆæ¯æ—¶é—´
          let timestamp = formatMessageTime();
          let prevElement = msgDiv.previousElementSibling;
          if (prevElement && prevElement.classList.contains('msg-time')) {
            const timeSpan = prevElement.querySelector('span');
            if (timeSpan) {
              timestamp = timeSpan.textContent;
            }
          }
          
          forwardMessages.push({
            id: messageId,
            content: content.trim(),
            role: role,
            roleId: roleId,
            fromName: displayName,
            avatar: avatarSrc,
            timestamp: timestamp,
            chatName: chatList.find(c => c.id === currentChatId)?.name || 'å½“å‰èŠå¤©'
          });
        }
      });
      
      // è®¾ç½®forwardMessageä¸ºå¤šæ¡æ¶ˆæ¯çš„åˆå¹¶ç‰ˆæœ¬
      if (forwardMessages.length > 0) {
        forwardMessage = {
          content: forwardMessages.map(msg => msg.content).join('\n'),
          chatName: forwardMessages[0].chatName,
          fromName: forwardMessages.length === 1 ? forwardMessages[0].fromName : 'å¤šä½ç”¨æˆ·',
          role: 'multi'
        };
        
        showForwardModal();
      }
      
      // é€€å‡ºå¤šé€‰æ¨¡å¼
      exitMultiSelectMode();
    }

    // å¤šé€‰åˆ é™¤
    function multiDelete() {
      if (selectedMessages.length === 0) return;
      
      if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedMessages.length} æ¡æ¶ˆæ¯å—ï¼Ÿ`)) {
        selectedMessages.forEach(messageId => {
          const msgDiv = document.querySelector(`[data-message-id="${messageId}"]`);
          if (msgDiv) {
            // åˆ é™¤ç•Œé¢å…ƒç´ 
            const timeElement = msgDiv.previousElementSibling;
            if (timeElement && timeElement.classList.contains('msg-time')) {
              timeElement.remove();
            }
            msgDiv.remove();
            
            // ä»èŠå¤©è®°å½•ä¸­åˆ é™¤
            const currentChat = chatList.find(c => c.id === currentChatId);
            if (currentChat) {
              currentChat.chatDisplay = currentChat.chatDisplay.filter(msg => msg.id !== messageId);
            }
          }
        });
        
        // ä¿å­˜èŠå¤©åˆ—è¡¨
        saveChatList();
        
        // é€€å‡ºå¤šé€‰æ¨¡å¼
        exitMultiSelectMode();
      }
    }

    // èŠå¤©è®°å½•ç›¸å…³å‡½æ•°

    // æ˜¾ç¤ºèŠå¤©è®°å½•è¯¦æƒ…
    window.showChatRecordDetail = function(chatRecordData) {
      const chatRecordModal = document.getElementById('chatRecordModal');
      const chatRecordModalBody = document.getElementById('chatRecordModalBody');
      const chatRecordModalTitle = document.querySelector('.chat-record-modal-title');
      
      if (!chatRecordModal || !chatRecordModalBody) return;
      
      // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜
      if (chatRecordModalTitle) {
        chatRecordModalTitle.textContent = `${chatRecordData.fromChat}çš„èŠå¤©è®°å½•`;
      }
      
      // ç”Ÿæˆè¯¦ç»†çš„èŠå¤©è®°å½•å†…å®¹
      const detailHtml = chatRecordData.messages.map(msg => `
        <div class="chat-record-detail-item">
          <img class="chat-record-detail-avatar" src="${msg.avatar || DEFAULT_USER_AVATAR}" alt="${msg.fromName}" onerror="this.src='${DEFAULT_USER_AVATAR}'">
          <div class="chat-record-detail-content">
            <div class="chat-record-detail-sender">${msg.fromName}</div>
            <div class="chat-record-detail-text">${msg.content}</div>
            <div class="chat-record-detail-time">${msg.timestamp || formatMessageTime()}</div>
          </div>
        </div>
      `).join('');
      
      chatRecordModalBody.innerHTML = detailHtml;
      chatRecordModal.classList.add('show');
    };

    // éšè—èŠå¤©è®°å½•æ¨¡æ€æ¡†
    function hideChatRecordModal() {
      const chatRecordModal = document.getElementById('chatRecordModal');
      if (chatRecordModal) {
        chatRecordModal.classList.remove('show');
      }
    }

    // æ›´æ–°ç°æœ‰æ¶ˆæ¯èœå•ï¼Œæ·»åŠ å¤šé€‰é€‰é¡¹
    function updateExistingMenus() {
      const allMenus = document.querySelectorAll('.msg-menu');
      allMenus.forEach(menu => {
        const forwardItem = menu.querySelector('[data-action="forward"]');
        const deleteItem = menu.querySelector('[data-action="delete"]');
        const multiSelectItem = menu.querySelector('[data-action="multiSelect"]');
        
        // å¦‚æœè¿˜æ²¡æœ‰å¤šé€‰é€‰é¡¹ï¼Œåˆ™æ·»åŠ 
        if (forwardItem && deleteItem && !multiSelectItem) {
          const messageId = forwardItem.getAttribute('data-message-id');
          const multiSelectDiv = document.createElement('div');
          multiSelectDiv.className = 'msg-menu-item';
          multiSelectDiv.setAttribute('data-action', 'multiSelect');
          multiSelectDiv.setAttribute('data-message-id', messageId);
          multiSelectDiv.textContent = 'å¤šé€‰';
          
          // åœ¨åˆ é™¤æŒ‰é’®å‰æ’å…¥å¤šé€‰é€‰é¡¹
          deleteItem.parentNode.insertBefore(multiSelectDiv, deleteItem);
          
          // ä¸ºèœå•æ·»åŠ äº‹ä»¶å§”æ‰˜
          if (!menu.hasAttribute('data-updated')) {
            menu.setAttribute('data-updated', 'true');
            menu.addEventListener('click', function(event) {
              const menuItem = event.target.closest('.msg-menu-item');
              if (menuItem && menuItem.getAttribute('data-action') === 'multiSelect') {
                event.stopPropagation();
                const msgId = menuItem.getAttribute('data-message-id');
                window.startMultiSelect(msgId);
                hideMsgMenu();
              }
            });
          }
        }
      });
    }

    // åœ¨æ¶ˆæ¯åŠ è½½å®Œæˆåæ›´æ–°èœå•
    function updateMenusAfterLoad() {
      setTimeout(() => {
        updateExistingMenus();
        updateRegenerateButtons();
      }, 100);
    }

    // æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç›‘å¬å™¨
    
    // è¡¨æƒ…åŒ…æ–‡ä»¶ä¸Šä¼ 
    uploadEmojiBtn.onclick = () => {
      emojiFileInput.click();
    };
    
    emojiFileInput.onchange = function(e) {
      const file = e.target.files[0];
      if (file) {
        handleImageUpload(file, null, true);
        e.target.value = ''; // æ¸…ç©ºinputä»¥å…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
      }
    };
    
    // AIå¤´åƒæ–‡ä»¶ä¸Šä¼ 
    uploadAiAvatarBtn.onclick = () => {
      aiAvatarFileInput.click();
    };
    
    aiAvatarFileInput.onchange = function(e) {
      const file = e.target.files[0];
      if (file) {
        handleImageUpload(file, aiAvatarInput, false);
        e.target.value = '';
      }
    };
    
    // ç”¨æˆ·å¤´åƒæ–‡ä»¶ä¸Šä¼ 
    uploadUserAvatarBtn.onclick = () => {
      userAvatarFileInput.click();
    };
    
    userAvatarFileInput.onchange = function(e) {
      const file = e.target.files[0];
      if (file) {
        handleImageUpload(file, userAvatarInput, false);
        e.target.value = '';
      }
    };
    
    // ç¾¤èŠè§’è‰²å¤´åƒæ–‡ä»¶ä¸Šä¼ 
    uploadModalRoleAvatarBtn.onclick = () => {
      modalRoleAvatarFileInput.click();
    };
    
    modalRoleAvatarFileInput.onchange = function(e) {
      const file = e.target.files[0];
      if (file) {
        handleImageUpload(file, modalRoleAvatarInput, false);
        e.target.value = '';
      }
    };

    // ç¾¤èŠè§’è‰²è§†é¢‘é€šè¯ç”»é¢æ–‡ä»¶ä¸Šä¼ 
    const uploadModalRoleVideoBtn = document.getElementById('uploadModalRoleVideoBtn');
    const modalRoleVideoFileInput = document.getElementById('modalRoleVideoFileInput');
    const modalRoleVideoInput = document.getElementById('modalRoleVideoInput');
    
    if (uploadModalRoleVideoBtn && modalRoleVideoFileInput && modalRoleVideoInput) {
      uploadModalRoleVideoBtn.onclick = () => {
        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
          // ç§»åŠ¨ç«¯æ˜¾ç¤ºé€‰æ‹©èœå•
          showMobileVideoUploadMenu(modalRoleVideoFileInput);
        } else {
          // æ¡Œé¢ç«¯ç›´æ¥æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
          modalRoleVideoFileInput.click();
        }
      };
      
      modalRoleVideoFileInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
            handleVideoCallMediaUpload(file, modalRoleVideoInput);
          } else {
            alert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–è§†é¢‘æ–‡ä»¶');
          }
          e.target.value = '';
        }
      };
    }

    // é¢„è§ˆç¾¤èŠè§’è‰²è§†é¢‘é€šè¯ç”»é¢æŒ‰é’®
    const previewModalRoleVideoBtn = document.getElementById('previewModalRoleVideoBtn');
    if (previewModalRoleVideoBtn) {
      previewModalRoleVideoBtn.onclick = () => {
        const videoUrl = document.getElementById('modalRoleVideoInput').value.trim();
        const roleName = document.getElementById('modalRoleNameInput').value.trim() || 'è§’è‰²';
        previewVideoCallMedia(videoUrl, roleName);
      };
    }

    // å•èŠAIè§†é¢‘é€šè¯ç”»é¢æ–‡ä»¶ä¸Šä¼ 
    const uploadAiVideoBtn = document.getElementById('uploadAiVideoBtn');
    const aiVideoFileInput = document.getElementById('aiVideoFileInput');
    const aiVideoInput = document.getElementById('aiVideoInput');
    
    if (uploadAiVideoBtn && aiVideoFileInput && aiVideoInput) {
      uploadAiVideoBtn.onclick = () => {
        // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
          // ç§»åŠ¨ç«¯æ˜¾ç¤ºé€‰æ‹©èœå•
          showMobileVideoUploadMenu(aiVideoFileInput);
        } else {
          // æ¡Œé¢ç«¯ç›´æ¥æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
          aiVideoFileInput.click();
        }
      };
      
      aiVideoFileInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          if (file.type.startsWith('image/') || file.type.startsWith('video/')) {
            handleVideoCallMediaUpload(file, aiVideoInput);
          } else {
            alert('è¯·é€‰æ‹©å›¾ç‰‡æˆ–è§†é¢‘æ–‡ä»¶');
          }
          e.target.value = '';
        }
      };
    }

    // é¢„è§ˆAIè§†é¢‘é€šè¯ç”»é¢æŒ‰é’®
    const previewAiVideoBtn = document.getElementById('previewAiVideoBtn');
    if (previewAiVideoBtn) {
      previewAiVideoBtn.onclick = () => {
        const videoUrl = document.getElementById('aiVideoInput').value.trim();
        const roleName = document.getElementById('roleNameInput').value.trim() || 'åŠ©æ‰‹';
        previewVideoCallMedia(videoUrl, roleName);
      };
    }

    // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
    const emojiDropArea = document.getElementById('emojiDropArea');
    
    // é˜²æ­¢é»˜è®¤çš„æ‹–æ‹½è¡Œä¸º
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      emojiDropArea.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    // é«˜äº®æ‹–æ‹½åŒºåŸŸ
    ['dragenter', 'dragover'].forEach(eventName => {
      emojiDropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      emojiDropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight(e) {
      emojiDropArea.classList.add('dragover');
    }
    
    function unhighlight(e) {
      emojiDropArea.classList.remove('dragover');
    }
    
    // å¤„ç†æ–‡ä»¶æ‹–æ‹½
    emojiDropArea.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length > 0) {
        const file = files[0];
        if (file.type.startsWith('image/')) {
          handleImageUpload(file, null, true);
        } else {
          alert('è¯·æ‹–æ‹½å›¾ç‰‡æ–‡ä»¶');
        }
      }
    }
    
    // ç‚¹å‡»æ‹–æ‹½åŒºåŸŸä¹Ÿå¯ä»¥é€‰æ‹©æ–‡ä»¶
    emojiDropArea.addEventListener('click', () => {
      emojiFileInput.click();
    });

    // å¤´åƒURLè¾“å…¥é¢„è§ˆåŠŸèƒ½
    function setupAvatarPreview(inputElement) {
      inputElement.addEventListener('blur', function() {
        const url = this.value.trim();
        if (url && (url.startsWith('http') || url.startsWith('data:image'))) {
          // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆå›¾ç‰‡URL
          const img = new Image();
          img.onload = function() {
            addImagePreview(inputElement, url);
          };
          img.onerror = function() {
            // å¦‚æœä¸æ˜¯æœ‰æ•ˆå›¾ç‰‡ï¼Œç§»é™¤é¢„è§ˆ
            const previewContainer = inputElement.parentNode.querySelector('.preview-container');
            if (previewContainer) {
              previewContainer.remove();
            }
          };
          img.src = url;
        } else if (!url) {
          // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œç§»é™¤é¢„è§ˆ
          const previewContainer = inputElement.parentNode.querySelector('.preview-container');
          if (previewContainer) {
            previewContainer.remove();
          }
        }
      });
    }

    // ä¸ºæ‰€æœ‰å¤´åƒè¾“å…¥æ¡†è®¾ç½®é¢„è§ˆåŠŸèƒ½
    setupAvatarPreview(aiAvatarInput);
    setupAvatarPreview(userAvatarInput);
    setupAvatarPreview(modalRoleAvatarInput);

    testBtn.onclick = testConnection;
    
    refreshModelsBtn.onclick = () => {
      refreshModelsBtn.disabled = true;
      refreshModelsBtn.textContent = 'åˆ·æ–°ä¸­...';
      fetchModels().finally(() => {
        refreshModelsBtn.disabled = false;
        refreshModelsBtn.textContent = 'åˆ·æ–°æ¨¡å‹';
      });
    };
    
    directChatTestBtn.onclick = directChatTest;

    // ç¡…åŸºæµåŠ¨APIè¿æ¥åŠ©æ‰‹
    const siliconflowApiHelperBtn = document.getElementById('siliconflowApiHelperBtn');
    if (siliconflowApiHelperBtn) {
      siliconflowApiHelperBtn.onclick = showSiliconflowApiHelper;
    }

    // è°ƒè¯•æ¨¡å‹æŒ‰é’® - æ˜¾ç¤ºæ‰€æœ‰åŸå§‹æ•°æ®
    document.getElementById('debugModelsBtn').onclick = async () => {
      const useApiUrl = apiUrlInput.value.trim();
      const useApiKey = apiKeyInput.value.trim();
      
      if (!useApiUrl || !useApiKey) {
        showTestResult('è¯·å…ˆå¡«å†™APIåœ°å€å’Œç§˜é’¥', 'error');
        return;
      }

      const debugBtn = document.getElementById('debugModelsBtn');
      debugBtn.disabled = true;
      debugBtn.textContent = 'è°ƒè¯•ä¸­...';
      
      try {
        const baseUrl = getApiBaseUrl(useApiUrl);
        let modelsUrl;
        
        if (baseUrl.includes('/v1')) {
          modelsUrl = `${baseUrl}/models`;
        } else {
          modelsUrl = `${baseUrl}/v1/models`;
        }
        
        console.log('ğŸ” è°ƒè¯•æ¨¡å¼ - è¯·æ±‚URL:', modelsUrl);
        
        const response = await fetchWithRetry(modelsUrl, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${useApiKey}`,
            'Content-Type': 'application/json'
          },
          timeout: 15000 // è°ƒè¯•æ¨¡å¼ä½¿ç”¨15ç§’è¶…æ—¶
        });

        if (response.ok) {
          const data = await response.json();
          console.log('ğŸ” è°ƒè¯•æ¨¡å¼ - åŸå§‹å“åº”æ•°æ®:', data);
          
          // æ˜¾ç¤ºåŸå§‹æ•°æ®çš„é¢„è§ˆ
          const preview = JSON.stringify(data, null, 2);
          const truncatedPreview = preview.length > 500 ? preview.substring(0, 500) + '...' : preview;
          
          showTestResult(`
            <div>è°ƒè¯•å®Œæˆï¼åŸå§‹æ•°æ®å·²è¾“å‡ºåˆ°æ§åˆ¶å°</div>
            <details style="margin-top: 10px;">
              <summary>åŸå§‹æ•°æ®é¢„è§ˆ (ç‚¹å‡»å±•å¼€)</summary>
              <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow: auto; max-height: 200px; font-size: 11px;">${truncatedPreview}</pre>
            </details>
          `, 'info');
          
          // å°è¯•è§£æå¹¶æ˜¾ç¤ºæ‰€æœ‰æ¨¡å‹ï¼ˆä¸è¿›è¡Œè¿‡æ»¤ï¼‰
          let allModels = [];
          if (data.data && Array.isArray(data.data)) {
            allModels = data.data;
          } else if (data.models && Array.isArray(data.models)) {
            allModels = data.models;
          } else if (Array.isArray(data)) {
            allModels = data;
          }
          
          if (allModels.length > 0) {
            availableModels = allModels.filter(model => model.id).sort((a, b) => a.id.localeCompare(b.id));
            updateModelSelect();
            console.log('ğŸ” è°ƒè¯•æ¨¡å¼ - æ‰€æœ‰å¯ç”¨æ¨¡å‹:', availableModels);
            showTestResult(`è°ƒè¯•æ¨¡å¼ï¼šæ˜¾ç¤ºæ‰€æœ‰ ${availableModels.length} ä¸ªæ¨¡å‹ï¼ˆæœªè¿‡æ»¤ï¼‰`, 'success');
          }
        } else {
          const errorText = await response.text();
          console.log('ğŸ” è°ƒè¯•æ¨¡å¼ - è¯·æ±‚å¤±è´¥:', response.status, errorText);
          showTestResult(`è°ƒè¯•å¤±è´¥: ${response.status} - ${errorText}`, 'error');
        }
      } catch (error) {
        console.log('ğŸ” è°ƒè¯•æ¨¡å¼ - å¼‚å¸¸:', error);
        showTestResult(`è°ƒè¯•å¼‚å¸¸: ${error.message}`, 'error');
      } finally {
        debugBtn.disabled = false;
        debugBtn.textContent = 'ğŸ” è°ƒè¯•æ¨¡å‹';
      }
    };

    modelSelect.onchange = updateModelInfo;
    
    rolePresetSelect.onchange = handleRolePresetChange;
    userPresetSelect.onchange = handleUserPresetChange;
    
    // é¢„è®¾ç®¡ç†äº‹ä»¶ç›‘å¬å™¨
    saveRolePresetBtn.onclick = () => saveRolePreset('main');
    manageRolePresetsBtn.onclick = () => managePresets('role', 'main');
    saveUserPresetBtn.onclick = saveUserPreset;
    manageUserPresetsBtn.onclick = () => managePresets('user', 'main');
    saveModalRolePresetBtn.onclick = () => saveRolePreset('modal');
    manageModalRolePresetsBtn.onclick = () => managePresets('role', 'modal');
    
    // é¢„è®¾ç®¡ç†å¼¹çª—äº‹ä»¶
    closePresetManageModal.onclick = () => {
      presetManageModal.style.display = 'none';
    };
    closePresetManageBtn.onclick = () => {
      presetManageModal.style.display = 'none';
    };
    presetManageModal.onclick = (e) => {
      if (e.target === presetManageModal) {
        presetManageModal.style.display = 'none';
      }
    };
    
    // ä¿å­˜é¢„è®¾å¼¹çª—äº‹ä»¶
    closeSavePresetModal.onclick = () => {
      savePresetModal.style.display = 'none';
    };
    cancelSavePresetBtn.onclick = () => {
      savePresetModal.style.display = 'none';
    };
    confirmSavePresetBtn.onclick = confirmSavePreset;
    savePresetModal.onclick = (e) => {
      if (e.target === savePresetModal) {
        savePresetModal.style.display = 'none';
      }
    };
    
    // APIé…ç½®ç®¡ç†äº‹ä»¶ç›‘å¬å™¨
    loadApiBtn.onclick = loadSelectedApiConfig;
    deleteApiBtn.onclick = deleteSelectedApiConfig;
    newApiConfigBtn.onclick = newApiConfig;
    saveAsNewBtn.onclick = saveAsNewApiConfig;
    updateCurrentBtn.onclick = updateCurrentApiConfig;
    
    // é…ç½®åç§°è¾“å…¥æ¡†å˜åŒ–æ—¶æ›´æ–°æŒ‰é’®çŠ¶æ€
    apiConfigNameInput.oninput = updateApiConfigButtons;
    
    // è¯†å›¾APIäº‹ä»¶ç›‘å¬å™¨
    testVisionBtn.onclick = testVisionConnection;
    refreshVisionModelsBtn.onclick = refreshVisionModels;
    debugVisionModelsBtn.onclick = debugVisionModels;
    visionModelSelect.onchange = function() {
      selectedVisionModel = this.value;
    };
    visionApiUrlInput.oninput = function() {
      visionApiURL = this.value.trim();
    };
    visionApiKeyInput.oninput = function() {
      visionApiKey = this.value.trim();
    };
    
    // å·²ä¿å­˜é…ç½®é€‰æ‹©æ¡†å˜åŒ–æ—¶æ›´æ–°æŒ‰é’®çŠ¶æ€
    savedApiSelect.onchange = updateApiConfigButtons;

    cancelBtn.onclick = () => {
      loadSettings(); // æ¢å¤åŸæ¥çš„å€¼
      settingsPanel.classList.remove('show');
      testResult.innerHTML = '';
    };

    saveRoleBtn.onclick = saveRoleSettings;

    cancelRoleBtn.onclick = () => {
      // æ¢å¤å½“å‰èŠå¤©çš„è§’è‰²è®¾å®šå€¼
      if (currentChatId) {
        const chat = chatList.find(c => c.id === currentChatId);
        if (chat) {
          roleNameInput.value = chat.roleName || '';
          roleDescInput.value = chat.roleDescription || '';
          aiAvatarInput.value = chat.aiAvatar === DEFAULT_AI_AVATAR ? '' : (chat.aiAvatar || '');
        }
      }
      rolePanel.classList.remove('show');
    };

    // ç”¨æˆ·è®¾å®šç›¸å…³äº‹ä»¶
    const saveUserBtn = document.getElementById('saveUserBtn');
    const cancelUserBtn = document.getElementById('cancelUserBtn');

    saveUserBtn.onclick = saveUserSettings;

    cancelUserBtn.onclick = () => {
      // æ¢å¤å½“å‰èŠå¤©çš„ç”¨æˆ·è®¾å®šå€¼
      if (currentChatId) {
        const chat = chatList.find(c => c.id === currentChatId);
        if (chat) {
          userNameInput.value = chat.userName || '';
          userDescInput.value = chat.userDescription || '';
          userAvatarInput.value = chat.userAvatar === DEFAULT_USER_AVATAR ? '' : (chat.userAvatar || '');
        }
      }
      userPanel.classList.remove('show');
    };

    clearChatBtn.onclick = () => {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰èŠå¤©è®°å½•å—ï¼Ÿ')) {
        clearChat();
        settingsPanel.classList.remove('show');
        rolePanel.classList.remove('show');
      }
    };

    exportChatBtn.onclick = exportChatHistory;

    importChatBtn.onclick = importChatHistory;

    importFileInput.onchange = handleFileImport;

    sendBtn.onclick = sendMsg;

    chatInput.onkeydown = function(e) {
      if (e.key === 'Enter') sendMsg();
    };

    // åˆå§‹åŒ–åº”ç”¨
    init();
    
    // ä½ç½®åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨
    locationBtn.onclick = showLocationModal;
    locationModalClose.onclick = hideLocationModal;
    locationCancelBtn.onclick = hideLocationModal;
    locationSendBtn.onclick = sendLocationMessage;
    
    // ä½ç½®è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨
    locationNameInput.oninput = updateLocationPreview;
    locationAddressInput.oninput = updateLocationPreview;
    
    // ä½ç½®å›¾ç‰‡ä¸Šä¼ äº‹ä»¶ç›‘å¬å™¨
    locationImageUpload.onclick = () => {
      locationImageInput.click();
    };
    
    locationImageInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        handleLocationImageUpload(file);
      }
    };
    
    // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
    locationModal.onclick = (e) => {
      if (e.target === locationModal) {
        hideLocationModal();
      }
    };
    
    // è½¬è´¦åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨
    transferBtn.onclick = showTransferModal;
    transferModalClose.onclick = hideTransferModal;
    transferCancelBtn.onclick = hideTransferModal;
    transferSendBtn.onclick = sendTransferMessage;
    
    // è½¬è´¦è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨
    transferAmountInput.oninput = updateTransferPreview;
    transferNoteInput.oninput = updateTransferPreview;
    
    // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
    transferModal.onclick = (e) => {
      if (e.target === transferModal) {
        hideTransferModal();
      }
    };
    
    // å›¾ç‰‡ä¸Šä¼ ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
    imageBtn.onclick = function() {
      imageFileInput.click();
    };
    
    imageFileInput.onchange = function(e) {
      const file = e.target.files[0];
      if (file) {
        // å¯ä»¥æ·»åŠ æ–‡æœ¬æè¿°çš„åŠŸèƒ½
        const userText = prompt('è¯·è¾“å…¥å¯¹è¿™å¼ å›¾ç‰‡çš„æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š', '');
        sendImageMessage(file, userText || '');
        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†
        this.value = '';
      }
    };
    
    // åˆå§‹åŒ–è¡¨æƒ…åŒ…æ•°æ®éªŒè¯
    function initEmojiData() {
      // éªŒè¯è¡¨æƒ…åŒ…æ•°æ®æ˜¯å¦å®Œæ•´
      const requiredEmotions = ['happy', 'sad', 'angry', 'confused', 'love'];
      let needsReset = false;
      
      if (!emojiData || typeof emojiData !== 'object') {
        needsReset = true;
      } else {
        for (const emotion of requiredEmotions) {
          if (!emojiData[emotion] || !Array.isArray(emojiData[emotion]) || emojiData[emotion].length === 0) {
            needsReset = true;
            break;
          }
        }
      }
      
      if (needsReset) {
        emojiData = JSON.parse(JSON.stringify(DEFAULT_EMOJIS));
        localStorage.setItem('aiChatEmojis', JSON.stringify(emojiData));
      }
    }
    
    // æ‰§è¡Œè¡¨æƒ…åŒ…æ•°æ®åˆå§‹åŒ–
    initEmojiData();

    // å¦‚æœæ²¡æœ‰é…ç½®APIï¼Œæ˜¾ç¤ºè®¾ç½®é¢æ¿
    if (!apiURL || !apiKey || !selectedModel) {
      if (chatList.length === 0) {
        // å¦‚æœæ²¡æœ‰èŠå¤©è®°å½•ï¼Œåˆ›å»ºä¸€ä¸ªæ–°èŠå¤©å¹¶æ˜¾ç¤ºè®¾ç½®
        createNewChat();
      settingsPanel.classList.add('show');
      }
    }

    // è·å–é¢‘ç‡æ–‡æœ¬
    function getFrequencyText(frequency) {
      const frequencies = {
        'always': 'æ¯æ¬¡éƒ½å›å¤',
        'often': 'ç»å¸¸å›å¤',
        'sometimes': 'å¶å°”å›å¤',
        'rarely': 'å¾ˆå°‘å›å¤'
      };
      return frequencies[frequency] || 'æ¯æ¬¡éƒ½å›å¤';
    }

    // æ·»åŠ è§’è‰²
    function addRole() {
      if (!currentChatId) return;
      
      currentEditingRoleIndex = -1;
      roleEditTitle.textContent = 'æ·»åŠ è§’è‰²';
      
      // æ¸…ç©ºè¡¨å•
      modalRolePresetSelect.value = '';
      modalRoleNameInput.value = '';
      modalRoleDescInput.value = '';
      modalRoleAvatarInput.value = '';
      modalRoleFrequencySelect.value = 'always';
      
      roleEditModal.style.display = 'flex';
    }

    // ç¼–è¾‘è§’è‰²
    function editRole(roleIndex) {
      if (!currentChatId) return;
      
      const chat = chatList.find(c => c.id === currentChatId);
      if (!chat || !chat.roles[roleIndex]) return;
      
      currentEditingRoleIndex = roleIndex;
      roleEditTitle.textContent = 'ç¼–è¾‘è§’è‰²';
      
      const role = chat.roles[roleIndex];
      modalRolePresetSelect.value = '';
      modalRoleNameInput.value = role.name || '';
      modalRoleDescInput.value = role.description || '';
      modalRoleAvatarInput.value = role.avatar || '';
      modalRoleVideoInput.value = role.videoCallMedia || '';
      modalRoleFrequencySelect.value = role.frequency || 'always';
      
      roleEditModal.style.display = 'flex';
    }

    // åˆ é™¤è§’è‰²
    function deleteRole(roleIndex) {
      if (!currentChatId) return;
      
      const chat = chatList.find(c => c.id === currentChatId);
      if (!chat || !chat.roles[roleIndex]) return;
      
      if (confirm(`ç¡®å®šè¦åˆ é™¤è§’è‰²"${chat.roles[roleIndex].name}"å—ï¼Ÿ`)) {
        chat.roles.splice(roleIndex, 1);
        updateRolesList(chat);
        saveChatList();
      }
    }

    // ä¿å­˜è§’è‰²ç¼–è¾‘
    function saveRoleEdit() {
      if (!currentChatId) return;
      
      const chat = chatList.find(c => c.id === currentChatId);
      if (!chat) return;
      
      const roleName = modalRoleNameInput.value.trim();
      const roleDesc = modalRoleDescInput.value.trim();
      const roleAvatar = modalRoleAvatarInput.value.trim() || DEFAULT_AI_AVATAR;
      const roleVideo = modalRoleVideoInput.value.trim() || roleAvatar;
      const roleFrequency = modalRoleFrequencySelect.value;
      
      if (!roleName) {
        alert('è¯·è¾“å…¥è§’è‰²å§“å');
        return;
      }
      
      const roleData = {
        id: currentEditingRoleIndex >= 0 ? chat.roles[currentEditingRoleIndex].id : generateId(),
        name: roleName,
        description: roleDesc,
        avatar: roleAvatar,
        videoCallMedia: roleVideo,
        frequency: roleFrequency
      };
      
      if (currentEditingRoleIndex >= 0) {
        // ç¼–è¾‘ç°æœ‰è§’è‰²
        chat.roles[currentEditingRoleIndex] = roleData;
      } else {
        // æ·»åŠ æ–°è§’è‰²
        chat.roles.push(roleData);
      }
      
      updateRolesList(chat);
      saveChatList();
      closeRoleEditModal.click();
    }

    // å¤„ç†è§’è‰²é¢„è®¾é€‰æ‹©ï¼ˆå¼¹çª—ç‰ˆæœ¬ï¼‰
    function handleModalRolePresetChange() {
      const selectedPreset = modalRolePresetSelect.value;
      if (selectedPreset && rolePresets[selectedPreset]) {
        modalRoleNameInput.value = rolePresets[selectedPreset].name;
        modalRoleDescInput.value = rolePresets[selectedPreset].description;
      }
    }

    // ==================== æœ‹å‹åœˆåŠŸèƒ½ ====================
    
    // åˆå§‹åŒ–æœ‹å‹åœˆ
    function initMoments() {
      // åŠ è½½æœ‹å‹åœˆæ•°æ®
      const savedMoments = localStorage.getItem('aiChatMoments');
      if (savedMoments) {
        try {
          moments = JSON.parse(savedMoments);
        } catch (e) {
          console.error('æœ‹å‹åœˆæ•°æ®è§£æå¤±è´¥:', e);
          moments = [];
        }
      }
      
      // åŠ è½½æœ‹å‹åœˆè®¾ç½®
      loadMomentsSettings();
      
      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
      updateMomentsUserInfo();
      
      // åˆå§‹åŒ–å¯è§æ€§é€‰é¡¹
      updateVisibilityOptions();
      
      // æ¸²æŸ“æœ‹å‹åœˆåˆ—è¡¨
      renderMoments();
    }
    
    // ä¿å­˜æœ‹å‹åœˆæ•°æ®
    function saveMoments() {
      localStorage.setItem('aiChatMoments', JSON.stringify(moments));
    }
    
    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
    function updateMomentsUserInfo() {
      const currentUserName = userName || 'æˆ‘';
      const currentUserAvatar = userAvatar || DEFAULT_USER_AVATAR;
      
      // ä½¿ç”¨è®¾ç½®ä¸­çš„æ ‡é¢˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤æ ¼å¼
      const displayTitle = momentsSettings.title || (currentUserName + 'çš„æœ‹å‹åœˆ');
      momentsUserName.textContent = displayTitle;
      
      momentsUserAvatar.src = currentUserAvatar;
      publishAvatar.src = currentUserAvatar;
      
      // æ›´æ–°å°é¢èƒŒæ™¯
      updateMomentsCover();
    }
    
    // æ˜¾ç¤ºæœ‹å‹åœˆç•Œé¢
    function showMoments() {
      chatListView.classList.remove('active');
      chatView.classList.remove('active');
      momentsView.classList.add('active');
      
      // æ¸…é™¤æ‹ä¸€æ‹è®¡æ—¶å™¨
      if (inactivityTimer) {
        clearTimeout(inactivityTimer);
        inactivityTimer = null;
      }
      
      // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
      updateMomentsUserInfo();
      
      // æ¸²æŸ“æœ‹å‹åœˆ
      renderMoments();
    }
    
    // éšè—æœ‹å‹åœˆç•Œé¢
    function hideMoments() {
      momentsView.classList.remove('active');
      chatListView.classList.add('active');
    }
    
    // æ¸²æŸ“æœ‹å‹åœˆåˆ—è¡¨
    function renderMoments() {
      if (moments.length === 0) {
        momentsList.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="font-size: 60px; margin-bottom: 20px;">ğŸ“¸</div>
            <div style="font-size: 16px;">è¿˜æ²¡æœ‰æœ‹å‹åœˆåŠ¨æ€</div>
          </div>
        `;
        return;
      }
      
      // æŒ‰æ—¶é—´å€’åºæ’åˆ—
      const sortedMoments = [...moments].sort((a, b) => b.timestamp - a.timestamp);
      
      momentsList.innerHTML = sortedMoments.map(moment => {
        return renderMomentItem(moment);
      }).join('');
      
      // ç»‘å®šäº‹ä»¶
      bindMomentEvents();
    }
    
    // æ¸²æŸ“å•ä¸ªæœ‹å‹åœˆåŠ¨æ€
    function renderMomentItem(moment) {
      const timeText = formatTime(moment.timestamp);
      const images = moment.images || [];
      const comments = moment.comments || [];
      const likes = moment.likes || 0;
      const isLiked = moment.isLiked || false;
      
      // ç”Ÿæˆå›¾ç‰‡ç½‘æ ¼
      let imagesHtml = '';
      if (images.length > 0) {
        const gridClass = getImageGridClass(images.length);
        imagesHtml = `
          <div class="moment-images ${gridClass}">
            ${images.map((img, index) => `
              <img class="moment-image" src="${img}" alt="å›¾ç‰‡${index + 1}" onclick="previewImage('${img}')">
            `).join('')}
          </div>
        `;
      }
      
      // ç”Ÿæˆè¯„è®º
      let commentsHtml = '';
      if (comments.length > 0 || true) { // æ€»æ˜¯æ˜¾ç¤ºè¯„è®ºåŒºï¼Œå³ä½¿æ²¡æœ‰è¯„è®º
        const displayComments = comments.slice(0, 3); // é»˜è®¤æ˜¾ç¤ºå‰3æ¡è¯„è®º
        const hasMoreComments = comments.length > 3;
        
        commentsHtml = `
          <div class="moment-comments show" id="comments-${moment.id}">
            <div class="comments-header">
              <div class="comments-title">è¯„è®º ${comments.length}</div>
              ${hasMoreComments ? `<button class="comments-toggle" onclick="toggleComments('${moment.id}')" id="toggle-${moment.id}">å±•å¼€å…¨éƒ¨</button>` : ''}
            </div>
            <div class="comments-list ${hasMoreComments ? 'collapsed' : ''}" id="list-${moment.id}">
              ${comments.map(comment => renderCommentItem(comment, moment.id)).join('')}
            </div>
            <div class="comment-input-area">
              <div id="reply-indicator-${moment.id}" class="reply-indicator" style="display: none;">
                <span id="reply-text-${moment.id}">æ­£åœ¨å›å¤...</span>
                <button class="cancel-reply" onclick="cancelReply('${moment.id}')">å–æ¶ˆ</button>
              </div>
              <div class="comment-input-container">
                <textarea class="comment-input" id="comment-input-${moment.id}" placeholder="å†™è¯„è®º..." 
                  onkeydown="handleCommentKeydown(event, '${moment.id}')"
                  oninput="handleCommentInput(event, '${moment.id}')"></textarea>
                <button class="comment-send-btn" onclick="sendComment('${moment.id}')" id="send-${moment.id}">å‘é€</button>
                <div class="mention-suggestions" id="mentions-${moment.id}"></div>
              </div>
            </div>
          </div>
        `;
      }
      
      return `
        <div class="moment-item" data-moment-id="${moment.id}">
          <div class="moment-header">
            <img class="moment-avatar" src="${moment.avatar}" alt="${moment.author}å¤´åƒ">
            <div class="moment-author-info">
              <div class="moment-author">${moment.author}</div>
            </div>
          </div>
          
          ${moment.content ? `<div class="moment-content-text">${moment.content}</div>` : ''}
          
          ${imagesHtml}
          
          <div class="moment-footer">
            <div class="moment-time">${timeText}</div>
            <div class="moment-actions">
              <button class="moment-like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${moment.id}')">
                <span>${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                <span>${likes > 0 ? likes : ''}</span>
              </button>
              <button class="moment-comment-btn" onclick="commentMoment('${moment.id}')">
                <span>ğŸ’¬</span>
                <span>è¯„è®º</span>
              </button>
            </div>
          </div>
          
          ${commentsHtml}
        </div>
      `;
    }
    
    // è·å–å›¾ç‰‡ç½‘æ ¼æ ·å¼ç±»
    function getImageGridClass(count) {
      switch (count) {
        case 1: return 'single';
        case 2: return 'two';
        case 3: return 'three';
        case 4: return 'four';
        case 5: return 'five';
        case 6: return 'six';
        case 7: return 'seven';
        case 8: return 'eight';
        case 9: return 'nine';
        default: return 'three';
      }
    }
    
    // æ¸²æŸ“å•ä¸ªè¯„è®º
    function renderCommentItem(comment, momentId) {
      const timeText = formatTime(comment.timestamp);
      let commentText = comment.text;
      
      // å¤„ç†å›å¤
      if (comment.replyTo) {
        commentText = `<span class="comment-reply">å›å¤ ${comment.replyTo}:</span> ${commentText}`;
      }
      
      // å¤„ç†@æåŠ
      commentText = commentText.replace(/@(\w+)/g, '<span class="comment-mention">@$1</span>');
      
      return `
        <div class="moment-comment" data-comment-id="${comment.id}">
          <span class="comment-author" onclick="replyToComment('${momentId}', '${comment.id}', '${comment.author}')">${comment.author}:</span>
          <span class="comment-text">${commentText}</span>
          <span class="comment-time">${timeText}</span>
          <div class="comment-actions">
            <button class="reply-btn" onclick="replyToComment('${momentId}', '${comment.id}', '${comment.author}')">å›å¤</button>
          </div>
        </div>
      `;
    }
    
    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(timestamp) {
      const now = new Date();
      const date = new Date(timestamp);
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) {
        return 'åˆšåˆš';
      } else if (minutes < 60) {
        return `${minutes}åˆ†é’Ÿå‰`;
      } else if (hours < 24) {
        return `${hours}å°æ—¶å‰`;
      } else if (days < 7) {
        return `${days}å¤©å‰`;
      } else {
        const month = date.getMonth() + 1;
        const day = date.getDate();
        return `${month}æœˆ${day}æ—¥`;
      }
    }
    
    // æ˜¾ç¤ºå‘å¸ƒå¼¹çª—
    function showPublishModal() {
      publishModal.classList.add('show');
      publishTextarea.value = '';
      selectedImages = [];
      currentVisibleRoles = [];
      renderPublishImages();
      updateVisibilityOptions();
      publishTextarea.focus();
    }
    
    // éšè—å‘å¸ƒå¼¹çª—
    function hidePublishModal() {
      publishModal.classList.remove('show');
      publishTextarea.value = '';
      selectedImages = [];
      currentVisibleRoles = [];
    }
    
    // æ›´æ–°å¯è§æ€§é€‰é¡¹
    function updateVisibilityOptions() {
      const allRoles = getAllRoles();
      
      let optionsHtml = '';
      
      // å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»ä½•è§’è‰²ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªè§’è‰²
      if (currentVisibleRoles.includes('all') || currentVisibleRoles.length === 0) {
        currentVisibleRoles = allRoles.length > 0 ? [allRoles[0].id] : [];
      }
      
      // æ·»åŠ å„ä¸ªè§’è‰²é€‰é¡¹
      allRoles.forEach(role => {
        const isSelected = currentVisibleRoles.includes(role.id);
        optionsHtml += `
          <div class="visibility-option ${isSelected ? 'selected' : ''}" data-visibility="${role.id}">
            ${role.name}
          </div>
        `;
      });
      
      if (allRoles.length === 0) {
        optionsHtml = '<div class="visibility-option disabled">æš‚æ— è§’è‰²</div>';
      }
      
      visibilityOptions.innerHTML = optionsHtml;
      
      // ç»‘å®šç‚¹å‡»äº‹ä»¶
      visibilityOptions.querySelectorAll('.visibility-option:not(.disabled)').forEach(option => {
        option.onclick = () => toggleVisibility(option.dataset.visibility);
      });
    }
    
    // è·å–æ‰€æœ‰è§’è‰²
    function getAllRoles() {
      const roles = [];
      const roleNameMap = new Map(); // ç”¨äºå»é‡ç›¸åŒåç§°çš„è§’è‰²
      
      // ä»æ‰€æœ‰èŠå¤©ä¸­æ”¶é›†è§’è‰²
      chatList.forEach(chat => {
        if (chat.type === 'group' && chat.roles) {
          chat.roles.forEach(role => {
            // ä½¿ç”¨è§’è‰²åç§°å»é‡ï¼Œé¿å…åŒä¸€ä¸ªè§’è‰²å‡ºç°å¤šæ¬¡
            if (!roleNameMap.has(role.name)) {
              roleNameMap.set(role.name, true);
              roles.push({
                id: role.id,
                name: role.name,
                description: role.description,
                avatar: role.avatar
              });
            }
          });
        } else if (chat.type === 'single' && chat.roleName) {
          // ä½¿ç”¨è§’è‰²åç§°å»é‡ï¼Œé¿å…åŒä¸€ä¸ªè§’è‰²çš„å¤šä¸ªå•èŠäº§ç”Ÿé‡å¤æ ‡ç­¾
          if (!roleNameMap.has(chat.roleName)) {
            roleNameMap.set(chat.roleName, true);
            const roleId = `single_${chat.id}`;
            roles.push({
              id: roleId,
              name: chat.roleName,
              description: chat.roleDescription,
              avatar: chat.aiAvatar
            });
          }
        }
      });
      
      // æŒ‰è§’è‰²åç§°æ’åº
      return roles.sort((a, b) => a.name.localeCompare(b.name));
    }
    
    // åˆ‡æ¢å¯è§æ€§é€‰æ‹©
    function toggleVisibility(visibility) {
      const index = currentVisibleRoles.indexOf(visibility);
      if (index >= 0) {
        // å¦‚æœå·²é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰æ‹©
        currentVisibleRoles.splice(index, 1);
        // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•è§’è‰²ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨è§’è‰²
        if (currentVisibleRoles.length === 0) {
          const allRoles = getAllRoles();
          if (allRoles.length > 0) {
            currentVisibleRoles = [allRoles[0].id];
          }
        }
      } else {
        // å¦‚æœæœªé€‰ä¸­ï¼Œåˆ™æ·»åŠ é€‰æ‹©
        currentVisibleRoles.push(visibility);
      }
      
      updateVisibilityOptions();
    }
    
    // æ·»åŠ å›¾ç‰‡
    function addImages() {
      momentImageInput.click();
    }
    
    // å¤„ç†å›¾ç‰‡é€‰æ‹©
    function handleImageSelect(event) {
      const files = Array.from(event.target.files);
      if (files.length === 0) return;
      
      // é™åˆ¶æœ€å¤š9å¼ å›¾ç‰‡
      const remainingSlots = 9 - selectedImages.length;
      const filesToProcess = files.slice(0, remainingSlots);
      
      filesToProcess.forEach(file => {
        if (file.type.startsWith('image/') && file.size <= 10 * 1024 * 1024) {
          const reader = new FileReader();
          reader.onload = (e) => {
            selectedImages.push(e.target.result);
            renderPublishImages();
          };
          reader.readAsDataURL(file);
        }
      });
      
      // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
      event.target.value = '';
    }
    
    // æ¸²æŸ“å‘å¸ƒå›¾ç‰‡
    function renderPublishImages() {
      let imagesHtml = '';
      
      // æ˜¾ç¤ºå·²é€‰æ‹©çš„å›¾ç‰‡
      selectedImages.forEach((img, index) => {
        imagesHtml += `
          <div class="publish-image-item has-image">
            <img src="${img}" alt="å›¾ç‰‡${index + 1}">
            <button class="publish-image-remove" onclick="removeImage(${index})">Ã—</button>
          </div>
        `;
      });
      
      // å¦‚æœå°‘äº9å¼ ï¼Œæ˜¾ç¤ºæ·»åŠ æŒ‰é’®
      if (selectedImages.length < 9) {
        imagesHtml += `
          <div class="publish-image-item" onclick="addImages()">
            <div class="publish-add-image">+</div>
          </div>
        `;
      }
      
      publishImagesContainer.innerHTML = imagesHtml;
    }
    
    // ç§»é™¤å›¾ç‰‡
    function removeImage(index) {
      selectedImages.splice(index, 1);
      renderPublishImages();
    }
    
    // å‘å¸ƒæœ‹å‹åœˆ
    function publishMoment() {
      const content = publishTextarea.value.trim();
      
      if (!content && selectedImages.length === 0) {
        alert('è¯·è¾“å…¥æ–‡å­—æˆ–é€‰æ‹©å›¾ç‰‡');
        return;
      }
      
      const moment = {
        id: generateId(),
        author: userName || 'æˆ‘',
        avatar: userAvatar || DEFAULT_USER_AVATAR,
        content: content,
        images: [...selectedImages],
        timestamp: Date.now(),
        visibleTo: [...currentVisibleRoles],
        likes: 0,
        isLiked: false,
        comments: []
      };
      
      moments.unshift(moment);
      saveMoments();
      hidePublishModal();
      renderMoments();
      
      // ç”ŸæˆAIè¯„è®º
      setTimeout(() => generateAIComments(moment.id), 2000);
    }
    
    // ç”ŸæˆAIè¯„è®º
    async function generateAIComments(momentId) {
      const moment = moments.find(m => m.id === momentId);
      if (!moment) return;
      
      const allRoles = getAllRoles();
      let visibleRoles = [];
      
      // ç›´æ¥æ ¹æ®é€‰æ‹©çš„è§’è‰²IDç­›é€‰å¯è§è§’è‰²
      visibleRoles = allRoles.filter(role => moment.visibleTo.includes(role.id));
      
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¯è§è§’è‰²ï¼Œå¯èƒ½æ˜¯æ—§æ•°æ®åŒ…å«'all'ï¼Œåˆ™ä½¿ç”¨æ‰€æœ‰è§’è‰²
      if (visibleRoles.length === 0 && moment.visibleTo.includes('all')) {
        visibleRoles = allRoles;
      }
      
      console.log('ğŸ‘ï¸ æœ‹å‹åœˆå¯è§è§’è‰²:', visibleRoles.map(r => r.name));
      
             // æ£€æŸ¥APIé…ç½®
       if (!apiURL || !apiKey || !selectedModel) {
         console.log('âŒ APIé…ç½®ä¸å®Œæ•´ï¼Œæ— æ³•ç”Ÿæˆæœ‹å‹åœˆè¯„è®º');
         return;
       }
       
       // æ ¹æ®ç”¨æˆ·è®¾ç½®çš„è¯„è®ºæ¨¡å¼é€‰æ‹©è§’è‰²
       let commentingRoles = [];
       const commentMode = momentsSettings.commentMode || 'smart';
       
       console.log('ğŸ“‹ æœ‹å‹åœˆè¯„è®ºæ¨¡å¼:', commentMode);
       
       switch (commentMode) {
         case 'none':
           // å…³é—­AIè¯„è®º
           console.log('ğŸš« AIè¯„è®ºå·²å…³é—­');
           return;
           
         case 'all':
           // æ‰€æœ‰å¯è§è§’è‰²éƒ½è¯„è®º
           commentingRoles = [...visibleRoles];
           console.log('ğŸ‘¥ æ‰€æœ‰å¯è§è§’è‰²å‚ä¸è¯„è®º:', commentingRoles.map(r => r.name));
           break;
           
         case 'random':
           // éšæœºé€‰æ‹©1-3ä¸ªè§’è‰²
           commentingRoles = visibleRoles
             .sort(() => Math.random() - 0.5)
             .slice(0, Math.floor(Math.random() * 3) + 1);
           console.log('ğŸ² éšæœºé€‰æ‹©è¯„è®ºè§’è‰²:', commentingRoles.map(r => r.name));
           break;
           
         case 'smart':
         default:
           // æ™ºèƒ½é€‰æ‹©è¯„è®ºè§’è‰²ï¼šæ ¹æ®è§’è‰²æ•°é‡å’Œå†…å®¹ç›¸å…³æ€§
           if (visibleRoles.length <= 3) {
             // å¦‚æœå¯è§è§’è‰²ä¸è¶…è¿‡3ä¸ªï¼Œå…¨éƒ¨å‚ä¸è¯„è®º
             commentingRoles = [...visibleRoles];
             console.log('ğŸ‘¥ æ™ºèƒ½æ¨¡å¼-æ‰€æœ‰å¯è§è§’è‰²å‚ä¸è¯„è®º:', commentingRoles.map(r => r.name));
           } else {
             // å¦‚æœè§’è‰²è¾ƒå¤šï¼Œä½¿ç”¨æ™ºèƒ½é€‰æ‹©ç­–ç•¥
             const contentLower = moment.content.toLowerCase();
             
             // ä¼˜å…ˆé€‰æ‹©è¢«æåŠçš„è§’è‰²
             const mentionedRoles = visibleRoles.filter(role => 
               contentLower.includes(role.name.toLowerCase())
             );
             
             // éšæœºé€‰æ‹©å…¶ä»–è§’è‰²ï¼Œç¡®ä¿è‡³å°‘æœ‰2-4ä¸ªè§’è‰²è¯„è®º
             const otherRoles = visibleRoles.filter(role => 
               !mentionedRoles.includes(role)
             );
             
             // è®¡ç®—éœ€è¦çš„é¢å¤–è§’è‰²æ•°é‡
             const minCommenters = Math.min(2, visibleRoles.length);
             const maxCommenters = Math.min(4, visibleRoles.length);
             const targetCount = Math.floor(Math.random() * (maxCommenters - minCommenters + 1)) + minCommenters;
             
             commentingRoles = [...mentionedRoles];
             
             // å¦‚æœè¢«æåŠçš„è§’è‰²ä¸å¤Ÿï¼Œéšæœºæ·»åŠ å…¶ä»–è§’è‰²
             if (commentingRoles.length < targetCount) {
               const shuffledOthers = otherRoles.sort(() => Math.random() - 0.5);
               const needed = targetCount - commentingRoles.length;
               commentingRoles.push(...shuffledOthers.slice(0, needed));
             }
             
             console.log('ğŸ§  æ™ºèƒ½é€‰æ‹©è¯„è®ºè§’è‰²:', {
               total: visibleRoles.length,
               mentioned: mentionedRoles.map(r => r.name),
               selected: commentingRoles.map(r => r.name),
               target: targetCount
             });
           }
           break;
       }
       
       for (const role of commentingRoles) {
        try {
          // æ„å»ºè¯„è®ºè¯·æ±‚
                     const messages = [
             { 
               role: 'system', 
               content: `ä½ æ˜¯${role.name}ã€‚è§’è‰²è®¾å®šï¼š${role.description}\nè¯·å§‹ç»ˆä¿æŒè¿™ä¸ªè§’è‰²çš„èº«ä»½ã€æ€§æ ¼å’Œè¯´è¯æ–¹å¼ã€‚` 
             },
                            { 
                 role: 'user', 
                 content: `ç”¨æˆ·åœ¨æœ‹å‹åœˆå‘å¸ƒäº†ä»¥ä¸‹å†…å®¹ï¼š"${moment.content}"${moment.images.length > 0 ? `å¹¶ä¸”å‘å¸ƒäº†${moment.images.length}å¼ å›¾ç‰‡ã€‚` : ''}\nè¯·ä»¥${role.name}çš„èº«ä»½å’Œè¯­æ°”ï¼Œå¯¹è¿™æ¡æœ‹å‹åœˆè¿›è¡Œç®€çŸ­çš„è¯„è®ºå›å¤ï¼ˆé™åˆ¶åœ¨50å­—ä»¥å†…ï¼‰ã€‚è¦ç¬¦åˆè§’è‰²çš„æ€§æ ¼ç‰¹ç‚¹ã€‚\n\næ³¨æ„ï¼šå¦‚æœä½ æƒ³å‘å¤šæ¡è¯„è®ºï¼Œå¯ä»¥ç”¨åæ–œæ  \\ åˆ†éš”ä¸åŒçš„è¯„è®ºå†…å®¹ã€‚` 
               }
           ];
           
           console.log(`ğŸ“¤ ä¸ºè§’è‰² ${role.name} ç”Ÿæˆæœ‹å‹åœˆè¯„è®º...`);
           const response = await callChatAPI(messages);
           
                       if (response && response.trim()) {
              // å¤„ç†åæ–œæ åˆ†éš”çš„å¤šä¸ªè¯„è®º
              const commentTexts = response.trim().split('\\').map(text => text.trim()).filter(text => text.length > 0);
              
              console.log(`âœ… è§’è‰² ${role.name} ç”Ÿæˆäº† ${commentTexts.length} æ¡è¯„è®º:`, commentTexts);
              
              // ä¸ºæ¯ä¸ªè¯„è®ºæ–‡æœ¬åˆ›å»ºå•ç‹¬çš„è¯„è®º
              commentTexts.forEach((text, index) => {
                const newComment = {
                  id: generateId(),
                  author: role.name,
                  avatar: role.avatar || DEFAULT_AI_AVATAR,
                  text: text,
                  timestamp: Date.now() + index * 100 // ç¨å¾®é”™å¼€æ—¶é—´æˆ³
                };
                
                moment.comments.push(newComment);
              });
              
              saveMoments();
              renderMoments();
            } else {
              console.log(`âŒ è§’è‰² ${role.name} è¯„è®ºç”Ÿæˆå¤±è´¥ï¼ŒAPIè¿”å›ç©ºå“åº”`);
            }
        } catch (error) {
          console.error(`è§’è‰² ${role.name} è¯„è®ºå¤±è´¥:`, error);
        }
        
        // éšæœºå»¶è¿Ÿ1-5ç§’å†è¯„è®ºä¸‹ä¸€ä¸ª
        await new Promise(resolve => setTimeout(resolve, Math.random() * 4000 + 1000));
      }
    }
    
    // åˆ‡æ¢ç‚¹èµ
    function toggleLike(momentId) {
      const moment = moments.find(m => m.id === momentId);
      if (!moment) return;
      
      moment.isLiked = !moment.isLiked;
      moment.likes += moment.isLiked ? 1 : -1;
      moment.likes = Math.max(0, moment.likes);
      
      saveMoments();
      renderMoments();
    }
    
    // è¯„è®ºæœ‹å‹åœˆï¼ˆç‚¹å‡»è¯„è®ºæŒ‰é’®æ—¶èšç„¦åˆ°è¾“å…¥æ¡†ï¼‰
    function commentMoment(momentId) {
      const commentInput = document.getElementById(`comment-input-${momentId}`);
      if (commentInput) {
        commentInput.focus();
        
        // æ»šåŠ¨åˆ°è¯„è®ºåŒº
        const commentsSection = document.getElementById(`comments-${momentId}`);
        if (commentsSection) {
          commentsSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }
    
    // é¢„è§ˆå›¾ç‰‡
    function previewImage(src) {
      imagePreviewContent.src = src;
      imagePreviewModal.classList.add('show');
    }
    
    // ç»‘å®šæœ‹å‹åœˆäº‹ä»¶
    function bindMomentEvents() {
      // ç»‘å®šè¯„è®ºè¾“å…¥æ¡†çš„äº‹ä»¶
      document.querySelectorAll('.comment-input').forEach(input => {
        input.addEventListener('input', function() {
          const momentId = this.id.replace('comment-input-', '');
          handleCommentInput({ target: this }, momentId);
        });
        
        input.addEventListener('keydown', function(e) {
          const momentId = this.id.replace('comment-input-', '');
          handleCommentKeydown(e, momentId);
        });
      });
    }
    
    // åˆ‡æ¢è¯„è®ºå±•å¼€/æ”¶èµ·
    function toggleComments(momentId) {
      const commentsList = document.getElementById(`list-${momentId}`);
      const toggleBtn = document.getElementById(`toggle-${momentId}`);
      
      if (commentsList.classList.contains('collapsed')) {
        commentsList.classList.remove('collapsed');
        toggleBtn.textContent = 'æ”¶èµ·';
      } else {
        commentsList.classList.add('collapsed');
        toggleBtn.textContent = 'å±•å¼€å…¨éƒ¨';
      }
    }
    
    // å›å¤è¯„è®º
    function replyToComment(momentId, commentId, authorName) {
      const replyIndicator = document.getElementById(`reply-indicator-${momentId}`);
      const replyText = document.getElementById(`reply-text-${momentId}`);
      const commentInput = document.getElementById(`comment-input-${momentId}`);
      
      currentReplyTo = { momentId, commentId, authorName };
      
      replyIndicator.style.display = 'flex';
      replyText.textContent = `æ­£åœ¨å›å¤ ${authorName}`;
      commentInput.placeholder = `å›å¤ ${authorName}...`;
      commentInput.focus();
    }
    
    // å–æ¶ˆå›å¤
    function cancelReply(momentId) {
      const replyIndicator = document.getElementById(`reply-indicator-${momentId}`);
      const commentInput = document.getElementById(`comment-input-${momentId}`);
      
      currentReplyTo = null;
      replyIndicator.style.display = 'none';
      commentInput.placeholder = 'å†™è¯„è®º...';
    }
    
    // å‘é€è¯„è®º
    function sendComment(momentId) {
      const commentInput = document.getElementById(`comment-input-${momentId}`);
      const content = commentInput.value.trim();
      
      if (!content) return;
      
      const moment = moments.find(m => m.id === momentId);
      if (!moment) return;
      
      const comment = {
        id: generateId(),
        author: userName || 'æˆ‘',
        avatar: userAvatar || DEFAULT_USER_AVATAR,
        text: content,
        timestamp: Date.now()
      };
      
      let replyToRoleName = null;
      
      // å¦‚æœæ˜¯å›å¤
      if (currentReplyTo && currentReplyTo.momentId === momentId) {
        comment.replyTo = currentReplyTo.authorName;
        comment.replyToId = currentReplyTo.commentId;
        replyToRoleName = currentReplyTo.authorName;
        
        console.log('ğŸ“ ç”¨æˆ·å›å¤äº†è¯„è®º:', {
          replyTo: currentReplyTo.authorName,
          content: content
        });
      }
      
      moment.comments.push(comment);
      saveMoments();
      renderMoments();
      
      // æ¸…ç©ºè¾“å…¥
      commentInput.value = '';
      cancelReply(momentId);
      
      // ç”ŸæˆAIå›å¤
      setTimeout(() => {
        // é¦–å…ˆå¤„ç†@æåŠçš„è§’è‰²
        generateAIReplies(momentId, content);
        
        // ç„¶åå¤„ç†è¢«å›å¤çš„è§’è‰²ï¼ˆå¦‚æœä¸æ˜¯ç”¨æˆ·è‡ªå·±ä¸”æ²¡æœ‰è¢«@æåŠï¼‰
        if (replyToRoleName && replyToRoleName !== (userName || 'æˆ‘')) {
          const mentions = content.match(/@(\w+)/g);
          const mentionedNames = mentions ? mentions.map(m => m.substring(1)) : [];
          
          // å¦‚æœè¢«å›å¤çš„è§’è‰²æ²¡æœ‰è¢«@æåŠï¼Œåˆ™è‡ªåŠ¨è§¦å‘è¯¥è§’è‰²çš„å›å¤
          if (!mentionedNames.includes(replyToRoleName)) {
            console.log('ğŸ¯ è‡ªåŠ¨è§¦å‘è¢«å›å¤è§’è‰²çš„å›å¤:', replyToRoleName);
            generateDirectRoleReply(momentId, content, replyToRoleName);
          }
        }
      }, 1000);
    }
    
    // å¤„ç†è¯„è®ºè¾“å…¥
    function handleCommentInput(event, momentId) {
      const input = event.target;
      const value = input.value;
      const cursorPos = input.selectionStart;
      
      // æ£€æŸ¥æ˜¯å¦è¾“å…¥äº†@
      const beforeCursor = value.substring(0, cursorPos);
      const atMatch = beforeCursor.match(/@(\w*)$/);
      
      if (atMatch) {
        const query = atMatch[1].toLowerCase();
        showMentionSuggestions(momentId, query, input);
      } else {
        hideMentionSuggestions(momentId);
      }
      
      // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 80) + 'px';
    }
    
    // å¤„ç†è¯„è®ºæŒ‰é”®
    function handleCommentKeydown(event, momentId) {
      const mentionsEl = document.getElementById(`mentions-${momentId}`);
      
      if (mentionsEl.classList.contains('show')) {
        if (event.key === 'ArrowDown') {
          event.preventDefault();
          selectedMentionIndex = Math.min(selectedMentionIndex + 1, mentionSuggestions.length - 1);
          updateMentionSelection(momentId);
        } else if (event.key === 'ArrowUp') {
          event.preventDefault();
          selectedMentionIndex = Math.max(selectedMentionIndex - 1, 0);
          updateMentionSelection(momentId);
        } else if (event.key === 'Enter' && selectedMentionIndex >= 0) {
          event.preventDefault();
          selectMention(momentId, selectedMentionIndex);
        } else if (event.key === 'Escape') {
          hideMentionSuggestions(momentId);
        }
      } else if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendComment(momentId);
      }
    }
    
    // æ˜¾ç¤º@æåŠå»ºè®®
    function showMentionSuggestions(momentId, query, input) {
      const allRoles = getAllRoles();
      const filteredRoles = allRoles.filter(role => 
        role.name.toLowerCase().includes(query)
      );
      
      if (filteredRoles.length === 0) {
        hideMentionSuggestions(momentId);
        return;
      }
      
      mentionSuggestions = filteredRoles;
      selectedMentionIndex = 0;
      
      const mentionsEl = document.getElementById(`mentions-${momentId}`);
      mentionsEl.innerHTML = filteredRoles.map((role, index) => `
        <div class="mention-item ${index === 0 ? 'selected' : ''}" data-index="${index}" onclick="selectMention('${momentId}', ${index})">
          <img class="mention-avatar" src="${role.avatar}" alt="${role.name}">
          <span class="mention-name">${role.name}</span>
        </div>
      `).join('');
      
      mentionsEl.classList.add('show');
    }
    
    // éšè—@æåŠå»ºè®®
    function hideMentionSuggestions(momentId) {
      const mentionsEl = document.getElementById(`mentions-${momentId}`);
      mentionsEl.classList.remove('show');
      mentionSuggestions = [];
      selectedMentionIndex = -1;
    }
    
    // æ›´æ–°@æåŠé€‰æ‹©
    function updateMentionSelection(momentId) {
      const mentionsEl = document.getElementById(`mentions-${momentId}`);
      const items = mentionsEl.querySelectorAll('.mention-item');
      
      items.forEach((item, index) => {
        if (index === selectedMentionIndex) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }
    
    // é€‰æ‹©@æåŠ
    function selectMention(momentId, index) {
      const role = mentionSuggestions[index];
      if (!role) return;
      
      const input = document.getElementById(`comment-input-${momentId}`);
      const value = input.value;
      const cursorPos = input.selectionStart;
      
      // æŸ¥æ‰¾@ä½ç½®
      const beforeCursor = value.substring(0, cursorPos);
      const atMatch = beforeCursor.match(/@(\w*)$/);
      
      if (atMatch) {
        const newValue = value.substring(0, atMatch.index) + `@${role.name} ` + value.substring(cursorPos);
        input.value = newValue;
        
        // è®¾ç½®å…‰æ ‡ä½ç½®
        const newCursorPos = atMatch.index + role.name.length + 2;
        input.setSelectionRange(newCursorPos, newCursorPos);
      }
      
      hideMentionSuggestions(momentId);
      input.focus();
    }
    
    // ç”ŸæˆAIå›å¤ï¼ˆå¤„ç†@æåŠï¼‰
    async function generateAIReplies(momentId, content) {
      console.log('ğŸ” å¼€å§‹ç”ŸæˆAIå›å¤ï¼Œå†…å®¹:', content);
      
      // æ£€æŸ¥æ˜¯å¦æœ‰@æŸä¸ªè§’è‰²
      const mentions = content.match(/@(\w+)/g);
      if (!mentions) {
        console.log('âŒ æ²¡æœ‰æ‰¾åˆ°@æåŠ');
        return;
      }
      
      console.log('ğŸ‘¥ æ‰¾åˆ°@æåŠ:', mentions);
      
      const moment = moments.find(m => m.id === momentId);
      if (!moment) {
        console.log('âŒ æ‰¾ä¸åˆ°å¯¹åº”çš„æœ‹å‹åœˆåŠ¨æ€');
        return;
      }
      
      const allRoles = getAllRoles();
      console.log('ğŸ­ æ‰€æœ‰å¯ç”¨è§’è‰²:', allRoles.map(r => r.name));
      
      // æ£€æŸ¥APIé…ç½®
      if (!apiURL || !apiKey || !selectedModel) {
        console.log('âŒ APIé…ç½®ä¸å®Œæ•´ï¼Œæ— æ³•ç”Ÿæˆå›å¤');
        console.log('APIé…ç½®çŠ¶æ€:', { apiURL: !!apiURL, apiKey: !!apiKey, selectedModel: !!selectedModel });
        alert('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®APIä¿¡æ¯æ‰èƒ½ä½¿ç”¨AIè§’è‰²å›å¤åŠŸèƒ½');
        return;
      }
      
      console.log('âœ… APIé…ç½®å®Œæ•´:', { apiURL, selectedModel });
      
      for (const mention of mentions) {
        const roleName = mention.substring(1); // å»æ‰@ç¬¦å·
        const role = allRoles.find(r => r.name === roleName);
        
        if (role) {
          console.log(`ğŸ¤– æ­£åœ¨ä¸ºè§’è‰² ${role.name} ç”Ÿæˆ@å›å¤...`);
          
          try {
            const messages = [
              { 
                role: 'system', 
                content: `ä½ æ˜¯${role.name}ã€‚è§’è‰²è®¾å®šï¼š${role.description}
                
é‡è¦æ ¼å¼è¦æ±‚ï¼š
1. ç”¨ï¼ˆï¼‰åŒ…è£¹åŠ¨ä½œæè¿°
2. ä¸¥æ ¼éµå¾ªä½¿ç”¨åæ–œçº¿\\åˆ†éš”å¥å­çš„è¦æ±‚ï¼Œæ¯ä¸ªå¥å­æ§åˆ¶åœ¨50å­—ä»¥å†…
3. å›å¤è¾“å‡ºç¤ºä¾‹æ ¼å¼ï¼šç¬¬ä¸€å¥è¯\\ç¬¬äºŒå¥è¯\\ç¬¬ä¸‰å¥è¯

è¯·å§‹ç»ˆä¿æŒè¿™ä¸ªè§’è‰²çš„èº«ä»½ã€æ€§æ ¼å’Œè¯´è¯æ–¹å¼ã€‚` 
              },
              { 
                role: 'user', 
                content: `ç”¨æˆ·åœ¨æœ‹å‹åœˆè¯„è®ºä¸­@äº†ä½ ï¼Œå†…å®¹æ˜¯ï¼š"${content}"\nè¯·ä»¥${role.name}çš„èº«ä»½å’Œè¯­æ°”ï¼Œå¯¹è¿™ä¸ª@ä½ çš„è¯„è®ºè¿›è¡Œç®€çŸ­å›å¤ï¼ˆé™åˆ¶åœ¨30å­—ä»¥å†…ï¼‰ã€‚è¦ç¬¦åˆè§’è‰²çš„æ€§æ ¼ç‰¹ç‚¹ã€‚

ç¤ºä¾‹ï¼š
ç”¨æˆ·@è¯„è®ºï¼š@å°é›ª ä½ å¥½å¯çˆ±
å›å¤ï¼š(å®³ç¾)è°¢è°¢å¤¸å¥–\\äººå®¶ä¼šä¸å¥½æ„æ€çš„

ä¸¥æ ¼æŒ‰ç…§æ ¼å¼è¦æ±‚å›å¤ã€‚` 
              }
            ];
            
            console.log('ğŸ“¤ å‘é€APIè¯·æ±‚...');
            const response = await callChatAPI(messages);
            
            console.log('ğŸ“¥ æ”¶åˆ°APIå“åº”:', response);
            
            if (response && response.trim()) {
              // å¤„ç†åæ–œæ åˆ†éš”çš„å¤šä¸ªå›å¤
              const replyTexts = response.trim().split('\\').map(text => text.trim()).filter(text => text.length > 0);
              
              console.log(`âœ… è§’è‰² ${role.name} ç”Ÿæˆäº† ${replyTexts.length} æ¡@å›å¤:`, replyTexts);
              
              // ä¸ºæ¯ä¸ªå›å¤æ–‡æœ¬åˆ›å»ºå•ç‹¬çš„è¯„è®º
              replyTexts.forEach((text, index) => {
                const newComment = {
                  id: generateId(),
                  author: role.name,
                  avatar: role.avatar || DEFAULT_AI_AVATAR,
                  text: text,
                  timestamp: Date.now() + index * 100, // ç¨å¾®é”™å¼€æ—¶é—´æˆ³
                  replyTo: userName || 'æˆ‘'
                };
                
                moment.comments.push(newComment);
              });
              
              console.log('âœ… æ·»åŠ æ–°@å›å¤è¯„è®º');
              
              saveMoments();
              renderMoments();
              
              // æ˜¾ç¤ºæˆåŠŸæç¤º
              console.log(`âœ¨ è§’è‰² ${role.name} å·²å›å¤@è¯„è®º`);
            } else {
              console.log('âŒ APIè¿”å›ç©ºå“åº”');
            }
          } catch (error) {
            console.error(`âŒ è§’è‰² ${role.name} @å›å¤å¤±è´¥:`, error);
            
            // æ·»åŠ é”™è¯¯å¤„ç†çš„æç¤º
            if (error.message.includes('API')) {
              alert(`AIè§’è‰²å›å¤å¤±è´¥ï¼š${error.message}\nè¯·æ£€æŸ¥APIé…ç½®æ˜¯å¦æ­£ç¡®`);
            }
          }
          
          // å»¶è¿Ÿå›å¤
          await new Promise(resolve => setTimeout(resolve, 2000));
        } else {
          console.log(`âŒ æ‰¾ä¸åˆ°è§’è‰²: ${roleName}`);
        }
      }
    }
    
    // ç”Ÿæˆç›´æ¥è§’è‰²å›å¤ï¼ˆå¤„ç†ç›´æ¥å›å¤è§’è‰²è¯„è®ºçš„æƒ…å†µï¼‰
    async function generateDirectRoleReply(momentId, content, roleName) {
      console.log('ğŸ¯ å¼€å§‹ç”Ÿæˆç›´æ¥è§’è‰²å›å¤:', { roleName, content });
      
      const moment = moments.find(m => m.id === momentId);
      if (!moment) {
        console.log('âŒ æ‰¾ä¸åˆ°å¯¹åº”çš„æœ‹å‹åœˆåŠ¨æ€');
        return;
      }
      
      const allRoles = getAllRoles();
      const role = allRoles.find(r => r.name === roleName);
      
      if (!role) {
        console.log(`âŒ æ‰¾ä¸åˆ°è§’è‰²: ${roleName}`);
        return;
      }
      
      // æ£€æŸ¥APIé…ç½®
      if (!apiURL || !apiKey || !selectedModel) {
        console.log('âŒ APIé…ç½®ä¸å®Œæ•´ï¼Œæ— æ³•ç”Ÿæˆè§’è‰²å›å¤');
        return;
      }
      
      console.log(`ğŸ¤– æ­£åœ¨ä¸ºè§’è‰² ${role.name} ç”Ÿæˆç›´æ¥å›å¤...`);
      
      try {
        const messages = [
          { 
            role: 'system', 
            content: `ä½ æ˜¯${role.name}ã€‚è§’è‰²è®¾å®šï¼š${role.description}
            
é‡è¦æ ¼å¼è¦æ±‚ï¼š
1. ç”¨ï¼ˆï¼‰åŒ…è£¹åŠ¨ä½œæè¿°
2. ä¸¥æ ¼éµå¾ªä½¿ç”¨åæ–œçº¿\\åˆ†éš”å¥å­çš„è¦æ±‚ï¼Œæ¯ä¸ªå¥å­æ§åˆ¶åœ¨50å­—ä»¥å†…
3. å›å¤è¾“å‡ºç¤ºä¾‹æ ¼å¼ï¼šç¬¬ä¸€å¥è¯\\ç¬¬äºŒå¥è¯\\ç¬¬ä¸‰å¥è¯

è¯·å§‹ç»ˆä¿æŒè¿™ä¸ªè§’è‰²çš„èº«ä»½ã€æ€§æ ¼å’Œè¯´è¯æ–¹å¼ã€‚` 
          },
          { 
            role: 'user', 
            content: `ç”¨æˆ·å›å¤äº†ä½ çš„æœ‹å‹åœˆè¯„è®ºï¼Œå†…å®¹æ˜¯ï¼š"${content}"\nè¯·ä»¥${role.name}çš„èº«ä»½å’Œè¯­æ°”ï¼Œå¯¹ç”¨æˆ·çš„å›å¤è¿›è¡Œç®€çŸ­çš„å›åº”ï¼ˆé™åˆ¶åœ¨30å­—ä»¥å†…ï¼‰ã€‚è¦ç¬¦åˆè§’è‰²çš„æ€§æ ¼ç‰¹ç‚¹ï¼Œè¡¨ç°å‡ºè¢«å›å¤æ—¶çš„ååº”ã€‚

ç¤ºä¾‹ï¼š
ç”¨æˆ·å›å¤ï¼šä½ è¯´å¾—å¯¹
å›å¤ï¼š(å¼€å¿ƒ)æ˜¯å§\\æˆ‘ä¹Ÿè¿™ä¹ˆè§‰å¾—

ä¸¥æ ¼æŒ‰ç…§æ ¼å¼è¦æ±‚å›å¤ã€‚` 
          }
        ];
        
        console.log('ğŸ“¤ å‘é€ç›´æ¥å›å¤APIè¯·æ±‚...');
        const response = await callChatAPI(messages);
        
        console.log('ğŸ“¥ æ”¶åˆ°ç›´æ¥å›å¤APIå“åº”:', response);
        
        if (response && response.trim()) {
          // å¤„ç†åæ–œæ åˆ†éš”çš„å¤šä¸ªå›å¤
          const replyTexts = response.trim().split('\\').map(text => text.trim()).filter(text => text.length > 0);
          
          console.log(`âœ… è§’è‰² ${role.name} ç”Ÿæˆäº† ${replyTexts.length} æ¡ç›´æ¥å›å¤:`, replyTexts);
          
          // ä¸ºæ¯ä¸ªå›å¤æ–‡æœ¬åˆ›å»ºå•ç‹¬çš„è¯„è®º
          replyTexts.forEach((text, index) => {
            const newComment = {
              id: generateId(),
              author: role.name,
              avatar: role.avatar || DEFAULT_AI_AVATAR,
              text: text,
              timestamp: Date.now() + index * 100 + 1500, // ç¨å¾®å»¶è¿Ÿï¼Œè®©å®ƒçœ‹èµ·æ¥åƒæ˜¯åœ¨ç”¨æˆ·è¯„è®ºåå›å¤çš„
              replyTo: userName || 'æˆ‘'
            };
            
            moment.comments.push(newComment);
          });
          
          console.log('âœ… æ·»åŠ æ–°ç›´æ¥å›å¤è¯„è®º');
          
          saveMoments();
          renderMoments();
          
          // æ˜¾ç¤ºæˆåŠŸæç¤º
          console.log(`âœ¨ è§’è‰² ${role.name} å·²ç›´æ¥å›å¤ç”¨æˆ·`);
        } else {
          console.log('âŒ ç›´æ¥å›å¤APIè¿”å›ç©ºå“åº”');
        }
      } catch (error) {
        console.error(`âŒ è§’è‰² ${role.name} ç›´æ¥å›å¤å¤±è´¥:`, error);
      }
    }
    
    // æµ‹è¯•AIå›å¤åŠŸèƒ½
    async function testAIReply() {
      const testContent = publishTextarea.value.trim() || "æµ‹è¯•æœ‹å‹åœˆå†…å®¹";
      const allRoles = getAllRoles();
      
      if (allRoles.length === 0) {
        alert('æ²¡æœ‰æ‰¾åˆ°ä»»ä½•è§’è‰²ï¼è¯·å…ˆåˆ›å»ºèŠå¤©å¹¶è®¾ç½®è§’è‰²ã€‚');
        return;
      }
      
      if (!apiURL || !apiKey || !selectedModel) {
        alert('è¯·å…ˆé…ç½®APIè®¾ç½®ï¼');
        return;
      }
      
      const testRole = allRoles[0]; // ä½¿ç”¨ç¬¬ä¸€ä¸ªè§’è‰²æµ‹è¯•
      console.log('ğŸ§ª æµ‹è¯•AIå›å¤åŠŸèƒ½...');
      console.log('æµ‹è¯•è§’è‰²:', testRole);
      console.log('æµ‹è¯•å†…å®¹:', testContent);
      
      try {
        const messages = [
          { 
            role: 'system', 
            content: `ä½ æ˜¯${testRole.name}ã€‚è§’è‰²è®¾å®šï¼š${testRole.description}\nè¯·å§‹ç»ˆä¿æŒè¿™ä¸ªè§’è‰²çš„èº«ä»½ã€æ€§æ ¼å’Œè¯´è¯æ–¹å¼ã€‚` 
          },
                     { 
             role: 'user', 
             content: `ç”¨æˆ·åœ¨æœ‹å‹åœˆå‘å¸ƒäº†ä»¥ä¸‹å†…å®¹ï¼š"${testContent}"\nè¯·ä»¥${testRole.name}çš„èº«ä»½å’Œè¯­æ°”ï¼Œå¯¹è¿™æ¡æœ‹å‹åœˆè¿›è¡Œç®€çŸ­çš„è¯„è®ºå›å¤ï¼ˆé™åˆ¶åœ¨50å­—ä»¥å†…ï¼‰ã€‚è¦ç¬¦åˆè§’è‰²çš„æ€§æ ¼ç‰¹ç‚¹ã€‚\n\næ³¨æ„ï¼šå¦‚æœä½ æƒ³å‘å¤šæ¡è¯„è®ºï¼Œå¯ä»¥ç”¨åæ–œæ  \\ åˆ†éš”ä¸åŒçš„è¯„è®ºå†…å®¹ã€‚` 
           }
        ];
        
        console.log('ğŸ“¤ å‘é€æµ‹è¯•è¯·æ±‚...');
        const response = await callChatAPI(messages);
        
        if (response && response.trim()) {
          // å¤„ç†åæ–œæ åˆ†éš”çš„å¤šä¸ªå›å¤
          const testTexts = response.trim().split('\\').map(text => text.trim()).filter(text => text.length > 0);
          
          if (testTexts.length > 1) {
            alert(`âœ… AIå›å¤æµ‹è¯•æˆåŠŸï¼\n\nè§’è‰²: ${testRole.name}\nç”Ÿæˆäº† ${testTexts.length} æ¡å›å¤:\n\n${testTexts.map((text, i) => `${i + 1}. ${text}`).join('\n\n')}`);
          } else {
            alert(`âœ… AIå›å¤æµ‹è¯•æˆåŠŸï¼\n\nè§’è‰²: ${testRole.name}\nå›å¤: ${testTexts[0]}`);
          }
          console.log('âœ… æµ‹è¯•æˆåŠŸ:', testTexts);
        } else {
          alert('âŒ AIå›å¤æµ‹è¯•å¤±è´¥ï¼šAPIè¿”å›ç©ºå“åº”');
          console.log('âŒ æµ‹è¯•å¤±è´¥ï¼šç©ºå“åº”');
        }
      } catch (error) {
        console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
        alert(`âŒ AIå›å¤æµ‹è¯•å¤±è´¥ï¼š\n${error.message}`);
      }
    }
    
    // ==================== æœ‹å‹åœˆè®¾ç½®åŠŸèƒ½ ====================
    
    // åŠ è½½æœ‹å‹åœˆè®¾ç½®
    function loadMomentsSettings() {
      const savedSettings = localStorage.getItem('aiChatMomentsSettings');
      if (savedSettings) {
        try {
          momentsSettings = JSON.parse(savedSettings);
          // ç¡®ä¿æ–°çš„è®¾ç½®é¡¹å­˜åœ¨
          if (!momentsSettings.commentMode) {
            momentsSettings.commentMode = 'smart';
          }
        } catch (e) {
          console.error('æœ‹å‹åœˆè®¾ç½®è§£æå¤±è´¥:', e);
          momentsSettings = {
            title: 'æˆ‘çš„æœ‹å‹åœˆ',
            coverImage: '',
            commentMode: 'smart'
          };
        }
      }
    }
    
    // ä¿å­˜æœ‹å‹åœˆè®¾ç½®
    function saveMomentsSettingsData() {
      localStorage.setItem('aiChatMomentsSettings', JSON.stringify(momentsSettings));
    }
    
    // æ›´æ–°æœ‹å‹åœˆå°é¢
    function updateMomentsCover() {
      const momentsHeader = document.querySelector('.moments-header');
      if (momentsSettings.coverImage) {
        momentsHeader.style.backgroundImage = `url('${momentsSettings.coverImage}')`;
      } else {
        // æ¢å¤é»˜è®¤èƒŒæ™¯
        momentsHeader.style.backgroundImage = `url('${getDefaultCoverUrl()}')`;
      }
    }
    
    // æ˜¾ç¤ºæœ‹å‹åœˆè®¾ç½®å¼¹çª—
    function showMomentsSettings() {
      // åˆå§‹åŒ–è®¾ç½®è¡¨å•
      momentsTitle.value = momentsSettings.title || 'æˆ‘çš„æœ‹å‹åœˆ';
      momentsCoverUrl.value = momentsSettings.coverImage || '';
      momentsCommentMode.value = momentsSettings.commentMode || 'smart';
      
      // æ›´æ–°é¢„è§ˆ
      updateCoverPreview();
      
      momentsSettingsModal.classList.add('show');
    }
    
    // éšè—æœ‹å‹åœˆè®¾ç½®å¼¹çª—
    function hideMomentsSettings() {
      momentsSettingsModal.classList.remove('show');
    }
    
    // æ›´æ–°å°é¢é¢„è§ˆ
    function updateCoverPreview() {
      const previewUrl = momentsCoverUrl.value.trim() || momentsSettings.coverImage;
      if (previewUrl) {
        momentsCoverPreview.style.backgroundImage = `url('${previewUrl}')`;
        momentsCoverPreview.textContent = '';
      } else {
        momentsCoverPreview.style.backgroundImage = `url('${getDefaultCoverUrl()}')`;
        momentsCoverPreview.textContent = 'é»˜è®¤å°é¢';
      }
    }
    
    // ä¸Šä¼ å°é¢å›¾ç‰‡
    function uploadMomentsCover() {
      momentsCoverFileInput.click();
    }
    
    // å¤„ç†å°é¢å›¾ç‰‡æ–‡ä»¶é€‰æ‹©
    function handleMomentsCoverSelect(event) {
      const file = event.target.file || event.target.files[0];
      if (!file) return;
      
      if (file.type.startsWith('image/') && file.size <= 10 * 1024 * 1024) {
        const reader = new FileReader();
        reader.onload = (e) => {
          momentsCoverUrl.value = e.target.result;
          updateCoverPreview();
        };
        reader.readAsDataURL(file);
      } else {
        alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼ˆæœ€å¤§10MBï¼‰');
      }
      
      // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
      event.target.value = '';
    }
    
    // é‡ç½®ä¸ºé»˜è®¤å°é¢
    function resetMomentsCover() {
      momentsCoverUrl.value = '';
      updateCoverPreview();
    }
    
    // è·å–å½“å‰å°é¢URL
    function getCurrentCoverUrl() {
      const momentsHeader = document.querySelector('.moments-header');
      const currentStyle = window.getComputedStyle(momentsHeader);
      const backgroundImage = currentStyle.backgroundImage;
      
      if (backgroundImage && backgroundImage !== 'none') {
        // æå–URL
        const urlMatch = backgroundImage.match(/url\(['"]?([^'"]+)['"]?\)/);
        if (urlMatch && urlMatch[1]) {
          return urlMatch[1];
        }
      }
      
      // å¦‚æœæ²¡æœ‰è®¾ç½®èƒŒæ™¯å›¾ï¼Œè¿”å›å½“å‰è®¾ç½®çš„å°é¢æˆ–é»˜è®¤å°é¢
      return momentsSettings.coverImage || getDefaultCoverUrl();
    }
    
    // å°†å½“å‰å°é¢è®¾ä¸ºé»˜è®¤å°é¢
    function setCurrentAsDefault() {
      // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„å°é¢ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰æ˜¾ç¤ºçš„å°é¢
      let currentCoverUrl = momentsSettings.coverImage;
      
      if (!currentCoverUrl) {
        // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰å°é¢ï¼Œè·å–å½“å‰æ˜¾ç¤ºçš„å°é¢
        currentCoverUrl = getCurrentCoverUrl();
      }
      
      // å¦‚æœå½“å‰å°é¢å°±æ˜¯é»˜è®¤å°é¢ï¼Œåˆ™æç¤ºç”¨æˆ·
      if (currentCoverUrl === getDefaultCoverUrl()) {
        alert('å½“å‰å°é¢å·²ç»æ˜¯é»˜è®¤å°é¢äº†ï¼');
        return;
      }
      
      const displayUrl = currentCoverUrl.length > 60 ? currentCoverUrl.substring(0, 60) + '...' : currentCoverUrl;
      
      if (confirm(`ç¡®å®šè¦å°†å½“å‰å°é¢è®¾ä¸ºæœ‹å‹åœˆé»˜è®¤å°é¢å—ï¼Ÿ\n\nå½“å‰å°é¢: ${displayUrl}\n\nè®¾ç½®åï¼Œæ‰€æœ‰æ–°ç”¨æˆ·å’Œé‡ç½®å°é¢æ—¶éƒ½ä¼šä½¿ç”¨è¿™ä¸ªå›¾ç‰‡ã€‚`)) {
        // æ›´æ–°æ‰€æœ‰é»˜è®¤å°é¢å¼•ç”¨
        updateDefaultCoverReferences(currentCoverUrl);
        alert('âœ… å·²å°†å½“å‰å°é¢è®¾ä¸ºé»˜è®¤å°é¢ï¼\n\nç°åœ¨é‡ç½®å°é¢æ—¶ä¼šä½¿ç”¨è¿™ä¸ªå›¾ç‰‡ä½œä¸ºé»˜è®¤å°é¢ã€‚');
      }
    }
    
    // æ›´æ–°ä»£ç ä¸­çš„é»˜è®¤å°é¢å¼•ç”¨
    function updateDefaultCoverReferences(newDefaultUrl) {
      console.log('æ–°çš„é»˜è®¤å°é¢URL:', newDefaultUrl);
      
      // ä¿å­˜æ–°çš„é»˜è®¤å°é¢URLåˆ°localStorage
      localStorage.setItem('aiChatDefaultMomentsCover', newDefaultUrl);
      
      // æ›´æ–°å½“å‰é¡µé¢çš„é»˜è®¤è¡Œä¸º
      window.defaultMomentsCoverUrl = newDefaultUrl;
      
      // å¦‚æœå½“å‰æ²¡æœ‰è‡ªå®šä¹‰å°é¢ï¼Œç«‹å³åº”ç”¨æ–°é»˜è®¤å°é¢
      if (!momentsSettings.coverImage) {
        const momentsHeader = document.querySelector('.moments-header');
        momentsHeader.style.backgroundImage = `url('${newDefaultUrl}')`;
        updateCoverPreview();
      }
    }
    
    // è·å–é»˜è®¤å°é¢URL
    function getDefaultCoverUrl() {
      return localStorage.getItem('aiChatDefaultMomentsCover') || 'https://i.postimg.cc/7Lr42Xqf/IMG-20250618-215711.jpg';
    }
    
    // ä¿å­˜æœ‹å‹åœˆè®¾ç½®
    function saveMomentsSettingsForm() {
      const newTitle = momentsTitle.value.trim() || 'æˆ‘çš„æœ‹å‹åœˆ';
      const newCoverImage = momentsCoverUrl.value.trim();
      const newCommentMode = momentsCommentMode.value || 'smart';
      
      momentsSettings.title = newTitle;
      momentsSettings.coverImage = newCoverImage;
      momentsSettings.commentMode = newCommentMode;
      
      saveMomentsSettingsData();
      updateMomentsUserInfo();
      hideMomentsSettings();
      
      // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
      alert('æœ‹å‹åœˆè®¾ç½®å·²ä¿å­˜ï¼');
    }
    
    // ==================== æœ‹å‹åœˆè®¾ç½®åŠŸèƒ½ç»“æŸ ====================
    
    // ç»‘å®šæœ‹å‹åœˆç›¸å…³äº‹ä»¶
    momentsBtn.onclick = showMoments;
    momentsBackBtn.onclick = hideMoments;
    momentsSettingsBtn.onclick = showMomentsSettings;
    publishText.onclick = showPublishModal;
    momentsPublishArea.onclick = showPublishModal;
    publishModalClose.onclick = hidePublishModal;
    publishCancel.onclick = hidePublishModal;
    publishConfirm.onclick = publishMoment;
    document.getElementById('testAIReply').onclick = testAIReply;
    momentImageInput.onchange = handleImageSelect;
    addImageBtn.onclick = addImages;
    imagePreviewClose.onclick = () => imagePreviewModal.classList.remove('show');
    
    // æœ‹å‹åœˆè®¾ç½®äº‹ä»¶
    momentsSettingsClose.onclick = hideMomentsSettings;
    cancelMomentsSettings.onclick = hideMomentsSettings;
    saveMomentsSettings.onclick = saveMomentsSettingsForm;
    uploadMomentsCoverBtn.onclick = uploadMomentsCover;
    resetMomentsCoverBtn.onclick = resetMomentsCover;
    document.getElementById('setAsDefaultBtn').onclick = setCurrentAsDefault;
    momentsCoverFileInput.onchange = handleMomentsCoverSelect;
    momentsCoverUrl.oninput = updateCoverPreview;
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
    publishModal.onclick = (e) => {
      if (e.target === publishModal) {
        hidePublishModal();
      }
    };
    
    imagePreviewModal.onclick = (e) => {
      if (e.target === imagePreviewModal) {
        imagePreviewModal.classList.remove('show');
      }
    };
    
    momentsSettingsModal.onclick = (e) => {
      if (e.target === momentsSettingsModal) {
        hideMomentsSettings();
      }
    };
    
    // åˆå§‹åŒ–æœ‹å‹åœˆ
    initMoments();
    
    // åˆå§‹åŒ–é»˜è®¤å°é¢
    setTimeout(() => {
      updateMomentsCover();
    }, 100);
    
    // ==================== æœ‹å‹åœˆåŠŸèƒ½ç»“æŸ ====================
    
    // ==================== ä¸»é¢˜è®¾ç½®åŠŸèƒ½ ====================
    
    // ä¸»é¢˜è®¾ç½®ç›¸å…³å˜é‡
    let currentTheme = {
      headerColor: '#6DA3BD',
      chatBgColor: '#f5f5f5',
      chatBgImage: '',
      userBubbleColor: '#95EC69',
      aiBubbleColor: '#FFFFFF',
      fontFamily: 'å¾®è½¯é›…é»‘, Arial, sans-serif',
      fontColor: '#333333',
      headerBorderRadius: '10',
      headerOpacity: '1',
      headerShadow: 'normal',
      bubbleBorderRadius: '18',
      bubbleOpacity: '0.95',
      bubbleShadow: 'light',
      bubbleBorder: 'none'
    };
    
    // è‡ªå®šä¹‰å­—ä½“å­˜å‚¨
    let customFonts = [];
    
    // é¢„è®¾ä¸»é¢˜
    const themePresets = {
      default: {
        headerColor: '#6DA3BD',
        chatBgColor: '#f5f5f5',
        chatBgImage: '',
        userBubbleColor: '#95EC69',
        aiBubbleColor: '#FFFFFF',
        fontFamily: 'å¾®è½¯é›…é»‘, Arial, sans-serif',
        fontColor: '#333333',
        headerBorderRadius: '10',
        headerOpacity: '1',
        headerShadow: 'normal',
        bubbleBorderRadius: '18',
        bubbleOpacity: '0.95',
        bubbleShadow: 'light',
        bubbleBorder: 'none'
      },
      dark: {
        headerColor: '#2c3e50',
        chatBgColor: '#34495e',
        chatBgImage: '',
        userBubbleColor: '#3498db',
        aiBubbleColor: '#2c3e50',
        fontFamily: 'å¾®è½¯é›…é»‘, Arial, sans-serif',
        fontColor: '#ecf0f1',
        headerBorderRadius: '10',
        headerOpacity: '1',
        headerShadow: 'normal',
        bubbleBorderRadius: '18',
        bubbleOpacity: '0.95',
        bubbleShadow: 'light',
        bubbleBorder: 'none'
      },
      blue: {
        headerColor: '#3498db',
        chatBgColor: '#ebf3fd',
        chatBgImage: '',
        userBubbleColor: '#5dade2',
        aiBubbleColor: '#ffffff',
        fontFamily: 'å¾®è½¯é›…é»‘, Arial, sans-serif',
        fontColor: '#2c3e50',
        headerBorderRadius: '10',
        headerOpacity: '1',
        headerShadow: 'normal',
        bubbleBorderRadius: '18',
        bubbleOpacity: '0.95',
        bubbleShadow: 'light',
        bubbleBorder: 'none'
      },
      green: {
        headerColor: '#27ae60',
        chatBgColor: '#eafaf1',
        chatBgImage: '',
        userBubbleColor: '#58d68d',
        aiBubbleColor: '#ffffff',
        fontFamily: 'å¾®è½¯é›…é»‘, Arial, sans-serif',
        fontColor: '#1e8449',
        headerBorderRadius: '10',
        headerOpacity: '1',
        headerShadow: 'normal',
        bubbleBorderRadius: '18',
        bubbleOpacity: '0.95',
        bubbleShadow: 'light',
        bubbleBorder: 'none'
      },
      purple: {
        headerColor: '#8e44ad',
        chatBgColor: '#f4ecf7',
        chatBgImage: '',
        userBubbleColor: '#bb8fce',
        aiBubbleColor: '#ffffff',
        fontFamily: 'å¾®è½¯é›…é»‘, Arial, sans-serif',
        fontColor: '#6c3483',
        headerBorderRadius: '10',
        headerOpacity: '1',
        headerShadow: 'normal',
        bubbleBorderRadius: '18',
        bubbleOpacity: '0.95',
        bubbleShadow: 'light',
        bubbleBorder: 'none'
      },
      pink: {
        headerColor: '#e91e63',
        chatBgColor: '#fce4ec',
        chatBgImage: '',
        userBubbleColor: '#f48fb1',
        aiBubbleColor: '#ffffff',
        fontFamily: 'å¾®è½¯é›…é»‘, Arial, sans-serif',
        fontColor: '#ad1457',
        headerBorderRadius: '10',
        headerOpacity: '1',
        headerShadow: 'normal',
        bubbleBorderRadius: '18',
        bubbleOpacity: '0.95',
        bubbleShadow: 'light',
        bubbleBorder: 'none'
      }
    };
    
    // åŠ è½½ä¸»é¢˜è®¾ç½®
    function loadThemeSettings() {
      const savedTheme = localStorage.getItem('aiChatThemeSettings');
      if (savedTheme) {
        try {
          currentTheme = { ...currentTheme, ...JSON.parse(savedTheme) };
        } catch (e) {
          console.error('ä¸»é¢˜è®¾ç½®è§£æå¤±è´¥:', e);
        }
      }
      applyTheme(currentTheme);
    }
    
    // ä¿å­˜ä¸»é¢˜è®¾ç½®
    function saveThemeSettings() {
      localStorage.setItem('aiChatThemeSettings', JSON.stringify(currentTheme));
    }
    
    // åº”ç”¨ä¸»é¢˜
    function applyTheme(theme) {
      const root = document.documentElement;
      
      // åº”ç”¨å¯¼èˆªæ æ ·å¼
      const headers = document.querySelectorAll('.chat-header, .chat-list-header');
      headers.forEach(header => {
        header.style.background = theme.headerColor;
        header.style.borderRadius = `${theme.headerBorderRadius}px ${theme.headerBorderRadius}px 0 0`;
        header.style.opacity = theme.headerOpacity;
        
        // åº”ç”¨é˜´å½±
        const shadowMap = {
          'none': 'none',
          'light': '0 1px 3px rgba(0,0,0,0.1)',
          'normal': '0 2px 8px rgba(0,0,0,0.15)',
          'heavy': '0 4px 16px rgba(0,0,0,0.25)'
        };
        header.style.boxShadow = shadowMap[theme.headerShadow] || shadowMap.normal;
      });
      
      // åº”ç”¨èŠå¤©èƒŒæ™¯
      const chatBodies = document.querySelectorAll('.chat-body');
      chatBodies.forEach(body => {
        body.style.backgroundColor = theme.chatBgColor;
        if (theme.chatBgImage) {
          body.style.backgroundImage = `url('${theme.chatBgImage}')`;
          body.style.backgroundSize = 'cover';
          body.style.backgroundPosition = 'center';
          body.style.backgroundRepeat = 'no-repeat';
        } else {
          body.style.backgroundImage = 'none';
        }
      });
      
      // åº”ç”¨æ¶ˆæ¯æ°”æ³¡æ ·å¼
      const allBubbles = document.querySelectorAll('.bubble');
      allBubbles.forEach(bubble => {
        bubble.style.borderRadius = `${theme.bubbleBorderRadius}px`;
        
        // åº”ç”¨é˜´å½±
        const shadowMap = {
          'none': 'none',
          'light': '0 1px 2px rgba(0,0,0,0.1)',
          'normal': '0 2px 4px rgba(0,0,0,0.1)',
          'heavy': '0 4px 8px rgba(0,0,0,0.15)'
        };
        bubble.style.boxShadow = shadowMap[theme.bubbleShadow] || shadowMap.light;
        
        // åº”ç”¨è¾¹æ¡†
        const borderMap = {
          'none': 'none',
          'thin': '1px solid rgba(0,0,0,0.1)',
          'normal': '2px solid rgba(0,0,0,0.1)',
          'thick': '3px solid rgba(0,0,0,0.15)'
        };
        bubble.style.border = borderMap[theme.bubbleBorder] || borderMap.none;
      });
      
      // åº”ç”¨ç”¨æˆ·æ°”æ³¡é¢œè‰²
      const userBubbles = document.querySelectorAll('.msg.user .bubble');
      userBubbles.forEach(bubble => {
        bubble.style.background = `rgba(${hexToRgb(theme.userBubbleColor)}, ${theme.bubbleOpacity})`;
      });
      
      // åº”ç”¨AIæ°”æ³¡é¢œè‰²
      const aiBubbles = document.querySelectorAll('.msg.ai .bubble');
      aiBubbles.forEach(bubble => {
        bubble.style.background = `rgba(${hexToRgb(theme.aiBubbleColor)}, ${theme.bubbleOpacity})`;
      });
      
      // åº”ç”¨å­—ä½“è®¾ç½®
      document.body.style.fontFamily = theme.fontFamily;
      document.body.style.color = theme.fontColor;
      
      currentTheme = { ...theme };
    }
    
    // åå…­è¿›åˆ¶é¢œè‰²è½¬RGB
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? 
        `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : 
        '255, 255, 255';
    }
    
    // æ˜¾ç¤ºä¸»é¢˜è®¾ç½®å¼¹çª—
    function showThemeSettings() {
      // åˆå§‹åŒ–è¡¨å•å€¼
      document.getElementById('headerColorInput').value = currentTheme.headerColor;
      document.getElementById('headerColorText').value = currentTheme.headerColor;
      document.getElementById('chatBgColorInput').value = currentTheme.chatBgColor;
      document.getElementById('chatBgColorText').value = currentTheme.chatBgColor;
      document.getElementById('userBubbleColorInput').value = currentTheme.userBubbleColor;
      document.getElementById('userBubbleColorText').value = currentTheme.userBubbleColor;
      document.getElementById('aiBubbleColorInput').value = currentTheme.aiBubbleColor;
      document.getElementById('aiBubbleColorText').value = currentTheme.aiBubbleColor;
      document.getElementById('chatBgImageInput').value = currentTheme.chatBgImage || '';
      document.getElementById('fontFamilySelect').value = currentTheme.fontFamily;
      document.getElementById('fontColorInput').value = currentTheme.fontColor;
      document.getElementById('fontColorText').value = currentTheme.fontColor;
      
      // åˆå§‹åŒ–æ ·å¼è®¾ç½®
      document.getElementById('headerBorderRadiusSlider').value = currentTheme.headerBorderRadius;
      document.getElementById('headerBorderRadiusValue').textContent = currentTheme.headerBorderRadius + 'px';
      document.getElementById('headerOpacitySlider').value = currentTheme.headerOpacity;
      document.getElementById('headerOpacityValue').textContent = Math.round(currentTheme.headerOpacity * 100) + '%';
      document.getElementById('headerShadowSelect').value = currentTheme.headerShadow;
      
      document.getElementById('bubbleBorderRadiusSlider').value = currentTheme.bubbleBorderRadius;
      document.getElementById('bubbleBorderRadiusValue').textContent = currentTheme.bubbleBorderRadius + 'px';
      document.getElementById('bubbleOpacitySlider').value = currentTheme.bubbleOpacity;
      document.getElementById('bubbleOpacityValue').textContent = Math.round(currentTheme.bubbleOpacity * 100) + '%';
      document.getElementById('bubbleShadowSelect').value = currentTheme.bubbleShadow;
      document.getElementById('bubbleBorderSelect').value = currentTheme.bubbleBorder;
      
      updateThemePreview();
      document.getElementById('themeSettingsModal').style.display = 'flex';
    }
    
    // éšè—ä¸»é¢˜è®¾ç½®å¼¹çª—
    function hideThemeSettings() {
      document.getElementById('themeSettingsModal').style.display = 'none';
    }
    
    // æ›´æ–°ä¸»é¢˜é¢„è§ˆ
    function updateThemePreview() {
      const preview = document.getElementById('themePreview');
      const previewHeader = preview.querySelector('.preview-header');
      const previewChat = preview.querySelector('.preview-chat');
      const userBubble = preview.querySelector('.preview-bubble.user');
      const aiBubble = preview.querySelector('.preview-bubble.ai');
      
      // è·å–å½“å‰è¡¨å•å€¼
      const headerColor = document.getElementById('headerColorInput').value;
      const chatBgColor = document.getElementById('chatBgColorInput').value;
      const userBubbleColor = document.getElementById('userBubbleColorInput').value;
      const aiBubbleColor = document.getElementById('aiBubbleColorInput').value;
      const fontFamily = document.getElementById('fontFamilySelect').value;
      const fontColor = document.getElementById('fontColorInput').value;
      
      const headerBorderRadius = document.getElementById('headerBorderRadiusSlider').value;
      const headerOpacity = document.getElementById('headerOpacitySlider').value;
      const bubbleBorderRadius = document.getElementById('bubbleBorderRadiusSlider').value;
      const bubbleOpacity = document.getElementById('bubbleOpacitySlider').value;
      
      // åº”ç”¨åˆ°é¢„è§ˆ
      previewHeader.style.background = headerColor;
      previewHeader.style.borderRadius = `${headerBorderRadius}px ${headerBorderRadius}px 0 0`;
      previewHeader.style.opacity = headerOpacity;
      
      previewChat.style.background = chatBgColor;
      
      userBubble.style.background = `rgba(${hexToRgb(userBubbleColor)}, ${bubbleOpacity})`;
      userBubble.style.borderRadius = `${bubbleBorderRadius}px`;
      
      aiBubble.style.background = `rgba(${hexToRgb(aiBubbleColor)}, ${bubbleOpacity})`;
      aiBubble.style.borderRadius = `${bubbleBorderRadius}px`;
      
      preview.style.fontFamily = fontFamily;
      preview.style.color = fontColor;
    }
    
    // åº”ç”¨é¢„è®¾ä¸»é¢˜
    function applyPresetTheme(presetName) {
      const preset = themePresets[presetName];
      if (preset) {
        // æ›´æ–°é¢œè‰²è¡¨å•
        document.getElementById('headerColorInput').value = preset.headerColor;
        document.getElementById('headerColorText').value = preset.headerColor;
        document.getElementById('chatBgColorInput').value = preset.chatBgColor;
        document.getElementById('chatBgColorText').value = preset.chatBgColor;
        document.getElementById('userBubbleColorInput').value = preset.userBubbleColor;
        document.getElementById('userBubbleColorText').value = preset.userBubbleColor;
        document.getElementById('aiBubbleColorInput').value = preset.aiBubbleColor;
        document.getElementById('aiBubbleColorText').value = preset.aiBubbleColor;
        document.getElementById('chatBgImageInput').value = preset.chatBgImage || '';
        document.getElementById('fontFamilySelect').value = preset.fontFamily;
        document.getElementById('fontColorInput').value = preset.fontColor;
        document.getElementById('fontColorText').value = preset.fontColor;
        
        // æ›´æ–°æ ·å¼è¡¨å•
        document.getElementById('headerBorderRadiusSlider').value = preset.headerBorderRadius;
        document.getElementById('headerBorderRadiusValue').textContent = preset.headerBorderRadius + 'px';
        document.getElementById('headerOpacitySlider').value = preset.headerOpacity;
        document.getElementById('headerOpacityValue').textContent = Math.round(preset.headerOpacity * 100) + '%';
        document.getElementById('headerShadowSelect').value = preset.headerShadow;
        
        document.getElementById('bubbleBorderRadiusSlider').value = preset.bubbleBorderRadius;
        document.getElementById('bubbleBorderRadiusValue').textContent = preset.bubbleBorderRadius + 'px';
        document.getElementById('bubbleOpacitySlider').value = preset.bubbleOpacity;
        document.getElementById('bubbleOpacityValue').textContent = Math.round(preset.bubbleOpacity * 100) + '%';
        document.getElementById('bubbleShadowSelect').value = preset.bubbleShadow;
        document.getElementById('bubbleBorderSelect').value = preset.bubbleBorder;
        
        // æ›´æ–°é¢„è®¾æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.theme-preset-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-theme="${presetName}"]`).classList.add('active');
        
        updateThemePreview();
      }
    }
    
    // ä»è¡¨å•è·å–ä¸»é¢˜è®¾ç½®
    function getThemeFromForm() {
      return {
        headerColor: document.getElementById('headerColorInput').value,
        chatBgColor: document.getElementById('chatBgColorInput').value,
        chatBgImage: document.getElementById('chatBgImageInput').value.trim(),
        userBubbleColor: document.getElementById('userBubbleColorInput').value,
        aiBubbleColor: document.getElementById('aiBubbleColorInput').value,
        fontFamily: document.getElementById('fontFamilySelect').value,
        fontColor: document.getElementById('fontColorInput').value,
        headerBorderRadius: document.getElementById('headerBorderRadiusSlider').value,
        headerOpacity: document.getElementById('headerOpacitySlider').value,
        headerShadow: document.getElementById('headerShadowSelect').value,
        bubbleBorderRadius: document.getElementById('bubbleBorderRadiusSlider').value,
        bubbleOpacity: document.getElementById('bubbleOpacitySlider').value,
        bubbleShadow: document.getElementById('bubbleShadowSelect').value,
        bubbleBorder: document.getElementById('bubbleBorderSelect').value
      };
    }
    
    // åº”ç”¨ä¸»é¢˜å¹¶ä¿å­˜
    function applyAndSaveTheme() {
      const newTheme = getThemeFromForm();
      applyTheme(newTheme);
      saveThemeSettings();
      hideThemeSettings();
      alert('âœ… ä¸»é¢˜å·²åº”ç”¨å¹¶ä¿å­˜ï¼');
    }
    
    // é‡ç½®ä¸ºé»˜è®¤ä¸»é¢˜
    function resetToDefaultTheme() {
      if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤ä¸»é¢˜å—ï¼Ÿ')) {
        applyPresetTheme('default');
        applyAndSaveTheme();
      }
    }
    
    // ä¸Šä¼ èŠå¤©èƒŒæ™¯å›¾ç‰‡
    function uploadChatBackground() {
      document.getElementById('chatBgFileInput').click();
    }
    
    // å¤„ç†èŠå¤©èƒŒæ™¯å›¾ç‰‡é€‰æ‹©
    function handleChatBgSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      if (file.type.startsWith('image/') && file.size <= 10 * 1024 * 1024) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('chatBgImageInput').value = e.target.result;
          updateThemePreview();
        };
        reader.readAsDataURL(file);
      } else {
        alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼ˆæœ€å¤§10MBï¼‰');
      }
      
      event.target.value = '';
    }
    
    // ç§»é™¤èŠå¤©èƒŒæ™¯
    function removeChatBackground() {
      document.getElementById('chatBgImageInput').value = '';
      updateThemePreview();
    }
    
    // å¯¼å…¥å­—ä½“åŠŸèƒ½
    function importFont() {
      document.getElementById('fontFileInput').click();
    }
    
    // å¤„ç†å­—ä½“æ–‡ä»¶é€‰æ‹©
    function handleFontSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const validTypes = ['.ttf', '.otf', '.woff', '.woff2'];
      const fileName = file.name.toLowerCase();
      const isValidType = validTypes.some(type => fileName.endsWith(type));
      
      if (!isValidType) {
        alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å­—ä½“æ–‡ä»¶ï¼ˆ.ttf, .otf, .woff, .woff2ï¼‰');
        return;
      }
      
      // æé«˜æ–‡ä»¶å¤§å°é™åˆ¶åˆ°50MB
      if (file.size > 50 * 1024 * 1024) {
        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
        alert(`å­—ä½“æ–‡ä»¶è¿‡å¤§ï¼ˆ${fileSizeMB}MBï¼‰ï¼Œè¯·é€‰æ‹©å°äº50MBçš„æ–‡ä»¶\n\nå»ºè®®ï¼š\n1. ä½¿ç”¨å­—ä½“å‹ç¼©å·¥å…·å‡å°æ–‡ä»¶å¤§å°\n2. é€‰æ‹©.woff2æ ¼å¼çš„å­—ä½“æ–‡ä»¶ï¼ˆå‹ç¼©ç‡æ›´é«˜ï¼‰\n3. è€ƒè™‘ä½¿ç”¨åœ¨çº¿å­—ä½“æœåŠ¡`);
        return;
      }
      
      // æ˜¾ç¤ºæ–‡ä»¶å¤§å°ä¿¡æ¯
      const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
      console.log(`æ­£åœ¨å¯¼å…¥å­—ä½“æ–‡ä»¶: ${fileName} (${fileSizeMB}MB)`);
      
      // æ˜¾ç¤ºåŠ è½½æç¤º
      const loadingMsg = document.createElement('div');
      loadingMsg.id = 'fontLoadingMsg';
      loadingMsg.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 20px;
        border-radius: 8px;
        z-index: 10000;
        text-align: center;
        font-size: 16px;
      `;
      loadingMsg.innerHTML = `
        <div>æ­£åœ¨å¯¼å…¥å­—ä½“æ–‡ä»¶...</div>
        <div style="margin-top: 10px; font-size: 14px; color: #ccc;">
          ${fileName} (${fileSizeMB}MB)
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: #999;">
          å¤§æ–‡ä»¶å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…
        </div>
      `;
      document.body.appendChild(loadingMsg);
      
      const reader = new FileReader();
      
      reader.onprogress = (e) => {
        if (e.lengthComputable) {
          const percentComplete = (e.loaded / e.total * 100).toFixed(1);
          const progressDiv = loadingMsg.querySelector('div:first-child');
          progressDiv.textContent = `æ­£åœ¨è¯»å–æ–‡ä»¶... ${percentComplete}%`;
        }
      };
      
      reader.onload = (e) => {
        const fontData = e.target.result;
        const fontName = file.name.replace(/\.[^/.]+$/, "");
        
        // æ›´æ–°åŠ è½½æç¤º
        const progressDiv = loadingMsg.querySelector('div:first-child');
        progressDiv.textContent = 'æ­£åœ¨åŠ è½½å­—ä½“...';
        
        // åˆ›å»ºå­—ä½“æ ·å¼
        const fontFace = new FontFace(fontName, `url(${fontData})`);
        
        fontFace.load().then((loadedFont) => {
          document.fonts.add(loadedFont);
          
          // æ·»åŠ åˆ°è‡ªå®šä¹‰å­—ä½“åˆ—è¡¨
          customFonts.push({
            name: fontName,
            data: fontData,
            size: file.size,
            fileName: fileName
          });
          
          // ä¿å­˜è‡ªå®šä¹‰å­—ä½“æ•°æ®
          saveCustomFonts();
          
          // æ›´æ–°å­—ä½“é€‰æ‹©å™¨
          updateFontSelector();
          
          // åº”ç”¨æ–°å­—ä½“
          document.getElementById('fontFamilySelect').value = fontName;
          updateThemePreview();
          
          // ç§»é™¤åŠ è½½æç¤º
          document.body.removeChild(loadingMsg);
          
          alert(`âœ… å­—ä½“ "${fontName}" å¯¼å…¥æˆåŠŸï¼\næ–‡ä»¶å¤§å°: ${fileSizeMB}MB\n\nå­—ä½“å·²æ·»åŠ åˆ°å­—ä½“é€‰æ‹©å™¨ä¸­ï¼Œæ‚¨å¯ä»¥åœ¨ä¸»é¢˜è®¾ç½®ä¸­ä½¿ç”¨å®ƒã€‚`);
          
          console.log(`âœ… å­—ä½“å¯¼å…¥æˆåŠŸ: ${fontName} (${fileSizeMB}MB)`);
        }).catch((error) => {
          // ç§»é™¤åŠ è½½æç¤º
          document.body.removeChild(loadingMsg);
          
          console.error('å­—ä½“åŠ è½½å¤±è´¥:', error);
          alert(`âŒ å­—ä½“æ–‡ä»¶åŠ è½½å¤±è´¥\n\nå¯èƒ½çš„åŸå› :\n1. å­—ä½“æ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸æ­£ç¡®\n2. æµè§ˆå™¨å†…å­˜ä¸è¶³\n3. å­—ä½“æ–‡ä»¶è¿‡äºå¤æ‚\n\nå»ºè®®:\n1. å°è¯•ä½¿ç”¨å…¶ä»–æ ¼å¼çš„å­—ä½“æ–‡ä»¶\n2. ä½¿ç”¨å­—ä½“å‹ç¼©å·¥å…·ä¼˜åŒ–æ–‡ä»¶\n3. é‡å¯æµè§ˆå™¨åé‡è¯•`);
        });
      };
      
      reader.onerror = () => {
        // ç§»é™¤åŠ è½½æç¤º
        if (document.getElementById('fontLoadingMsg')) {
          document.body.removeChild(loadingMsg);
        }
        alert('âŒ æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
      };
      
      reader.readAsDataURL(file);
      event.target.value = '';
    }
    
    // æ›´æ–°å­—ä½“é€‰æ‹©å™¨
    function updateFontSelector() {
      const fontSelect = document.getElementById('fontFamilySelect');
      
      // ç§»é™¤ä¹‹å‰çš„è‡ªå®šä¹‰å­—ä½“é€‰é¡¹
      const customOptions = fontSelect.querySelectorAll('.custom-font');
      customOptions.forEach(option => option.remove());
      
      // æ·»åŠ è‡ªå®šä¹‰å­—ä½“é€‰é¡¹
      customFonts.forEach(font => {
        const option = document.createElement('option');
        option.value = font.name;
        
        // æ˜¾ç¤ºæ–‡ä»¶å¤§å°ä¿¡æ¯
        if (font.size) {
          const sizeMB = (font.size / (1024 * 1024)).toFixed(1);
          option.textContent = `${font.name} (è‡ªå®šä¹‰, ${sizeMB}MB)`;
        } else {
          option.textContent = font.name + ' (è‡ªå®šä¹‰)';
        }
        
        option.className = 'custom-font';
        option.title = `è‡ªå®šä¹‰å­—ä½“: ${font.fileName || font.name}`;
        fontSelect.appendChild(option);
      });
    }
    
    // ä¿å­˜è‡ªå®šä¹‰å­—ä½“åˆ°localStorage
    function saveCustomFonts() {
      try {
        localStorage.setItem('aiChatCustomFonts', JSON.stringify(customFonts));
        console.log('âœ… è‡ªå®šä¹‰å­—ä½“æ•°æ®å·²ä¿å­˜ï¼Œå­—ä½“æ•°é‡:', customFonts.length);
      } catch (error) {
        console.error('âŒ ä¿å­˜è‡ªå®šä¹‰å­—ä½“å¤±è´¥:', error);
        // å¦‚æœä¿å­˜å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ•°æ®è¿‡å¤§ï¼Œå°è¯•æ¸…ç†æˆ–æç¤ºç”¨æˆ·
        if (error.name === 'QuotaExceededError') {
          alert('å­—ä½“æ•°æ®è¿‡å¤§ï¼Œæ— æ³•ä¿å­˜åˆ°æµè§ˆå™¨å­˜å‚¨ä¸­ã€‚å»ºè®®åˆ é™¤ä¸€äº›è¾ƒå¤§çš„å­—ä½“æ–‡ä»¶ã€‚');
        }
      }
    }
    
    // ä»localStorageåŠ è½½è‡ªå®šä¹‰å­—ä½“
    function loadCustomFonts() {
      try {
        const savedFonts = localStorage.getItem('aiChatCustomFonts');
        if (savedFonts) {
          const fontsData = JSON.parse(savedFonts);
          console.log('ğŸ”„ æ­£åœ¨åŠ è½½è‡ªå®šä¹‰å­—ä½“ï¼Œæ•°é‡:', fontsData.length);
          
          // é‡æ–°åŠ è½½æ¯ä¸ªå­—ä½“åˆ°document.fonts
          fontsData.forEach((fontInfo, index) => {
            if (fontInfo.data && fontInfo.name) {
              const fontFace = new FontFace(fontInfo.name, `url(${fontInfo.data})`);
              fontFace.load().then((loadedFont) => {
                document.fonts.add(loadedFont);
                console.log(`âœ… å­—ä½“ ${fontInfo.name} é‡æ–°åŠ è½½æˆåŠŸ`);
              }).catch((error) => {
                console.error(`âŒ å­—ä½“ ${fontInfo.name} é‡æ–°åŠ è½½å¤±è´¥:`, error);
              });
            }
          });
          
          customFonts = fontsData;
          updateFontSelector();
          console.log('âœ… è‡ªå®šä¹‰å­—ä½“æ•°æ®åŠ è½½å®Œæˆ');
        } else {
          console.log('â„¹ï¸ æœªæ‰¾åˆ°ä¿å­˜çš„è‡ªå®šä¹‰å­—ä½“æ•°æ®');
        }
      } catch (error) {
        console.error('âŒ åŠ è½½è‡ªå®šä¹‰å­—ä½“å¤±è´¥:', error);
        customFonts = [];
      }
    }
    
    // æ¸…é™¤è‡ªå®šä¹‰å­—ä½“
    function clearCustomFonts() {
      if (customFonts.length === 0) {
        alert('æ²¡æœ‰è‡ªå®šä¹‰å­—ä½“éœ€è¦æ¸…é™¤');
        return;
      }
      
      // è®¡ç®—æ€»æ–‡ä»¶å¤§å°
      const totalSize = customFonts.reduce((sum, font) => sum + (font.size || 0), 0);
      const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(1);
      
      // ç”Ÿæˆå­—ä½“åˆ—è¡¨
      const fontList = customFonts.map(font => {
        const sizeMB = font.size ? `(${(font.size / (1024 * 1024)).toFixed(1)}MB)` : '';
        return `â€¢ ${font.name} ${sizeMB}`;
      }).join('\n');
      
      if (confirm(`ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ ${customFonts.length} ä¸ªè‡ªå®šä¹‰å­—ä½“å—ï¼Ÿ\næ€»å¤§å°: ${totalSizeMB}MB\n\nå­—ä½“åˆ—è¡¨:\n${fontList}\n\næ¸…é™¤åå°†é‡Šæ”¾æµè§ˆå™¨å†…å­˜ã€‚`)) {
        customFonts.forEach(font => {
          // ä»document.fontsä¸­ç§»é™¤
          document.fonts.forEach(f => {
            if (f.family === font.name) {
              document.fonts.delete(f);
            }
          });
        });
        
        customFonts = [];
        
        // æ¸…é™¤localStorageä¸­çš„å­—ä½“æ•°æ®
        localStorage.removeItem('aiChatCustomFonts');
        
        updateFontSelector();
        
        // å¦‚æœå½“å‰ä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰å­—ä½“ï¼Œé‡ç½®ä¸ºé»˜è®¤å­—ä½“
        const currentFont = document.getElementById('fontFamilySelect').value;
        if (!document.getElementById('fontFamilySelect').querySelector(`option[value="${currentFont}"]:not(.custom-font)`)) {
          document.getElementById('fontFamilySelect').value = 'å¾®è½¯é›…é»‘, Arial, sans-serif';
          updateThemePreview();
        }
        
        alert(`âœ… å·²æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰å­—ä½“\né‡Šæ”¾å†…å­˜: ${totalSizeMB}MB`);
        console.log(`âœ… æ¸…é™¤äº† ${customFonts.length} ä¸ªè‡ªå®šä¹‰å­—ä½“ï¼Œé‡Šæ”¾å†…å­˜ ${totalSizeMB}MB`);
      }
    }
    
    // åˆå§‹åŒ–ä¸»é¢˜è®¾ç½®äº‹ä»¶ç›‘å¬
    function initThemeSettings() {
      // ä¸»é¢˜è®¾ç½®æŒ‰é’®
      document.getElementById('themeBtn').onclick = showThemeSettings;
      document.getElementById('closeThemeSettingsModal').onclick = hideThemeSettings;
      document.getElementById('cancelThemeBtn').onclick = hideThemeSettings;
      document.getElementById('applyThemeBtn').onclick = applyAndSaveTheme;
      document.getElementById('previewThemeBtn').onclick = () => {
        applyTheme(getThemeFromForm());
      };
      document.getElementById('resetThemeBtn').onclick = resetToDefaultTheme;
      
      // é¢„è®¾ä¸»é¢˜æŒ‰é’®
      document.querySelectorAll('.theme-preset-btn').forEach(btn => {
        btn.onclick = () => applyPresetTheme(btn.dataset.theme);
      });
      
      // é¢œè‰²è¾“å…¥åŒæ­¥
      const colorInputs = [
        'headerColor', 'chatBgColor', 'userBubbleColor', 'aiBubbleColor', 'fontColor'
      ];
      colorInputs.forEach(name => {
        const colorInput = document.getElementById(name + 'Input');
        const textInput = document.getElementById(name + 'Text');
        
        colorInput.oninput = () => {
          textInput.value = colorInput.value;
          updateThemePreview();
        };
        
        textInput.oninput = () => {
          if (/^#[0-9A-F]{6}$/i.test(textInput.value)) {
            colorInput.value = textInput.value;
            updateThemePreview();
          }
        };
      });
      
      // æ ·å¼æ»‘å—
      const styleSliders = [
        'headerBorderRadius', 'headerOpacity', 'bubbleBorderRadius', 'bubbleOpacity'
      ];
      styleSliders.forEach(name => {
        const slider = document.getElementById(name + 'Slider');
        const valueSpan = document.getElementById(name + 'Value');
        
        slider.oninput = (e) => {
          if (name.includes('Opacity')) {
            valueSpan.textContent = Math.round(e.target.value * 100) + '%';
          } else {
            valueSpan.textContent = e.target.value + 'px';
          }
          updateThemePreview();
        };
      });
      
      // æ ·å¼é€‰æ‹©å™¨
      const styleSelectors = ['headerShadow', 'bubbleShadow', 'bubbleBorder'];
      styleSelectors.forEach(name => {
        document.getElementById(name + 'Select').onchange = updateThemePreview;
      });
      
      // å­—ä½“ç›¸å…³
      document.getElementById('fontFamilySelect').onchange = updateThemePreview;
      document.getElementById('importFontBtn').onclick = importFont;
      document.getElementById('clearCustomFontsBtn').onclick = clearCustomFonts;
      document.getElementById('fontFileInput').onchange = handleFontSelect;
      document.getElementById('chatBgImageInput').oninput = updateThemePreview;
      
      // èƒŒæ™¯å›¾ç‰‡ç›¸å…³
      document.getElementById('uploadChatBgBtn').onclick = uploadChatBackground;
      document.getElementById('removeChatBgBtn').onclick = removeChatBackground;
      document.getElementById('chatBgFileInput').onchange = handleChatBgSelect;
      
      // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
      document.getElementById('themeSettingsModal').onclick = (e) => {
        if (e.target.id === 'themeSettingsModal') {
          hideThemeSettings();
        }
      };
    }
    
    // ==================== ä¸»é¢˜è®¾ç½®åŠŸèƒ½ç»“æŸ ====================
    
    // åˆå§‹åŒ–ä¸»é¢˜è®¾ç½®
    loadThemeSettings();
    initThemeSettings();
    
    // ç¡®ä¿å­—ä½“é€‰æ‹©å™¨æ­£ç¡®æ˜¾ç¤ºè‡ªå®šä¹‰å­—ä½“
    updateFontSelector();

    // ==================== æ‹ä¸€æ‹æé†’åŠŸèƒ½å¼€å§‹ ====================

    // é‡ç½®æ´»åŠ¨è®¡æ—¶å™¨
    function resetActivityTimer() {
      lastActivityTime = Date.now();
      patReminderShown = false;
      
      // æ¸…é™¤ç°æœ‰è®¡æ—¶å™¨
      if (inactivityTimer) {
        clearTimeout(inactivityTimer);
      }
      
      // è®¾ç½®æ–°çš„è®¡æ—¶å™¨
      inactivityTimer = setTimeout(() => {
        showPatReminder();
      }, INACTIVITY_TIMEOUT);
    }

    // æ˜¾ç¤ºæ‹ä¸€æ‹æé†’
    function showPatReminder() {
      // å¦‚æœå·²ç»æ˜¾ç¤ºè¿‡æˆ–è€…ä¸åœ¨èŠå¤©ç•Œé¢ï¼Œåˆ™ä¸æ˜¾ç¤º
      if (patReminderShown || !currentChatId || !chatView.classList.contains('active')) {
        return;
      }
      
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (!currentChat) return;
      
      let roleName = '';
      let roleAvatar = '';
      
      if (currentChat.type === 'group') {
        // ç¾¤èŠæ¨¡å¼ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªè§’è‰²
        const availableRoles = currentChat.roles.filter(role => role.enabled !== false);
        if (availableRoles.length === 0) return;
        
        const randomRole = availableRoles[Math.floor(Math.random() * availableRoles.length)];
        roleName = randomRole.name || 'è§’è‰²';
        roleAvatar = randomRole.avatar || DEFAULT_AI_AVATAR;
      } else {
        // å•èŠæ¨¡å¼
        roleName = currentChat.roleName || roleName || 'åŠ©æ‰‹';
        roleAvatar = currentChat.aiAvatar || aiAvatar || DEFAULT_AI_AVATAR;
      }
      
      // è®¾ç½®å¼¹çª—å†…å®¹
      patReminderAvatar.src = roleAvatar;
      patReminderText.textContent = `${roleName}æ‹äº†æ‹ä½ `;
      
      // æ˜¾ç¤ºå¼¹çª—
      patReminderModal.classList.add('show');
      patReminderShown = true;
      
      // 3ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        hidePatReminder();
      }, 3000);
    }

    // éšè—æ‹ä¸€æ‹æé†’
    function hidePatReminder() {
      patReminderModal.classList.remove('show');
      // é‡ç½®è®¡æ—¶å™¨ï¼Œå‡†å¤‡ä¸‹æ¬¡æé†’
      resetActivityTimer();
    }

    // ç›‘å¬ç”¨æˆ·æ´»åŠ¨
    function setupActivityListeners() {
      const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'touchmove', 'click'];
      
      events.forEach(event => {
        document.addEventListener(event, resetActivityTimer, true);
      });
      
      // ç‰¹åˆ«ç›‘å¬èŠå¤©è¾“å…¥æ¡†
      if (chatInput) {
        chatInput.addEventListener('input', resetActivityTimer);
        chatInput.addEventListener('focus', resetActivityTimer);
      }
    }

    // åŠ è½½æ‹ä¸€æ‹æ¶ˆæ¯
    function loadPatMessage(msg) {
      // åˆ›å»ºæ—¶é—´å…ƒç´ 
      if (msg.timestamp) {
        const timeElement = document.createElement('div');
        timeElement.className = 'msg-time';
        const timeSpan = document.createElement('span');
        timeSpan.textContent = msg.timestamp;
        timeElement.appendChild(timeSpan);
        chatBody.appendChild(timeElement);
      }
      
      const patDiv = document.createElement('div');
      patDiv.className = 'pat-message';
      patDiv.innerHTML = `<div class="pat-message-content">${msg.content}</div>`;
      chatBody.appendChild(patDiv);
    }

    // å‘é€æ‹ä¸€æ‹æ¶ˆæ¯
    function sendPatMessage(targetNameOrFullText, isUserPat = true) {
      if (!currentChatId) return;
      
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (!currentChat) return;
      
      let patText = '';
      if (isUserPat) {
        // ç”¨æˆ·æ‹äº†è§’è‰²
        patText = `ä½ æ‹äº†æ‹${targetNameOrFullText}`;
      } else {
        // è§’è‰²æ‹äº†ç”¨æˆ·ï¼Œå¦‚æœä¼ å…¥çš„æ˜¯å®Œæ•´æ–‡æœ¬å°±ç›´æ¥ä½¿ç”¨
        if (targetNameOrFullText.includes('æ‹äº†æ‹')) {
          patText = targetNameOrFullText;
        } else {
          patText = `${targetNameOrFullText}æ‹äº†æ‹ä½ `;
        }
      }
      
      // åˆ›å»ºæ—¶é—´å…ƒç´ ï¼ˆå¾®ä¿¡é£æ ¼ï¼‰
      const timeElement = document.createElement('div');
      timeElement.className = 'msg-time';
      const timeSpan = document.createElement('span');
      timeSpan.textContent = formatMessageTime();
      timeElement.appendChild(timeSpan);
      
      // åˆ›å»ºæ‹ä¸€æ‹æ¶ˆæ¯å…ƒç´ 
      const patDiv = document.createElement('div');
      patDiv.className = 'pat-message';
      patDiv.innerHTML = `<div class="pat-message-content">${patText}</div>`;
      
      // æ·»åŠ åˆ°èŠå¤©ç•Œé¢
      chatBody.appendChild(timeElement);
      chatBody.appendChild(patDiv);
      
      // æ·»åŠ éœ‡åŠ¨æ•ˆæœ
      setTimeout(() => {
        const content = patDiv.querySelector('.pat-message-content');
        if (content) {
          content.classList.add('shake');
        }
      }, 100);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatBody.scrollTop = chatBody.scrollHeight;
      
      // ä¿å­˜åˆ°èŠå¤©è®°å½•
      if (!currentChat.chatDisplay) {
        currentChat.chatDisplay = [];
      }
      
      const currentTimestamp = formatMessageTime();
      currentChat.chatDisplay.push({
        id: generateId(),
        type: 'pat',
        content: patText,
        timestamp: currentTimestamp,
        isUserPat: isUserPat,
        targetName: isUserPat ? targetNameOrFullText : (targetNameOrFullText.includes('æ‹äº†æ‹') ? targetNameOrFullText.split('æ‹äº†æ‹')[0] : targetNameOrFullText)
      });
      
      saveCurrentChatData();
      
      // é‡ç½®æ´»åŠ¨è®¡æ—¶å™¨
      resetActivityTimer();
    }

    // å¤„ç†è§’è‰²å›å¤æ‹ä¸€æ‹
    async function handleRolePatReply(roleId, roleName) {
      if (!currentChatId) return;
      
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (!currentChat) return;
      
      // æ„å»ºæ‹ä¸€æ‹çš„ä¸Šä¸‹æ–‡
      const patContext = `ç”¨æˆ·æ‹äº†æ‹ä½ ï¼Œè¯·æ ¹æ®ä½ çš„è§’è‰²è®¾å®šåšå‡ºå›åº”ã€‚

é‡è¦æ ¼å¼è¦æ±‚ï¼š
1. ç”¨ï¼ˆï¼‰åŒ…è£¹åŠ¨ä½œæè¿°
2. ä¸¥æ ¼éµå¾ªä½¿ç”¨åæ–œçº¿\\åˆ†éš”å¥å­çš„è¦æ±‚ï¼Œæ¯ä¸ªå¥å­æ§åˆ¶åœ¨50å­—ä»¥å†…
3. å›å¤è¾“å‡ºç¤ºä¾‹æ ¼å¼ï¼šç¬¬ä¸€å¥è¯\\ç¬¬äºŒå¥è¯\\ç¬¬ä¸‰å¥è¯

ä½ å¯ä»¥é€‰æ‹©ï¼š
1. æ‹å›å»ï¼ˆå¦‚ï¼š(è½»è½»æ‹å›å»)ä½ ä¹Ÿæ‹æ‹æˆ‘å‘€\\æˆ‘ä»¬ä¸€èµ·ç©ï¼‰
2. è¯´ä¸€å¥è¯å›åº”ï¼ˆå¦‚ï¼š(å®³ç¾åœ°ä½ä¸‹å¤´)ä½ æ€ä¹ˆçªç„¶æ‹æˆ‘\\äººå®¶ä¼šä¸å¥½æ„æ€çš„ï¼‰
3. åšå‡ºå…¶ä»–ç¬¦åˆè§’è‰²çš„ååº”

è¯·ä¿æŒè§’è‰²çš„æ€§æ ¼ç‰¹ç‚¹ï¼Œä¸¥æ ¼æŒ‰ç…§æ ¼å¼è¦æ±‚å›å¤ã€‚`;
      
      // å¤„ç†æ‹ä¸€æ‹å›å¤
      await handlePatReply(patContext, currentChat, roleId, roleName);
    }

    // å¤„ç†æ‹ä¸€æ‹å›å¤
    async function handlePatReply(patContext, chat, roleId, roleName) {
      try {
        // æ„å»ºæ­£ç¡®çš„èŠå¤©APIç«¯ç‚¹
        const baseChatEndpoint = getChatEndpoint(apiURL);
        
        // æ„å»ºåŒ…å«è§’è‰²è®¾å®šå’Œæ‹ä¸€æ‹ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯
        const messages = buildMessages(patContext);
        
        // æ ¹æ®ä¸åŒAPIæä¾›å•†æ„å»ºè¯·æ±‚
        let chatEndpoint, headers, requestBody;
        
        try {
          const url = new URL(apiURL);
          
          if (url.hostname === 'generativelanguage.googleapis.com') {
            // Google Gemini API
            chatEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
            headers = {
              'Content-Type': 'application/json'
            };
            
            // è½¬æ¢æ¶ˆæ¯æ ¼å¼ä¸ºGeminiæ ¼å¼
            const contents = [];
            let systemPrompt = '';
            
            // å…ˆæ”¶é›†ç³»ç»Ÿæ¶ˆæ¯
            messages.forEach(msg => {
              if (msg.role === 'system') {
                systemPrompt += (systemPrompt ? '\n' : '') + msg.content;
              }
            });
            
            // è½¬æ¢ç”¨æˆ·å’ŒåŠ©æ‰‹æ¶ˆæ¯
            messages.forEach(msg => {
              if (msg.role === 'user') {
                let userContent = msg.content;
                // å°†ç³»ç»Ÿæç¤ºæ·»åŠ åˆ°ç¬¬ä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯ä¸­
                if (systemPrompt && contents.length === 0) {
                  userContent = systemPrompt + '\n\n' + userContent;
                  systemPrompt = ''; // æ ‡è®°å·²æ·»åŠ 
                }
                contents.push({
                  role: 'user',
                  parts: [{ text: userContent }]
                });
              } else if (msg.role === 'assistant') {
                contents.push({
                  role: 'model', 
                  parts: [{ text: msg.content }]
                });
              }
            });
            
            // å¦‚æœæ²¡æœ‰ç”¨æˆ·æ¶ˆæ¯ä½†æœ‰ç³»ç»Ÿæ¶ˆæ¯ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤ç”¨æˆ·æ¶ˆæ¯
            if (contents.length === 0 && systemPrompt) {
              contents.push({
                role: 'user',
                parts: [{ text: systemPrompt + '\n\n' + patContext }]
              });
            }
            
            requestBody = JSON.stringify({
              contents: contents,
              generationConfig: {
                temperature: 0.8,
                maxOutputTokens: 200, // æ‹ä¸€æ‹å›å¤è¦ç®€çŸ­
                topK: 40,
                topP: 0.95
              }
            });
          } else {
            // OpenAI/DeepSeekæ ¼å¼
            chatEndpoint = baseChatEndpoint;
            headers = {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${apiKey}`
            };
            
            requestBody = JSON.stringify({
              model: selectedModel,
              messages: messages,
              max_tokens: 200, // æ‹ä¸€æ‹å›å¤è¦ç®€çŸ­
              temperature: 0.8,
              stream: false // æ‹ä¸€æ‹å›å¤ä¸éœ€è¦æµå¼è¾“å‡º
            });
          }
        } catch (e) {
          // é»˜è®¤ä½¿ç”¨OpenAIæ ¼å¼
          chatEndpoint = baseChatEndpoint;
          headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          };
          
          requestBody = JSON.stringify({
            model: selectedModel,
            messages: messages,
            max_tokens: 200,
            temperature: 0.8,
            stream: false
          });
        }
        
        const response = await fetchWithRetry(chatEndpoint, {
          method: 'POST',
          headers: headers,
          body: requestBody,
          timeout: 15000 // æ‹ä¸€æ‹å›å¤ä½¿ç”¨è¾ƒçŸ­è¶…æ—¶
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const url = new URL(apiURL);
        let aiReply = '';
        
        if (url.hostname === 'generativelanguage.googleapis.com') {
          // å¤„ç†Gemini APIå“åº”
          const data = await response.json();
          
          if (data.error) {
            throw new Error(`Gemini APIé”™è¯¯: ${data.error.message}`);
          }
          
          if (data.candidates && data.candidates.length > 0) {
            const candidate = data.candidates[0];
            if (candidate.content && candidate.content.parts) {
              aiReply = candidate.content.parts.map(part => part.text || '').join('').trim();
            }
          }
        } else {
          // å¤„ç†OpenAI/DeepSeekå“åº”
          const data = await response.json();
          if (data.choices && data.choices.length > 0) {
            aiReply = data.choices[0].message.content.trim();
          }
        }
        
        if (aiReply) {
          // æ£€æŸ¥å›å¤æ˜¯å¦æ˜¯æ‹ä¸€æ‹åŠ¨ä½œ
          if (aiReply.includes('æ‹äº†æ‹') || aiReply.includes('æ‹æ‹')) {
            // å¦‚æœæ˜¯æ‹ä¸€æ‹åŠ¨ä½œï¼Œä½œä¸ºæ‹ä¸€æ‹æ¶ˆæ¯æ˜¾ç¤º
            sendPatMessage(aiReply, false);
          } else {
            // å¦‚æœæ˜¯æ™®é€šå›å¤ï¼Œä½œä¸ºæ™®é€šæ¶ˆæ¯æ˜¾ç¤ºï¼Œæ”¯æŒæ°”æ³¡åˆ†å‰²
            const thinkingMsg = roleName ? `${roleName}æ­£åœ¨å›å¤...` : 'æ­£åœ¨å›å¤...';
            const aiMsgBubble = appendMsg('ai', thinkingMsg, true, roleId, roleName);
            
            // ä½¿ç”¨handleNonStreamResponseå¤„ç†åˆ†å‰²
            await handleNonStreamResponse(aiReply, aiMsgBubble, roleId, roleName);
          }
          
          // æ›´æ–°å¯¹è¯å†å²
          if (window.conversationHistory) {
            window.conversationHistory.push({
              role: "user",
              content: patContext
            });
            window.conversationHistory.push({
              role: "assistant", 
              content: aiReply
            });
          }
        } else {
          // å¦‚æœAIæ²¡æœ‰å›å¤ï¼Œä½¿ç”¨éšæœºæ‹ä¸€æ‹å›åº”
          handleAIPatResponse(roleName);
        }
        
      } catch (error) {
        console.error('æ‹ä¸€æ‹å›å¤é”™è¯¯:', error);
        // å‘ç”Ÿé”™è¯¯æ—¶ä½¿ç”¨éšæœºæ‹ä¸€æ‹å›åº”
        handleAIPatResponse(roleName);
      }
    }

    // å¤„ç†AIå›åº”æ‹ä¸€æ‹ï¼ˆä¿ç•™åŸæœ‰çš„éšæœºå›åº”åŠŸèƒ½ä½œä¸ºå¤‡ç”¨ï¼‰
    function handleAIPatResponse(roleName) {
      if (!currentChatId) return;
      
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (!currentChat) return;
      
      // AIå›åº”çš„éšæœºè¡Œä¸º
      const responses = [
        'æ‹äº†æ‹ä½ ',
        'æ‹äº†æ‹ä½ çš„å¤´',
        'æ‹äº†æ‹ä½ å¹¶è¯´"å˜¿å˜¿"',
        'æ‹äº†æ‹ä½ çš„è„¸',
        'æ‹äº†æ‹ä½ çš„è‚©è†€',
        'æ‹äº†æ‹ä½ å¹¶çœ¨äº†çœ¨çœ¼',
        'æ‹äº†æ‹ä½ çš„æ‰‹',
        'è½»è½»æ‹äº†æ‹ä½ '
      ];
      
      const randomAction = responses[Math.floor(Math.random() * responses.length)];
      const responseText = `${roleName}${randomAction}`;
      
      // å‘é€AIçš„æ‹ä¸€æ‹å›åº”
      sendPatMessage(responseText, false);
    }

    // å¤„ç†å¤´åƒåŒå‡»äº‹ä»¶
    function handleAvatarDoubleClick(avatar, roleId, roleName) {
      // é˜²æ­¢è¿‡å¿«è¿ç»­ç‚¹å‡»
      if (avatar.dataset.lastPatTime) {
        const lastTime = parseInt(avatar.dataset.lastPatTime);
        if (Date.now() - lastTime < 1000) { // 1ç§’å†…ä¸èƒ½é‡å¤æ‹
          return;
        }
      }
      
      avatar.dataset.lastPatTime = Date.now().toString();
      
      // æ·»åŠ å¤´åƒéœ‡åŠ¨æ•ˆæœ
      avatar.style.animation = 'none';
      setTimeout(() => {
        avatar.style.animation = 'patBounce 0.6s ease-in-out';
      }, 10);
      
      // å‘é€æ‹ä¸€æ‹æ¶ˆæ¯
      sendPatMessage(roleName || 'è§’è‰²', true);
      
      // è®©è§’è‰²æ ¹æ®è®¾å®šå›å¤æ‹ä¸€æ‹
      setTimeout(() => {
        handleRolePatReply(roleId, roleName);
      }, 1000 + Math.random() * 2000); // 1-3ç§’åå›åº”
    }

    // è®¾ç½®å¤´åƒåŒå‡»ç›‘å¬å™¨
    function setupAvatarPatListeners() {
      // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç›‘å¬æ‰€æœ‰å¤´åƒçš„åŒå‡»äº‹ä»¶
      chatBody.addEventListener('dblclick', (e) => {
        const avatar = e.target.closest('.avatar');
        if (!avatar) return;
        
        const msgElement = avatar.closest('.msg');
        if (!msgElement || !msgElement.classList.contains('ai')) return;
        
        // è·å–è§’è‰²ä¿¡æ¯
        let roleId = msgElement.getAttribute('data-role-id');
        let roleName = msgElement.getAttribute('data-role-name');
        
        // å¦‚æœæ²¡æœ‰ä»å±æ€§è·å–åˆ°ï¼Œå°è¯•ä»è§’è‰²åç§°å…ƒç´ è·å–
        if (!roleName) {
          const roleNameElement = msgElement.querySelector('.role-name');
          if (roleNameElement) {
            roleName = roleNameElement.textContent;
          }
        }
        
        // å¦‚æœè¿˜æ˜¯æ²¡æœ‰åç§°ï¼Œä½¿ç”¨é»˜è®¤åç§°
        if (!roleName) {
          const currentChat = chatList.find(c => c.id === currentChatId);
          if (currentChat) {
            if (currentChat.type === 'group') {
              roleName = 'è§’è‰²';
            } else {
              roleName = currentChat.roleName || roleName || 'åŠ©æ‰‹';
            }
          } else {
            roleName = 'åŠ©æ‰‹';
          }
        }
        
        // å¤„ç†æ‹ä¸€æ‹
        handleAvatarDoubleClick(avatar, roleId, roleName);
      });
    }

    // åˆå§‹åŒ–æ‹ä¸€æ‹åŠŸèƒ½
    function initPatReminder() {
      // è®¾ç½®å…³é—­æŒ‰é’®äº‹ä»¶
      patReminderClose.addEventListener('click', hidePatReminder);
      
      // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
      patReminderModal.addEventListener('click', (e) => {
        if (e.target === patReminderModal) {
          hidePatReminder();
        }
      });
      
      // è®¾ç½®æ´»åŠ¨ç›‘å¬å™¨
      setupActivityListeners();
      
      // è®¾ç½®å¤´åƒåŒå‡»ç›‘å¬å™¨
      setupAvatarPatListeners();
      
      // å¼€å§‹è®¡æ—¶
      resetActivityTimer();
    }

    // ==================== è§†é¢‘é€šè¯åŠŸèƒ½å¼€å§‹ ====================

    // åˆå§‹åŒ–è§†é¢‘é€šè¯åŠŸèƒ½
    function initVideoCall() {
      // è§†é¢‘é€šè¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      videoCallBtn.addEventListener('click', startVideoCall);
      
      // è§†é¢‘é€šè¯ç”³è¯·å¼¹çª—äº‹ä»¶
      videoCallDeclineBtn.addEventListener('click', declineVideoCall);
      videoCallAcceptBtn.addEventListener('click', acceptVideoCall);
      
      // è§†é¢‘é€šè¯ç•Œé¢äº‹ä»¶
      videoCallSendBtn.addEventListener('click', sendVideoCallMessage);
      videoCallInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendVideoCallMessage();
        }
      });
      
      // è§†é¢‘é€šè¯æ§åˆ¶æŒ‰é’®
      videoCallMuteBtn.addEventListener('click', toggleMute);
      videoCallCameraBtn.addEventListener('click', toggleCamera);
      videoCallHangupBtn.addEventListener('click', hangupVideoCall);
      
      // é˜»æ­¢è§†é¢‘é€šè¯ç•Œé¢çš„æ»šåŠ¨
      videoCallModal.addEventListener('touchmove', (e) => {
        e.preventDefault();
      }, { passive: false });
    }

    // å¼€å§‹è§†é¢‘é€šè¯
    function startVideoCall() {
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (!currentChat) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©');
        return;
      }

      let roleData = null;
      let roleName = '';
      let roleAvatar = '';
      let roleVideo = '';
      let roleDescription = '';

      if (currentChat.type === 'group') {
        // ç¾¤èŠæ¨¡å¼ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªè§’è‰²å‘èµ·é€šè¯
        if (!currentChat.roles || currentChat.roles.length === 0) {
          alert('ç¾¤èŠä¸­æ²¡æœ‰è§’è‰²ï¼Œæ— æ³•å‘èµ·è§†é¢‘é€šè¯');
          return;
        }
        roleData = currentChat.roles[Math.floor(Math.random() * currentChat.roles.length)];
        roleName = roleData.name;
        roleAvatar = roleData.avatar || DEFAULT_AI_AVATAR;
        roleVideo = roleData.videoCallMedia || roleAvatar;
        roleDescription = roleData.description || '';
      } else {
        // å•èŠæ¨¡å¼
        roleName = currentChat.roleName || 'åŠ©æ‰‹';
        roleAvatar = currentChat.aiAvatar || DEFAULT_AI_AVATAR;
        roleVideo = currentChat.aiVideo || roleAvatar;
        roleDescription = currentChat.roleDescription || '';
      }

      currentVideoCallRole = {
        id: roleData ? roleData.id : `single_${currentChat.id}`,
        name: roleName,
        avatar: roleAvatar,
        video: roleVideo,
        description: roleDescription,
        chatType: currentChat.type,
        fullRoleData: roleData, // ä¿å­˜å®Œæ•´çš„è§’è‰²æ•°æ®ä»¥å¤‡åç”¨
        currentChat: currentChat // ä¿å­˜å½“å‰èŠå¤©æ•°æ®ä»¥å¤‡åç”¨
      };

      // æ˜¾ç¤ºé€šè¯ç”³è¯·å¼¹çª—
      showVideoCallRequest(roleName, roleAvatar);
    }

    // æ˜¾ç¤ºè§†é¢‘é€šè¯ç”³è¯·å¼¹çª—
    function showVideoCallRequest(roleName, roleAvatar) {
      videoCallRequestName.textContent = roleName;
      videoCallRequestAvatar.src = roleAvatar;
      videoCallRequestModal.classList.add('show');
      
      // æ¨¡æ‹ŸAIå‘èµ·é€šè¯çš„å»¶è¿Ÿ
      setTimeout(() => {
        if (videoCallRequestModal.classList.contains('show')) {
          // å¦‚æœç”¨æˆ·æ²¡æœ‰å“åº”ï¼Œè‡ªåŠ¨æ¥å¬
          acceptVideoCall();
        }
      }, 8000);
    }

    // æ‹’ç»è§†é¢‘é€šè¯
    function declineVideoCall() {
      videoCallRequestModal.classList.remove('show');
      currentVideoCallRole = null;
      
      // åœ¨èŠå¤©ä¸­æ˜¾ç¤ºæ‹’ç»æ¶ˆæ¯
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (currentChat) {
        appendMsg('user', 'å·²æ‹’ç»è§†é¢‘é€šè¯', false, null, null, null, null, null, false, null, false, null, 'text');
        saveCurrentChatData();
      }
    }

    // æ¥å¬è§†é¢‘é€šè¯
    function acceptVideoCall() {
      videoCallRequestModal.classList.remove('show');
      
      if (!currentVideoCallRole) return;
      
      // æ˜¾ç¤ºè§†é¢‘é€šè¯ç•Œé¢
      showVideoCallInterface();
      
      // å¼€å§‹è®¡æ—¶
      startVideoCallTimer();
      
      // åœ¨èŠå¤©ä¸­æ˜¾ç¤ºæ¥å¬æ¶ˆæ¯
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (currentChat) {
        appendMsg('user', 'å·²æ¥å¬è§†é¢‘é€šè¯', false, null, null, null, null, null, false, null, false, null, 'text');
        saveCurrentChatData();
      }
    }

    // æ˜¾ç¤ºè§†é¢‘é€šè¯ç•Œé¢
    function showVideoCallInterface() {
      isVideoCallActive = true;
      
      // è®¾ç½®è§’è‰²ä¿¡æ¯
      videoCallUserName.textContent = currentVideoCallRole.name;
      videoCallUserAvatar.src = userAvatar || DEFAULT_USER_AVATAR;
      
      // è®¾ç½®è§†é¢‘ç”»é¢
      const videoUrl = currentVideoCallRole.video;
      
      // æ£€æµ‹æ˜¯å¦ä¸ºè§†é¢‘æ–‡ä»¶ï¼ˆæ”¯æŒURLå’Œbase64æ ¼å¼ï¼‰
      const isVideo = videoUrl && (
        videoUrl.includes('.mp4') || 
        videoUrl.includes('.webm') || 
        videoUrl.includes('.mov') ||
        videoUrl.includes('.avi') ||
        videoUrl.includes('.mkv') ||
        videoUrl.startsWith('data:video/') // base64è§†é¢‘
      );
      
      if (isVideo) {
        console.log('ğŸ¥ æ£€æµ‹åˆ°è§†é¢‘æ–‡ä»¶ï¼Œå¼€å§‹è®¾ç½®è§†é¢‘æ’­æ”¾:', videoUrl.substring(0, 50) + '...');
        
        // æ˜¾ç¤ºè§†é¢‘
        videoCallMainVideo.style.display = 'block';
        videoCallMainImage.style.display = 'none';
        
        // ç¡®ä¿è§†é¢‘å±æ€§è®¾ç½®æ­£ç¡®
        videoCallMainVideo.autoplay = true;
        videoCallMainVideo.loop = true;
        videoCallMainVideo.muted = true;
        videoCallMainVideo.playsInline = true; // ç§»åŠ¨ç«¯å†…è”æ’­æ”¾
        videoCallMainVideo.controls = false; // éšè—æ§åˆ¶æ¡
        
        // è®¾ç½®è§†é¢‘æº
        videoCallMainVideo.src = videoUrl;
        
        // åŠ è½½å¹¶æ’­æ”¾è§†é¢‘
        videoCallMainVideo.load();
        
        // ç›‘å¬è§†é¢‘äº‹ä»¶
        videoCallMainVideo.addEventListener('loadstart', function() {
          console.log('ğŸ¥ è§†é¢‘å¼€å§‹åŠ è½½');
        }, { once: true });
        
        videoCallMainVideo.addEventListener('loadedmetadata', function() {
          console.log('ğŸ¥ è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆï¼Œæ—¶é•¿:', videoCallMainVideo.duration);
        }, { once: true });
        
        videoCallMainVideo.addEventListener('loadeddata', function() {
          console.log('ğŸ¥ è§†é¢‘æ•°æ®åŠ è½½å®Œæˆï¼Œå°è¯•æ’­æ”¾');
          videoCallMainVideo.play().then(() => {
            console.log('âœ… è§†é¢‘æ’­æ”¾æˆåŠŸ');
          }).catch(error => {
            console.warn('âš ï¸ è§†é¢‘è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', error);
            // å¦‚æœè‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œå°è¯•é™éŸ³æ’­æ”¾
            videoCallMainVideo.muted = true;
            videoCallMainVideo.play().then(() => {
              console.log('âœ… é™éŸ³è§†é¢‘æ’­æ”¾æˆåŠŸ');
            }).catch(e => {
              console.error('âŒ è§†é¢‘æ’­æ”¾å¤±è´¥:', e);
            });
          });
        }, { once: true });
        
        videoCallMainVideo.addEventListener('playing', function() {
          console.log('ğŸ¥ è§†é¢‘æ­£åœ¨æ’­æ”¾');
        }, { once: true });
        
        // å¤„ç†è§†é¢‘åŠ è½½é”™è¯¯
        videoCallMainVideo.addEventListener('error', function(e) {
          console.error('âŒ è§†é¢‘åŠ è½½å¤±è´¥:', e, videoCallMainVideo.error);
          // é™çº§åˆ°å›¾ç‰‡æ˜¾ç¤º
          videoCallMainVideo.style.display = 'none';
          videoCallMainImage.style.display = 'block';
          videoCallMainImage.src = videoUrl;
          console.log('ğŸ–¼ï¸ é™çº§åˆ°å›¾ç‰‡æ˜¾ç¤º');
        }, { once: true });
        
      } else {
        // æ˜¾ç¤ºå›¾ç‰‡
        videoCallMainImage.style.display = 'block';
        videoCallMainVideo.style.display = 'none';
        videoCallMainImage.src = videoUrl;
      }
      
      // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
      videoCallMessages.innerHTML = '';
      videoCallInput.value = '';
      
      // æ˜¾ç¤ºè§†é¢‘é€šè¯æ¨¡æ€æ¡†
      videoCallModal.classList.add('show');
      
      // èšç„¦è¾“å…¥æ¡†
      setTimeout(() => {
        videoCallInput.focus();
      }, 300);
    }

    // å¼€å§‹è§†é¢‘é€šè¯è®¡æ—¶
    function startVideoCallTimer() {
      videoCallStartTime = Date.now();
      updateVideoCallDuration();
      
      videoCallTimer = setInterval(() => {
        updateVideoCallDuration();
      }, 1000);
    }

    // æ›´æ–°è§†é¢‘é€šè¯æ—¶é•¿æ˜¾ç¤º
    function updateVideoCallDuration() {
      if (!videoCallStartTime) return;
      
      const elapsed = Math.floor((Date.now() - videoCallStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      
      videoCallDuration.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // å‘é€è§†é¢‘é€šè¯æ¶ˆæ¯
    function sendVideoCallMessage() {
      const text = videoCallInput.value.trim();
      if (!text) return;
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      videoCallInput.value = '';
      
      // åœ¨è§†é¢‘é€šè¯ç•Œé¢æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
      addVideoCallMessage(text, 'user');
      
      // æ¨¡æ‹ŸAIå›å¤
      setTimeout(() => {
        generateVideoCallAIReply(text);
      }, 1000 + Math.random() * 2000);
    }

    // åœ¨è§†é¢‘é€šè¯ç•Œé¢æ·»åŠ æ¶ˆæ¯
    function addVideoCallMessage(text, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'video-call-message';
      
      if (sender === 'user') {
        messageDiv.style.marginLeft = 'auto';
        messageDiv.style.marginRight = '0';
        messageDiv.style.background = 'rgba(149, 236, 105, 0.9)';
        messageDiv.style.color = '#333';
      }
      
      messageDiv.textContent = text;
      videoCallMessages.appendChild(messageDiv);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      videoCallMessages.scrollTop = videoCallMessages.scrollHeight;
    }

    // ç”ŸæˆAIè§†é¢‘é€šè¯å›å¤
    async function generateVideoCallAIReply(userMessage) {
      if (!currentVideoCallRole) return;
      
      try {
        console.log('ğŸ­ è§†é¢‘é€šè¯AIå›å¤ - å½“å‰è§’è‰²ä¿¡æ¯:', {
          name: currentVideoCallRole.name,
          description: currentVideoCallRole.description,
          chatType: currentVideoCallRole.chatType
        });
        
        // æ„å»ºè§’è‰²ç³»ç»Ÿæç¤ºè¯
        let systemPrompt = `ä½ æ­£åœ¨ä¸ç”¨æˆ·è¿›è¡Œè§†é¢‘é€šè¯ã€‚`;
        
        // æ·»åŠ è§’è‰²ä¿¡æ¯
        systemPrompt += `ä½ æ˜¯${currentVideoCallRole.name}ã€‚`;
        
        // æ·»åŠ è§’è‰²æè¿°
        if (currentVideoCallRole.description && currentVideoCallRole.description.trim()) {
          systemPrompt += `\n\nè§’è‰²è®¾å®šï¼š${currentVideoCallRole.description}`;
        }
        
        // æ·»åŠ ç”¨æˆ·ä¿¡æ¯
        if (userName && userName.trim()) {
          systemPrompt += `\n\nç”¨æˆ·å§“åï¼š${userName}`;
        }
        if (userDescription && userDescription.trim()) {
          systemPrompt += `\nç”¨æˆ·ä¿¡æ¯ï¼š${userDescription}`;
        }
        
        // æ·»åŠ è‡ªå®šä¹‰æç¤ºè¯
        if (aiCustomPrompt && aiCustomPrompt.trim()) {
          systemPrompt += `\n\nè¡¥å……è®¾å®šï¼š${aiCustomPrompt}`;
        }
        
        // æ·»åŠ è§†é¢‘é€šè¯ç‰¹å®šæŒ‡å¯¼å’Œæ ¼å¼è¦æ±‚
        systemPrompt += `\n\nè¯·æ³¨æ„ï¼š
1. ä½ æ­£åœ¨è¿›è¡Œè§†é¢‘é€šè¯ï¼Œå›å¤è¦ç®€çŸ­è‡ªç„¶ï¼ˆ1-2å¥è¯ï¼‰
2. ä¿æŒäº²åˆ‡å‹å¥½çš„è¯­è°ƒï¼Œå°±åƒçœŸæ­£çš„è§†é¢‘é€šè¯
3. å¯ä»¥é€‚å½“æåŠè§†é¢‘é€šè¯åœºæ™¯ï¼ˆå¦‚"çœ‹åˆ°ä½ äº†"ã€"å¬å¾—æ¸…æ¥šå—"ç­‰ï¼‰
4. ä¸¥æ ¼æŒ‰ç…§è§’è‰²è®¾å®šè¿›è¡Œå›å¤

é‡è¦æ ¼å¼è¦æ±‚ï¼š
1. ç”¨ï¼ˆï¼‰åŒ…è£¹åŠ¨ä½œæè¿°
2. ä¸¥æ ¼éµå¾ªä½¿ç”¨åæ–œçº¿\\åˆ†éš”å¥å­çš„è¦æ±‚ï¼Œæ¯ä¸ªå¥å­æ§åˆ¶åœ¨50å­—ä»¥å†…
3. å›å¤è¾“å‡ºç¤ºä¾‹æ ¼å¼ï¼šç¬¬ä¸€å¥è¯\\ç¬¬äºŒå¥è¯\\ç¬¬ä¸‰å¥è¯

ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼šä½ å¥½
AIå›å¤ï¼š(æŒ¥æ‰‹)ä½ å¥½å‘€\\çœ‹åˆ°ä½ äº†å‘¢

ç”¨æˆ·ï¼šå¬å¾—æ¸…æ¥šå—ï¼Ÿ
AIå›å¤ï¼š(ç‚¹å¤´)å¬å¾—å¾ˆæ¸…æ¥š\\è§†é¢‘ä¹Ÿå¾ˆæ¸…æ™°`;

        // è·å–è§†é¢‘é€šè¯æ¶ˆæ¯å†å²ï¼ˆæœ€è¿‘çš„å‡ æ¡æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡ï¼‰
        const videoCallHistory = [];
        const messageElements = videoCallMessages.querySelectorAll('.video-call-message');
        const maxHistory = Math.min(6, messageElements.length); // æœ€å¤šå–6æ¡å†å²æ¶ˆæ¯
        
        // ä»æœ€è¿‘çš„æ¶ˆæ¯å¼€å§‹å–ï¼Œä½†è¦ä¿æŒæ—¶é—´é¡ºåº
        const recentMessages = Array.from(messageElements).slice(-maxHistory);
        
        recentMessages.forEach(msgElement => {
          const isUser = msgElement.style.marginLeft === 'auto';
          const content = msgElement.textContent.trim();
          if (content) {
            videoCallHistory.push({
              role: isUser ? 'user' : 'assistant',
              content: content
            });
          }
        });

        console.log('ğŸ­ è§†é¢‘é€šè¯ç³»ç»Ÿæç¤ºè¯:', systemPrompt);

        // æ„å»ºè§†é¢‘é€šè¯ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯
        const messages = [
          {
            role: 'system',
            content: systemPrompt
          },
          // æ·»åŠ å†å²æ¶ˆæ¯ä½œä¸ºä¸Šä¸‹æ–‡
          ...videoCallHistory,
          // å½“å‰ç”¨æˆ·æ¶ˆæ¯
          {
            role: 'user',
            content: userMessage
          }
        ];
        
        console.log('ğŸ­ è§†é¢‘é€šè¯æ¶ˆæ¯ä¸Šä¸‹æ–‡:', messages);
        
        // å‘é€APIè¯·æ±‚
        const response = await fetch(getChatEndpoint(apiURL), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: selectedModel,
            messages: messages,
            max_tokens: 100,
            temperature: 0.8
          })
        });
        
        if (!response.ok) {
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
        }
        
        const data = await response.json();
        const aiReply = data.choices?.[0]?.message?.content?.trim() || 'æˆ‘å¬åˆ°äº†ï¼Œç»§ç»­èŠå§~';
        
        // å¤„ç†åæ–œæ åˆ†å‰²ï¼Œæ˜¾ç¤ºå¤šæ¡æ¶ˆæ¯
        const replyTexts = aiReply.split('\\').map(text => text.trim()).filter(text => text.length > 0);
        
        // ä¾æ¬¡æ˜¾ç¤ºæ¯æ¡å›å¤ï¼ˆæœ‰å»¶è¿Ÿï¼‰
        replyTexts.forEach((text, index) => {
          setTimeout(() => {
            addVideoCallMessage(text, 'ai');
          }, index * 1000); // æ¯æ¡å›å¤é—´éš”1ç§’
        });
        
      } catch (error) {
        console.error('è§†é¢‘é€šè¯AIå›å¤ç”Ÿæˆå¤±è´¥:', error);
        
        // ä½¿ç”¨è§’è‰²åŒ–çš„é»˜è®¤å›å¤
        const roleName = currentVideoCallRole.name || 'æˆ‘';
        const defaultReplies = [
          'æˆ‘å¬åˆ°äº†~',
          'æ˜¯çš„ï¼Œæˆ‘æ˜ç™½',
          'ç»§ç»­è¯´å§',
          'çœŸçš„å—ï¼Ÿ',
          'æˆ‘è§‰å¾—ä¹Ÿæ˜¯',
          'å“ˆå“ˆï¼Œæœ‰æ„æ€',
          'æˆ‘ä¹Ÿè¿™ä¹ˆæƒ³',
          'è¯´å¾—å¯¹',
          'å¬å¾—å¾ˆæ¸…æ¥šå‘¢',
          'çœ‹åˆ°ä½ äº†~',
          'å—¯å—¯ï¼Œç„¶åå‘¢ï¼Ÿ',
          'æˆ‘åœ¨å¬ç€å‘¢'
        ];
        
        const randomReply = defaultReplies[Math.floor(Math.random() * defaultReplies.length)];
        addVideoCallMessage(randomReply, 'ai');
      }
    }

    // åˆ‡æ¢é™éŸ³çŠ¶æ€
    function toggleMute() {
      const isMuted = videoCallMuteBtn.textContent === 'ğŸ”‡';
      videoCallMuteBtn.textContent = isMuted ? 'ğŸ”Š' : 'ğŸ”‡';
      videoCallMuteBtn.title = isMuted ? 'å–æ¶ˆé™éŸ³' : 'é™éŸ³';
    }

    // åˆ‡æ¢æ‘„åƒå¤´çŠ¶æ€
    function toggleCamera() {
      const isCameraOff = videoCallCameraBtn.textContent === 'ğŸ“·';
      videoCallCameraBtn.textContent = isCameraOff ? 'ğŸ“¹' : 'ğŸ“·';
      videoCallCameraBtn.title = isCameraOff ? 'å…³é—­æ‘„åƒå¤´' : 'å¼€å¯æ‘„åƒå¤´';
      
      // åˆ‡æ¢ç”¨æˆ·è§†é¢‘æ˜¾ç¤º
      if (isCameraOff) {
        videoCallUserAvatar.style.opacity = '1';
      } else {
        videoCallUserAvatar.style.opacity = '0.3';
      }
    }

    // é¢„è§ˆè§†é¢‘é€šè¯ç”»é¢
    function previewVideoCallMedia(videoUrl, roleName) {
      if (!videoUrl || videoUrl.trim() === '') {
        alert('è¯·å…ˆè®¾ç½®è§†é¢‘é€šè¯ç”»é¢');
        return;
      }
      
      // åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†
      const previewModal = document.createElement('div');
      previewModal.className = 'modal-overlay';
      previewModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      `;
      
      const previewContent = document.createElement('div');
      previewContent.style.cssText = `
        background: #000;
        border-radius: 10px;
        padding: 20px;
        max-width: 90%;
        max-height: 90%;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
      `;
      
      // æ ‡é¢˜
      const title = document.createElement('div');
      title.textContent = `${roleName || 'è§’è‰²'}çš„è§†é¢‘é€šè¯ç”»é¢é¢„è§ˆ`;
      title.style.cssText = `
        color: white;
        font-size: 16px;
        margin-bottom: 15px;
        text-align: center;
      `;
      previewContent.appendChild(title);
      
      // æ£€æµ‹æ˜¯å¦ä¸ºè§†é¢‘æ–‡ä»¶
      const isVideo = videoUrl && (
        videoUrl.includes('.mp4') || 
        videoUrl.includes('.webm') || 
        videoUrl.includes('.mov') ||
        videoUrl.includes('.avi') ||
        videoUrl.includes('.mkv') ||
        videoUrl.startsWith('data:video/')
      );
      
      // åˆ›å»ºåª’ä½“å…ƒç´ 
      let mediaElement;
      if (isVideo) {
        mediaElement = document.createElement('video');
        mediaElement.autoplay = true;
        mediaElement.loop = true;
        mediaElement.muted = true;
        mediaElement.playsInline = true;
        mediaElement.controls = true; // é¢„è§ˆæ—¶æ˜¾ç¤ºæ§åˆ¶æ¡
        mediaElement.style.cssText = `
          max-width: 400px;
          max-height: 300px;
          border-radius: 8px;
          background: #333;
        `;
        
        mediaElement.addEventListener('loadeddata', function() {
          mediaElement.play().catch(error => {
            console.warn('é¢„è§ˆè§†é¢‘æ’­æ”¾å¤±è´¥:', error);
          });
        });
        
        mediaElement.addEventListener('error', function(e) {
          console.error('é¢„è§ˆè§†é¢‘åŠ è½½å¤±è´¥:', e);
          alert('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–ç½‘ç»œè¿æ¥');
        });
        
      } else {
        mediaElement = document.createElement('img');
        mediaElement.style.cssText = `
          max-width: 400px;
          max-height: 300px;
          border-radius: 8px;
          background: #333;
        `;
        
        mediaElement.addEventListener('error', function() {
          alert('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆ');
        });
      }
      
      mediaElement.src = videoUrl;
      previewContent.appendChild(mediaElement);
      
      // å…³é—­æŒ‰é’®
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'å…³é—­';
      closeBtn.style.cssText = `
        margin-top: 15px;
        padding: 8px 20px;
        background: #666;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      `;
      
      closeBtn.addEventListener('mouseover', function() {
        this.style.background = '#777';
      });
      
      closeBtn.addEventListener('mouseout', function() {
        this.style.background = '#666';
      });
      
      closeBtn.onclick = function() {
        if (isVideo && mediaElement.src) {
          mediaElement.pause();
          mediaElement.src = '';
        }
        document.body.removeChild(previewModal);
      };
      
      previewContent.appendChild(closeBtn);
      previewModal.appendChild(previewContent);
      
      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      previewModal.onclick = function(e) {
        if (e.target === previewModal) {
          closeBtn.click();
        }
      };
      
      document.body.appendChild(previewModal);
    }

    // æŒ‚æ–­è§†é¢‘é€šè¯
    function hangupVideoCall() {
      if (!isVideoCallActive) return;
      
      // åœæ­¢è®¡æ—¶å™¨
      if (videoCallTimer) {
        clearInterval(videoCallTimer);
        videoCallTimer = null;
      }
      
      // åœæ­¢å¹¶æ¸…ç†è§†é¢‘
      if (videoCallMainVideo.src) {
        videoCallMainVideo.pause();
        videoCallMainVideo.src = '';
        videoCallMainVideo.load(); // æ¸…ç†ç¼“å­˜
      }
      
      // éšè—è§†é¢‘å…ƒç´ 
      videoCallMainVideo.style.display = 'none';
      videoCallMainImage.style.display = 'none';
      
      // éšè—è§†é¢‘é€šè¯ç•Œé¢
      videoCallModal.classList.remove('show');
      
      // é‡ç½®çŠ¶æ€
      isVideoCallActive = false;
      videoCallStartTime = null;
      
      // é‡ç½®æŒ‰é’®çŠ¶æ€
      videoCallMuteBtn.textContent = 'ğŸ”‡';
      videoCallMuteBtn.title = 'é™éŸ³';
      videoCallCameraBtn.textContent = 'ğŸ“·';
      videoCallCameraBtn.title = 'å…³é—­æ‘„åƒå¤´';
      videoCallUserAvatar.style.opacity = '1';
      
      // åœ¨èŠå¤©ä¸­æ˜¾ç¤ºé€šè¯ç»“æŸæ¶ˆæ¯
      const currentChat = chatList.find(c => c.id === currentChatId);
      if (currentChat && currentVideoCallRole) {
        const duration = videoCallDuration.textContent;
        appendMsg('user', `è§†é¢‘é€šè¯å·²ç»“æŸï¼Œé€šè¯æ—¶é•¿ï¼š${duration}`, false, null, null, null, null, null, false, null, false, null, 'text');
        saveCurrentChatData();
      }
      
      currentVideoCallRole = null;
    }

    // ä¿å­˜å’ŒåŠ è½½è§†é¢‘é€šè¯è®¾ç½®
    function saveVideoCallSettings(roleData) {
      if (roleData.videoCallMedia) {
        // ç¾¤èŠè§’è‰²ä¿å­˜
        const currentChat = chatList.find(c => c.id === currentChatId);
        if (currentChat && currentChat.type === 'group') {
          const roleIndex = currentChat.roles.findIndex(r => r.id === roleData.id);
          if (roleIndex !== -1) {
            currentChat.roles[roleIndex].videoCallMedia = roleData.videoCallMedia;
          }
        }
      } else {
        // å•èŠä¿å­˜
        const currentChat = chatList.find(c => c.id === currentChatId);
        if (currentChat && currentChat.type === 'single') {
          currentChat.aiVideo = roleData.aiVideo;
        }
      }
      saveCurrentChatData();
    }

    // ==================== è§†é¢‘é€šè¯åŠŸèƒ½ç»“æŸ ====================

    // åˆå§‹åŒ–è§†é¢‘é€šè¯åŠŸèƒ½
    initVideoCall();
    
    // åˆå§‹åŒ–æ‹ä¸€æ‹æé†’åŠŸèƒ½
    initPatReminder();
  </script>
</body>
</html>